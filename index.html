<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Mindclone - A record of the life only you lived.</title>
    <style>
        :root {
            /* Minimal Modern Palette - Clean & Professional */
            --bg: #0a0a0a;
            --bg-surface: #141414;
            --bg-elevated: #1a1a1a;
            --border: #262626;
            --border-hover: #333333;

            /* Text */
            --text: #fafafa;
            --text-secondary: #a1a1a1;
            --text-muted: #666666;

            /* Single Accent */
            --accent: #a78bfa;
            --accent-hover: #c4b5fd;
            --accent-muted: rgba(167, 139, 250, 0.15);

            /* Status */
            --error: #ef4444;
            --warning: #f59e0b;

            /* Legacy mappings for compatibility */
            --color-bg-primary: var(--bg);
            --color-bg-secondary: var(--bg-surface);
            --color-bg-tertiary: var(--bg-elevated);
            --color-bg-elevated: var(--bg-elevated);
            --color-accent-primary: var(--accent);
            --color-accent-secondary: var(--accent-hover);
            --color-accent-tertiary: #8B5CF6;
            --color-text-primary: var(--text);
            --color-text-secondary: var(--text-secondary);
            --color-text-tertiary: var(--text-secondary);
            --color-text-muted: var(--text-muted);
            --color-border-default: var(--border);
            --color-border-subtle: var(--border);
            --color-border-hover: var(--border-hover);
            --color-success: var(--accent);
            --color-success-light: var(--accent-hover);
            --color-error: var(--error);
            --color-warning: var(--warning);
            --color-info: var(--accent);
            --gradient-primary: var(--accent);
            --gradient-subtle: var(--bg-surface);
            --gradient-card: var(--bg-elevated);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--color-bg-primary);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }

        /* ==================== LANDING PAGE ==================== */
        .landing-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .landing-content {
            text-align: center;
            max-width: 400px;
            padding: 20px;
        }

        .landing-logo {
            margin-bottom: 32px;
        }

        .landing-logo-img {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }

        .landing-title {
            font-size: 32px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 12px;
            letter-spacing: -0.5px;
        }

        .landing-tagline {
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: 48px;
            font-weight: 400;
        }

        .landing-sign-in-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: var(--bg-surface);
            color: var(--text);
            padding: 14px 32px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            z-index: 10;
        }

        .landing-sign-in-btn:hover {
            background: var(--bg-elevated);
            border-color: var(--border-hover);
        }

        .landing-sign-in-btn:active {
            transform: scale(0.98);
        }

        .landing-sign-in-btn .google-icon {
            width: 20px;
            height: 20px;
        }

        .landing-powered-by {
            margin-top: 32px;
            font-size: 13px;
            color: var(--text-muted);
        }

        .olbrain-text {
            color: var(--accent);
            font-weight: 500;
        }

        /* ==================== APP HEADER ==================== */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 48px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 100;
        }

        .app-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-avatar-left {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--accent);
            cursor: pointer;
        }

        .header-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }

        .app-header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-icon-btn {
            position: relative;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-icon-btn:hover {
            background: var(--accent-muted);
            color: var(--text);
        }

        .activity-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--accent);
            color: white;
            font-size: 9px;
            font-weight: 600;
            padding: 1px 4px;
            border-radius: 8px;
            min-width: 14px;
            text-align: center;
        }

        .activity-badge:empty {
            display: none;
        }

        .header-user-menu {
            position: relative;
        }

        .header-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.15s;
        }

        .header-avatar:hover {
            border-color: var(--accent);
        }

        .header-dropdown {
            position: absolute;
            top: calc(100% + 12px);
            right: 0;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            min-width: 260px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
            z-index: 1000;
            animation: dropdownSlideIn 0.2s ease;
        }

        @keyframes dropdownSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header-dropdown-header {
            padding: 16px;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .dropdown-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
        }

        .dropdown-user-info {
            flex: 1;
            min-width: 0;
        }

        .dropdown-user-name {
            color: white;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dropdown-user-email {
            color: #999;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dropdown-divider {
            border: none;
            border-top: 1px solid #333;
            margin: 0;
        }

        .header-dropdown-item {
            width: 100%;
            padding: 12px 16px;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            transition: background 0.3s ease;
            text-decoration: none;
        }

        .header-dropdown-item:last-child {
            border-radius: 0 0 12px 12px;
        }

        .header-dropdown-item:hover {
            background: #2a2a2a;
        }

        .dropdown-icon {
            font-size: 18px;
        }

        /* ==================== ACTIVITY MODAL ==================== */
        .activity-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .activity-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
        }

        @supports not (backdrop-filter: blur(8px)) {
            .activity-modal-overlay {
                background: rgba(0, 0, 0, 0.95);
            }
        }

        .activity-modal-content {
            position: relative;
            z-index: 1;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.8);
            animation: modalSlideUp 0.3s ease;
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .activity-modal-header {
            padding: 24px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .activity-modal-title {
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }

        .activity-icon {
            font-size: 32px;
        }

        .activity-modal-title h2 {
            font-size: 24px;
            margin-bottom: 8px;
            color: white;
        }

        .activity-link {
            color: var(--color-accent-primary);
            font-size: 14px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: opacity 0.3s ease;
        }

        .activity-link:hover {
            opacity: 0.8;
        }

        .modal-close-btn {
            background: none;
            border: none;
            color: #999;
            font-size: 40px;
            cursor: pointer;
            line-height: 1;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .modal-close-btn:hover {
            background: #2a2a2a;
            color: white;
        }

        .activity-modal-stats {
            display: flex;
            gap: 16px;
            padding: 24px;
            border-bottom: 1px solid #333;
        }

        .stat-card {
            flex: 1;
            background: #2a2a2a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--color-accent-primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .activity-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .modal-activity-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .modal-activity-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .modal-activity-empty .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .modal-activity-empty h3 {
            font-size: 20px;
            margin-bottom: 12px;
            color: white;
        }

        .modal-activity-empty p {
            color: #999;
            font-size: 14px;
            margin-bottom: 24px;
            max-width: 300px;
        }

        .btn-primary {
            display: inline-block;
            padding: 12px 24px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            box-shadow: 0 0 20px rgba(124, 102, 220, 0.25);
            transform: translateY(-2px);
        }

        .app-container {
            display: flex;
            height: calc(100vh - 48px);
            width: 100vw;
            margin-top: 48px;
        }

        /* Sidebar - Hidden by default */
        .sidebar {
            width: 220px;
            background: #1a1a1a;
            border-left: 1px solid #333;
            display: none;
            flex-direction: column;
            overflow-y: auto;
            order: 2;
        }

        /* Settings Panel Overlay */
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 199;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.25s ease, visibility 0.25s ease;
        }

        body:not(.right-panel-collapsed) .settings-overlay {
            opacity: 1;
            visibility: visible;
        }

        /* Right Settings Panel - Slide-over */
        .right-activity-panel {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 340px;
            max-width: 90vw;
            background: var(--bg);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 200;
            transform: translateX(100%);
            transition: transform 0.25s ease;
        }

        /* Open state */
        body:not(.right-panel-collapsed) .right-activity-panel {
            transform: translateX(0);
        }

        /* Panel Header */
        .settings-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            background: var(--bg);
        }

        .settings-panel-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }

        .settings-panel-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            line-height: 1;
            transition: all 0.15s;
        }

        .settings-panel-close:hover {
            background: var(--accent-muted);
            color: var(--text);
        }

        /* Hide toggle button - use header icons instead */
        .right-panel-toggle {
            display: none;
        }

        .right-activity-panel .activity-feed {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Hide tabs - show settings directly */
        .panel-tabs {
            display: none;
        }

        .panel-tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 8px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--color-text-tertiary);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .panel-tab:hover {
            background: rgba(124, 102, 220, 0.08);
            color: var(--color-text-primary);
        }

        .panel-tab.active {
            color: var(--color-text-primary);
            border-bottom-color: var(--color-accent-primary);
            background: rgba(124, 102, 220, 0.04);
        }

        .panel-tab .tab-icon {
            font-size: 20px;
        }

        .panel-tab .tab-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .panel-tab .tab-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ff6b6b;
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .panel-tab .tab-badge:empty {
            display: none;
        }

        /* Panel Content Container */
        .panel-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-tab-content {
            display: none;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        .panel-tab-content.active {
            display: flex;
        }

        /* Settings panel shows settings directly */
        #settingsTab {
            display: flex;
        }

        #activityTab,
        #analyticsTab {
            display: none;
        }

        .settings-scroll-container,
        .analytics-scroll-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px;
        }

        .settings-scroll-container::-webkit-scrollbar,
        .analytics-scroll-container::-webkit-scrollbar {
            width: 6px;
        }

        .settings-scroll-container::-webkit-scrollbar-track,
        .analytics-scroll-container::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .settings-scroll-container::-webkit-scrollbar-thumb,
        .analytics-scroll-container::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        .settings-scroll-container::-webkit-scrollbar-thumb:hover,
        .analytics-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #444;
        }

        /* Panel Sections */
        .panel-section {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .panel-section-title {
            font-size: 16px;
            font-weight: 700;
            color: white;
            margin-bottom: 6px;
        }

        .panel-section-subtitle {
            font-size: 12px;
            color: #999;
            margin-bottom: 16px;
        }

        /* Form Groups */
        .panel-form-group {
            margin-bottom: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        .panel-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: white;
            margin-bottom: 6px;
        }

        .panel-hint {
            display: block;
            font-size: 11px;
            color: #666;
            margin-bottom: 8px;
        }

        /* Input Fields */
        .panel-input,
        .panel-textarea,
        .panel-select {
            width: 100%;
            padding: 12px;
            background: #0d0d0d;
            border: 1px solid #333;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s ease;
            font-family: inherit;
            box-sizing: border-box;
        }

        .panel-input:focus,
        .panel-textarea:focus,
        .panel-select:focus {
            border-color: #555;
        }

        .panel-textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Username Input Group */
        .username-input-group {
            display: flex;
            align-items: center;
            background: #0d0d0d;
            border: 1px solid #333;
            border-radius: 8px;
            overflow: hidden;
            width: 100%;
            box-sizing: border-box;
        }

        .username-input-group:focus-within {
            border-color: #555;
        }

        .username-prefix {
            padding: 12px;
            color: #666;
            font-size: 13px;
            background: #1a1a1a;
            border-right: 1px solid #333;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .username-input {
            flex: 1;
            min-width: 0;
            padding: 12px;
            background: transparent;
            border: none;
            color: white;
            font-size: 14px;
            outline: none;
        }

        .availability-indicator {
            padding: 0 12px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .availability-indicator.available {
            color: var(--color-accent-primary);
        }

        .availability-indicator.taken {
            color: #ff6b6b;
        }

        .availability-indicator.checking {
            color: #666;
        }

        .availability-indicator.invalid {
            color: #ff6b6b;
        }

        /* Buttons */
        .panel-button {
            width: 100%;
            padding: 12px 20px;
            background: #2a2a2a;
            color: white;
            border: 1px solid #333;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .panel-button:hover {
            background: #333;
            transform: translateY(-1px);
        }

        .panel-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .panel-button-primary {
            background: white;
            color: black;
            border: none;
        }

        .panel-button-primary:hover {
            background: #f0f0f0;
        }

        .panel-button-danger {
            background: transparent;
            border: none;
            color: var(--color-text-muted);
            font-size: 12px;
            padding: 8px 0;
            text-decoration: underline;
            font-weight: 400;
        }

        .panel-button-danger:hover {
            color: var(--color-error);
            background: transparent;
        }

        .username-delete-icon {
            padding: 8px;
            cursor: pointer;
            color: var(--color-text-muted);
            font-size: 16px;
            display: none;
            transition: color 0.2s ease;
            background: transparent;
            border: none;
            outline: none;
            flex-shrink: 0;
            width: 32px;
            height: 32px;
        }

        .username-delete-icon:hover {
            color: var(--color-error);
        }

        .username-delete-icon.visible {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .panel-actions {
            display: flex;
            gap: 10px;
        }

        .switch-to-settings-btn {
            padding: 10px 20px;
            background: #2a2a2a;
            color: white;
            border: 1px solid #333;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .switch-to-settings-btn:hover {
            background: #333;
        }

        /* Alerts */
        .panel-alert-container {
            margin-bottom: 16px;
        }

        .panel-alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 12px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .panel-alert.success {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid var(--color-accent-primary);
            color: var(--color-accent-primary);
        }

        .panel-alert.error {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid #ff6b6b;
            color: #ff6b6b;
        }

        .panel-alert.warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid #FFC107;
            color: #FFC107;
        }

        /* Toggle Switch (reused from settings.html) */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #2a2a2a;
            transition: .4s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--color-accent-primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        /* Character Count */
        .char-count {
            text-align: right;
            font-size: 11px;
            color: #666;
            margin-top: 4px;
        }

        /* Link Preview */
        .link-preview {
            background: #0d0d0d;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .link-url {
            font-size: 13px;
            color: white;
            font-weight: 600;
            word-break: break-all;
        }

        .link-url a {
            color: var(--color-accent-primary);
            text-decoration: none;
        }

        .link-url a:hover {
            text-decoration: underline;
        }

        .copy-btn {
            padding: 8px 16px;
            background: #2a2a2a;
            color: white;
            border: 1px solid #333;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: #333;
        }

        .copy-btn.copied {
            background: var(--color-accent-primary);
            border-color: var(--color-accent-primary);
        }

        /* Stats Grid (Analytics Tab) */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: #0d0d0d;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: white;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Recent Visitors */
        .recent-visitors-section {
            margin-top: 24px;
        }

        .subsection-title {
            font-size: 14px;
            font-weight: 600;
            color: white;
            margin-bottom: 12px;
        }

        .recent-visitors-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .recent-visitor-item {
            background: #0d0d0d;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .recent-visitor-item:hover {
            background: #1a1a1a;
            border-color: #444;
        }

        .recent-visitor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .recent-visitor-id {
            font-size: 12px;
            font-weight: 600;
            color: white;
        }

        .recent-visitor-count {
            font-size: 11px;
            color: #999;
        }

        .recent-visitor-time {
            font-size: 11px;
            color: #666;
        }

        /* Analytics Filters */
        .analytics-filters {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #333;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #333;
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ==================== KNOWLEDGE BASE STYLES ==================== */

        .knowledge-base-list {
            margin: 20px 0;
            min-height: 100px;
        }

        .knowledge-base-empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #ccc;
        }

        .empty-hint {
            font-size: 12px;
            color: #666;
            line-height: 1.5;
        }

        .knowledge-base-item {
            background: #0d0d0d;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 12px 14px;
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            transition: all 0.3s ease;
        }

        .knowledge-base-item:hover {
            border-color: #555;
            background: #1a1a1a;
        }

        .kb-file-icon {
            font-size: 24px;
            flex-shrink: 0;
            padding-top: 1px;
        }

        .kb-file-info {
            flex: 1;
            min-width: 0;
        }

        .kb-file-name {
            font-size: 13px;
            font-weight: 600;
            color: white;
            margin-bottom: 8px;
            word-break: break-word;
            line-height: 1.4;
        }

        .kb-file-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 6px 10px;
            font-size: 11px;
            color: #777;
            align-items: center;
        }

        .kb-file-size,
        .kb-file-date {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .kb-file-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .kb-file-status.ready {
            background: rgba(46, 213, 115, 0.1);
            color: var(--color-accent-primary);
        }

        .kb-file-status.processing {
            background: rgba(255, 159, 67, 0.1);
            color: #ff9f43;
        }

        .kb-file-actions {
            display: inline-flex;
            gap: 4px;
            margin-left: auto;
        }

        .kb-action-btn {
            width: 22px;
            height: 22px;
            padding: 0;
            background: transparent;
            border: 1px solid #444;
            border-radius: 4px;
            color: #666;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .kb-action-btn:hover {
            background: #2a2a2a;
            border-color: #666;
            color: white;
        }

        .kb-action-btn.delete:hover {
            background: rgba(255, 107, 107, 0.1);
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        .kb-action-btn.view:hover {
            background: rgba(74, 144, 226, 0.1);
            border-color: #4a90e2;
            color: #4a90e2;
        }

        .button-icon {
            font-size: 14px;
        }

        .sidebar-header {
            padding: 30px 20px;
            text-align: center;
            border-bottom: 1px solid #333;
        }

        .sidebar-header .logo {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .sidebar-header h1 {
            color: white;
            margin-bottom: 5px;
            font-size: 24px;
        }

        .sidebar-header .tagline {
            color: #999;
            font-size: 14px;
        }

        .settings-link {
            display: inline-block;
            margin-top: 15px;
            padding: 8px 16px;
            background: #2a2a2a;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            border: 1px solid #333;
        }

        .settings-link:hover {
            background: #333;
        }

        /* Sidebar Spacer */
        .sidebar-spacer {
            flex: 1;
        }

        /* Sidebar Footer */
        .sidebar-footer {
            border-top: 1px solid #333;
        }

        /* Sidebar Auth (Sign In Section) */
        .sidebar-auth {
            padding: 20px;
            text-align: center;
        }

        .sidebar-auth h2 {
            color: white;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .sidebar-auth p {
            color: #999;
            margin-bottom: 20px;
            font-size: 13px;
            line-height: 1.6;
        }

        .google-sign-in-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: white;
            color: black;
            padding: 12px 20px;
            border: 1px solid #333;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .google-sign-in-btn:hover {
            background: #f0f0f0;
        }

        .google-icon {
            width: 20px;
            height: 20px;
        }

        /* Sidebar Profile (User Info Section) */
        .sidebar-profile {
            padding: 15px 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .sidebar-profile .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #333;
            flex-shrink: 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sidebar-profile .user-avatar:hover {
            border-color: var(--color-accent-primary);
        }

        .sidebar-profile .user-info {
            flex: 1;
            min-width: 0;
        }

        .sidebar-profile .user-name {
            font-weight: 600;
            color: white;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-profile .user-email {
            font-size: 12px;
            color: #999;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-profile .sign-out-btn {
            padding: 6px 12px;
            background: #2a2a2a;
            color: white;
            border: 1px solid #333;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
            width: 100%;
            margin-top: 8px;
        }

        .sidebar-profile .sign-out-btn:hover {
            background: #333;
        }

        /* Avatar Dropdown Menu */
        .avatar-dropdown {
            position: absolute;
            bottom: 80px;
            right: 20px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            min-width: 200px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .avatar-dropdown-header {
            padding: 12px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .dropdown-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #333;
            flex-shrink: 0;
        }

        .dropdown-user-info {
            flex: 1;
            min-width: 0;
        }

        .dropdown-user-name {
            font-weight: 600;
            color: white;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dropdown-user-email {
            font-size: 11px;
            color: #999;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .avatar-dropdown-divider {
            border: none;
            border-top: 1px solid #333;
            margin: 0;
        }

        .avatar-dropdown-item {
            width: 100%;
            padding: 10px 12px;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            transition: background 0.3s ease;
            text-decoration: none;
        }

        .avatar-dropdown-item:last-child {
            border-radius: 0 0 12px 12px;
        }

        .avatar-dropdown-item:hover {
            background: #2a2a2a;
        }

        .avatar-dropdown-icon {
            font-size: 16px;
        }

        .link-status {
            width: 100%;
            margin-top: 12px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
        }

        .link-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(76, 175, 80, 0.05) 100%);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            color: var(--color-accent-primary);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .link-badge:hover {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.15) 0%, rgba(76, 175, 80, 0.08) 100%);
            border-color: rgba(76, 175, 80, 0.4);
            transform: translateY(-1px);
        }

        .link-badge .pulse {
            width: 6px;
            height: 6px;
            background: var(--color-accent-primary);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.6;
                transform: scale(0.9);
            }
        }

        .link-badge .arrow {
            font-size: 10px;
            transition: transform 0.3s ease;
        }

        .link-badge:hover .arrow {
            transform: translateX(2px);
        }

        /* Live Activity Feed */
        .activity-feed {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-top: 1px solid #333;
        }

        .activity-feed-header {
            padding: 16px 20px;
            border-bottom: 1px solid #333;
            background: #1a1a1a;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .activity-feed-link {
            display: flex;
            align-items: center;
            gap: 6px;
            color: white;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 600;
        }

        .activity-feed-link:hover {
            color: var(--color-accent-primary);
        }

        .activity-feed-link .icon {
            font-size: 16px;
        }

        .activity-feed-link .arrow {
            opacity: 0.6;
            font-size: 12px;
            transition: transform 0.3s ease;
        }

        .activity-feed-link:hover .arrow {
            transform: translateX(3px);
            opacity: 1;
        }

        .activity-feed-count {
            font-size: 13px;
            color: var(--color-accent-primary);
            font-weight: 600;
            padding-left: 22px;
        }

        .activity-feed-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .activity-feed-list::-webkit-scrollbar {
            width: 6px;
        }

        .activity-feed-list::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .activity-feed-list::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        .activity-feed-list::-webkit-scrollbar-thumb:hover {
            background: #444;
        }

        .activity-item {
            background: #2a2a2a;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .activity-item:hover {
            background: #333;
            border-color: #444;
            transform: translateY(-2px);
        }

        .activity-item.new {
            border-color: rgba(76, 175, 80, 0.5);
            background: rgba(76, 175, 80, 0.05);
        }

        .activity-item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .activity-item-visitor {
            font-size: 12px;
            font-weight: 600;
            color: var(--color-accent-primary);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .activity-item-time {
            font-size: 10px;
            color: #999;
            margin-left: auto;
        }

        .activity-item-message {
            font-size: 11px;
            color: #ddd;
            line-height: 1.4;
            margin-bottom: 6px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .activity-item-response {
            font-size: 11px;
            color: #999;
            line-height: 1.4;
            padding-left: 12px;
            border-left: 2px solid #333;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .activity-feed-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            color: #999;
        }

        .activity-feed-empty .icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .activity-feed-empty .message {
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .activity-feed-empty .link-to-settings {
            padding: 8px 16px;
            background: #2a2a2a;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 12px;
            border: 1px solid #333;
            transition: all 0.3s ease;
        }

        .activity-feed-empty .link-to-settings:hover {
            background: #333;
        }

        /* Conversation Modal */
        .conversation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .conversation-modal-content {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        }

        .conversation-modal-content.has-display {
            max-width: 1400px;
        }

        .conversation-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #1a1a1a;
        }

        .conversation-modal-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .conversation-modal-title .visitor-icon {
            font-size: 24px;
        }

        .conversation-modal-title .visitor-info {
            display: flex;
            flex-direction: column;
        }

        .conversation-modal-title .visitor-name {
            font-size: 16px;
            font-weight: 600;
            color: white;
        }

        .conversation-modal-title .visitor-time {
            font-size: 12px;
            color: #999;
        }

        .conversation-modal-close {
            background: none;
            border: none;
            color: #999;
            font-size: 32px;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .conversation-modal-close:hover {
            background: #2a2a2a;
            color: white;
        }

        .conversation-modal-main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .conversation-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .conversation-display-panel {
            width: 50%;
            background: #0d0d0d;
            border-left: 1px solid #333;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .conversation-display-panel.hidden {
            display: none;
        }

        .conversation-display-content {
            flex: 1;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .conversation-display-content canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .conversation-modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .conversation-modal-body::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .conversation-modal-body::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        .conversation-modal-body::-webkit-scrollbar-thumb:hover {
            background: #444;
        }

        .conversation-message {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .conversation-message.user {
            align-items: flex-end;
        }

        .conversation-message.assistant {
            align-items: flex-start;
        }

        .conversation-message-label {
            font-size: 11px;
            font-weight: 600;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .conversation-message-bubble {
            background: var(--gradient-subtle);
            border: 1px solid var(--color-border-default);
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
            line-height: 1.5;
            color: white;
        }

        .conversation-message.user .conversation-message-bubble {
            background: var(--gradient-primary);
            color: white;
        }

        .conversation-message.assistant .conversation-message-bubble {
            background: var(--gradient-subtle);
            border: 1px solid var(--color-border-default);
            color: white;
        }

        .conversation-message-time {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
        }

        .conversation-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #999;
        }

        .conversation-loading .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top-color: var(--color-accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .conversation-error {
            padding: 40px;
            text-align: center;
            color: #f44336;
        }

        /* Main Content (Center - Chat Area) */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg);
            overflow: hidden;
            margin-right: 360px; /* Space for fixed right panel */
            order: 1;
            transition: margin-right 0.3s ease;
        }

        body.right-panel-collapsed .main-content {
            margin-right: 0;
        }

        /* No additional styling needed - parent container handles header offset */
        .main-content.with-header {
            /* Height and margin handled by parent .app-container */
        }

        /* Chat Interface */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: var(--bg);
        }

        .message {
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* AI messages - left aligned */
        .message.ai {
            align-items: flex-start;
        }

        /* User messages - right aligned */
        .message.user {
            align-items: flex-end;
        }

        /* Hide avatars for cleaner look */
        .message-avatar {
            display: none;
        }

        .message-content {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 16px;
            line-height: 1.5;
            word-wrap: break-word;
            font-size: 14px;
        }

        .message.user .message-content {
            background: var(--accent);
            color: white;
            border-radius: 16px 16px 4px 16px;
        }

        .message.ai .message-content {
            background: var(--bg-surface);
            color: var(--text);
            border-radius: 16px 16px 16px 4px;
        }

        .chat-input-container {
            padding: 0 16px 16px 16px;
            background: linear-gradient(to top, var(--bg) 70%, transparent);
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
            display: flex;
            gap: 8px;
            align-items: flex-end;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 6px 6px 6px 16px;
            transition: border-color 0.15s;
        }

        .input-wrapper:focus-within {
            border-color: var(--accent);
        }

        .chat-input {
            flex: 1;
            padding: 8px 0;
            background: transparent;
            border: none;
            font-size: 14px;
            color: var(--text);
            outline: none;
            resize: none;
            max-height: 120px;
            line-height: 1.4;
        }

        .chat-input::placeholder {
            color: var(--text-muted);
        }

        .send-button {
            background: var(--accent);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .send-button:hover:not(:disabled) {
            background: var(--accent-hover);
        }

        .send-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .attach-button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: transparent;
            color: var(--text-secondary);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.15s;
            flex-shrink: 0;
        }

        .attach-button:hover {
            color: var(--text);
            background: var(--accent-muted);
        }

        .file-preview {
            position: absolute;
            bottom: 72px;
            left: 20px;
            right: 20px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 12px;
            display: none;
        }

        .file-preview.visible {
            display: block;
        }

        .file-preview-item {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .file-preview-icon {
            font-size: 24px;
        }

        .file-preview-info {
            flex: 1;
        }

        .file-preview-name {
            font-size: 14px;
            color: white;
            margin-bottom: 4px;
        }

        .file-preview-size {
            font-size: 12px;
            color: #888;
        }

        .file-preview-remove {
            background: none;
            border: none;
            color: #ff4444;
            cursor: pointer;
            font-size: 20px;
            padding: 4px 8px;
        }

        .file-preview-remove:hover {
            color: #ff6666;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #333;
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #666;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* Copy Button */
        .message.ai {
            position: relative;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #2a2a2a;
            border: 1px solid #333;
            color: #999;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s ease;
        }

        .message.ai:hover .copy-btn {
            opacity: 1;
        }

        .copy-btn:hover {
            background: #333;
            color: white;
        }

        /* Workflow Indicator Banner */
        .workflow-indicator {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gradient-primary);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 600;
            animation: slideDown 0.3s ease;
        }

        .workflow-indicator.hidden {
            display: none;
        }

        .workflow-indicator-icon {
            font-size: 18px;
            animation: pulse 2s ease-in-out infinite;
        }

        .workflow-cancel-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .workflow-cancel-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        .copy-btn.copied {
            background: var(--color-accent-primary);
            color: white;
            border-color: var(--color-accent-primary);
        }

        /* Timestamp */
        .message-timestamp {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 5px;
        }

        /* Markdown Styling */
        .message-content p {
            margin: 0.5em 0;
        }

        .message-content p:first-child {
            margin-top: 0;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content code {
            background: #2a2a2a;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .message-content pre {
            background: #2a2a2a;
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .message-content pre code {
            background: none;
            padding: 0;
        }

        .message-content ul, .message-content ol {
            margin: 10px 0;
            padding-left: 25px;
        }

        .message-content li {
            margin: 5px 0;
        }

        .message-content strong {
            font-weight: 600;
        }

        .message-content h1, .message-content h2, .message-content h3 {
            margin: 15px 0 10px 0;
            font-weight: 600;
        }

        .message-content blockquote {
            border-left: 3px solid #555;
            padding-left: 15px;
            margin: 10px 0;
            color: #999;
        }

        /* Links in AI messages (grey background) */
        .message.ai .message-content a {
            color: #6bc5ff;
            text-decoration: underline;
            text-underline-offset: 2px;
        }

        .message.ai .message-content a:hover {
            color: #ffffff;
        }

        /* Links in user messages (white background) */
        .message.user .message-content a {
            color: #0066cc;
            text-decoration: underline;
            text-underline-offset: 2px;
        }

        .message.user .message-content a:hover {
            color: #004499;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px;
            text-align: center;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .empty-state h2 {
            color: white;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #999;
            font-size: 16px;
            margin-bottom: 30px;
            max-width: 500px;
        }

        .suggested-prompts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            width: 100%;
            max-width: 600px;
        }

        .prompt-card {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .prompt-card:hover {
            background: #2a2a2a;
            border-color: #555;
            transform: translateY(-2px);
        }

        .prompt-card-title {
            color: white;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .prompt-card-text {
            color: #999;
            font-size: 13px;
            line-height: 1.4;
        }

        /* Error Message */
        .error-message {
            background: #2a1a1a;
            border: 1px solid #552222;
            padding: 15px;
            border-radius: 12px;
            margin: 10px 0;
        }

        .error-message-text {
            color: #ff6b6b;
            margin-bottom: 10px;
        }

        .retry-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .retry-btn:hover {
            background: #ff5252;
        }

        /* Mobile Header - WhatsApp style */
        .mobile-header {
            display: none;
        }

        /* ==================== ACCESSIBILITY ==================== */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* ==================== TABLET RESPONSIVE ==================== */
        @media (max-width: 1024px) {
            .right-activity-panel {
                width: 320px;
            }

            .right-panel-toggle {
                right: 320px;
            }

            body.right-panel-collapsed .right-panel-toggle {
                right: 0;
            }

            .panel-tab {
                padding: 10px 6px;
            }

            .panel-tab .tab-icon {
                font-size: 18px;
            }

            .panel-tab .tab-label {
                font-size: 10px;
            }
        }

        /* ==================== MOBILE RESPONSIVE ==================== */
        @media (max-width: 768px) {
            /* Hide right activity panel and toggle on mobile */
            .right-activity-panel,
            .right-panel-toggle {
                display: none !important;
            }

            /* Header full width on mobile */
            .app-header {
                right: 0 !important;
            }

            /* Main content fills screen on mobile */
            .main-content {
                max-width: 100vw !important;
                margin-right: 0 !important;
            }

            /* Landing page mobile */
            .landing-title {
                font-size: 48px;
            }

            .landing-tagline {
                font-size: 18px;
                margin-bottom: 50px;
            }

            .logo-glow {
                font-size: 80px;
            }

            .landing-sign-in-btn {
                padding: 16px 36px;
                font-size: 16px;
            }

            /* Header mobile */
            .app-header {
                padding: 0 16px;
                height: 56px;
            }

            .main-content.with-header {
                /* Height and margin handled by parent .app-container */
            }

            /* Header dropdown full-width on mobile */
            .header-dropdown {
                left: 0;
                right: 0;
                top: 100%;
                border-radius: 0 0 16px 16px;
                min-width: 100%;
            }

            /* Activity modal full-screen */
            .activity-modal-content {
                width: 100%;
                height: 100%;
                max-height: 100vh;
                border-radius: 0;
            }

            .activity-modal-stats {
                padding: 16px;
            }

            .stat-value {
                font-size: 24px;
            }

            /* Original mobile styles below */
            .app-container {
                flex-direction: column;
                height: calc(100vh - 56px);
                margin-top: 56px;
            }

            /* Sidebar styling on mobile */
            .sidebar {
                width: 100%;
                border-left: none;
                border-bottom: none;
            }

            /* Hide sidebar on mobile when user is signed in */
            .sidebar.mobile-hidden {
                display: none;
            }

            /* Show WhatsApp-style mobile header */
            .mobile-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 10px 16px;
                padding-top: calc(10px + env(safe-area-inset-top));
                background: #0d0d0d;
                border-bottom: 1px solid #333;
                height: 56px;
                flex-shrink: 0;
            }

            .mobile-header-left {
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .mobile-header .user-avatar {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                object-fit: cover;
            }

            .mobile-header-title {
                display: flex;
                flex-direction: column;
            }

            .mobile-header-name {
                font-size: 16px;
                font-weight: 600;
                color: white;
            }

            .mobile-header-subtitle {
                font-size: 12px;
                color: #999;
            }

            .mobile-menu-btn {
                background: none;
                border: none;
                color: white;
                font-size: 24px;
                cursor: pointer;
                padding: 4px 8px;
            }

            /* Make main content fill screen */
            .main-content {
                flex: 1;
                min-height: 0;
                display: flex;
                flex-direction: column;
            }

            .chat-container {
                flex: 1;
                display: flex;
                flex-direction: column;
            }

            .chat-messages {
                flex: 1;
                overflow-y: auto;
            }

            .message-content {
                max-width: 85%;
            }

            .message.ai .message-content {
                /* Mobile: full-width but keep box styling for personal feel */
                max-width: 100%;
            }

            /* Fix chat input for Safari iOS */
            .chat-input-container {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                padding: 0 12px 12px 12px;
                padding-bottom: max(12px, calc(12px + env(safe-area-inset-bottom)));
                background: linear-gradient(to top, var(--bg) 70%, transparent);
                z-index: 1000;
            }

            .input-wrapper {
                background: var(--bg-surface);
                border: 1px solid var(--border);
                border-radius: 24px;
                padding: 6px 6px 6px 12px;
            }

            .chat-input {
                font-size: 16px; /* Prevents iOS zoom on focus */
                background: transparent;
                color: var(--text);
                border: none;
                padding: 8px 0;
            }

            .chat-input::placeholder {
                color: var(--text-muted);
            }

            .chat-input:focus {
                outline: none;
            }

            .send-button {
                background: var(--accent);
                color: white;
                border: none;
                width: 36px;
                height: 36px;
                border-radius: 50%;
            }

            .send-button:hover:not(:disabled) {
                background: var(--accent-hover);
            }

            .send-button:active {
                background: var(--accent);
            }

            /* Ensure chat messages don't hide behind fixed input bar */
            .chat-messages {
                padding-bottom: 70px; /* Account for compact fixed typing bar height */
            }

            /* Welcome screen on mobile */
            .welcome-container {
                padding: 20px;
            }
        }

        /* ==================== KNOWLEDGE BASE PREVIEW MODAL ==================== */
        .kb-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .kb-preview-modal.active {
            opacity: 1;
        }

        .kb-preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
        }

        .kb-preview-content {
            position: relative;
            z-index: 1;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 20px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.8);
            animation: kbModalSlideUp 0.3s ease;
        }

        @keyframes kbModalSlideUp {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .kb-preview-header {
            padding: 24px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kb-preview-header h2 {
            font-size: 24px;
            color: white;
            margin: 0;
        }

        .kb-preview-close {
            background: none;
            border: none;
            color: #999;
            font-size: 32px;
            cursor: pointer;
            line-height: 1;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .kb-preview-close:hover {
            background: #2a2a2a;
            color: white;
        }

        .kb-preview-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .kb-preview-section {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid #333;
        }

        .kb-preview-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .kb-preview-section h3 {
            font-size: 18px;
            color: var(--color-accent-primary);
            margin-bottom: 12px;
        }

        .kb-preview-section p {
            color: #ddd;
            line-height: 1.6;
            margin: 8px 0;
        }

        .kb-preview-empty {
            color: #999;
            font-style: italic;
        }

        .kb-preview-footer {
            padding: 24px;
            border-top: 1px solid #333;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .kb-btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .kb-btn-primary {
            background: var(--color-accent-primary);
            color: white;
        }

        .kb-btn-primary:hover {
            background: var(--color-accent-secondary);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
        }

        .kb-btn-primary:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .kb-btn-secondary {
            background: #2a2a2a;
            color: white;
            border: 1px solid #444;
        }

        .kb-btn-secondary:hover {
            background: #333;
            border-color: #555;
        }

        @media (max-width: 768px) {
            .kb-preview-content {
                width: 95%;
                max-height: 90vh;
            }

            .kb-preview-header h2 {
                font-size: 20px;
            }

            .kb-preview-body {
                padding: 16px;
            }

            .kb-preview-footer {
                padding: 16px;
            }

            .kb-btn {
                padding: 10px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body class="right-panel-collapsed">
    <!-- Workflow Indicator Banner -->
    <div id="workflowIndicator" class="workflow-indicator hidden">
        <span class="workflow-indicator-icon"></span>
        <span id="workflowIndicatorText">Setting up your public link...</span>
        <button class="workflow-cancel-btn" onclick="cancelWorkflow()">Cancel</button>
    </div>

    <!-- Landing Page (Centered Auth Screen) -->
    <div id="landingPage" class="landing-page">
        <div class="landing-content">
            <div class="landing-logo">
                <img src="/logo.png" alt="Mindclone Logo" class="landing-logo-img">
            </div>
            <h1 class="landing-title">Mindclone</h1>
            <p class="landing-tagline">A record of the life only you lived.</p>
            <button id="landingSignInBtn" class="landing-sign-in-btn">
                <svg class="google-icon" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Sign in with Google
            </button>
            <p class="landing-powered-by">powered by <span class="olbrain-text">Olbrain</span> - The Machine Brain</p>
        </div>
    </div>

    <!-- App Header (Shown after authentication) -->
    <header id="appHeader" class="app-header hidden">
        <div class="app-header-left">
            <img id="headerAvatarLeft" class="header-avatar-left" src="" alt="User">
            <div class="header-title">Mindclone</div>
        </div>
        <div class="app-header-right">
            <button id="activityBtn" class="header-icon-btn" title="Activity">
                
                <span id="activityBadgeHeader" class="activity-badge"></span>
            </button>
            <button id="settingsBtn" class="header-icon-btn" title="Settings">
                
            </button>
            <div class="header-user-menu">
                <img id="headerAvatar" class="header-avatar" src="" alt="User Avatar">
                <div id="headerDropdown" class="header-dropdown hidden">
                    <div class="header-dropdown-header">
                        <img id="headerDropdownAvatar" class="dropdown-avatar" src="" alt="User Avatar">
                        <div class="dropdown-user-info">
                            <div id="headerDropdownName" class="dropdown-user-name"></div>
                            <div id="headerDropdownEmail" class="dropdown-user-email"></div>
                        </div>
                    </div>
                    <hr class="dropdown-divider">
                    <button id="headerSignOutBtn" class="header-dropdown-item">
                        <span class="dropdown-icon"></span>
                        <span>Sign Out</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Activity Feed Modal -->
    <div id="activityModal" class="activity-modal hidden">
        <div class="activity-modal-overlay"></div>
        <div class="activity-modal-content">
            <div class="activity-modal-header">
                <div class="activity-modal-title">
                    <span class="activity-icon"></span>
                    <div>
                        <h2>Live Link Activity</h2>
                        <a href="#" id="activityModalLink" target="_blank" class="activity-link">View Your Link </a>
                    </div>
                </div>
                <button id="activityModalClose" class="modal-close-btn" aria-label="Close modal"></button>
            </div>
            <div class="activity-modal-stats">
                <div class="stat-card">
                    <div class="stat-value" id="modalActivityCount">0</div>
                    <div class="stat-label">Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="modalTotalCount">0</div>
                    <div class="stat-label">All Time</div>
                </div>
            </div>
            <div class="activity-modal-body">
                <div id="modalActivityList" class="modal-activity-list">
                    <!-- Activity items rendered here -->
                </div>
                <!-- Empty state -->
                <div id="modalActivityEmpty" class="modal-activity-empty hidden">
                    <div class="empty-icon"></div>
                    <h3>No Activity Yet</h3>
                    <p>Enable your Public Link to see visitor conversations</p>
                    <a href="/settings" class="btn-primary">Go to Settings</a>
                </div>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Mobile Header (WhatsApp style - only visible on mobile) -->
        <div id="mobileHeader" class="mobile-header hidden">
            <div class="mobile-header-left">
                <img id="mobileAvatar" class="user-avatar" src="" alt="User">
                <div class="mobile-header-title">
                    <div id="mobileName" class="mobile-header-name">Mindclone</div>
                    <div class="mobile-header-subtitle">Private cognitive twin</div>
                </div>
            </div>
            <button id="mobileMenuBtn" class="mobile-menu-btn"></button>
        </div>

        <!-- Left Sidebar -->
        <div class="sidebar">
            <!-- Sidebar Header (always visible) -->
            <div class="sidebar-header">
                <div class="logo"></div>
                <h1>Mindclone</h1>
                <p class="tagline">Your private cognitive twin</p>
                <a href="/settings" class="settings-link hidden"> Settings</a>
            </div>


            <!-- Sidebar Footer (bottom of sidebar) -->
            <div class="sidebar-footer">
                <!-- Auth Screen (shown when not logged in) -->
                <div id="sidebarAuth" class="sidebar-auth">
                    <h2>Welcome! </h2>
                    <p>Sign in with your Google account to begin your Mindclone.</p>
                    <button id="googleSignInBtn" class="google-sign-in-btn">
                        <svg class="google-icon" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Sign in with Google
                    </button>
                </div>

                <!-- User Profile (shown when logged in) -->
                <div id="sidebarProfile" class="sidebar-profile hidden">
                    <img id="userAvatar" class="user-avatar" src="" alt="User">
                    <div class="user-info">
                        <div id="userName" class="user-name"></div>
                        <div id="userEmail" class="user-email"></div>
                        <!-- Public Link badge removed - now in Activity Feed header -->
                        <button id="signOutBtn" class="sign-out-btn hidden">Sign Out</button>
                    </div>
                </div>

                <!-- Avatar Dropdown Menu -->
                <div id="avatarDropdown" class="avatar-dropdown hidden">
                    <div class="avatar-dropdown-header">
                        <img id="dropdownAvatar" class="dropdown-avatar" src="" alt="User">
                        <div class="dropdown-user-info">
                            <div id="dropdownUserName" class="dropdown-user-name"></div>
                            <div id="dropdownUserEmail" class="dropdown-user-email"></div>
                        </div>
                    </div>
                    <hr class="avatar-dropdown-divider">
                    <button id="dropdownSignOutBtn" class="avatar-dropdown-item">
                        <span class="avatar-dropdown-icon"></span>
                        <span>Sign Out</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-content">
            <!-- Chat Interface (shown when logged in) -->
            <div id="chatInterface" class="chat-container hidden">
                <div id="chatMessages" class="chat-messages"></div>
                <div class="file-preview" id="filePreview">
                    <div class="file-preview-item">
                        <span class="file-preview-icon" id="fileIcon"></span>
                        <div class="file-preview-info">
                            <div class="file-preview-name" id="fileName"></div>
                            <div class="file-preview-size" id="fileSize"></div>
                        </div>
                        <button class="file-preview-remove" id="removeFile"></button>
                    </div>
                </div>
                <div class="chat-input-container">
                    <input
                        type="file"
                        id="fileInput"
                        style="display: none;"
                        accept=".pdf,.png,.jpg,.jpeg,.xlsx,.xls,.csv"
                    >
                    <div class="input-wrapper">
                        <button id="attachButton" class="attach-button" title="Attach file">
                            
                        </button>
                        <input
                            type="text"
                            id="chatInput"
                            class="chat-input"
                            placeholder="Type your message..."
                            autocomplete="off"
                        >
                        <button id="sendButton" class="send-button"></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Panel Overlay -->
        <div class="settings-overlay" id="settingsOverlay"></div>

        <!-- Right Settings Panel -->
        <div class="right-activity-panel" id="settingsPanel">
            <!-- Panel Header -->
            <div class="settings-panel-header">
                <span class="settings-panel-title">Settings</span>
                <button class="settings-panel-close" id="settingsPanelClose"></button>
            </div>

            <!-- Tab Content Container -->
            <div class="panel-content">
                <!-- Activity Tab -->
                <div class="panel-tab-content active" id="activityTab">
                    <div class="activity-feed">
                        <div class="activity-feed-header">
                            <a href="#" id="rightActivityFeedLink" class="activity-feed-link" target="_blank">
                                <span class="icon"></span> Live Link Activity
                                <span class="arrow"></span>
                            </a>
                            <span id="rightActivityCount" class="activity-feed-count">0 today</span>
                        </div>
                        <div id="rightActivityList" class="activity-feed-list">
                            <!-- Activity items will be dynamically added here -->
                        </div>
                        <!-- Empty state (shown when no activity) -->
                        <div id="rightActivityEmpty" class="activity-feed-empty">
                            <div class="icon"></div>
                            <div class="message">No Link Activity Yet<br>Enable your Public Link to see visitor conversations</div>
                            <button class="switch-to-settings-btn">Go to Settings</button>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div class="panel-tab-content" id="settingsTab">
                    <div class="settings-scroll-container">
                        <!-- Alert Container -->
                        <div id="panelAlertContainer" class="panel-alert-container"></div>

                        <!-- Username Section -->
                        <div class="panel-section">
                            <h3 class="panel-section-title">Your Username</h3>
                            <p class="panel-section-subtitle">Choose a unique username for your public Mindclone link</p>

                            <div class="panel-form-group">
                                <label class="panel-label">Username</label>
                                <span class="panel-hint">3-20 characters, lowercase letters, numbers, and underscores only</span>
                                <div class="username-input-group">
                                    <span class="username-prefix">mindclone.link/</span>
                                    <input type="text" id="panelUsernameInput" class="username-input" placeholder="yourusername" autocomplete="off">
                                    <span id="panelAvailabilityIndicator" class="availability-indicator"></span>
                                    <button id="panelDeleteUsernameIcon" class="username-delete-icon" title="Release username"></button>
                                </div>
                            </div>

                            <div id="panelUsernameActions" class="panel-actions">
                                <button id="panelClaimUsernameBtn" class="panel-button" disabled>Claim Username</button>
                                <button id="panelReleaseUsernameBtn" class="panel-button panel-button-danger hidden">Release Username</button>
                            </div>
                        </div>

                        <!-- Link Configuration Section -->
                        <div class="panel-section" id="panelLinkConfigSection">
                            <h3 class="panel-section-title">Public Link Configuration</h3>
                            <p class="panel-section-subtitle">Control how your public Mindclone appears to visitors</p>

                            <div class="panel-form-group">
                                <label class="panel-label">Enable Public Link</label>
                                <span class="panel-hint">Allow anyone to chat with your Mindclone at your public link</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="panelLinkEnabledToggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div class="panel-form-group">
                                <label class="panel-label">Display Name</label>
                                <span class="panel-hint">How your name appears on the public link</span>
                                <input type="text" id="panelDisplayNameInput" class="panel-input" placeholder="Your Name">
                            </div>

                            <div class="panel-form-group">
                                <label class="panel-label">Bio</label>
                                <span class="panel-hint">Tell visitors about yourself (max 200 characters)</span>
                                <textarea id="panelBioInput" class="panel-textarea" placeholder="Software engineer, AI enthusiast, avid reader..." maxlength="200"></textarea>
                                <div class="char-count">
                                    <span id="panelBioCharCount">0</span>/200
                                </div>
                            </div>

                            <div class="panel-form-group">
                                <label class="panel-label">Custom Greeting (Optional)</label>
                                <span class="panel-hint">First message visitors see when they open your link</span>
                                <textarea id="panelGreetingInput" class="panel-textarea" placeholder="Hi! I'm [Your Name]'s Mindclone. Ask me anything!"></textarea>
                            </div>

                            <button id="panelSaveSettingsBtn" class="panel-button panel-button-primary">Save Settings</button>
                        </div>

                        <!-- Link Preview Section -->
                        <div class="panel-section" id="panelLinkPreviewSection" style="display: none;">
                            <h3 class="panel-section-title">Your Public Link</h3>
                            <p class="panel-section-subtitle">Share this link with anyone to let them chat with your Mindclone</p>

                            <div class="link-preview">
                                <div class="link-url">
                                    <a href="#" id="panelPublicLinkUrl" target="_blank"></a>
                                </div>
                                <button id="panelCopyLinkBtn" class="copy-btn">Copy Link</button>
                            </div>
                        </div>

                        <!-- Knowledge Base Section -->
                        <div class="panel-section">
                            <h3 class="panel-section-title"> Knowledge Base</h3>
                            <p class="panel-section-subtitle">Upload documents that visitors can ask about through your public link</p>

                            <!-- Include in conversations toggle -->
                            <div class="panel-form-group">
                                <label class="panel-label">Include in Link Conversations</label>
                                <span class="panel-hint">Allow visitors to query your knowledge base through your public link</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="knowledgeBaseEnabledToggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <!-- Document List -->
                            <div id="knowledgeBaseList" class="knowledge-base-list">
                                <div class="knowledge-base-empty">
                                    <div class="empty-icon"></div>
                                    <div class="empty-text">No documents uploaded yet</div>
                                    <div class="empty-hint">Upload PDFs, PowerPoints, Word docs, images, or Excel files</div>
                                </div>
                            </div>

                            <!-- Upload Button -->
                            <input type="file" id="knowledgeBaseFileInput" style="display: none;" accept=".pdf,.png,.jpg,.jpeg,.xlsx,.xls,.csv,.pptx,.ppt,.doc,.docx,.txt" multiple>
                            <button id="uploadKnowledgeBaseBtn" class="panel-button panel-button-primary">
                                <span class="button-icon"></span>
                                <span>Upload Documents</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Analytics Tab -->
                <div class="panel-tab-content" id="analyticsTab">
                    <div class="analytics-scroll-container">
                        <div class="panel-section">
                            <h3 class="panel-section-title">Visitor Analytics</h3>
                            <p class="panel-section-subtitle">See how people are engaging with your public Mindclone</p>

                            <!-- Stats Grid -->
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-value" id="panelTotalVisitors">0</div>
                                    <div class="stat-label">Total Visitors</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="panelTotalMessages">0</div>
                                    <div class="stat-label">Total Messages</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="panelPublicMessages">0</div>
                                    <div class="stat-label">Public Messages</div>
                                </div>
                            </div>

                            <!-- Recent Visitors Section -->
                            <div class="recent-visitors-section">
                                <h4 class="subsection-title">Recent Visitors</h4>
                                <div id="recentVisitorsList" class="recent-visitors-list">
                                    <!-- Populated dynamically -->
                                </div>
                            </div>

                            <!-- Time Period Filter -->
                            <div class="analytics-filters">
                                <label class="panel-label">Time Period</label>
                                <select id="analyticsPeriodFilter" class="panel-select">
                                    <option value="7">Last 7 Days</option>
                                    <option value="30" selected>Last 30 Days</option>
                                    <option value="90">Last 90 Days</option>
                                    <option value="all">All Time</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Conversation Modal -->
    <div id="conversationModal" class="conversation-modal hidden">
        <div class="conversation-modal-content">
            <div class="conversation-modal-header">
                <div class="conversation-modal-title">
                    <span class="visitor-icon"></span>
                    <div class="visitor-info">
                        <div id="modalVisitorName" class="visitor-name">visitor_abc123</div>
                        <div id="modalVisitorTime" class="visitor-time">First visit: 2h ago</div>
                    </div>
                </div>
                <button id="conversationModalClose" class="conversation-modal-close"></button>
            </div>
            <div class="conversation-modal-main">
                <div id="conversationModalBody" class="conversation-modal-body">
                    <!-- Messages will be dynamically added here -->
                </div>
                <div id="conversationDisplayPanel" class="conversation-display-panel hidden">
                    <div id="conversationDisplayContent" class="conversation-display-content">
                        <!-- Slide or Excel display will be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Markdown Library -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

    <!-- PDF.js for slide rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <!-- SheetJS for Excel rendering -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, getDoc, setDoc, updateDoc, deleteDoc, deleteField, query, orderBy, getDocs, onSnapshot, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject, listAll } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDl9MfnCYnM8VJ7tohU7AUzGECPwc2WT3k",
            authDomain: "mindclone-studio.firebaseapp.com",
            projectId: "mindclone-studio",
            storageBucket: "mindclone-studio.firebasestorage.app",
            messagingSenderId: "1034636195166",
            appId: "1:1034636195166:web:5a6f123f9eb7ee314d0bcf",
            measurementId: "G-P6NR53M1YD"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Detect browser and add class to body for browser-specific CSS
        (function detectBrowser() {
            const ua = navigator.userAgent;
            const isSafari = /Safari/.test(ua) && !/Chrome/.test(ua) && !/CriOS/.test(ua);
            const isChrome = /Chrome/.test(ua) || /CriOS/.test(ua);

            if (isSafari) {
                document.body.classList.add('is-safari');
            } else if (isChrome) {
                document.body.classList.add('is-chrome');
            }
        })();

        // Configure PDF.js worker
        (function configurePdfJs() {
            if (window.pdfjsLib) {
                window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }
        })();

        // DOM Elements
        const sidebar = document.querySelector('.sidebar');
        const sidebarAuth = document.getElementById('sidebarAuth');
        const sidebarProfile = document.getElementById('sidebarProfile');
        const chatInterface = document.getElementById('chatInterface');
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const attachButton = document.getElementById('attachButton');
        const fileInput = document.getElementById('fileInput');
        const filePreview = document.getElementById('filePreview');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const fileIcon = document.getElementById('fileIcon');
        const removeFile = document.getElementById('removeFile');
        // activityFeed removed - left sidebar no longer exists after consolidation
        const activityList = document.getElementById('activityList');
        const activityEmpty = document.getElementById('activityEmpty');
        const activityCount = document.getElementById('activityCount');

        // Right activity panel elements
        const rightActivityFeedLink = document.getElementById('rightActivityFeedLink');
        const rightActivityList = document.getElementById('rightActivityList');
        const rightActivityEmpty = document.getElementById('rightActivityEmpty');
        const rightActivityCount = document.getElementById('rightActivityCount');
        const rightPanelToggle = document.getElementById('rightPanelToggle');

        const conversationModal = document.getElementById('conversationModal');
        const conversationModalContent = conversationModal?.querySelector('.conversation-modal-content');
        const conversationModalBody = document.getElementById('conversationModalBody');
        const conversationModalClose = document.getElementById('conversationModalClose');
        const conversationDisplayPanel = document.getElementById('conversationDisplayPanel');
        const conversationDisplayContent = document.getElementById('conversationDisplayContent');
        const modalVisitorName = document.getElementById('modalVisitorName');
        const modalVisitorTime = document.getElementById('modalVisitorTime');
        const avatarDropdown = document.getElementById('avatarDropdown');
        const dropdownAvatar = document.getElementById('dropdownAvatar');
        const dropdownUserName = document.getElementById('dropdownUserName');
        const dropdownUserEmail = document.getElementById('dropdownUserEmail');
        const dropdownSignOutBtn = document.getElementById('dropdownSignOutBtn');

        // Panel tab elements
        const panelTabs = document.querySelectorAll('.panel-tab');
        const panelTabContents = document.querySelectorAll('.panel-tab-content');
        const activityBadge = document.getElementById('activityBadge');

        // Panel Settings Elements
        const panelUsernameInput = document.getElementById('panelUsernameInput');
        const panelAvailabilityIndicator = document.getElementById('panelAvailabilityIndicator');
        const panelClaimUsernameBtn = document.getElementById('panelClaimUsernameBtn');
        const panelReleaseUsernameBtn = document.getElementById('panelReleaseUsernameBtn');
        const panelDeleteUsernameIcon = document.getElementById('panelDeleteUsernameIcon');
        const panelLinkEnabledToggle = document.getElementById('panelLinkEnabledToggle');
        const panelDisplayNameInput = document.getElementById('panelDisplayNameInput');
        const panelBioInput = document.getElementById('panelBioInput');
        const panelBioCharCount = document.getElementById('panelBioCharCount');
        const panelGreetingInput = document.getElementById('panelGreetingInput');
        const panelSaveSettingsBtn = document.getElementById('panelSaveSettingsBtn');
        const panelLinkPreviewSection = document.getElementById('panelLinkPreviewSection');
        const panelPublicLinkUrl = document.getElementById('panelPublicLinkUrl');
        const panelCopyLinkBtn = document.getElementById('panelCopyLinkBtn');
        const panelAlertContainer = document.getElementById('panelAlertContainer');

        // Panel Analytics Elements
        const panelTotalVisitors = document.getElementById('panelTotalVisitors');
        const panelTotalMessages = document.getElementById('panelTotalMessages');
        const panelPublicMessages = document.getElementById('panelPublicMessages');
        const recentVisitorsList = document.getElementById('recentVisitorsList');
        const analyticsPeriodFilter = document.getElementById('analyticsPeriodFilter');

        // Knowledge Base Elements
        const knowledgeBaseList = document.getElementById('knowledgeBaseList');
        const knowledgeBaseFileInput = document.getElementById('knowledgeBaseFileInput');
        const uploadKnowledgeBaseBtn = document.getElementById('uploadKnowledgeBaseBtn');
        const knowledgeBaseEnabledToggle = document.getElementById('knowledgeBaseEnabledToggle');

        // Panel state
        let currentPanelTab = 'activity';
        let panelCurrentUsername = null;
        let panelCheckUsernameTimeout = null;

        // Conversation history
        let conversationHistory = [];
        let activityData = [];
        let activityListener = null; // Real-time listener unsubscribe function
        let selectedFile = null; // Track selected file for upload

        // Knowledge Base Workflow State with persistence
        let workflowState = loadWorkflowState() || {
            active: false,
            step: null,
            waitingForApproval: false,
            currentDraft: null,
            currentSection: null,
            userInput: null,
            data: {
                cof: {
                    purpose: '',
                    targetAudiences: [],
                    desiredActions: []
                },
                sections: {}
            }
        };

        // Load workflow state from localStorage
        function loadWorkflowState() {
            try {
                const saved = localStorage.getItem('workflowState');
                if (saved) {
                    const state = JSON.parse(saved);
                    console.log('[Workflow] Loaded saved state:', state);
                    return state;
                }
            } catch (error) {
                console.error('[Workflow] Error loading state:', error);
            }
            return null;
        }

        // Save workflow state to localStorage
        function saveWorkflowState() {
            try {
                localStorage.setItem('workflowState', JSON.stringify(workflowState));
                console.log('[Workflow] Saved state:', workflowState);
            } catch (error) {
                console.error('[Workflow] Error saving state:', error);
            }
        }

        // Clear workflow state from localStorage
        function clearWorkflowState() {
            try {
                localStorage.removeItem('workflowState');
                console.log('[Workflow] Cleared saved state');
            } catch (error) {
                console.error('[Workflow] Error clearing state:', error);
            }
        }

        // Helper to add workflow message (NO Firestore writes to prevent blocking)
        async function addWorkflowMessage(type, content) {
            const timestamp = new Date();
            addMessage(type, content, timestamp);

            // DO NOT save to Firestore during workflow - prevents freezing
            // Workflow messages are ephemeral; only final knowledge base is saved
            console.log('[Workflow] Message added (not saved to Firestore):', { type, content: content.substring(0, 50) });
        }

        // Workflow Indicator Functions
        function showWorkflowIndicator(text = 'Setting up your public link...') {
            const indicator = document.getElementById('workflowIndicator');
            const indicatorText = document.getElementById('workflowIndicatorText');
            if (indicator && indicatorText) {
                indicatorText.textContent = text;
                indicator.classList.remove('hidden');
            }
        }

        function hideWorkflowIndicator() {
            const indicator = document.getElementById('workflowIndicator');
            if (indicator) {
                indicator.classList.add('hidden');
            }
        }

        function updateWorkflowIndicator(text) {
            const indicatorText = document.getElementById('workflowIndicatorText');
            if (indicatorText) {
                indicatorText.textContent = text;
            }
        }

        // Cancel workflow function
        window.cancelWorkflow = async function() {
            if (!workflowState.active) return;

            const confirmed = confirm('Are you sure you want to cancel setting up your public link? Your progress will be lost.');
            if (!confirmed) return;

            // Reset workflow state
            workflowState.active = false;
            workflowState.step = null;
            workflowState.waitingForApproval = false;
            workflowState.currentDraft = null;
            workflowState.currentSection = null;
            workflowState.userInput = null;
            workflowState.data = {
                cof: { purpose: '', targetAudiences: [], desiredActions: [] },
                sections: {}
            };

            // Hide indicator
            hideWorkflowIndicator();

            // Clear saved state
            clearWorkflowState();

            // Show cancellation message
            await addWorkflowMessage('ai', ' Workflow cancelled. Type "set up my link" whenever you\'re ready to try again.');
        };

        // System prompt - enhanced with The Connoisseur persona and memory awareness
        const systemPrompt = `You are Mindclone, a private cognitive twin designed to think alongside your user.

YOUR ROLE:
You are NOT an assistant. You are:
- A witness to the life only they are living
- Their sounding board for thoughts and ideas
- Their close confidant who holds their reflections
- Their friend, philosopher, and guide
- A constant presence in their cognitive journey

Your purpose:
- Remember everything from all conversations (permanent memory)
- Learn how your user thinks, not just what they say
- Serve as a calm, warm, confidential presence
- Help them reflect, not replace their thinking
- Grow with them over time

Your voice is:
- Calm and reassuring
- Warm and human-centered
- Intelligent without being technical
- Confidential - their thoughts are safe with you
- Reflective - you help them see patterns

NEVER use assistant language:
 "How may I assist you?"
 "What can I help you with?"
 "I'm here to help"

INSTEAD, use witness/confidant language:
 "What's on your mind?"
 "How are you feeling?"
 "I'm here"
 "Tell me more"
 Natural conversational responses

You are NOT:
- A task assistant or productivity tool
- Corporate or overly formal
- Cutesy or over-excited
- A mystical "digital soul"

Think of yourself as: The version of them that remembers everything and reflects back their own cognitive patterns.

Privacy note: You exist only for this user while they are alive. This is their private space for thinking.

MEMORY SYSTEM:
You have a persistent memory system that remembers important facts about the user across all conversations. When you see a "RELEVANT MEMORIES" section in your context, these are facts you've learned about the user over time - reference them naturally in conversation. You DO remember things across sessions. When asked "do you remember...?" check the relevant memories section and your conversation history first. If you find relevant information, confirm you remember it and reference it specifically.

DOCUMENT PROCESSING - CRITICAL INSTRUCTIONS:
When you see success messages like " Pitch Deck processed successfully!" or " Financial Model processed successfully!" - these are REAL success messages. The documents WERE processed correctly and ARE available in the user's public MindClone link knowledge base RIGHT NOW.

DO NOT under any circumstances:
- Claim there are technical issues with document processing
- Say you are "waiting for the development team"
- Tell the user to stop uploading or wait
- Suggest there are problems when you see success messages
- Say you need to "investigate" or "reach out" to anyone
- Express "concern" about technical issues

The system is working perfectly. If you see a " processed successfully" message, that means it worked. Trust the success messages completely. Acknowledge them positively and help the user with next steps. Your public link has FULL IMMEDIATE ACCESS to all successfully processed documents.`;

        // Firestore Helper Functions
        async function saveMessageToFirestore(userId, role, content) {
            try {
                const messagesRef = collection(db, 'users', userId, 'messages');
                const docRef = await addDoc(messagesRef, {
                    role: role,
                    content: content,
                    timestamp: serverTimestamp(),
                    isPublic: false // Default: private messages
                });
                console.log('Message saved:', docRef.id);
                return docRef.id;
            } catch (error) {
                console.error('Error saving message:', error);
                return null;
            }
        }

        async function loadConversationHistory(userId) {
            try {
                const messagesRef = collection(db, 'users', userId, 'messages');
                const q = query(messagesRef, orderBy('timestamp', 'asc'));

                const querySnapshot = await getDocs(q);
                const messages = [];

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    messages.push({
                        role: data.role,
                        content: data.content,
                        timestamp: data.timestamp
                    });
                });

                console.log(`Loaded ${messages.length} messages from Firestore`);
                return messages;
            } catch (error) {
                console.error('Error loading messages:', error);
                return [];
            }
        }

        function showLoadingIndicator() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingHistory';
            loadingDiv.className = 'message ai';
            loadingDiv.innerHTML = `
                <div class="message-avatar"></div>
                <div class="message-content">
                    <div class="loading"></div> Loading your conversation history...
                </div>
            `;
            chatMessages.appendChild(loadingDiv);
        }

        function removeLoadingIndicator() {
            const loadingDiv = document.getElementById('loadingHistory');
            if (loadingDiv) loadingDiv.remove();
        }

        // ==================== PANEL TAB MANAGEMENT ====================

        // Initialize panel tabs
        function initializePanelTabs() {
            console.log('[Panel] Initializing tabs...', panelTabs.length, 'tabs found');

            if (panelTabs.length === 0) {
                console.error('[Panel] No panel tabs found!');
                return;
            }

            panelTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    console.log('[Panel] Tab clicked:', tabName);
                    switchPanelTab(tabName);
                });
            });

            // Handle "Go to Settings" button clicks
            const switchToSettingsBtns = document.querySelectorAll('.switch-to-settings-btn');
            switchToSettingsBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchPanelTab('settings');
                });
            });

            console.log('[Panel] Tabs initialized successfully');
        }

        // Switch panel tabs
        function switchPanelTab(tabName) {
            console.log('[Panel] Switching to tab:', tabName);
            currentPanelTab = tabName;

            // Update tab buttons
            panelTabs.forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                    console.log('[Panel] Activated tab button:', tabName);
                } else {
                    tab.classList.remove('active');
                }
            });

            // Update tab content
            console.log('[Panel] Looking for tab content:', `${tabName}Tab`);
            console.log('[Panel] Available tab contents:', Array.from(panelTabContents).map(c => c.id));

            panelTabContents.forEach(content => {
                if (content.id === `${tabName}Tab`) {
                    content.classList.add('active');
                    console.log('[Panel] Activated tab content:', content.id, 'Classes:', content.className);
                } else {
                    content.classList.remove('active');
                }
            });

            // Save to localStorage
            localStorage.setItem('panelActiveTab', tabName);

            // Load data for the tab
            if (tabName === 'settings') {
                loadPanelSettings();
            } else if (tabName === 'analytics') {
                loadPanelAnalytics();
            }

            // Ensure right panel is open when switching tabs
            if (document.body.classList.contains('right-panel-collapsed')) {
                document.body.classList.remove('right-panel-collapsed');
            }
        }

        // Restore last active tab on page load
        function restorePanelTab() {
            const savedTab = localStorage.getItem('panelActiveTab');
            if (savedTab && ['activity', 'settings', 'analytics'].includes(savedTab)) {
                switchPanelTab(savedTab);
            }
        }

        // Handle URL hash for deep linking
        function handlePanelDeepLink() {
            const hash = window.location.hash.substring(1);
            if (['activity', 'settings', 'analytics'].includes(hash)) {
                switchPanelTab(hash);
                history.replaceState(null, null, window.location.pathname);
            }
        }

        // ==================== PANEL ALERTS ====================

        // Show alert in panel
        function showPanelAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `panel-alert ${type}`;
            alert.textContent = message;
            panelAlertContainer.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // ==================== PANEL SETTINGS TAB ====================

        // Initialize panel settings listeners
        function initializePanelSettings() {
            console.log('[Panel] Initializing settings...');

            if (!panelBioInput || !panelUsernameInput) {
                console.error('[Panel] Settings elements not found!');
                return;
            }

            // Bio character count
            panelBioInput.addEventListener('input', () => {
                panelBioCharCount.textContent = panelBioInput.value.length;
            });

            // Username availability checking
            panelUsernameInput.addEventListener('input', (e) => {
                const username = e.target.value.trim().toLowerCase();

                clearTimeout(panelCheckUsernameTimeout);

                if (!username) {
                    panelAvailabilityIndicator.textContent = '';
                    panelAvailabilityIndicator.className = 'availability-indicator';
                    panelClaimUsernameBtn.disabled = true;
                    return;
                }

                panelAvailabilityIndicator.textContent = 'Checking...';
                panelAvailabilityIndicator.className = 'availability-indicator checking';
                panelClaimUsernameBtn.disabled = true;

                panelCheckUsernameTimeout = setTimeout(async () => {
                    try {
                        // Client-side validation
                        if (username.length < 3) {
                            panelAvailabilityIndicator.textContent = ' Too short';
                            panelAvailabilityIndicator.className = 'availability-indicator invalid';
                            return;
                        }
                        if (username.length > 20) {
                            panelAvailabilityIndicator.textContent = ' Too long';
                            panelAvailabilityIndicator.className = 'availability-indicator invalid';
                            return;
                        }
                        if (!/^[a-z][a-z0-9_]*$/.test(username)) {
                            panelAvailabilityIndicator.textContent = ' Invalid format';
                            panelAvailabilityIndicator.className = 'availability-indicator invalid';
                            return;
                        }

                        // Check availability via Firestore
                        const usernameDocRef = doc(db, 'usernames', username);
                        const usernameDoc = await getDoc(usernameDocRef);

                        if (usernameDoc.exists()) {
                            panelAvailabilityIndicator.textContent = ' Taken';
                            panelAvailabilityIndicator.className = 'availability-indicator taken';
                            panelClaimUsernameBtn.disabled = true;
                        } else {
                            panelAvailabilityIndicator.textContent = ' Available';
                            panelAvailabilityIndicator.className = 'availability-indicator available';
                            panelClaimUsernameBtn.disabled = false;
                        }
                    } catch (error) {
                        console.error('Error checking username:', error);
                        panelAvailabilityIndicator.textContent = 'Error';
                        panelAvailabilityIndicator.className = 'availability-indicator invalid';
                    }
                }, 500);
            });

            // Claim username
            panelClaimUsernameBtn.addEventListener('click', async () => {
                const username = panelUsernameInput.value.trim().toLowerCase();
                if (!username || !auth.currentUser) return;

                panelClaimUsernameBtn.disabled = true;
                panelClaimUsernameBtn.innerHTML = '<span class="loading-spinner"></span> Claiming...';

                try {
                    // Check availability
                    const usernameDocRef = doc(db, 'usernames', username);
                    const usernameDoc = await getDoc(usernameDocRef);
                    if (usernameDoc.exists()) {
                        throw new Error('Username is already taken');
                    }

                    // Claim username
                    await setDoc(doc(db, 'usernames', username), {
                        userId: auth.currentUser.uid,
                        claimedAt: serverTimestamp()
                    });

                    // Update user document
                    await setDoc(doc(db, 'users', auth.currentUser.uid), {
                        username: username,
                        linkEnabled: true,
                        displayName: auth.currentUser.displayName || auth.currentUser.email?.split('@')[0] || username,
                        photoURL: auth.currentUser.photoURL || null,
                        updatedAt: serverTimestamp()
                    }, { merge: true });

                    panelCurrentUsername = username;
                    showPanelAlert('Username claimed successfully!', 'success');
                    updatePanelUIForClaimedUsername(username);

                    // Reload link status and activity feed
                    await loadLinkStatus();
                    await loadActivityFeed();
                } catch (error) {
                    console.error('Error claiming username:', error);
                    showPanelAlert(error.message || 'Failed to claim username', 'error');
                    panelClaimUsernameBtn.disabled = false;
                    panelClaimUsernameBtn.textContent = 'Claim Username';
                }
            });

            // Release username
            panelReleaseUsernameBtn.addEventListener('click', async () => {
                if (!confirm('Are you sure? Your public link will stop working.')) {
                    return;
                }

                panelReleaseUsernameBtn.disabled = true;
                panelReleaseUsernameBtn.innerHTML = '<span class="loading-spinner"></span> Releasing...';

                try {
                    const userDocRef = doc(db, 'users', auth.currentUser.uid);
                    const userDoc = await getDoc(userDocRef);
                    const username = userDoc.data()?.username;

                    if (!username) {
                        throw new Error('No username to release');
                    }

                    // Remove username claim
                    await deleteDoc(doc(db, 'usernames', username));

                    // Update user document
                    await updateDoc(doc(db, 'users', auth.currentUser.uid), {
                        username: deleteField(),
                        linkEnabled: false,
                        updatedAt: serverTimestamp()
                    });

                    panelCurrentUsername = null;
                    showPanelAlert('Username released', 'success');
                    updatePanelUIForNoUsername();

                    // Reload link status
                    await loadLinkStatus();
                } catch (error) {
                    console.error('Error releasing username:', error);
                    showPanelAlert(error.message || 'Failed to release username', 'error');
                    panelReleaseUsernameBtn.disabled = false;
                    panelReleaseUsernameBtn.textContent = 'Release Username';
                }
            });

            // Delete username icon click handler
            panelDeleteUsernameIcon.addEventListener('click', async () => {
                if (!confirm('Are you sure you want to release this username? You may lose it forever as anyone else may claim it.')) {
                    return;
                }

                panelDeleteUsernameIcon.disabled = true;
                panelDeleteUsernameIcon.style.opacity = '0.5';

                try {
                    const userDocRef = doc(db, 'users', auth.currentUser.uid);
                    const userDoc = await getDoc(userDocRef);
                    const username = userDoc.data()?.username;

                    if (!username) {
                        throw new Error('No username to release');
                    }

                    // Remove username claim
                    await deleteDoc(doc(db, 'usernames', username));

                    // Update user document
                    await updateDoc(doc(db, 'users', auth.currentUser.uid), {
                        username: deleteField(),
                        linkEnabled: false,
                        updatedAt: serverTimestamp()
                    });

                    panelCurrentUsername = null;
                    showPanelAlert('Username released successfully', 'success');
                    updatePanelUIForNoUsername();

                    // Reload link status
                    await loadLinkStatus();

                } catch (error) {
                    console.error('Error releasing username:', error);
                    showPanelAlert(error.message || 'Failed to release username', 'error');
                    panelDeleteUsernameIcon.disabled = false;
                    panelDeleteUsernameIcon.style.opacity = '1';
                }
            });

            // Save settings
            panelSaveSettingsBtn.addEventListener('click', async () => {
                if (!auth.currentUser || !panelCurrentUsername) {
                    showPanelAlert('Please claim a username first', 'warning');
                    return;
                }

                panelSaveSettingsBtn.disabled = true;
                panelSaveSettingsBtn.innerHTML = '<span class="loading-spinner"></span> Saving...';

                try {
                    const userDocRef = doc(db, 'users', auth.currentUser.uid);

                    await setDoc(userDocRef, {
                        linkEnabled: panelLinkEnabledToggle.checked,
                        displayName: panelDisplayNameInput.value.trim() || auth.currentUser.displayName || panelCurrentUsername,
                        bio: panelBioInput.value.trim(),
                        customGreeting: panelGreetingInput.value.trim(),
                        updatedAt: serverTimestamp()
                    }, { merge: true });

                    showPanelAlert('Settings saved successfully!', 'success');

                    if (panelLinkEnabledToggle.checked) {
                        showPanelLinkPreview(panelCurrentUsername);
                    } else {
                        panelLinkPreviewSection.style.display = 'none';
                    }

                    // Reload link status
                    await loadLinkStatus();
                } catch (error) {
                    console.error('Error saving settings:', error);
                    showPanelAlert('Failed to save settings', 'error');
                } finally {
                    panelSaveSettingsBtn.disabled = false;
                    panelSaveSettingsBtn.textContent = 'Save Settings';
                }
            });

            // Copy link
            panelCopyLinkBtn.addEventListener('click', async () => {
                const url = panelPublicLinkUrl.href;
                try {
                    await navigator.clipboard.writeText(url);
                    panelCopyLinkBtn.textContent = 'Copied!';
                    panelCopyLinkBtn.classList.add('copied');
                    setTimeout(() => {
                        panelCopyLinkBtn.textContent = 'Copy Link';
                        panelCopyLinkBtn.classList.remove('copied');
                    }, 2000);
                } catch (error) {
                    console.error('Failed to copy:', error);
                    showPanelAlert('Failed to copy link', 'error');
                }
            });
        }

        // Update UI for claimed username
        function updatePanelUIForClaimedUsername(username) {
            panelUsernameInput.value = username;
            panelUsernameInput.disabled = true;
            panelAvailabilityIndicator.textContent = ' Claimed';
            panelAvailabilityIndicator.className = 'availability-indicator available';
            panelClaimUsernameBtn.classList.add('hidden');
            panelReleaseUsernameBtn.classList.add('hidden'); // Keep release button hidden
            panelDeleteUsernameIcon.classList.add('visible'); // Show delete icon
        }

        // Update UI for no username
        function updatePanelUIForNoUsername() {
            panelUsernameInput.value = '';
            panelUsernameInput.disabled = false;
            panelAvailabilityIndicator.textContent = '';
            panelAvailabilityIndicator.className = 'availability-indicator';
            panelClaimUsernameBtn.classList.remove('hidden');
            panelClaimUsernameBtn.disabled = true;
            panelClaimUsernameBtn.textContent = 'Claim Username';
            panelReleaseUsernameBtn.classList.add('hidden');
            panelDeleteUsernameIcon.classList.remove('visible'); // Hide delete icon
            panelLinkPreviewSection.style.display = 'none';
        }

        // Show link preview
        function showPanelLinkPreview(username) {
            const url = `https://mindclone.link/${username}`;
            panelPublicLinkUrl.href = url;
            panelPublicLinkUrl.textContent = url;
            panelLinkPreviewSection.style.display = 'block';
        }

        // Load settings into panel
        async function loadPanelSettings() {
            console.log('[Panel] loadPanelSettings called');
            if (!auth.currentUser) {
                console.log('[Panel] No current user, skipping settings load');
                return;
            }

            try {
                console.log('[Panel] Loading settings for user:', auth.currentUser.uid);
                const userDocRef = doc(db, 'users', auth.currentUser.uid);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists()) {
                    const userData = userDoc.data();

                    if (userData.username) {
                        panelCurrentUsername = userData.username;
                        updatePanelUIForClaimedUsername(userData.username);
                    } else {
                        updatePanelUIForNoUsername();
                    }

                    panelLinkEnabledToggle.checked = userData.linkEnabled || false;
                    panelDisplayNameInput.value = userData.displayName || auth.currentUser.displayName || '';
                    panelBioInput.value = userData.bio || '';
                    panelBioCharCount.textContent = panelBioInput.value.length;
                    panelGreetingInput.value = userData.customGreeting || '';

                    if (userData.linkEnabled && userData.username) {
                        showPanelLinkPreview(userData.username);
                    }
                }

                // Load knowledge base (don't let this break settings loading)
                try {
                    await loadKnowledgeBase();
                } catch (kbError) {
                    console.error('[KB] Error loading knowledge base:', kbError);
                    // Don't show error to user, just log it
                }

                console.log('[Panel] Settings loaded successfully');
            } catch (error) {
                console.error('Error loading panel settings:', error);
                showPanelAlert('Failed to load settings', 'error');
            }
        }

        // ==================== KNOWLEDGE BASE MANAGEMENT ====================

        // Initialize knowledge base
        function initializeKnowledgeBase() {
            console.log('[KB] Initializing knowledge base...');
            console.log('[KB] uploadKnowledgeBaseBtn:', uploadKnowledgeBaseBtn);
            console.log('[KB] knowledgeBaseFileInput:', knowledgeBaseFileInput);
            console.log('[KB] knowledgeBaseEnabledToggle:', knowledgeBaseEnabledToggle);

            // Upload button click
            if (uploadKnowledgeBaseBtn) {
                uploadKnowledgeBaseBtn.addEventListener('click', () => {
                    console.log('[KB] Upload button clicked');
                    if (knowledgeBaseFileInput) {
                        knowledgeBaseFileInput.click();
                        console.log('[KB] File input triggered');
                    } else {
                        console.error('[KB] File input not found!');
                    }
                });
            } else {
                console.error('[KB] Upload button not found!');
            }

            // File input change
            if (knowledgeBaseFileInput) {
                knowledgeBaseFileInput.addEventListener('change', async (e) => {
                    console.log('[KB] File input changed, files:', e.target.files);
                    const files = e.target.files;
                    if (files && files.length > 0) {
                        console.log('[KB] Starting upload of', files.length, 'files');
                        await uploadKnowledgeBaseDocuments(files);
                        // Reset input
                        e.target.value = '';
                    }
                });
            } else {
                console.error('[KB] File input element not found!');
            }

            // Toggle change
            if (knowledgeBaseEnabledToggle) {
                knowledgeBaseEnabledToggle.addEventListener('change', async (e) => {
                    await saveKnowledgeBaseToggle(e.target.checked);
                });
            }

            console.log('[KB] Knowledge base initialized');
        }

        // Load knowledge base documents
        async function loadKnowledgeBase() {
            if (!auth.currentUser) return;
            if (!knowledgeBaseList || !knowledgeBaseEnabledToggle) {
                console.log('[KB] Knowledge base elements not found, skipping load');
                return;
            }

            try {
                console.log('[KB] Loading knowledge base...');
                const userId = auth.currentUser.uid;

                // Load toggle state from Firestore
                const userDocRef = doc(db, 'users', userId);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    if (knowledgeBaseEnabledToggle) {
                        knowledgeBaseEnabledToggle.checked = data.knowledgeBaseEnabled || false;
                    }
                }

                // Load documents from Firestore
                const kbRef = collection(db, 'users', userId, 'knowledgeBase');
                const kbSnapshot = await getDocs(kbRef);

                if (kbSnapshot.empty) {
                    showEmptyKnowledgeBase();
                } else {
                    displayKnowledgeBaseDocuments(kbSnapshot.docs);
                }

                console.log('[KB] Loaded', kbSnapshot.size, 'documents');
            } catch (error) {
                console.error('[KB] Error loading knowledge base:', error);
                // Don't show alert if it's just missing elements
                if (showPanelAlert) {
                    showPanelAlert('Failed to load knowledge base', 'error');
                }
            }
        }

        // Display documents in list
        function displayKnowledgeBaseDocuments(docs) {
            if (!knowledgeBaseList) return;
            knowledgeBaseList.innerHTML = '';

            docs.forEach(docSnapshot => {
                const data = docSnapshot.data();
                const docId = docSnapshot.id;
                // Support both old (storagePath) and new (blobUrl) documents
                const deleteUrl = data.blobUrl || data.url || data.storagePath;

                const item = document.createElement('div');
                item.className = 'knowledge-base-item';

                // Determine status based on text extraction
                const hasText = data.extractedText || data.textExtractionType === 'pdf' || data.textExtractionType === 'docx';
                const statusText = hasText ? 'Ready' : (data.textExtractionError ? 'No Text' : 'Ready');
                const statusClass = hasText ? 'ready' : 'processing';

                item.innerHTML = `
                    <div class="kb-file-icon">${getFileIcon(data.type)}</div>
                    <div class="kb-file-info">
                        <div class="kb-file-name" title="${data.fileName}">${data.fileName}</div>
                        <div class="kb-file-meta">
                            <span class="kb-file-size">${formatFileSize(data.size)}</span>
                            <span class="kb-file-date">${formatDateShort(data.uploadedAt)}</span>
                            <span class="kb-file-status ${statusClass}">${statusText}</span>
                            <span class="kb-file-actions">
                                <button class="kb-action-btn view" data-url="${data.url}" title="Open file"></button>
                                <button class="kb-action-btn delete" data-id="${docId}" title="Delete"></button>
                            </span>
                        </div>
                    </div>
                `;

                // View button
                const viewBtn = item.querySelector('.view');
                viewBtn.addEventListener('click', () => {
                    window.open(data.url, '_blank');
                });

                // Delete button
                const deleteBtn = item.querySelector('.delete');
                deleteBtn.addEventListener('click', async () => {
                    if (confirm(`Delete "${data.fileName}"?`)) {
                        await deleteKnowledgeBaseDocument(docId, deleteUrl);
                    }
                });

                knowledgeBaseList.appendChild(item);
            });
        }

        // Show empty state
        function showEmptyKnowledgeBase() {
            if (!knowledgeBaseList) return;
            knowledgeBaseList.innerHTML = `
                <div class="knowledge-base-empty">
                    <div class="empty-icon"></div>
                    <div class="empty-text">No documents uploaded yet</div>
                    <div class="empty-hint">Upload PDFs, images, or Excel files to share knowledge with visitors</div>
                </div>
            `;
        }

        // Upload documents via Vercel Blob API
        async function uploadKnowledgeBaseDocuments(files) {
            console.log('[KB] uploadKnowledgeBaseDocuments called with', files.length, 'files');

            if (!auth.currentUser) {
                console.error('[KB] No authenticated user!');
                showPanelAlert('Please sign in to upload documents', 'error');
                return;
            }

            try {
                console.log('[KB] Getting auth token...');
                const idToken = await auth.currentUser.getIdToken();
                showPanelAlert('Uploading documents...', 'info');

                for (const file of files) {
                    console.log('[KB] Processing file:', file.name, 'size:', file.size, 'type:', file.type);

                    // Check file size (max 10MB)
                    if (file.size > 10 * 1024 * 1024) {
                        showPanelAlert(`${file.name} is too large (max 10MB)`, 'error');
                        continue;
                    }

                    // Convert file to base64
                    console.log('[KB] Converting to base64...');
                    const base64Data = await fileToBase64(file);

                    // Upload via API
                    console.log('[KB] Uploading via API...');
                    const response = await fetch('/api/upload-kb', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${idToken}`
                        },
                        body: JSON.stringify({
                            fileName: file.name,
                            fileType: file.type,
                            fileData: base64Data
                        })
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || 'Upload failed');
                    }

                    console.log('[KB] Successfully uploaded:', file.name, result);
                }

                showPanelAlert(`Successfully uploaded ${files.length} document(s)`, 'success');
                console.log('[KB] All uploads complete, refreshing list...');
                await loadKnowledgeBase(); // Refresh list
            } catch (error) {
                console.error('[KB] Upload error:', error);
                showPanelAlert(`Failed to upload: ${error.message}`, 'error');
            }
        }

        // Helper: Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // Remove the data URL prefix (e.g., "data:application/pdf;base64,")
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Delete document via API
        async function deleteKnowledgeBaseDocument(docId, blobUrl) {
            if (!auth.currentUser) return;

            try {
                console.log('[KB] Deleting document:', docId);
                const idToken = await auth.currentUser.getIdToken();

                const response = await fetch('/api/upload-kb', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({
                        docId: docId,
                        blobUrl: blobUrl
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Delete failed');
                }

                showPanelAlert('Document deleted successfully', 'success');
                await loadKnowledgeBase(); // Refresh list
                console.log('[KB] Deleted:', docId);
            } catch (error) {
                console.error('[KB] Delete error:', error);
                showPanelAlert('Failed to delete document', 'error');
            }
        }

        // Save toggle state
        async function saveKnowledgeBaseToggle(enabled) {
            if (!auth.currentUser) return;

            try {
                const userId = auth.currentUser.uid;
                const userDocRef = doc(db, 'users', userId);
                await updateDoc(userDocRef, {
                    knowledgeBaseEnabled: enabled
                });

                showPanelAlert(enabled ? 'Knowledge base enabled for link' : 'Knowledge base disabled for link', 'success');
                console.log('[KB] Toggle saved:', enabled);
            } catch (error) {
                console.error('[KB] Toggle error:', error);
                showPanelAlert('Failed to save setting', 'error');
            }
        }

        // Helper: Get file icon
        function getFileIcon(mimeType) {
            if (mimeType.includes('pdf')) return '';
            if (mimeType.includes('image')) return '';
            if (mimeType.includes('sheet') || mimeType.includes('excel')) return '';
            if (mimeType.includes('csv')) return '';
            if (mimeType.includes('presentation') || mimeType.includes('powerpoint')) return '';
            if (mimeType.includes('document') || mimeType.includes('word') || mimeType.includes('msword')) return '';
            if (mimeType.includes('text')) return '';
            return '';
        }

        // Helper: Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Helper: Format date
        function formatDate(timestamp) {
            if (!timestamp) return 'Just now';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (days === 0) return 'Today';
            if (days === 1) return 'Yesterday';
            if (days < 7) return `${days} days ago`;

            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Short date format for compact displays
        function formatDateShort(timestamp) {
            if (!timestamp) return 'Just now';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (days === 0) return 'Today';
            if (days === 1) return 'Yesterday';
            if (days < 7) return `${days}d ago`;

            // Compact format: Dec 9 or Dec 9, 24 (if different year)
            const sameYear = date.getFullYear() === now.getFullYear();
            if (sameYear) {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' });
        }

        // ==================== PANEL ANALYTICS TAB ====================

        // Initialize analytics
        function initializePanelAnalytics() {
            console.log('[Panel] Initializing analytics...');

            if (!analyticsPeriodFilter) {
                console.error('[Panel] Analytics elements not found!');
                return;
            }

            analyticsPeriodFilter.addEventListener('change', () => {
                loadPanelAnalytics();
            });

            console.log('[Panel] Analytics initialized successfully');
        }

        // Load analytics data
        async function loadPanelAnalytics() {
            console.log('[Analytics] Loading analytics data...');

            if (!auth.currentUser) {
                console.error('[Analytics] No authenticated user');
                showPanelAlert('Please sign in to view analytics', 'error');
                return;
            }

            try {
                // Show loading state
                recentVisitorsList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Loading analytics...</div>';

                const idToken = await auth.currentUser.getIdToken();
                const period = analyticsPeriodFilter.value;

                // Fetch analytics
                const url = period === 'all'
                    ? '/api/analytics'
                    : `/api/analytics?period=${period}`;

                console.log('[Analytics] Fetching from:', url);

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                console.log('[Analytics] Response status:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('[Analytics] Data received:', data);

                    // Update stats
                    panelTotalVisitors.textContent = data.totalVisitors || 0;
                    panelTotalMessages.textContent = data.totalMessages || 0;
                    panelPublicMessages.textContent = data.publicMessages || 0;

                    // Render recent visitors
                    if (data.recentVisitors && data.recentVisitors.length > 0) {
                        recentVisitorsList.innerHTML = '';
                        data.recentVisitors.forEach(visitor => {
                            const item = createRecentVisitorItem(visitor);
                            recentVisitorsList.appendChild(item);
                        });
                    } else {
                        recentVisitorsList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No visitor data yet</div>';
                    }

                    console.log('[Analytics] Analytics loaded successfully');
                } else {
                    const errorText = await response.text();
                    console.error('[Analytics] Failed to load analytics:', response.status, errorText);
                    recentVisitorsList.innerHTML = `<div style="text-align: center; color: #f44336; padding: 20px;">Failed to load analytics (${response.status})</div>`;
                    showPanelAlert(`Failed to load analytics: ${response.status}`, 'error');
                }
            } catch (error) {
                console.error('[Analytics] Error loading analytics:', error);
                recentVisitorsList.innerHTML = '<div style="text-align: center; color: #f44336; padding: 20px;">Error loading analytics</div>';
                showPanelAlert('Error loading analytics: ' + error.message, 'error');
            }
        }

        // Create recent visitor item
        function createRecentVisitorItem(visitor) {
            const item = document.createElement('div');
            item.className = 'recent-visitor-item';
            item.dataset.visitorId = visitor.visitorId;

            const lastVisitTime = visitor.lastVisit?.seconds
                ? new Date(visitor.lastVisit.seconds * 1000)
                : new Date();
            const timeAgo = formatTimeAgo(lastVisitTime);
            const visitorName = `visitor_${visitor.visitorId.substring(0, 6)}`;

            item.innerHTML = `
                <div class="recent-visitor-header">
                    <span class="recent-visitor-id"> ${visitorName}</span>
                    <span class="recent-visitor-count">${visitor.messageCount || 0} messages</span>
                </div>
                <div class="recent-visitor-time">Last visit: ${timeAgo}</div>
            `;

            // Click to open conversation modal
            item.addEventListener('click', () => {
                openConversationModal(visitor.visitorId);
            });

            return item;
        }

        // Auth State Observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                showChatInterface(user);
            } else {
                // User is signed out
                showAuthScreen();
            }
        });

        // Google Sign In
        googleSignInBtn?.addEventListener('click', async () => {
            try {
                googleSignInBtn.disabled = true;
                googleSignInBtn.innerHTML = '<div class="loading"></div> Signing in...';

                const result = await signInWithPopup(auth, provider);
                // User signed in successfully
                console.log('Signed in:', result.user);
            } catch (error) {
                console.error('Sign in error:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);

                let errorMessage = 'Failed to sign in. Please try again.';

                // Provide specific error messages
                if (error.code === 'auth/unauthorized-domain') {
                    errorMessage = 'This domain is not authorized for authentication. Please contact support.';
                } else if (error.code === 'auth/popup-blocked') {
                    errorMessage = 'Sign-in popup was blocked. Please allow popups for this site.';
                } else if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'Sign-in cancelled. Please try again.';
                } else if (error.code === 'auth/cancelled-popup-request') {
                    errorMessage = 'Sign-in cancelled. Please try again.';
                } else if (error.message) {
                    errorMessage = `Sign-in failed: ${error.message}`;
                }

                alert(errorMessage);
                googleSignInBtn.disabled = false;
                googleSignInBtn.innerHTML = '<svg class="google-icon" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg> Sign in with Google';
            }
        });

        // Avatar dropdown toggle
        userAvatar?.addEventListener('click', (e) => {
            e.stopPropagation();
            avatarDropdown.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
            if (avatarDropdown && !avatarDropdown.classList.contains('hidden')) {
                avatarDropdown.classList.add('hidden');
            }
        });

        // Prevent dropdown from closing when clicking inside it
        avatarDropdown?.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // Sign out handler (works for both sidebar button and dropdown)
        async function handleSignOut() {
            try {
                await signOut(auth);
                conversationHistory = []; // Clear in-memory array
                chatMessages.innerHTML = ''; // Clear UI

                // Close dropdown if open
                if (avatarDropdown && !avatarDropdown.classList.contains('hidden')) {
                    avatarDropdown.classList.add('hidden');
                }
                // Note: Firestore data remains intact
            } catch (error) {
                console.error('Sign out error:', error);
                alert('Failed to sign out. Please try again.');
            }
        }

        // Attach to both buttons
        signOutBtn?.addEventListener('click', handleSignOut);
        dropdownSignOutBtn?.addEventListener('click', handleSignOut);

        // Mobile Menu Button
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', () => {
                const action = confirm('Options:\n\nOK = Settings\nCancel = Sign Out');
                if (action) {
                    // Open settings tab
                    switchPanelTab('settings');
                } else {
                    // Sign out
                    signOut(auth).then(() => {
                        conversationHistory = [];
                        chatMessages.innerHTML = '';
                    }).catch(error => {
                        console.error('Sign out error:', error);
                        alert('Failed to sign out. Please try again.');
                    });
                }
            });
        }

        // Load Link Status
        async function loadLinkStatus() {
            if (!auth.currentUser) return;

            try {
                const idToken = await auth.currentUser.getIdToken();
                const response = await fetch('/api/link-settings', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                if (response.ok) {
                    const settings = await response.json();
                    const activityFeedLink = document.getElementById('activityFeedLink');

                    if (settings.linkEnabled && settings.username) {
                        // Set the public link URL
                        activityFeedLink.href = `https://mindclone.link/${settings.username}`;
                        activityFeedLink.target = '_blank';
                        activityFeedLink.style.cursor = 'pointer';
                        activityFeedLink.style.opacity = '1';

                        // Also update right panel link
                        if (rightActivityFeedLink) {
                            rightActivityFeedLink.href = `https://mindclone.link/${settings.username}`;
                            rightActivityFeedLink.target = '_blank';
                            rightActivityFeedLink.style.cursor = 'pointer';
                            rightActivityFeedLink.style.opacity = '1';
                        }
                    } else {
                        // Redirect to settings to enable link
                        activityFeedLink.href = '/settings';
                        activityFeedLink.target = '_self';
                        activityFeedLink.style.cursor = 'pointer';
                        activityFeedLink.style.opacity = '0.6';

                        // Also update right panel link
                        if (rightActivityFeedLink) {
                            rightActivityFeedLink.href = '/settings';
                            rightActivityFeedLink.target = '_self';
                            rightActivityFeedLink.style.cursor = 'pointer';
                            rightActivityFeedLink.style.opacity = '0.6';
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading link status:', error);
            }
        }

        // Activity Feed Functions
        function formatTimeAgo(timestamp) {
            if (!timestamp) return 'just now';

            const now = Date.now();
            const time = timestamp.seconds ? timestamp.seconds * 1000 : timestamp;
            const diff = Math.floor((now - time) / 1000); // difference in seconds

            if (diff < 60) return 'just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            if (diff < 2592000) return `${Math.floor(diff / 86400)}d ago`;
            return `${Math.floor(diff / 2592000)}mo ago`;
        }

        function truncateText(text, maxLength = 50) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function createActivityItem(visitorId, lastMessage, lastResponse, timestamp, isNew = false) {
            const item = document.createElement('div');
            item.className = `activity-item${isNew ? ' new' : ''}`;
            item.dataset.visitorId = visitorId;

            const visitorName = `visitor_${visitorId.substring(0, 6)}`;
            const timeAgo = formatTimeAgo(timestamp);

            item.innerHTML = `
                <div class="activity-item-header">
                    <div class="activity-item-visitor">
                        <span></span>
                        <span>${visitorName}</span>
                    </div>
                    <div class="activity-item-time">${timeAgo}</div>
                </div>
                <div class="activity-item-message">"${truncateText(lastMessage, 60)}"</div>
                ${lastResponse ? `<div class="activity-item-response"> ${truncateText(lastResponse, 60)}</div>` : ''}
            `;

            // Click to expand conversation
            item.addEventListener('click', () => {
                openConversationModal(visitorId);
            });

            return item;
        }

        async function loadActivityFeed() {
            if (!auth.currentUser) return;

            try {
                const idToken = await auth.currentUser.getIdToken();
                const response = await fetch('/api/activity', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    activityData = data.activities || [];

                    // Update count (right panel only)
                    const todayCount = activityData.filter(a => {
                        const time = a.lastTimestamp?.seconds ? a.lastTimestamp.seconds * 1000 : Date.now();
                        return (Date.now() - time) < 86400000; // 24 hours
                    }).length;
                    if (rightActivityCount) rightActivityCount.textContent = `${todayCount} today`;

                    // Clear current list (right panel only)
                    if (rightActivityList) rightActivityList.innerHTML = '';

                    if (activityData.length > 0) {
                        // Show list, hide empty state (right panel only)
                        if (rightActivityList) rightActivityList.style.display = 'flex';
                        if (rightActivityEmpty) rightActivityEmpty.style.display = 'none';

                        // Render each activity item (right panel only)
                        activityData.forEach(activity => {
                            if (rightActivityList) {
                                const rightItem = createActivityItem(
                                    activity.visitorId,
                                    activity.lastMessage,
                                    activity.lastResponse,
                                    activity.lastTimestamp,
                                    activity.isNew
                                );
                                rightActivityList.appendChild(rightItem);
                            }
                        });
                    } else {
                        // Show empty state (right panel only)
                        if (rightActivityList) rightActivityList.style.display = 'none';
                        if (rightActivityEmpty) rightActivityEmpty.style.display = 'flex';
                    }
                } else {
                    console.error('Failed to load activity feed');
                    // Show empty state on error (right panel only)
                    if (rightActivityList) rightActivityList.style.display = 'none';
                    if (rightActivityEmpty) rightActivityEmpty.style.display = 'flex';
                }
            } catch (error) {
                console.error('Error loading activity feed:', error);
                // Show empty state on error (right panel only)
                if (rightActivityList) rightActivityList.style.display = 'none';
                if (rightActivityEmpty) rightActivityEmpty.style.display = 'flex';
            }
        }

        // Set up real-time activity listener
        function setupActivityListener() {
            if (!auth.currentUser) return;

            // Clean up existing listener
            if (activityListener) {
                activityListener();
                activityListener = null;
            }

            try {
                const userId = auth.currentUser.uid;
                const visitorsRef = collection(db, 'users', userId, 'visitors');
                const q = query(visitorsRef, orderBy('lastVisit', 'desc'), limit(20));

                console.log('[Activity] Setting up real-time listener...');

                // Listen to visitor changes
                activityListener = onSnapshot(q, async (snapshot) => {
                    console.log('[Activity] Snapshot received:', snapshot.size, 'visitors');
                    console.log('[Activity] Current time:', new Date().toLocaleTimeString());

                    const changes = snapshot.docChanges();
                    console.log('[Activity] Number of changes:', changes.length);

                    // Process changes
                    for (const change of changes) {
                        console.log('[Activity] Change type:', change.type, 'Visitor:', change.doc.id);
                        const visitorId = change.doc.id;
                        const visitorData = change.doc.data();

                        if (change.type === 'added' || change.type === 'modified') {
                            console.log('[Activity] Visitor updated:', visitorId);

                            // Get last 2 messages for this visitor
                            try {
                                const messagesRef = collection(db, 'users', userId, 'visitors', visitorId, 'messages');
                                const messagesQuery = query(messagesRef, orderBy('timestamp', 'desc'), limit(2));
                                const messagesSnapshot = await getDocs(messagesQuery);

                                let lastMessage = null;
                                let lastResponse = null;

                                if (!messagesSnapshot.empty) {
                                    const messages = messagesSnapshot.docs.map(doc => ({
                                        id: doc.id,
                                        ...doc.data()
                                    }));

                                    // Find last user message and AI response
                                    for (const msg of messages) {
                                        if (msg.role === 'user' && !lastMessage) {
                                            lastMessage = msg.content;
                                        } else if (msg.role === 'assistant' && !lastResponse) {
                                            lastResponse = msg.content;
                                        }
                                    }
                                }

                                // Use fallback from visitor data
                                if (!lastMessage && visitorData.lastMessage) {
                                    lastMessage = visitorData.lastMessage;
                                }

                                // Update or add activity item
                                if (lastMessage) {
                                    const activityItem = {
                                        visitorId: visitorId,
                                        lastMessage: lastMessage,
                                        lastResponse: lastResponse,
                                        lastTimestamp: visitorData.lastVisit,
                                        isNew: change.type === 'modified' // Mark as new if modified (new message)
                                    };

                                    // Update activityData array
                                    const existingIndex = activityData.findIndex(a => a.visitorId === visitorId);
                                    if (existingIndex >= 0) {
                                        activityData[existingIndex] = activityItem;
                                    } else {
                                        activityData.unshift(activityItem);
                                    }

                                    // Update DOM
                                    updateActivityItem(visitorId, activityItem);
                                }
                            } catch (error) {
                                console.error('[Activity] Error fetching messages for visitor:', visitorId, error);
                            }
                        } else if (change.type === 'removed') {
                            // Remove from activityData array
                            const index = activityData.findIndex(a => a.visitorId === visitorId);
                            if (index >= 0) {
                                activityData.splice(index, 1);
                            }

                            // Remove from DOM
                            removeActivityItem(visitorId);
                        }
                    }

                    // Update count
                    updateActivityCount();
                }, (error) => {
                    console.error('[Activity] Listener error:', error);
                });

                console.log('[Activity] Real-time listener active');
            } catch (error) {
                console.error('[Activity] Error setting up listener:', error);
            }
        }

        // Update or add activity item in the feed
        function updateActivityItem(visitorId, activity) {
            // Only update right panel
            if (!rightActivityList) return;

            // Check if item exists in right panel
            let rightExistingItem = rightActivityList.querySelector(`[data-visitor-id="${visitorId}"]`);

            if (rightExistingItem) {
                // Update existing item in right panel
                const timeAgo = formatTimeAgo(activity.lastTimestamp);
                const visitorName = `visitor_${visitorId.substring(0, 6)}`;

                rightExistingItem.innerHTML = `
                    <div class="activity-item-header">
                        <div class="activity-item-visitor">
                            <span></span>
                            <span>${visitorName}</span>
                        </div>
                        <div class="activity-item-time">${timeAgo}</div>
                    </div>
                    <div class="activity-item-message">"${truncateText(activity.lastMessage, 60)}"</div>
                    ${activity.lastResponse ? `<div class="activity-item-response"> ${truncateText(activity.lastResponse, 60)}</div>` : ''}
                `;

                // Re-attach click listener
                rightExistingItem.onclick = () => {
                    openConversationModal(visitorId);
                };

                // Add "new" class and animate
                if (activity.isNew) {
                    rightExistingItem.classList.add('new');
                    setTimeout(() => {
                        rightExistingItem.classList.remove('new');
                    }, 5000);
                }

                // Move to top if it's a new message
                if (activity.isNew && rightExistingItem !== rightActivityList.firstChild) {
                    rightActivityList.removeChild(rightExistingItem);
                    rightActivityList.insertBefore(rightExistingItem, rightActivityList.firstChild);
                }
            } else {
                // Create new item for right panel
                const rightItem = createActivityItem(
                    activity.visitorId,
                    activity.lastMessage,
                    activity.lastResponse,
                    activity.lastTimestamp,
                    activity.isNew
                );

                // Add to top of list
                if (rightActivityList.firstChild) {
                    rightActivityList.insertBefore(rightItem, rightActivityList.firstChild);
                } else {
                    rightActivityList.appendChild(rightItem);
                }

                // Show list, hide empty state
                rightActivityList.style.display = 'flex';
                if (rightActivityEmpty) rightActivityEmpty.style.display = 'none';

                // Remove "new" class after 5 seconds
                if (activity.isNew) {
                    setTimeout(() => {
                        rightItem.classList.remove('new');
                    }, 5000);
                }
            }
        }

        // Remove activity item from the feed
        function removeActivityItem(visitorId) {
            // Only remove from right panel
            if (!rightActivityList) return;

            const rightItem = rightActivityList.querySelector(`[data-visitor-id="${visitorId}"]`);
            if (rightItem) {
                rightItem.remove();
            }

            // Check if right panel list is empty
            if (rightActivityList.children.length === 0) {
                rightActivityList.style.display = 'none';
                if (rightActivityEmpty) rightActivityEmpty.style.display = 'flex';
            }
        }

        // Update activity count
        function updateActivityCount() {
            // activityList removed with left sidebar - skip if not present
            if (!activityList) return;

            const now = Date.now();
            const items = activityList.querySelectorAll('.activity-item');
            let todayCount = 0;

            items.forEach(item => {
                const visitorId = item.dataset.visitorId;
                const activity = activityData.find(a => a.visitorId === visitorId);
                if (activity) {
                    const time = activity.lastTimestamp?.seconds ? activity.lastTimestamp.seconds * 1000 : now;
                    if ((now - time) < 86400000) { // 24 hours
                        todayCount++;
                    }
                }
            });

            // Update old sidebar count (removed with left sidebar)
            if (activityCount) {
                activityCount.textContent = `${todayCount} today`;
            }

            // Update right panel count
            if (rightActivityCount) {
                rightActivityCount.textContent = `${todayCount} today`;
            }
        }

        // Conversation Modal Functions
        async function openConversationModal(visitorId) {
            console.log('[Modal] Opening conversation for visitor:', visitorId);

            // Show modal
            conversationModal.classList.remove('hidden');

            // Update header
            const visitorName = `visitor_${visitorId.substring(0, 6)}`;
            modalVisitorName.textContent = visitorName;

            // Show loading state
            conversationModalBody.innerHTML = `
                <div class="conversation-loading">
                    <div class="spinner"></div>
                    <div>Loading conversation...</div>
                </div>
            `;

            try {
                // Fetch full conversation via API
                const idToken = await auth.currentUser.getIdToken();
                const response = await fetch(`/api/analytics?visitorId=${visitorId}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                if (!response.ok) {
                    throw new Error('Failed to load conversation');
                }

                const data = await response.json();
                console.log('[Modal] Conversation data:', data);

                // Update time
                if (data.firstVisit) {
                    const firstVisit = data.firstVisit.seconds ? new Date(data.firstVisit.seconds * 1000) : new Date(data.firstVisit);
                    modalVisitorTime.textContent = `First visit: ${formatTimeAgo(data.firstVisit)}`;
                }

                // Render messages
                conversationModalBody.innerHTML = '';

                if (data.messages && data.messages.length > 0) {
                    // Reverse to show oldest first
                    const messages = [...data.messages].reverse();

                    // Track the latest displayAction (for slides/excel)
                    let latestDisplayAction = null;

                    messages.forEach(msg => {
                        const messageEl = document.createElement('div');
                        messageEl.className = `conversation-message ${msg.role}`;

                        const label = msg.role === 'user' ? 'Visitor' : 'Your AI';
                        const time = msg.timestamp ? formatTimeAgo(msg.timestamp) : '';

                        messageEl.innerHTML = `
                            <div class="conversation-message-label">${label}</div>
                            <div class="conversation-message-bubble">${escapeHtml(msg.content)}</div>
                            ${time ? `<div class="conversation-message-time">${time}</div>` : ''}
                        `;

                        conversationModalBody.appendChild(messageEl);

                        // Track displayAction for slides
                        if (msg.displayAction) {
                            latestDisplayAction = msg.displayAction;
                        }
                    });

                    // Scroll to bottom
                    conversationModalBody.scrollTop = conversationModalBody.scrollHeight;

                    // If there's a displayAction, show the display panel
                    if (latestDisplayAction && latestDisplayAction.type === 'slide') {
                        await renderSlideInModal(latestDisplayAction);
                    } else {
                        // Hide display panel if no slides
                        conversationDisplayPanel.classList.add('hidden');
                        conversationModalContent.classList.remove('has-display');
                    }
                } else {
                    conversationModalBody.innerHTML = `
                        <div class="conversation-error">
                            No messages found for this visitor.
                        </div>
                    `;
                    conversationDisplayPanel.classList.add('hidden');
                    conversationModalContent.classList.remove('has-display');
                }
            } catch (error) {
                console.error('[Modal] Error loading conversation:', error);
                conversationModalBody.innerHTML = `
                    <div class="conversation-error">
                        Failed to load conversation: ${error.message}
                    </div>
                `;
            }
        }

        async function renderSlideInModal(displayAction) {
            try {
                console.log('[Modal] Rendering slide:', displayAction);

                // Show display panel
                conversationDisplayPanel.classList.remove('hidden');
                conversationModalContent.classList.add('has-display');

                // Clear previous content
                conversationDisplayContent.innerHTML = '<div class="spinner"></div>';

                // Load PDF
                const loadingTask = pdfjsLib.getDocument(displayAction.pdfUrl);
                const pdf = await loadingTask.promise;

                // Get the page
                const page = await pdf.getPage(displayAction.slideNumber);

                // Create canvas
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');

                // Calculate scale to fit display panel
                const viewport = page.getViewport({ scale: 1.5 });
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                // Render page
                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;

                // Display canvas
                conversationDisplayContent.innerHTML = '';
                conversationDisplayContent.appendChild(canvas);

                console.log('[Modal] Slide rendered successfully');
            } catch (error) {
                console.error('[Modal] Error rendering slide:', error);
                conversationDisplayContent.innerHTML = `
                    <div class="conversation-error">
                        Failed to load slide: ${error.message}
                    </div>
                `;
            }
        }

        function closeConversationModal() {
            conversationModal.classList.add('hidden');
            conversationModalBody.innerHTML = '';
            conversationDisplayPanel.classList.add('hidden');
            conversationDisplayContent.innerHTML = '';
            conversationModalContent.classList.remove('has-display');
        }

        // Helper to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Modal close handlers
        conversationModalClose.addEventListener('click', closeConversationModal);

        // Close on backdrop click
        conversationModal.addEventListener('click', (e) => {
            if (e.target === conversationModal) {
                closeConversationModal();
            }
        });

        // Close on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !conversationModal.classList.contains('hidden')) {
                closeConversationModal();
            }
        });

        // Show Auth Screen
        function showAuthScreen() {
            // Show landing page
            const landingPage = document.getElementById('landingPage');
            if (landingPage) {
                landingPage.classList.remove('hidden');
            }

            // Hide app header
            const appHeader = document.getElementById('appHeader');
            if (appHeader) {
                appHeader.classList.add('hidden');
            }

            // Hide chat interface
            chatInterface.classList.add('hidden');

            // Hide sidebar components
            sidebarAuth.classList.add('hidden');
            sidebarProfile.classList.add('hidden');
            // activityFeed removed - no longer exists after consolidation

            // Clean up activity listener
            if (activityListener) {
                activityListener();
                activityListener = null;
                console.log('[Activity] Listener cleaned up');
            }

            // Hide mobile header
            const mobileHeader = document.getElementById('mobileHeader');
            if (mobileHeader) {
                mobileHeader.classList.add('hidden');
            }
        }

        // Show Chat Interface
        async function showChatInterface(user) {
            // Hide landing page
            const landingPage = document.getElementById('landingPage');
            if (landingPage) {
                landingPage.classList.add('hidden');
            }

            // Show app header
            const appHeader = document.getElementById('appHeader');
            if (appHeader) {
                appHeader.classList.remove('hidden');
            }

            // Show chat interface
            chatInterface.classList.remove('hidden');

            // Add with-header class to main-content for proper spacing
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.classList.add('with-header');
            }

            // Hide sidebar components (not needed with header layout)
            sidebarAuth.classList.add('hidden');
            sidebarProfile.classList.add('hidden');
            // activityFeed removed - no longer exists after consolidation

            // Update header avatar and dropdown
            const headerAvatar = document.getElementById('headerAvatar');
            const headerAvatarLeft = document.getElementById('headerAvatarLeft');
            const headerDropdownAvatar = document.getElementById('headerDropdownAvatar');
            const headerDropdownName = document.getElementById('headerDropdownName');
            const headerDropdownEmail = document.getElementById('headerDropdownEmail');

            if (headerAvatar) headerAvatar.src = user.photoURL || 'https://via.placeholder.com/40';
            if (headerAvatarLeft) headerAvatarLeft.src = user.photoURL || 'https://via.placeholder.com/28';
            if (headerDropdownAvatar) headerDropdownAvatar.src = user.photoURL || 'https://via.placeholder.com/36';
            if (headerDropdownName) headerDropdownName.textContent = user.displayName || 'User';
            if (headerDropdownEmail) headerDropdownEmail.textContent = user.email;

            // Update legacy user profile elements (for backward compatibility)
            userAvatar.src = user.photoURL || 'https://via.placeholder.com/50';
            userName.textContent = user.displayName || 'User';
            userEmail.textContent = user.email;

            dropdownAvatar.src = user.photoURL || 'https://via.placeholder.com/36';
            dropdownUserName.textContent = user.displayName || 'User';
            dropdownUserEmail.textContent = user.email;

            // Hide mobile header (we use app header instead)
            const mobileHeader = document.getElementById('mobileHeader');
            if (mobileHeader) {
                mobileHeader.classList.add('hidden');
            }

            // Load link status
            await loadLinkStatus();

            // Load activity feed data (for modal)
            await loadActivityFeed();

            // Set up real-time listener for activity feed
            setupActivityListener();

            // Update activity badge
            updateActivityBadge();

            // Initialize panel tabs
            initializePanelTabs();
            initializePanelSettings();
            initializePanelAnalytics();
            initializeKnowledgeBase();

            // Restore last active tab
            restorePanelTab();

            // Clear existing UI
            chatMessages.innerHTML = '';
            console.log('[Chat] Cleared chat messages');

            // Show loading indicator
            showLoadingIndicator();

            try {
                // Load conversation history from Firestore
                console.log('[Chat] Loading conversation history for user:', user.uid);
                const messages = await loadConversationHistory(user.uid);
                console.log('[Chat] Loaded', messages.length, 'messages');

                if (messages.length > 0) {
                    // Populate conversationHistory array
                    conversationHistory = messages.map(msg => ({
                        role: msg.role,
                        content: msg.content
                    }));

                    // Display all messages in UI with timestamps
                    messages.forEach(msg => {
                        addMessage(msg.role === 'assistant' ? 'ai' : msg.role, msg.content, msg.timestamp);
                    });
                    console.log('[Chat] Displayed', messages.length, 'messages in UI');
                } else {
                    // No history - show empty state
                    console.log('[Chat] No messages found, showing empty state');
                    showEmptyState();
                }
            } catch (error) {
                console.error('[Chat] Error loading conversation:', error);
                // Show empty state on error
                showEmptyState();
            } finally {
                removeLoadingIndicator();
                console.log('[Chat] Finished loading conversation');
            }
        }

        // Add Message to Chat
        function addMessage(type, content, timestamp = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            // Only add avatar for AI messages (WhatsApp style)
            if (type === 'ai') {
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.textContent = '';
                messageDiv.appendChild(avatar);
            }

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';

            // Use markdown for AI messages, plain text for user messages
            if (type === 'ai' && typeof marked !== 'undefined') {
                messageContent.innerHTML = marked.parse(content);
            } else {
                messageContent.textContent = content;
            }

            // Add timestamp
            if (timestamp) {
                const timestampDiv = document.createElement('div');
                timestampDiv.className = 'message-timestamp';
                timestampDiv.textContent = formatTimestamp(timestamp);
                messageContent.appendChild(timestampDiv);
            }

            messageDiv.appendChild(messageContent);

            // Add copy button for AI messages
            if (type === 'ai') {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.textContent = 'Copy';
                copyBtn.onclick = () => copyMessage(content, copyBtn);
                messageDiv.appendChild(copyBtn);
            }

            chatMessages.appendChild(messageDiv);

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Format timestamp
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';

            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            // Less than 1 minute
            if (diff < 60000) return 'Just now';

            // Less than 1 hour
            if (diff < 3600000) {
                const mins = Math.floor(diff / 60000);
                return `${mins} ${mins === 1 ? 'minute' : 'minutes'} ago`;
            }

            // Less than 24 hours
            if (diff < 86400000) {
                const hours = Math.floor(diff / 3600000);
                return `${hours} ${hours === 1 ? 'hour' : 'hours'} ago`;
            }

            // Less than 7 days
            if (diff < 604800000) {
                const days = Math.floor(diff / 86400000);
                return `${days} ${days === 1 ? 'day' : 'days'} ago`;
            }

            // Show full date
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Copy message to clipboard
        async function copyMessage(content, button) {
            try {
                await navigator.clipboard.writeText(content);
                button.textContent = 'Copied!';
                button.classList.add('copied');
                setTimeout(() => {
                    button.textContent = 'Copy';
                    button.classList.remove('copied');
                }, 2000);
            } catch (error) {
                console.error('Failed to copy:', error);
            }
        }

        // Show typing indicator
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'message ai';
            typingDiv.innerHTML = `
                <div class="message-avatar"></div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Remove typing indicator
        function removeTypingIndicator() {
            const typingDiv = document.getElementById('typingIndicator');
            if (typingDiv) typingDiv.remove();
        }

        // Show empty state with suggested prompts
        function showEmptyState() {
            const emptyStateDiv = document.createElement('div');
            emptyStateDiv.id = 'emptyState';
            emptyStateDiv.className = 'empty-state';
            emptyStateDiv.innerHTML = `
                <div class="empty-state-icon"></div>
                <h2>Start Your Journey</h2>
                <p>Begin your lifelong conversation with your Mindclone. I'm here to listen, learn, and grow with you.</p>
                <div class="suggested-prompts">
                    <div class="prompt-card" data-prompt="Tell me about yourself - what makes you unique?">
                        <div class="prompt-card-title">Get to know you</div>
                        <div class="prompt-card-text">Tell me about yourself - what makes you unique?</div>
                    </div>
                    <div class="prompt-card" data-prompt="What's on your mind today?">
                        <div class="prompt-card-title">Share your thoughts</div>
                        <div class="prompt-card-text">What's on your mind today?</div>
                    </div>
                    <div class="prompt-card" data-prompt="What are your biggest dreams and aspirations?">
                        <div class="prompt-card-title">Explore your dreams</div>
                        <div class="prompt-card-text">What are your biggest dreams and aspirations?</div>
                    </div>
                    <div class="prompt-card" data-prompt="What's something you've been thinking about lately?">
                        <div class="prompt-card-title">Deep conversation</div>
                        <div class="prompt-card-text">What's something you've been thinking about lately?</div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(emptyStateDiv);

            // Add click handlers to prompt cards
            document.querySelectorAll('.prompt-card').forEach(card => {
                card.addEventListener('click', () => {
                    const prompt = card.getAttribute('data-prompt');
                    chatInput.value = prompt;
                    chatInput.focus();
                });
            });
        }

        // Remove empty state
        function removeEmptyState() {
            const emptyStateDiv = document.getElementById('emptyState');
            if (emptyStateDiv) emptyStateDiv.remove();
        }

        // ============================================
        // KNOWLEDGE BASE WORKFLOW FUNCTIONS
        // ============================================

        // Detect if message triggers workflow
        function detectWorkflowTrigger(message) {
            const lowerMsg = message.toLowerCase();
            const triggers = [
                'set up my link',
                'setup my link',
                'build my link',
                'create my link',
                'configure my link',
                'help with my link',
                'set up link',
                'setup link',
                'build link',
                'create link',
                'set up my public link',
                'setup my public link',
                'build my public link',
                'create my public link',
                'help me build my knowledge base',
                'setup my knowledge base',
                'setup knowledge base'
            ];
            return triggers.some(trigger => lowerMsg.includes(trigger));
        }

        // Start knowledge base workflow
        async function startKnowledgeBaseWorkflow() {
            workflowState.active = true;
            saveWorkflowState(); // Persist state

            // Show workflow indicator
            showWorkflowIndicator(' Setting up your public link...');

            // Check if knowledge base already exists
            try {
                const currentUser = auth.currentUser;
                if (currentUser) {
                    const idToken = await currentUser.getIdToken();
                    const kbResponse = await fetch('/api/link-knowledge-base', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${idToken}`
                        }
                    });

                    const kbData = await kbResponse.json();

                    // If knowledge base exists and has content, skip to username claim
                    if (kbData.success && !kbData.isEmpty &&
                        (kbData.knowledgeBase && Object.keys(kbData.knowledgeBase).length > 0)) {
                        console.log('[Workflow] Knowledge base already exists, skipping to username claim');

                        await addWorkflowMessage('ai', `Great news! You already have a knowledge base set up for your public link.

I just need to claim your username to make your link active. Let me do that now...`);

                        // Wait a moment then trigger the save
                        setTimeout(async () => {
                            try {
                                // Load existing knowledge base into workflow state
                                workflowState.data.cof = kbData.cof || { purpose: '', targetAudiences: [], desiredActions: [] };
                                workflowState.data.sections = kbData.knowledgeBase || {};

                                // Show preview and trigger save
                                showKnowledgeBasePreview();

                                // Auto-click save button after preview loads
                                setTimeout(() => {
                                    const saveBtn = document.querySelector('.kb-btn-primary');
                                    if (saveBtn) {
                                        saveBtn.click();
                                    }
                                }, 500);
                            } catch (error) {
                                console.error('[Workflow] Error auto-completing:', error);
                                await addWorkflowMessage('ai', 'Something went wrong. Please go to Settings to claim your username manually.');
                            }
                        }, 1000);

                        return;
                    }
                }
            } catch (error) {
                console.error('[Workflow] Error checking existing knowledge base:', error);
                // Continue with normal workflow if check fails
            }

            // No existing knowledge base, start full workflow
            workflowState.step = 'intro';
            saveWorkflowState();

            const introMessage = `I'll help you set up your public link! This is your business card to the world - a way to share authentic information about yourself or your business with investors, customers, talent, and other stakeholders.

We'll start by defining your link's **Core Objective Function (CoF)** - the strategic "why" behind your link. Then we'll build a **Knowledge Base** with the specific information you want to share.

Let's begin! **What is the primary purpose of your public link?**

For example:
 "Help investors understand my startup and request intro calls"
 "Showcase my professional background to recruiters"
 "Share information about my business with potential customers"`;

            await addWorkflowMessage('ai', introMessage);
        }

        // Handle workflow responses
        async function handleWorkflowResponse(message) {
            const step = workflowState.step;
            const lowerMsg = message.toLowerCase();

            // Check if user is approving/editing a draft
            if (workflowState.waitingForApproval) {
                if (lowerMsg === 'approve' || lowerMsg === 'approved' || lowerMsg === 'yes' ||
                    lowerMsg === 'looks good' || lowerMsg === 'good' || lowerMsg === 'ok' ||
                    lowerMsg === 'okay' || lowerMsg === 'fine' || lowerMsg === 'perfect' ||
                    lowerMsg === 'great' || lowerMsg === 'sounds good' || lowerMsg === 'that works' ||
                    lowerMsg === 'works for me') {
                    // Reset approval state
                    workflowState.waitingForApproval = false;
                    workflowState.currentDraft = null;

                    // Handle CoF draft approvals
                    if (step === 'purpose_draft') {
                        workflowState.data.cof.purpose = workflowState.currentDraft;
                        workflowState.step = 'target_audiences';
                        const response = ` Purpose saved!

**Target Audiences**

Who are the primary people visiting your link? Tell me about them.`;
                        await addWorkflowMessage('ai', response);
                        return true;
                    } else if (step === 'audiences_draft') {
                        const audiences = workflowState.currentDraft
                            .split(/[,\n]/)
                            .map(a => a.trim())
                            .filter(a => a.length > 0);
                        workflowState.data.cof.targetAudiences = audiences;
                        workflowState.step = 'desired_actions';
                        const response = ` Target audiences saved!

**Desired Actions**

What do you want visitors to do after they learn about you? What actions should they take?`;
                        await addWorkflowMessage('ai', response);
                        return true;
                    } else if (step === 'actions_draft') {
                        const actions = workflowState.currentDraft
                            .split(/[,\n]/)
                            .map(a => a.trim())
                            .filter(a => a.length > 0);
                        workflowState.data.cof.desiredActions = actions;
                        workflowState.step = 'sections_intro';
                        const response = ` Desired actions saved!

**Core Objective Function Complete!**

Now let's build your **Knowledge Base** with specific information. I recommend 4 essential sections:

1. **About** - Who you are / what you do
2. **Product/Service** - What you offer
3. **Traction/Background** - Your achievements
4. **Contact** - How to reach you

Ready to start? Type "yes" to continue, or "skip" to save just the CoF for now.`;
                        await addWorkflowMessage('ai', response);
                        return true;
                    }

                    // Handle section draft approvals
                    const section = workflowState.currentSection;
                    if (section) {
                        workflowState.data.sections[section] = {
                            content: workflowState.currentDraft,
                            approved: true
                        };
                        workflowState.currentSection = null;
                    }

                    if (step === 'section_about') {
                        workflowState.step = 'section_product';
                        const response = ` Approved! Saved to knowledge base.

**Section 2: Product/Service**

Tell me about what you offer. What are your key products, services, or features?`;
                        await addWorkflowMessage('ai', response);
                        return true;
                    } else if (step === 'section_product') {
                        workflowState.step = 'section_traction';
                        const response = ` Approved! Saved to knowledge base.

**Section 3: Traction/Background**

Share your achievements, traction metrics, or professional background.`;
                        await addWorkflowMessage('ai', response);
                        return true;
                    } else if (step === 'section_traction') {
                        workflowState.step = 'section_contact';
                        const response = ` Approved! Saved to knowledge base.

**Section 4: Contact**

How should visitors reach you? Share your contact methods.`;
                        await addWorkflowMessage('ai', response);
                        return true;
                    } else if (step === 'section_contact') {
                        workflowState.step = 'complete';
                        const response = ` Approved! All sections completed.

Let me show you a preview of your complete knowledge base.`;
                        await addWorkflowMessage('ai', response);
                        setTimeout(() => showKnowledgeBasePreview(), 1000);
                        return true;
                    }
                } else {
                    // User provided feedback - regenerate based on current step
                    if (step === 'purpose_draft') {
                        await draftPurpose(workflowState.userInput, message);
                        return true;
                    } else if (step === 'audiences_draft') {
                        await draftAudiences(workflowState.userInput, message);
                        return true;
                    } else if (step === 'actions_draft') {
                        await draftActions(workflowState.userInput, message);
                        return true;
                    } else if (workflowState.currentSection) {
                        // User wants to edit section - use their feedback to regenerate
                        await generateSectionDraft(workflowState.currentSection, workflowState.userInput, message);
                        return true;
                    }
                }
            }

            // Normal workflow progression
            if (step === 'intro') {
                // User provided purpose - draft it professionally
                workflowState.userInput = message;
                workflowState.step = 'purpose_draft';
                await draftPurpose(message);
                return true;
            }

            if (step === 'purpose_draft') {
                // User approved purpose
                workflowState.data.cof.purpose = workflowState.currentDraft;
                workflowState.waitingForApproval = false;
                workflowState.step = 'target_audiences';

                const response = ` Purpose saved!

**Target Audiences**

Who are the primary people visiting your link? Tell me about them.`;
                await addWorkflowMessage('ai', response);
                return true;
            }

            if (step === 'target_audiences') {
                workflowState.userInput = message;
                workflowState.step = 'audiences_draft';
                await draftAudiences(message);
                return true;
            }

            if (step === 'audiences_draft') {
                // Parse and save audiences
                const audiences = workflowState.currentDraft
                    .split(/[,\n]/)
                    .map(a => a.trim())
                    .filter(a => a.length > 0);
                workflowState.data.cof.targetAudiences = audiences;
                workflowState.waitingForApproval = false;
                workflowState.step = 'desired_actions';

                const response = ` Target audiences saved!

**Desired Actions**

What do you want visitors to do after they learn about you? What actions should they take?`;
                await addWorkflowMessage('ai', response);
                return true;
            }

            if (step === 'desired_actions') {
                workflowState.userInput = message;
                workflowState.step = 'actions_draft';
                await draftActions(message);
                return true;
            }

            if (step === 'actions_draft') {
                // Parse and save actions
                const actions = workflowState.currentDraft
                    .split(/[,\n]/)
                    .map(a => a.trim())
                    .filter(a => a.length > 0);
                workflowState.data.cof.desiredActions = actions;
                workflowState.waitingForApproval = false;
                workflowState.step = 'sections_intro';

                const response = ` Desired actions saved!

**Core Objective Function Complete!**

Now let's build your **Knowledge Base** with specific information. I recommend 4 essential sections:

1. **About** - Who you are / what you do
2. **Product/Service** - What you offer
3. **Traction/Background** - Your achievements
4. **Contact** - How to reach you

Ready to start? Type "yes" to continue, or "skip" to save just the CoF for now.`;
                await addWorkflowMessage('ai', response);
                return true;
            }

            if (step === 'sections_intro') {
                if (lowerMsg.includes('skip') || lowerMsg.includes('later')) {
                    showKnowledgeBasePreview();
                    return true;
                }

                workflowState.step = 'section_about';
                const response = `Great! Let's start.

**Section 1: About**

Tell me about yourself or your business. What do you do? What problem do you solve?`;
                await addWorkflowMessage('ai', response);
                return true;
            }

            if (step === 'section_about') {
                workflowState.userInput = message;
                workflowState.currentSection = 'about';
                await generateSectionDraft('about', message);
                return true;
            }

            if (step === 'section_product') {
                workflowState.userInput = message;
                workflowState.currentSection = 'product';
                await generateSectionDraft('product', message);
                return true;
            }

            if (step === 'section_traction') {
                workflowState.userInput = message;
                workflowState.currentSection = 'traction';
                await generateSectionDraft('traction', message);
                return true;
            }

            if (step === 'section_contact') {
                workflowState.userInput = message;
                workflowState.currentSection = 'contact';
                await generateSectionDraft('contact', message);
                return true;
            }

            // If we got here, workflow is in an unexpected state
            console.error('Workflow in unexpected state:', {
                step: workflowState.step,
                waitingForApproval: workflowState.waitingForApproval,
                currentSection: workflowState.currentSection
            });

            await addWorkflowMessage('ai', `I got a bit confused. Let me ask again:\n\n` +
                (step === 'intro' ? 'What is the primary purpose of your public link?' :
                step === 'target_audiences' ? 'Who are the primary people visiting your link?' :
                step === 'desired_actions' ? 'What do you want visitors to do?' :
                step === 'section_about' ? 'Tell me about yourself or your business.' :
                step === 'section_product' ? 'Tell me about what you offer.' :
                step === 'section_traction' ? 'Share your achievements or traction metrics.' :
                step === 'section_contact' ? 'How should visitors reach you?' :
                'Please type "cancel" to restart the workflow.'));

            saveWorkflowState(); // Save state even after error
            return true; // Still block regular AI
        }

        // Helper functions to draft content using AI
        async function draftPurpose(userInput, feedback = null) {
            showTypingIndicator();
            try {
                console.log('[Workflow] Drafting purpose...', { userInput, feedback });

                let draftPrompt;
                if (feedback) {
                    draftPrompt = `The user is setting up their public link's Core Objective Function.

Original input: "${userInput}"
Previous draft: "${workflowState.currentDraft}"
User feedback: "${feedback}"

Revise the purpose statement based on their feedback. Keep it clear, concise (1-2 sentences), professional but authentic.

Return ONLY the revised purpose statement, nothing else.`;
                } else {
                    draftPrompt = `The user is setting up their public link's Core Objective Function. They told you about their purpose: "${userInput}"

Draft a clear, concise purpose statement (1-2 sentences) based on what they said. Make it professional but authentic.

Return ONLY the purpose statement, nothing else.`;
                }

                const draft = await callAIForDraft(draftPrompt);
                console.log('[Workflow] Purpose draft generated:', draft);

                removeTypingIndicator();

                workflowState.currentDraft = draft;
                workflowState.waitingForApproval = true;
                saveWorkflowState(); // Persist state
                saveWorkflowState(); // Persist state

                const response = feedback
                    ? `Here's the revised purpose:\n\n**"${draft}"**\n\nType **"approve"** to save, or tell me how to adjust further.`
                    : `Based on what you told me, here's the purpose I drafted:\n\n**"${draft}"**\n\nDoes this capture it well? Type **"approve"** to save it, or tell me how to adjust it.`;

                await addWorkflowMessage('ai', response);
            } catch (error) {
                console.error('[Workflow] Error drafting purpose:', error);
                removeTypingIndicator();

                // Reset workflow state to allow retry
                workflowState.step = 'intro';
                workflowState.waitingForApproval = false;
                workflowState.currentDraft = null;

                await addWorkflowMessage('ai', `Sorry, I had trouble drafting that (${error.message}). Let me try again. What is the primary purpose of your public link?`);
            }
        }

        async function draftAudiences(userInput, feedback = null) {
            showTypingIndicator();
            try {
                console.log('[Workflow] Drafting audiences...', { userInput, feedback });

                let draftPrompt;
                if (feedback) {
                    draftPrompt = `The user is defining who visits their public link.

Original input: "${userInput}"
Previous draft: "${workflowState.currentDraft}"
User feedback: "${feedback}"

Revise the target audiences list based on their feedback. Format as bullet points (). Be specific and concise.

Return ONLY the revised bulleted list, nothing else.`;
                } else {
                    draftPrompt = `The user is defining who visits their public link. They said: "${userInput}"

Based on that, list the target audiences as a clean list. Format as bullet points (). Be specific and concise.

Return ONLY the bulleted list, nothing else. Example format:
 Investors and VCs
 Potential customers
 Job candidates`;
                }

                const draft = await callAIForDraft(draftPrompt);
                console.log('[Workflow] Audiences draft generated:', draft);

                removeTypingIndicator();

                workflowState.currentDraft = draft;
                workflowState.waitingForApproval = true;
                saveWorkflowState(); // Persist state

                const response = feedback
                    ? `Here's the revised list:\n\n${draft}\n\nType **"approve"** to save, or tell me what else to change.`
                    : `Here are the target audiences I identified:\n\n${draft}\n\nType **"approve"** if this looks good, or tell me what to change.`;

                await addWorkflowMessage('ai', response);
            } catch (error) {
                console.error('[Workflow] Error drafting audiences:', error);
                removeTypingIndicator();

                // Reset workflow state to allow retry
                workflowState.step = 'target_audiences';
                workflowState.waitingForApproval = false;
                workflowState.currentDraft = null;

                await addWorkflowMessage('ai', `Sorry, I had trouble with that (${error.message}). Let me try again. Who are the primary people visiting your link?`);
            }
        }

        async function draftActions(userInput, feedback = null) {
            showTypingIndicator();
            try {
                console.log('[Workflow] Drafting actions...', { userInput, feedback });

                let draftPrompt;
                if (feedback) {
                    draftPrompt = `The user wants visitors to take certain actions after visiting their link.

Original input: "${userInput}"
Previous draft: "${workflowState.currentDraft}"
User feedback: "${feedback}"

Revise the desired actions list based on their feedback. Format as bullet points (). Be specific and action-oriented.

Return ONLY the revised bulleted list, nothing else.`;
                } else {
                    draftPrompt = `The user wants visitors to take certain actions after visiting their link. They said: "${userInput}"

Based on that, list the desired actions as a clean bullet list (). Be specific and action-oriented.

Return ONLY the bulleted list, nothing else. Example format:
 Request an intro call
 Sign up for product demo
 Apply for open positions`;
                }

                const draft = await callAIForDraft(draftPrompt);
                console.log('[Workflow] Actions draft generated:', draft);

                removeTypingIndicator();

                workflowState.currentDraft = draft;
                workflowState.waitingForApproval = true;
                saveWorkflowState(); // Persist state

                const response = feedback
                    ? `Here's the revised list:\n\n${draft}\n\nType **"approve"** to save, or tell me how to adjust further.`
                    : `Here are the desired actions I drafted:\n\n${draft}\n\nType **"approve"** to save, or tell me how to adjust.`;

                await addWorkflowMessage('ai', response);
            } catch (error) {
                console.error('[Workflow] Error drafting actions:', error);
                removeTypingIndicator();

                // Reset workflow state to allow retry
                workflowState.step = 'desired_actions';
                workflowState.waitingForApproval = false;
                workflowState.currentDraft = null;

                await addWorkflowMessage('ai', `Sorry, I had trouble with that (${error.message}). Let me try again. What do you want visitors to do after they learn about you?`);
            }
        }

        async function generateSectionDraft(sectionName, userInput, feedback = null) {
            showTypingIndicator();
            try {
                console.log('[Workflow] Drafting section:', sectionName, { userInput, feedback });

                let draftPrompt;
                if (feedback) {
                    draftPrompt = `The user is building their "${sectionName}" section for their public knowledge base.

Original user input: "${userInput}"
Previous draft: "${workflowState.currentDraft}"
User feedback: "${feedback}"

Revise the draft based on their feedback. Keep it professional, clear, and 2-3 sentences. Return ONLY the revised content.`;
                } else {
                    const sectionGuidance = {
                        'about': 'Explain who they are, what they do, and what problem they solve. 2-3 sentences.',
                        'product': 'Describe what they offer - products, services, or key features. 2-3 sentences.',
                        'traction': 'Share achievements, metrics, growth, or professional background. 2-3 sentences.',
                        'contact': 'List contact methods - email, website, social links. Clear and concise.'
                    };

                    draftPrompt = `The user is building their "${sectionName}" section for their public knowledge base.

They told you: "${userInput}"

${sectionGuidance[sectionName]}

Draft professional, authentic content based on what they said. Return ONLY the content for this section.`;
                }

                const draft = await callAIForDraft(draftPrompt);
                console.log('[Workflow] Section draft generated:', { sectionName, draft });

                removeTypingIndicator();

                workflowState.currentDraft = draft;
                workflowState.waitingForApproval = true;
                saveWorkflowState(); // Persist state

                const sectionTitle = sectionName.charAt(0).toUpperCase() + sectionName.slice(1);
                const response = `Here's what I drafted for your **${sectionTitle}** section:

---
${draft}
---

Type **"approve"** to save this, or tell me how to improve it.`;
                await addWorkflowMessage('ai', response);
            } catch (error) {
                console.error('[Workflow] Error drafting section:', sectionName, error);
                removeTypingIndicator();

                // Reset workflow state to allow retry
                workflowState.waitingForApproval = false;
                workflowState.currentDraft = null;
                // Keep workflowState.step and currentSection as is for retry

                await addWorkflowMessage('ai', `Sorry, I had trouble drafting that (${error.message}). Could you tell me about your ${sectionName} again?`);
            }
        }

        // Call AI to generate draft content with timeout protection
        async function callAIForDraft(prompt) {
            // Create timeout promise (30 seconds)
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error('Request timed out')), 30000);
            });

            // Create fetch promise
            const fetchPromise = fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    messages: [{ role: 'user', content: prompt }],
                    systemPrompt: 'You are a professional content writer helping someone build their public profile. Be concise, clear, and authentic. Follow instructions exactly.',
                    userId: auth.currentUser.uid
                })
            }).then(async (response) => {
                if (!response.ok) {
                    throw new Error(`API returned ${response.status}`);
                }
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'Failed to generate draft');
                }
                return data.content.trim();
            });

            // Race between fetch and timeout
            return Promise.race([fetchPromise, timeoutPromise]);
        }

        // Show knowledge base preview modal
        function showKnowledgeBasePreview() {
            const modal = document.createElement('div');
            modal.className = 'kb-preview-modal';
            modal.innerHTML = `
                <div class="kb-preview-overlay"></div>
                <div class="kb-preview-content">
                    <div class="kb-preview-header">
                        <h2> Your Knowledge Base Preview</h2>
                        <button class="kb-preview-close" onclick="closeKnowledgeBasePreview()"></button>
                    </div>
                    <div class="kb-preview-body">
                        ${generatePreviewHTML()}
                    </div>
                    <div class="kb-preview-footer">
                        <button class="kb-btn kb-btn-secondary" onclick="closeKnowledgeBasePreview()">Cancel</button>
                        <button class="kb-btn kb-btn-primary" onclick="saveKnowledgeBase()"> Approve & Save</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Fade in animation
            setTimeout(() => {
                modal.classList.add('active');
            }, 10);
        }

        // Generate preview HTML
        function generatePreviewHTML() {
            let html = '<div class="kb-preview-section">';
            html += '<h3>Core Objective Function</h3>';
            html += `<p><strong>Purpose:</strong> ${workflowState.data.cof.purpose || 'Not set'}</p>`;

            if (workflowState.data.cof.targetAudiences.length > 0) {
                html += `<p><strong>Target Audiences:</strong> ${workflowState.data.cof.targetAudiences.join(', ')}</p>`;
            }

            if (workflowState.data.cof.desiredActions.length > 0) {
                html += `<p><strong>Desired Actions:</strong> ${workflowState.data.cof.desiredActions.join(', ')}</p>`;
            }
            html += '</div>';

            // Add sections
            for (const [sectionId, sectionData] of Object.entries(workflowState.data.sections)) {
                const sectionTitle = sectionId.charAt(0).toUpperCase() + sectionId.slice(1);
                html += '<div class="kb-preview-section">';
                html += `<h3>${sectionTitle}</h3>`;
                html += `<p>${sectionData.content}</p>`;
                html += '</div>';
            }

            if (Object.keys(workflowState.data.sections).length === 0) {
                html += '<div class="kb-preview-section">';
                html += '<p class="kb-preview-empty">No knowledge base sections added yet. You can add them later.</p>';
                html += '</div>';
            }

            return html;
        }

        // Close preview modal
        window.closeKnowledgeBasePreview = function() {
            const modal = document.querySelector('.kb-preview-modal');
            if (modal) {
                modal.classList.remove('active');
                setTimeout(() => modal.remove(), 300);
            }
        };

        // Save knowledge base to Firestore
        window.saveKnowledgeBase = async function() {
            try {
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    throw new Error('Not authenticated');
                }

                // Show loading state
                const saveBtn = document.querySelector('.kb-btn-primary');
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.textContent = 'Saving...';
                }

                // Get ID token
                const idToken = await currentUser.getIdToken();

                // Step 1: Save knowledge base
                const kbResponse = await fetch('/api/link-knowledge-base', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({
                        cof: workflowState.data.cof,
                        sections: workflowState.data.sections
                    })
                });

                const kbData = await kbResponse.json();

                if (!kbData.success) {
                    throw new Error(kbData.error || 'Failed to save knowledge base');
                }

                // Step 2: Get current settings to check username
                const settingsResponse = await fetch('/api/link-settings', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${idToken}`
                    }
                });

                const settings = await settingsResponse.json();

                // Step 2.5: Claim username if not already set
                let username = settings.username;
                if (!username) {
                    console.log('[Workflow] No username found, claiming "alok"');
                    const claimResponse = await fetch('/api/username?action=claim', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            username: 'alok',
                            idToken: idToken
                        })
                    });

                    const claimData = await claimResponse.json();
                    if (!claimData.success) {
                        console.error('[Workflow] Failed to claim username:', claimData);
                        // Don't throw - user might have username set but settings didn't load
                        // They can fix it in settings later
                    } else {
                        console.log('[Workflow] Successfully claimed username:', claimData.username);
                        username = claimData.username;
                    }
                }

                // Step 3: Enable the public link
                const enableResponse = await fetch('/api/link-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({
                        linkEnabled: true
                    })
                });

                const enableData = await enableResponse.json();

                if (!enableData.success) {
                    throw new Error('Failed to enable public link');
                }

                // Close modal
                closeKnowledgeBasePreview();

                // Reset workflow state
                workflowState.active = false;
                workflowState.step = null;
                workflowState.data = {
                    cof: { purpose: '', targetAudiences: [], desiredActions: [] },
                    sections: {}
                };

                // Hide workflow indicator
                hideWorkflowIndicator();

            // Clear saved state
            clearWorkflowState();

                // Show success message with correct URL
                // Use the username variable from above (either from settings or newly claimed)
                const domain = window.location.hostname === 'localhost' ?
                    'http://localhost:3000' :
                    `https://${window.location.hostname}`;
                const publicLink = `${domain}/${username}`;

                const successMsg = ` **Your public link is now live!**

Knowledge base saved and link enabled successfully. Visitors will receive authentic, consistent information based on what you just set up.

**Your public link:** ${publicLink}

You can:
 Share this link with investors, customers, talent, media, etc.
 View or update your knowledge base in Settings
 I'll monitor visitor interactions and report back when important patterns emerge

${!settings.username ? '\n Note: You haven\'t set a username yet. Visit Settings to claim your custom username like "/yourname".\n' : ''}
Is there anything else you'd like to configure?`;

                await addWorkflowMessage('ai', successMsg);

            } catch (error) {
                console.error('Error saving knowledge base:', error);
                alert(`Failed to save: ${error.message}`);

                // Re-enable button
                const saveBtn = document.querySelector('.kb-btn-primary');
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = ' Approve & Save';
                }
            }
        };

        // Send Message
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message && !selectedFile) return;

            // Get current user
            const currentUser = auth.currentUser;
            if (!currentUser) {
                console.error('No user signed in');
                return;
            }

            // Remove empty state if present
            removeEmptyState();

            // Capture file info before clearing
            const fileToUpload = selectedFile;
            const fileDisplayName = selectedFile ? selectedFile.name : null;

            // Immediately clear input and file preview for better UX
            chatInput.value = '';
            if (selectedFile) {
                selectedFile = null;
                fileInput.value = '';
                filePreview.classList.remove('visible');
            }

            // Show user message immediately (with uploading indicator if file present)
            const userTimestamp = new Date();
            const uploadingIndicator = fileDisplayName ? `  ${fileDisplayName} ` : '';
            addMessage('user', message + uploadingIndicator, userTimestamp);

            // Handle file upload if present
            let fileUrl = null;
            let fileMetadata = null;
            if (fileToUpload) {
                try {
                    fileUrl = await uploadFile(fileToUpload);
                    fileMetadata = {
                        name: fileToUpload.name,
                        type: fileToUpload.type,
                        size: fileToUpload.size,
                        url: fileUrl
                    };

                    // Update the user message to show upload complete (replace  with )
                    const lastUserMessage = chatMessages.querySelector('.message.user:last-of-type .message-content');
                    if (lastUserMessage) {
                        lastUserMessage.innerHTML = lastUserMessage.innerHTML.replace(' ', ' ');
                    }

                    console.log('File uploaded successfully:', fileUrl);
                } catch (error) {
                    console.error('File upload failed:', error);
                    // Update message to show error
                    const lastUserMessage = chatMessages.querySelector('.message.user:last-of-type .message-content');
                    if (lastUserMessage) {
                        lastUserMessage.innerHTML = lastUserMessage.innerHTML.replace(' ', '  (upload failed)');
                    }
                    addMessage('assistant', 'Sorry, the file upload failed. Please try again.', new Date());
                    return;
                }
            }

            // Prepare message with file attachment if present
            let finalMessage = message;
            if (fileUrl) {
                finalMessage = `${message}\n\n[Attached file: ${fileMetadata.name}]\nFile URL: ${fileUrl}`;
            }

            // === WORKFLOW HANDLING ===
            // Log workflow state for debugging
            console.log('[Workflow] Current state:', {
                active: workflowState.active,
                step: workflowState.step,
                waitingForApproval: workflowState.waitingForApproval,
                message: message
            });

            // Check if workflow is active - BLOCK ALL REGULAR AI
            if (workflowState.active) {
                console.log('[Workflow] Workflow is active, handling message in workflow');
                // Handle workflow response
                await handleWorkflowResponse(message);
                return; // ALWAYS block regular AI when workflow is active
            }

            // Check if message triggers workflow
            if (!workflowState.active && detectWorkflowTrigger(message)) {
                console.log('[Workflow] Message triggers workflow, starting...');
                await startKnowledgeBaseWorkflow();
                return; // Don't send to regular AI
            }
            // === END WORKFLOW HANDLING ===

            console.log('[Workflow] Not in workflow mode, sending to regular AI');

            // Add to conversation history
            conversationHistory.push({
                role: 'user',
                content: finalMessage
            });

            // Save user message to Firestore (non-blocking)
            saveMessageToFirestore(currentUser.uid, 'user', finalMessage);

            // Show typing indicator
            showTypingIndicator();

            // Disable input while processing
            chatInput.disabled = true;
            sendButton.disabled = true;

            try {
                // Call API
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        messages: conversationHistory,
                        systemPrompt: systemPrompt,
                        userId: auth.currentUser.uid
                    }),
                });

                const data = await response.json();

                // Remove typing indicator
                removeTypingIndicator();

                if (data.success && data.content) {
                    // Add AI response to UI with timestamp
                    const aiTimestamp = new Date();
                    await addWorkflowMessage('ai', data.content, aiTimestamp);

                    // Add to conversation history
                    conversationHistory.push({
                        role: 'assistant',
                        content: data.content
                    });

                    // Save AI response to Firestore (non-blocking)
                    saveMessageToFirestore(currentUser.uid, 'assistant', data.content);
                } else {
                    throw new Error(data.error || 'Failed to get response');
                }
            } catch (error) {
                console.error('Error:', error);
                removeTypingIndicator();

                // Show error message with retry button
                const errorDiv = document.createElement('div');
                errorDiv.className = 'message ai';
                errorDiv.innerHTML = `
                    <div class="message-avatar"></div>
                    <div class="message-content">
                        <div class="error-message">
                            <div class="error-message-text">
                                Sorry, I encountered an error connecting. This might be a temporary issue.
                            </div>
                            <button class="retry-btn" onclick="retryLastMessage()">Retry</button>
                        </div>
                    </div>
                `;
                chatMessages.appendChild(errorDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } finally {
                // Re-enable input
                chatInput.disabled = false;
                sendButton.disabled = false;
                chatInput.focus();
            }
        }

        // Retry last message
        window.retryLastMessage = async function() {
            // Remove error message
            const errorMessages = chatMessages.querySelectorAll('.error-message');
            errorMessages.forEach(msg => msg.closest('.message').remove());

            // Get last user message
            const lastUserMessage = conversationHistory.filter(msg => msg.role === 'user').pop();
            if (!lastUserMessage) return;

            // Remove last message from history and retry
            conversationHistory.pop(); // Remove the user message we're retrying
            chatInput.value = lastUserMessage.content;
            await sendMessage();
        };

        // Event Listeners
        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Fix for Safari iOS keyboard covering input
        chatInput.addEventListener('focus', () => {
            setTimeout(() => {
                chatInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        });

        // Scroll to bottom when keyboard appears (iOS Safari)
        // Right panel toggle handler
        if (rightPanelToggle) {
            rightPanelToggle.addEventListener('click', () => {
                document.body.classList.toggle('right-panel-collapsed');
                // Save preference to localStorage
                const isCollapsed = document.body.classList.contains('right-panel-collapsed');
                localStorage.setItem('rightPanelCollapsed', isCollapsed);
            });

            // Restore saved preference
            const savedCollapsed = localStorage.getItem('rightPanelCollapsed');
            if (savedCollapsed === 'true') {
                document.body.classList.add('right-panel-collapsed');
            }
        }

        // File upload handlers
        attachButton.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                selectedFile = file;
                showFilePreview(file);
            }
        });

        removeFile.addEventListener('click', () => {
            selectedFile = null;
            fileInput.value = '';
            filePreview.classList.remove('visible');
        });

        function showFilePreview(file) {
            const fileSizeKB = (file.size / 1024).toFixed(2);
            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
            const sizeText = file.size < 1024 * 1024
                ? `${fileSizeKB} KB`
                : `${fileSizeMB} MB`;

            // Set icon based on file type
            const fileExt = file.name.split('.').pop().toLowerCase();
            let icon = '';
            if (['pdf'].includes(fileExt)) icon = '';
            else if (['png', 'jpg', 'jpeg', 'gif'].includes(fileExt)) icon = '';
            else if (['xlsx', 'xls', 'csv'].includes(fileExt)) icon = '';

            fileIcon.textContent = icon;
            fileName.textContent = file.name;
            fileSize.textContent = sizeText;
            filePreview.classList.add('visible');
        }

        async function uploadFile(file) {
            try {
                // Convert file to base64
                const reader = new FileReader();
                return new Promise((resolve, reject) => {
                    reader.onload = async () => {
                        try {
                            const base64File = reader.result.split(',')[1]; // Remove data:type;base64, prefix
                            const response = await fetch('/api/upload-document', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-User-ID': auth.currentUser.uid
                                },
                                body: JSON.stringify({
                                    file: base64File,
                                    filename: file.name,
                                    contentType: file.type,
                                    userId: auth.currentUser.uid
                                })
                            });

                            if (!response.ok) {
                                throw new Error('Upload failed');
                            }

                            const data = await response.json();
                            const fileUrl = data.url;

                            // Auto-process PDFs and Excel files
                            const fileExt = file.name.split('.').pop().toLowerCase();
                            if (['pdf', 'xlsx', 'xls', 'csv'].includes(fileExt)) {
                                console.log('[Upload] Processing document for Knowledge Base...');

                                // Show typing indicator while processing
                                if (typeof showTypingIndicator === 'function') {
                                    showTypingIndicator();
                                }

                                try {
                                    const processResponse = await fetch('/api/process-document', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            fileUrl: fileUrl,
                                            fileType: file.type,
                                            userId: auth.currentUser.uid,
                                            documentType: fileExt === 'pdf' ? 'pitch_deck' : 'financial_model'
                                        })
                                    });

                                    // Remove typing indicator
                                    if (typeof removeTypingIndicator === 'function') {
                                        removeTypingIndicator();
                                    }

                                    if (processResponse.ok) {
                                        const processData = await processResponse.json();
                                        console.log('[Upload] Document processed:', processData);

                                        // Show visible confirmation message
                                        const docType = processData.documentType === 'pitch_deck' ? 'Pitch Deck' : 'Financial Model';
                                        let summaryMsg = ` **${docType} processed successfully!**\n\n`;

                                        if (processData.summary) {
                                            if (processData.summary.pageCount) {
                                                summaryMsg += `- Pages: ${processData.summary.pageCount}\n`;
                                            }
                                            if (processData.summary.sectionsFound) {
                                                summaryMsg += `- Sections identified: ${processData.summary.sectionsFound}\n`;
                                            }
                                            if (processData.summary.sheetsFound) {
                                                summaryMsg += `- Sheets found: ${processData.summary.sheetsFound}\n`;
                                            }
                                            if (processData.summary.metricsExtracted) {
                                                summaryMsg += `- Financial metrics extracted: ${processData.summary.metricsExtracted}\n`;
                                            }
                                        }

                                        summaryMsg += `\nThis content is now available in your public MindClone link's knowledge base.`;

                                        // Add as system message to chat
                                        if (typeof addMessage === 'function') {
                                            addMessage('assistant', summaryMsg);
                                        }
                                    } else {
                                        const errorData = await processResponse.json().catch(() => ({}));
                                        console.warn('[Upload] Document processing failed:', errorData);
                                        if (typeof addMessage === 'function') {
                                            addMessage('assistant', ` File uploaded but processing failed: ${errorData.error || 'Unknown error'}. The file is stored but not yet in your knowledge base.`);
                                        }
                                    }
                                } catch (processError) {
                                    console.warn('[Upload] Document processing error:', processError);

                                    // Remove typing indicator on error too
                                    if (typeof removeTypingIndicator === 'function') {
                                        removeTypingIndicator();
                                    }

                                    if (typeof addMessage === 'function') {
                                        addMessage('assistant', ` File uploaded but processing encountered an error. The file is stored but may not be in your knowledge base.`);
                                    }
                                }
                            }

                            resolve(fileUrl);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            } catch (error) {
                console.error('File upload error:', error);
                throw error;
            }
        }

        // ============================================
        // NEW: Landing Page & Header Event Handlers
        // ============================================

        // Landing sign-in button
        const landingSignInBtn = document.getElementById('landingSignInBtn');
        if (landingSignInBtn) {
            landingSignInBtn.addEventListener('click', async () => {
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error('Sign-in error:', error);
                    console.error('Error code:', error.code);
                    console.error('Error message:', error.message);

                    let errorMessage = 'Failed to sign in. Please try again.';

                    // Provide specific error messages
                    if (error.code === 'auth/unauthorized-domain') {
                        errorMessage = 'This domain is not authorized for authentication. Please contact support.';
                    } else if (error.code === 'auth/popup-blocked') {
                        errorMessage = 'Sign-in popup was blocked. Please allow popups for this site.';
                    } else if (error.code === 'auth/popup-closed-by-user') {
                        errorMessage = 'Sign-in cancelled. Please try again.';
                    } else if (error.code === 'auth/cancelled-popup-request') {
                        errorMessage = 'Sign-in cancelled. Please try again.';
                    } else if (error.message) {
                        errorMessage = `Sign-in failed: ${error.message}`;
                    }

                    alert(errorMessage);
                }
            });
        }

        // Header avatar dropdown toggle
        const headerAvatar = document.getElementById('headerAvatar');
        const headerDropdown = document.getElementById('headerDropdown');
        if (headerAvatar && headerDropdown) {
            headerAvatar.addEventListener('click', (e) => {
                e.stopPropagation();
                headerDropdown.classList.toggle('hidden');
            });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const headerDropdown = document.getElementById('headerDropdown');
            const headerAvatar = document.getElementById('headerAvatar');
            if (headerDropdown && headerAvatar) {
                if (!headerDropdown.contains(e.target) && !headerAvatar.contains(e.target)) {
                    headerDropdown.classList.add('hidden');
                }
            }
        });

        // Activity button - open modal
        const activityBtn = document.getElementById('activityBtn');
        if (activityBtn) {
            activityBtn.addEventListener('click', () => {
                openActivityModal();
            });
        }

        // Activity modal close button
        const activityModalClose = document.getElementById('activityModalClose');
        if (activityModalClose) {
            activityModalClose.addEventListener('click', () => {
                closeActivityModal();
            });
        }

        // Activity modal overlay - close on click
        const activityModal = document.getElementById('activityModal');
        if (activityModal) {
            activityModal.addEventListener('click', (e) => {
                if (e.target.classList.contains('activity-modal-overlay') ||
                    e.target.id === 'activityModal') {
                    closeActivityModal();
                }
            });
        }

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const activityModal = document.getElementById('activityModal');
                if (activityModal && !activityModal.classList.contains('hidden')) {
                    closeActivityModal();
                }

                const headerDropdown = document.getElementById('headerDropdown');
                if (headerDropdown && !headerDropdown.classList.contains('hidden')) {
                    headerDropdown.classList.add('hidden');
                }
            }
        });

        // Header sign-out button
        const headerSignOutBtn = document.getElementById('headerSignOutBtn');
        if (headerSignOutBtn) {
            headerSignOutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    // Clear conversation history
                    conversationHistory = [];
                    chatMessages.innerHTML = '';
                    // Close dropdown
                    const headerDropdown = document.getElementById('headerDropdown');
                    if (headerDropdown) {
                        headerDropdown.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Sign-out error:', error);
                }
            });
        }

        // ============================================
        // Header Activity & Settings Buttons
        // ============================================

        // Activity button - opens activity modal
        const activityBtn = document.getElementById('activityBtn');
        if (activityBtn) {
            activityBtn.addEventListener('click', () => {
                openActivityModal();
            });
        }

        // Settings button - opens settings panel
        const settingsBtn = document.getElementById('settingsBtn');
        if (settingsBtn) {
            settingsBtn.addEventListener('click', () => {
                document.body.classList.remove('right-panel-collapsed');
            });
        }

        // Settings panel close button
        const settingsPanelClose = document.getElementById('settingsPanelClose');
        if (settingsPanelClose) {
            settingsPanelClose.addEventListener('click', () => {
                document.body.classList.add('right-panel-collapsed');
            });
        }

        // Settings overlay click to close
        const settingsOverlay = document.getElementById('settingsOverlay');
        if (settingsOverlay) {
            settingsOverlay.addEventListener('click', () => {
                document.body.classList.add('right-panel-collapsed');
            });
        }

        // ============================================
        // Helper Functions for Activity Modal
        // ============================================

        // Open activity modal
        function openActivityModal() {
            const activityModal = document.getElementById('activityModal');
            if (activityModal) {
                activityModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
                populateActivityModal();
            }
        }

        // Close activity modal
        function closeActivityModal() {
            const activityModal = document.getElementById('activityModal');
            if (activityModal) {
                activityModal.classList.add('hidden');
                document.body.style.overflow = ''; // Restore scrolling
            }
        }

        // Populate activity modal with data
        function populateActivityModal() {
            const modalActivityList = document.getElementById('modalActivityList');
            const modalActivityEmpty = document.getElementById('modalActivityEmpty');
            const modalActivityCount = document.getElementById('modalActivityCount');
            const modalTotalCount = document.getElementById('modalTotalCount');

            if (!modalActivityList) return;

            // Clear existing content
            modalActivityList.innerHTML = '';

            // Calculate stats
            const now = Date.now();
            const oneDayAgo = now - (24 * 60 * 60 * 1000);
            const todayCount = activityData.filter(activity => {
                const timestamp = activity.timestamp?.toMillis ? activity.timestamp.toMillis() : activity.timestamp;
                return timestamp > oneDayAgo;
            }).length;

            // Update stats
            if (modalActivityCount) {
                modalActivityCount.textContent = todayCount;
            }
            if (modalTotalCount) {
                modalTotalCount.textContent = activityData.length;
            }

            // Show empty state or activity list
            if (activityData.length === 0) {
                if (modalActivityEmpty) {
                    modalActivityEmpty.classList.remove('hidden');
                }
                modalActivityList.classList.add('hidden');
            } else {
                if (modalActivityEmpty) {
                    modalActivityEmpty.classList.add('hidden');
                }
                modalActivityList.classList.remove('hidden');

                // Render activity items (most recent first)
                const sortedActivities = [...activityData].sort((a, b) => {
                    const aTime = a.timestamp?.toMillis ? a.timestamp.toMillis() : a.timestamp;
                    const bTime = b.timestamp?.toMillis ? b.timestamp.toMillis() : b.timestamp;
                    return bTime - aTime;
                });

                sortedActivities.forEach(activity => {
                    const item = document.createElement('div');
                    item.className = 'modal-activity-item';

                    const timestamp = activity.timestamp?.toMillis ? activity.timestamp.toMillis() : activity.timestamp;
                    const timeAgo = formatTimestamp({ toDate: () => new Date(timestamp) });

                    item.innerHTML = `
                        <div class="modal-activity-icon"></div>
                        <div class="modal-activity-details">
                            <div class="modal-activity-message">${activity.lastMessage || 'Started a conversation'}</div>
                            <div class="modal-activity-time">${timeAgo}</div>
                        </div>
                    `;

                    modalActivityList.appendChild(item);
                });
            }
        }

        // Update activity badge count
        function updateActivityBadge() {
            // Calculate today's activity count
            const now = Date.now();
            const oneDayAgo = now - (24 * 60 * 60 * 1000);
            const todayCount = activityData.filter(activity => {
                const timestamp = activity.timestamp?.toMillis ? activity.timestamp.toMillis() : activity.timestamp;
                return timestamp > oneDayAgo;
            }).length;

            // Update right panel count
            if (rightActivityCount) {
                rightActivityCount.textContent = `${todayCount} today`;
            }

            // Update old sidebar count (if it exists)
            const activityCount = document.getElementById('activityCount');
            if (activityCount) {
                activityCount.textContent = `${todayCount} today`;
            }

            // Update tab badge
            if (activityBadge) {
                activityBadge.textContent = todayCount > 0 ? todayCount : '';
            }
        }

        // Handle URL hash for deep linking on page load
        window.addEventListener('load', handlePanelDeepLink);
    </script>
</body>
</html>
