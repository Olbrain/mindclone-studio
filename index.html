<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Mindclone - A record of the life only you lived.</title>
    <link rel="icon" type="image/png" href="/logo.png">

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2e2d32">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mindclone">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&display=swap');

        :root {
            /* Original Purple Theme (claude.ai style) */
            --bg: #2e2d32;
            --bg-surface: #333238;
            --bg-elevated: #39383e;
            --border: #494850;
            --border-hover: #59585f;

            /* Text */
            --text: #fafafa;
            --text-secondary: #a1a1a1;
            --text-muted: #666666;

            /* Purple Accent */
            --accent: #a78bfa;
            --accent-hover: #c4b5fd;
            --accent-muted: rgba(167, 139, 250, 0.15);

            /* Status */
            --error: #ef4444;
            --warning: #f59e0b;

            /* Legacy mappings for compatibility */
            --color-bg-primary: var(--bg);
            --color-bg-secondary: var(--bg-surface);
            --color-bg-tertiary: var(--bg-elevated);
            --color-bg-elevated: var(--bg-elevated);
            --color-accent-primary: var(--accent);
            --color-accent-secondary: var(--accent-hover);
            --color-accent-tertiary: #8B5CF6;
            --color-text-primary: var(--text);
            --color-text-secondary: var(--text-secondary);
            --color-text-tertiary: var(--text-secondary);
            --color-text-muted: var(--text-muted);
            --color-border-default: var(--border);
            --color-border-subtle: var(--border);
            --color-border-hover: var(--border-hover);
            --color-success: var(--accent);
            --color-success-light: var(--accent-hover);
            --color-error: var(--error);
            --color-warning: var(--warning);
            --color-info: var(--accent);
            --gradient-primary: var(--accent);
            --gradient-subtle: var(--bg-surface);
            --gradient-card: var(--bg-elevated);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--color-bg-primary);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }

        /* ==================== LANDING PAGE - LUXURIOUS SINGLE PAGE ==================== */
        .landing-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            background: linear-gradient(135deg, #2e2d32 0%, #333238 50%, #2e2d32 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            overflow: hidden;
            padding-top: env(safe-area-inset-top, 0);
            padding-bottom: env(safe-area-inset-bottom, 0);
            box-sizing: border-box;
        }

        .landing-page::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at 50% 0%, var(--accent-muted) 0%, transparent 50%);
            pointer-events: none;
        }

        .landing-page::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0.02;
            pointer-events: none;
        }

        .landing-content {
            position: relative;
            z-index: 1;
            width: 100%;
            max-width: 1000px;
            padding: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            animation: landingFadeIn 1s ease;
        }

        @keyframes landingFadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* Brand */
        .landing-brand {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .landing-logo-img {
            width: 160px;
            height: 160px;
            animation: logoFloat 4s ease-in-out infinite;
        }

        .landing-title {
            font-family: 'Playfair Display', serif;
            font-size: 88px;
            font-weight: 400;
            color: var(--text);
            letter-spacing: 24px;
            text-transform: uppercase;
            margin: 0;
        }

        /* Tagline */
        .landing-tagline {
            font-size: 22px;
            color: var(--text-secondary);
            font-weight: 300;
            letter-spacing: 1px;
            margin-bottom: 24px;
        }

        /* Elegant Divider */
        .landing-divider {
            width: 60px;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            margin-bottom: 48px;
        }

        /* Three Value Props */
        .landing-claims {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 28px;
            width: 100%;
            margin-bottom: 56px;
        }

        .claim-item {
            text-align: center;
            padding: 40px 28px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .claim-item:hover {
            border-color: rgba(167, 139, 250, 0.2);
            background: rgba(255, 255, 255, 0.04);
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        .claim-icon {
            font-size: 42px;
            margin-bottom: 20px;
            display: block;
            color: white;
            text-shadow: 0 0 30px rgba(167, 139, 250, 0.4);
        }

        .claim-title {
            font-family: 'Playfair Display', serif;
            font-size: 15px;
            font-weight: 500;
            color: var(--text);
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 14px;
        }

        .claim-text {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .claim-subtext {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 14px;
            font-style: italic;
        }

        /* CTA Section */
        .landing-cta {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 48px;
        }

        .landing-sign-in-btn {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            background: white;
            color: #2f2f2f;
            padding: 18px 52px;
            border: none;
            border-radius: 50px;
            font-size: 15px;
            font-weight: 600;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1);
        }

        .landing-sign-in-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 40px rgba(167, 139, 250, 0.3);
        }

        .landing-sign-in-btn .google-icon {
            width: 18px;
            height: 18px;
        }

        .landing-pricing {
            font-size: 13px;
            color: var(--text-muted);
            letter-spacing: 0.5px;
        }

        .landing-pricing strong {
            color: var(--text-secondary);
        }

        /* Footer */
        .landing-footer {
            position: absolute;
            bottom: 32px;
            left: 0;
            right: 0;
            text-align: center;
        }

        .landing-legal {
            font-size: 11px;
            color: var(--text-muted);
            letter-spacing: 1px;
            opacity: 0.6;
        }

        .landing-legal span {
            opacity: 0.5;
            margin: 0 10px;
        }

        /* ==================== APP HEADER ==================== */
        .app-header {
            display: none;
        }

        /* When right panel is collapsed */
        body.right-panel-collapsed .app-header {
            right: 0;
        }

        .app-header-left {
            display: none;
        }

        .header-logo {
            font-size: 32px;
            animation: logoFloat 4s ease-in-out infinite;
        }

        .header-title {
            font-size: 24px;
            font-weight: 700;
            color: white;
            letter-spacing: -0.5px;
        }

        .app-header-right {
            display: flex;
            align-items: center;
            gap: 0;
        }

        .header-icon-btn {
            position: relative;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.3s ease;
        }

        .header-icon-btn:hover {
            background: #39383e;
        }

        .activity-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--color-accent-primary);
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .header-user-menu {
            position: relative;
        }

        .header-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid #333;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .header-avatar:hover {
            border-color: var(--color-accent-primary);
            transform: scale(1.05);
        }

        .header-dropdown {
            position: absolute;
            top: calc(100% + 12px);
            right: 0;
            background: #39383e;
            border: 1px solid #333;
            border-radius: 12px;
            min-width: 260px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
            z-index: 1000;
            animation: dropdownSlideIn 0.2s ease;
        }

        @keyframes dropdownSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header-dropdown-header {
            padding: 16px;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .dropdown-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
        }

        .dropdown-user-info {
            flex: 1;
            min-width: 0;
                        display: flex;
                        align-items: center;
                        gap: 8px;
        }

        .dropdown-user-name {
            color: white;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dropdown-user-email {
            color: #999;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dropdown-divider {
            border: none;
            border-top: 1px solid #333;
            margin: 0;
        }

        .header-dropdown-item {
            width: 100%;
            padding: 12px 16px;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            transition: background 0.3s ease;
            text-decoration: none;
        }

        .header-dropdown-item:last-child {
            border-radius: 0 0 12px 12px;
        }

        .header-dropdown-item:hover {
            background: #29282e;
        }

        .dropdown-icon {
            font-size: 18px;
        }

        /* ==================== ACTIVITY MODAL ==================== */
        /* Alpha: Link features hidden - will be enabled in Max plan */
        .activity-modal {
            display: none !important; /* Alpha: Link features hidden */
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9998;
            align-items: center;
            justify-content: center;
        }

        .activity-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
        }

        @supports not (backdrop-filter: blur(8px)) {
            .activity-modal-overlay {
                background: rgba(0, 0, 0, 0.95);
            }
        }

        .activity-modal-content {
            position: relative;
            z-index: 1;
            background: #39383e;
            border: 1px solid #333;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.8);
            animation: modalSlideUp 0.3s ease;
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .activity-modal-header {
            padding: 24px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .activity-modal-title {
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }

        .activity-icon {
            font-size: 32px;
        }

        .activity-modal-title h2 {
            font-size: 24px;
            margin-bottom: 8px;
            color: white;
        }

        .activity-link {
            color: var(--color-accent-primary);
            font-size: 14px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: opacity 0.3s ease;
        }

        .activity-link:hover {
            opacity: 0.8;
        }

        .modal-close-btn {
            background: none;
            border: none;
            color: #999;
            font-size: 40px;
            cursor: pointer;
            line-height: 1;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .modal-close-btn:hover {
            background: #29282e;
            color: white;
        }

        /* Feedback Modal */
        .feedback-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .feedback-modal.visible {
            display: flex;
        }

        .feedback-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
        }

        .feedback-modal-content {
            position: relative;
            z-index: 1;
            background: var(--card-bg, #39383e);
            border: 1px solid var(--color-border-default, #333);
            border-radius: 16px;
            width: 90%;
            max-width: 480px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.8);
            animation: modalSlideUp 0.3s ease;
        }

        .feedback-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--color-border-default, #333);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .feedback-modal-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary, white);
        }

        .feedback-modal-body {
            padding: 24px;
        }

        .feedback-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--color-border-default, #333);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Feedback Form Elements */
        .feedback-form-group {
            margin-bottom: 20px;
        }

        .feedback-form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .feedback-screenshot-preview {
            width: 100%;
            height: 160px;
            background: #29282e;
            border: 1px solid var(--color-border-default, #333);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .feedback-screenshot-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .screenshot-placeholder {
            color: rgba(255, 255, 255, 0.4);
            font-size: 14px;
        }

        .feedback-retake-btn {
            background: transparent;
            border: 1px solid var(--color-border-default, #333);
            color: rgba(255, 255, 255, 0.7);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
        }

        .feedback-retake-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .feedback-select {
            width: 100%;
            padding: 12px;
            background: #29282e;
            border: 1px solid var(--color-border-default, #333);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }

        .feedback-select:focus {
            outline: none;
            border-color: var(--color-accent-primary);
        }

        .feedback-textarea {
            width: 100%;
            padding: 12px;
            background: #29282e;
            border: 1px solid var(--color-border-default, #333);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
            min-height: 100px;
        }

        .feedback-textarea:focus {
            outline: none;
            border-color: var(--color-accent-primary);
        }

        .feedback-textarea::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .feedback-char-count {
            text-align: right;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 4px;
        }

        .feedback-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .feedback-btn-secondary {
            background: transparent;
            border: 1px solid var(--color-border-default, #333);
            color: rgba(255, 255, 255, 0.7);
        }

        .feedback-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .feedback-btn-primary {
            background: var(--color-accent-primary);
            color: white;
        }

        .feedback-btn-primary:hover {
            filter: brightness(1.1);
        }

        .feedback-btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .feedback-success {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px;
            background: rgba(34, 197, 94, 0.1);
            border-top: 1px solid rgba(34, 197, 94, 0.2);
            color: #22c55e;
            font-size: 14px;
        }

        .success-icon {
            width: 20px;
            height: 20px;
            background: #22c55e;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        /* Feedback Admin List Styles */
        .feedback-scroll-container {
            padding: 16px;
            overflow-y: auto;
            height: 100%;
        }

        .feedback-filters {
            margin-bottom: 12px;
        }

        .feedback-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .feedback-empty {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255, 255, 255, 0.5);
        }

        .feedback-empty .icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .feedback-empty .message {
            font-size: 14px;
            line-height: 1.5;
        }

        .feedback-card {
            background: #29282e;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 16px;
            position: relative;
        }

        .feedback-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .feedback-type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .feedback-type-badge.bug {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .feedback-type-badge.feature {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .feedback-type-badge.other {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }

        .feedback-status-select {
            padding: 4px 8px;
            font-size: 12px;
            background: #1a191e;
            border: 1px solid #333;
            border-radius: 6px;
            color: white;
            cursor: pointer;
        }

        .feedback-message {
            font-size: 14px;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 12px;
        }

        .feedback-meta {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 12px;
        }

        .feedback-screenshot-thumb {
            width: 100%;
            max-width: 200px;
            border-radius: 8px;
            border: 1px solid #333;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .feedback-screenshot-thumb:hover {
            transform: scale(1.02);
        }

        .activity-modal-stats {
            display: flex;
            gap: 16px;
            padding: 24px;
            border-bottom: 1px solid #333;
        }

        .stat-card {
            flex: 1;
            background: #29282e;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--color-accent-primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .activity-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .modal-activity-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .modal-activity-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .modal-activity-empty .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .modal-activity-empty h3 {
            font-size: 20px;
            margin-bottom: 12px;
            color: white;
        }

        .modal-activity-empty p {
            color: #999;
            font-size: 14px;
            margin-bottom: 24px;
            max-width: 300px;
        }

        .btn-primary {
            display: inline-block;
            padding: 12px 24px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            box-shadow: 0 0 20px rgba(124, 102, 220, 0.25);
            transform: translateY(-2px);
        }

        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            margin-top: 0;
        }

        /* Account Sidebar */
        .account-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 64px;
            background: var(--color-bg-primary);
            border-right: 1px solid var(--color-border-default);
            display: flex;
            flex-direction: column;
            z-index: 90;
        }

        .account-sidebar-content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .account-avatar-container {
            padding: 12px;
            display: flex;
            justify-content: center;
        }

        .account-sidebar-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #333;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .account-sidebar-avatar:hover {
            border-color: var(--color-accent-primary);
            transform: scale(1.1);
        }

        .account-menu {
            position: fixed;
            left: 72px;
            top: 12px;
            background: #39383e;
            border: 1px solid #333;
            border-radius: 12px;
            min-width: 280px;
            padding: 16px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 1000;
        }

        .account-avatar-container:hover ~ .account-menu,
        .account-menu:hover {
            opacity: 1;
            pointer-events: auto;
        }

        .account-profile {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 16px;
        }

        .account-menu-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #333;
        }

        .account-menu-info {
            flex: 1;
            min-width: 0;
        }

        .account-menu-name {
            font-size: 15px;
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
        }

        .account-menu-email {
            font-size: 13px;
            color: #999;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .account-menu-button {
            width: 100%;
            padding: 12px;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .account-menu-button:hover {
            background: var(--bg-elevated);
            color: var(--text);
            border-color: var(--border-hover);
        }

        /* Account Billing Section */
        .account-billing-section {
            padding: 12px 0;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            margin: 12px 0;
        }

        .account-plan-info .plan-card {
            padding: 8px 12px;
            background: var(--bg-surface);
            border-radius: 8px;
            text-align: center;
            margin-bottom: 8px;
        }

        .account-plan-info .plan-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
        }

        .account-plan-info .plan-status {
            font-size: 11px;
            color: var(--text-muted);
            display: block;
            margin-top: 2px;
        }

        .account-grandfathered {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px;
            background: var(--bg-surface);
            border-radius: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .account-upgrade-btn,
        .account-manage-btn {
            width: 100%;
            padding: 10px;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .account-upgrade-btn:hover,
        .account-manage-btn:hover {
            background: var(--bg-elevated);
            color: var(--text);
            border-color: var(--border-hover);
        }

        /* Knowledge Base Section */
        .account-kb-section {
            padding: 12px 0;
            border-top: 1px solid var(--border);
            margin-top: 8px;
        }

        .kb-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .kb-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .kb-count {
            font-size: 11px;
            background: var(--bg-elevated);
            color: var(--text-muted);
            padding: 2px 6px;
            border-radius: 10px;
        }

        .kb-file-list {
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 8px;
        }

        .kb-file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 8px;
            background: var(--bg-surface);
            border-radius: 6px;
            margin-bottom: 4px;
            font-size: 11px;
        }

        .kb-file-info {
            display: flex;
            align-items: center;
            gap: 6px;
            overflow: hidden;
            flex: 1;
        }

        .kb-file-icon {
            font-size: 14px;
            flex-shrink: 0;
        }

        .kb-file-name {
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .kb-file-delete {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 2px 4px;
            font-size: 12px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .kb-file-delete:hover {
            opacity: 1;
            color: #f44336;
        }

        .kb-upload-btn {
            width: 100%;
            padding: 8px;
            background: var(--bg-surface);
            border: 1px dashed var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .kb-upload-btn:hover {
            background: var(--bg-elevated);
            border-color: var(--border-hover);
            color: var(--text);
        }

        .kb-upload-btn.uploading {
            opacity: 0.6;
            cursor: wait;
        }

        .kb-hint {
            font-size: 10px;
            color: var(--text-muted);
            text-align: center;
            margin-top: 6px;
        }

        .kb-empty {
            text-align: center;
            color: var(--text-muted);
            font-size: 11px;
            padding: 8px;
        }

        /* ===========================================
           COLLAPSIBLE LEFT PANEL
           =========================================== */
        .left-panel {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 260px;
            background: var(--color-bg-primary);
            border-right: 1px solid var(--color-border-default);
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: width 0.3s ease;
        }

        .left-panel.collapsed {
            width: 56px;
        }

        .left-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid var(--color-border-default);
            flex-shrink: 0; /* Prevent header from shrinking */
        }

        .left-panel-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            overflow: hidden;
        }

        .left-panel-logo {
            width: 28px;
            height: 28px;
            flex-shrink: 0;
        }

        .left-panel-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.2s ease;
        }

        .left-panel.collapsed .left-panel-title {
            opacity: 0;
            width: 0;
        }

        .left-panel-toggle {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .left-panel-toggle:hover {
            background: var(--color-bg-elevated);
            color: var(--text);
        }

        .left-panel-toggle svg {
            width: 18px;
            height: 18px;
            transition: transform 0.3s ease;
        }

        .left-panel.collapsed .left-panel-toggle svg {
            transform: rotate(180deg);
        }

        .left-panel.collapsed .left-panel-header {
            justify-content: center;
            padding: 16px 8px;
        }

        .left-panel.collapsed .left-panel-brand {
            display: none;
        }

        /* Trial Countdown Banner */
        .trial-countdown-banner {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.15) 0%, rgba(234, 179, 8, 0.05) 100%);
            border-bottom: 1px solid rgba(234, 179, 8, 0.2);
            cursor: pointer;
            transition: background 0.2s;
        }

        .trial-countdown-banner:hover {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.2) 0%, rgba(234, 179, 8, 0.1) 100%);
        }

        .trial-countdown-icon {
            flex-shrink: 0;
        }

        .trial-countdown-icon svg {
            width: 18px;
            height: 18px;
            color: #eab308;
        }

        .trial-countdown-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .trial-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(234, 179, 8, 0.9);
        }

        .trial-days {
            font-size: 13px;
            font-weight: 500;
            color: #eab308;
        }

        .trial-upgrade-btn {
            margin-left: auto;
            padding: 4px 12px;
            background: linear-gradient(135deg, #eab308, #ca8a04);
            color: #000;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .trial-upgrade-btn:hover {
            background: linear-gradient(135deg, #fbbf24, #eab308);
            transform: scale(1.02);
        }

        .trial-countdown-banner.urgent .trial-countdown-icon svg {
            color: #ef4444;
        }

        .trial-countdown-banner.urgent {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(239, 68, 68, 0.05) 100%);
            border-bottom-color: rgba(239, 68, 68, 0.2);
        }

        .trial-countdown-banner.urgent .trial-label {
            color: rgba(239, 68, 68, 0.9);
        }

        .left-panel.collapsed .trial-countdown-banner {
            display: none;
        }

        /* Panel Content */
        .left-panel-content {
            flex: 1 1 0; /* flex-grow: 1, flex-shrink: 1, flex-basis: 0 - forces proper size calculation */
            min-height: 0; /* Required for flex child overflow to work */
            height: 0; /* Force height from flex, enables overflow to work */
            overflow-y: auto;
            overflow-x: hidden;
            padding-bottom: 100px; /* Extra padding to ensure submit button isn't covered by footer */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        /* Panel Sections */
        .left-panel-section {
            padding: 12px;
            border-bottom: 1px solid var(--color-border-default);
        }

        .left-panel-section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 4px;
            color: var(--text-secondary);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .left-panel-section-icon {
            font-size: 14px;
        }

        .left-panel-section-title {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
        }

        .left-panel.collapsed .left-panel-section-title {
            display: none;
        }

        .left-panel.collapsed .left-panel-section-header {
            justify-content: center;
            padding: 8px 0;
        }

        /* History Search */
        .history-search {
            margin-bottom: 8px;
        }

        .history-search-input {
            width: 100%;
            padding: 8px 12px;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border-default);
            border-radius: 8px;
            color: var(--text);
            font-size: 13px;
        }

        .history-search-input::placeholder {
            color: var(--text-muted);
        }

        .history-search-input:focus {
            outline: none;
            border-color: var(--color-accent-primary);
        }

        .left-panel.collapsed .history-search {
            display: none;
        }

        /* Conversation List */
        .conversation-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
            max-height: 300px;
            overflow-y: auto;
        }

        .conversation-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: none;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
            text-align: left;
            width: 100%;
        }

        .conversation-item:hover {
            background: var(--color-bg-elevated);
        }

        .conversation-item.active {
            background: var(--color-bg-elevated);
            border-left: 2px solid var(--color-accent-primary);
        }

        .conversation-icon {
            font-size: 16px;
            flex-shrink: 0;
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .conversation-title {
            font-size: 13px;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-date {
            font-size: 11px;
            color: var(--text-muted);
        }

        .left-panel.collapsed .conversation-info {
            display: none;
        }

        .left-panel.collapsed .conversation-item {
            justify-content: center;
            padding: 10px;
        }

        /* Panel KB Section */
        .panel-kb-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-height: 200px;
            overflow-y: auto;
        }

        .panel-kb-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: var(--color-bg-elevated);
            border-radius: 6px;
            font-size: 12px;
        }

        .panel-kb-icon {
            font-size: 14px;
        }

        .panel-kb-name {
            flex: 1;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .panel-kb-delete {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .panel-kb-item:hover .panel-kb-delete {
            opacity: 1;
        }

        .panel-kb-delete:hover {
            color: #ef4444;
        }

        .left-panel.collapsed .panel-kb-name,
        .left-panel.collapsed .panel-kb-delete {
            display: none;
        }

        .panel-upload-btn {
            width: 100%;
            padding: 8px 12px;
            background: var(--color-bg-elevated);
            border: 1px dashed var(--color-border-default);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-top: 8px;
        }

        .panel-upload-btn:hover {
            border-color: var(--color-accent-primary);
            color: var(--color-accent-primary);
        }

        .left-panel.collapsed .panel-upload-btn span:last-child {
            display: none;
        }

        /* Hide KB list and upload button completely when collapsed */
        .left-panel.collapsed .panel-kb-list,
        .left-panel.collapsed .panel-upload-btn,
        .left-panel.collapsed .kb-count {
            display: none;
        }

        /* Panel Footer (Account) */
        .left-panel-footer {
            flex-shrink: 0; /* Prevent footer from shrinking */
            padding: 12px;
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
            border-top: 1px solid var(--color-border-default);
        }

        .panel-account {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .panel-account:hover {
            background: var(--color-bg-elevated);
        }

        .panel-account-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--color-border-default);
            flex-shrink: 0;
        }

        .panel-account-info {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .panel-account-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .panel-account-email {
            font-size: 11px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .left-panel.collapsed .panel-account-info {
            display: none;
        }

        .left-panel.collapsed .panel-account {
            justify-content: center;
            padding: 8px;
        }

        /* Account Dropdown (from panel) */
        .panel-account-dropdown {
            position: absolute;
            bottom: 70px;
            left: 12px;
            right: 12px;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border-default);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            z-index: 200;
            padding: 8px;
        }

        .panel-account-dropdown.hidden {
            display: none;
        }

        .panel-dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: none;
            border: none;
            border-radius: 8px;
            color: var(--text);
            font-size: 13px;
            cursor: pointer;
            width: 100%;
            text-align: left;
            transition: background 0.2s;
        }

        .panel-dropdown-item:hover {
            background: var(--color-bg-primary);
        }

        .panel-dropdown-divider {
            height: 1px;
            background: var(--color-border-default);
            margin: 4px 0;
        }

        /* Adjust main content for left panel */
        .main-content {
            margin-left: 260px;
            transition: margin-left 0.3s ease;
        }

        .left-panel.collapsed ~ .main-content {
            margin-left: 56px;
        }

        /* Sidebar - Hidden by default */
        .sidebar {
            width: 220px;
            background: #39383e;
            border-left: 1px solid #333;
            display: none;
            flex-direction: column;
            overflow-y: auto;
            order: 2;
        }

        /* Right Activity Panel - Full height fixed */
        .right-activity-panel {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 360px;
            background: var(--color-bg-secondary);
            border-left: 1px solid var(--color-border-default);
            display: none; /* Hidden by default, shown via JS */
            flex-direction: column;
            overflow: hidden;
            z-index: 101;
            transition: transform 0.3s ease;
        }

        /* Collapsed state */
        body.right-panel-collapsed .right-activity-panel {
            transform: translateX(100%);
        }

        /* Toggle button for right panel */
        .right-panel-toggle {
            position: fixed;
            top: 50%;
            right: 360px;
            transform: translateY(-50%);
            width: 24px;
            height: 48px;
            background: #39383e;
            border: 1px solid #333;
            border-right: none;
            border-radius: 8px 0 0 8px;
            color: #888;
            cursor: pointer;
            display: none; /* Hidden by default, shown when panel is open */
            align-items: center;
            justify-content: center;
            z-index: 102;
            transition: all 0.3s ease;
        }

        .right-panel-toggle.visible {
            display: flex;
        }

        .right-panel-toggle:hover {
            background: #29282e;
            color: white;
        }

        body.right-panel-collapsed .right-panel-toggle {
            right: 0 !important;
            display: flex !important; /* Show toggle when collapsed so user can re-open */
        }

        .right-panel-toggle .toggle-icon {
            font-size: 14px;
            transition: transform 0.3s ease;
        }

        body.right-panel-collapsed .right-panel-toggle .toggle-icon {
            transform: rotate(180deg);
        }

        .right-activity-panel .activity-feed {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Right Panel User Section */
        .right-panel-user {
            display: none !important;
        }

        .right-panel-user .header-user-menu {
            position: relative;
        }

        .right-panel-user .header-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #333;
            cursor: pointer;
            transition: all 0.3s ease;
            object-fit: cover;
            display: block;
        }

        .right-panel-user .header-avatar:hover {
            border-color: var(--color-accent-primary);
            transform: scale(1.05);
        }

        /* Right Panel Header */
        .right-panel-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--color-bg-primary);
            border-bottom: 1px solid var(--color-border-default);
        }

        .right-panel-close {
            margin-left: auto;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .right-panel-close:hover {
            background: var(--color-bg-elevated);
            color: var(--text);
        }

        .panel-header-icon {
            font-size: 16px;
            opacity: 0.7;
        }

        .panel-header-title {
            font-size: 13px;
            font-weight: 500;
            color: #999;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

        /* Panel Tab Navigation */
        .panel-tabs {
            display: flex;
            background: var(--color-bg-primary);
            border-bottom: 1px solid var(--color-border-default);
            padding: 0;
        }

        .panel-tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 10px 8px;
            background: transparent;
            border: none;
            border-bottom: 1px solid transparent;
            color: var(--color-text-tertiary);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .panel-tab:hover {
            background: rgba(124, 102, 220, 0.05);
            color: #aaa;
        }

        .panel-tab.active {
            color: white;
            border-bottom-color: var(--color-accent-primary);
            background: transparent;
        }

        .panel-tab .tab-icon {
            font-size: 18px;
            opacity: 0.8;
        }

        .panel-tab .tab-label {
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .panel-tab .tab-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ff6b6b;
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .panel-tab .tab-badge:empty {
            display: none;
        }

        /* Panel Content Container */
        .panel-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-tab-content {
            display: none;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        .panel-tab-content.active {
            display: flex;
        }

        .settings-scroll-container,
        .analytics-scroll-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px;
        }

        .settings-scroll-container::-webkit-scrollbar,
        .analytics-scroll-container::-webkit-scrollbar {
            width: 6px;
        }

        .settings-scroll-container::-webkit-scrollbar-track,
        .analytics-scroll-container::-webkit-scrollbar-track {
            background: #39383e;
        }

        .settings-scroll-container::-webkit-scrollbar-thumb,
        .analytics-scroll-container::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        .settings-scroll-container::-webkit-scrollbar-thumb:hover,
        .analytics-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #444;
        }

        /* Feedback Tab Styles */
        .feedback-scroll-container {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            padding-right: 8px;
        }

        .feedback-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .screenshot-container {
            margin-top: 8px;
        }

        .screenshot-preview {
            position: relative;
            margin-bottom: 12px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #444;
        }

        .screenshot-preview img {
            width: 100%;
            height: auto;
            display: block;
        }

        .remove-screenshot-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-screenshot-btn:hover {
            background: rgba(255, 0, 0, 1);
        }

        .panel-button-secondary {
            background: transparent;
            border: 1px solid #555;
            color: #ccc;
        }

        .panel-button-secondary:hover {
            background: #444;
            border-color: #666;
        }

        .feedback-success {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            margin-top: 12px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 8px;
            color: #22c55e;
            font-size: 14px;
        }

        .feedback-success .success-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #22c55e;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        /* Panel Sections */
        .panel-section {
            background: #39383e;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .panel-section-title {
            font-size: 16px;
            font-weight: 700;
            color: white;
            margin-bottom: 6px;
        }

        .panel-section-subtitle {
            font-size: 12px;
            color: #999;
            margin-bottom: 16px;
        }

        /* User Profile Card */
        .user-profile-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: #2f2f2f;
            border: 1px solid #333;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .user-profile-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #333;
        }

        .user-profile-info {
            flex: 1;
            min-width: 0;
        }

        .user-profile-name {
            font-size: 15px;
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
        }

        .user-profile-email {
            font-size: 13px;
            color: #999;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Form Groups */
        .panel-form-group {
            margin-bottom: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        .panel-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: white;
            margin-bottom: 6px;
        }

        .panel-hint {
            display: block;
            font-size: 11px;
            color: #666;
            margin-bottom: 8px;
        }

        /* Input Fields */
        .panel-input,
        .panel-textarea,
        .panel-select {
            width: 100%;
            padding: 12px;
            background: #0d0d0d;
            border: 1px solid #333;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s ease;
            font-family: inherit;
            box-sizing: border-box;
        }

        .panel-input:focus,
        .panel-textarea:focus,
        .panel-select:focus {
            border-color: #555;
        }

        .panel-textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Username Input Group */
        .username-input-group {
            display: flex;
            align-items: center;
            background: #0d0d0d;
            border: 1px solid #333;
            border-radius: 8px;
            overflow: hidden;
            width: 100%;
            box-sizing: border-box;
        }

        .username-input-group:focus-within {
            border-color: #555;
        }

        .username-prefix {
            padding: 12px;
            color: #666;
            font-size: 13px;
            background: #39383e;
            border-right: 1px solid #333;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .username-input {
            flex: 1;
            min-width: 0;
            padding: 12px;
            background: transparent;
            border: none;
            color: white;
            font-size: 14px;
            outline: none;
        }

        .username-status {
            margin-top: 8px;
            min-height: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .availability-indicator {
            font-size: 12px;
            font-weight: 600;
        }

        .availability-indicator.available {
            color: var(--color-accent-primary);
        }

        .availability-indicator.taken {
            color: #ff6b6b;
        }

        .availability-indicator.checking {
            color: #666;
        }

        .availability-indicator.invalid {
            color: #ff6b6b;
        }

        .username-delete-btn {
            padding: 4px 12px;
            background: transparent;
            color: #666;
            border: 1px solid #444;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .username-delete-btn:hover {
            background: rgba(255, 107, 107, 0.1);
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        .username-delete-btn .button-icon {
            font-size: 12px;
        }

        /* Buttons */
        .panel-button {
            width: 100%;
            padding: 12px 20px;
            background: #29282e;
            color: white;
            border: 1px solid #333;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .panel-button:hover {
            background: #333;
            transform: translateY(-1px);
        }

        .panel-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .panel-button-primary {
            background: white;
            color: black;
            border: none;
        }

        .panel-button-primary:hover {
            background: #f0f0f0;
        }

        .panel-button-danger {
            background: transparent;
            border: none;
            color: var(--color-text-muted);
            font-size: 12px;
            padding: 8px 0;
            text-decoration: underline;
            font-weight: 400;
        }

        .panel-button-danger:hover {
            color: var(--color-error);
            background: transparent;
        }

        .username-delete-icon {
            padding: 8px;
            cursor: pointer;
            color: var(--color-text-muted);
            font-size: 16px;
            display: none;
            transition: color 0.2s ease;
            background: transparent;
            border: none;
            outline: none;
            flex-shrink: 0;
            width: 32px;
            height: 32px;
        }

        .username-delete-icon:hover {
            color: var(--color-error);
        }

        .username-delete-icon.visible {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .panel-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .switch-to-settings-btn {
            padding: 10px 20px;
            background: #29282e;
            color: white;
            border: 1px solid #333;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .switch-to-settings-btn:hover {
            background: #333;
        }

        /* Alerts */
        .panel-alert-container {
            margin-bottom: 16px;
        }

        .panel-alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 12px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .panel-alert.success {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid var(--color-accent-primary);
            color: var(--color-accent-primary);
        }

        .panel-alert.error {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid #ff6b6b;
            color: #ff6b6b;
        }

        .panel-alert.warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid #FFC107;
            color: #FFC107;
        }

        /* Toggle Switch (reused from settings.html) */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #2a2a2a;
            transition: .4s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--color-accent-primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        /* Character Count */
        .char-count {
            text-align: right;
            font-size: 11px;
            color: #666;
            margin-top: 4px;
        }

        /* Link Preview */
        .link-preview {
            background: #0d0d0d;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .link-url {
            font-size: 13px;
            color: white;
            font-weight: 600;
            word-break: break-all;
        }

        .link-url a {
            color: var(--color-accent-primary);
            text-decoration: none;
        }

        .link-url a:hover {
            text-decoration: underline;
        }

        .copy-btn {
            padding: 8px 16px;
            background: #29282e;
            color: white;
            border: 1px solid #333;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: #333;
        }

        .copy-btn.copied {
            background: var(--color-accent-primary);
            border-color: var(--color-accent-primary);
        }

        /* Stats Grid (Analytics Tab) */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: #0d0d0d;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: white;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Recent Visitors */
        .recent-visitors-section {
            margin-top: 24px;
        }

        .subsection-title {
            font-size: 14px;
            font-weight: 600;
            color: white;
            margin-bottom: 12px;
        }

        .recent-visitors-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .recent-visitor-item {
            background: #0d0d0d;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .recent-visitor-item:hover {
            background: #39383e;
            border-color: #444;
        }

        .recent-visitor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .recent-visitor-id {
            font-size: 12px;
            font-weight: 600;
            color: white;
        }

        .recent-visitor-count {
            font-size: 11px;
            color: #999;
        }

        .recent-visitor-time {
            font-size: 11px;
            color: #666;
        }

        /* Analytics Filters */
        .analytics-filters {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #333;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #333;
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ==================== KNOWLEDGE BASE STYLES ==================== */

        .knowledge-base-list {
            margin: 20px 0;
            min-height: 100px;
        }

        .knowledge-base-empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #ccc;
        }

        .empty-hint {
            font-size: 12px;
            color: #666;
            line-height: 1.5;
        }

        .knowledge-base-item {
            background: #0d0d0d;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 12px 14px;
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            transition: all 0.3s ease;
        }

        .knowledge-base-item:hover {
            border-color: #555;
            background: #39383e;
        }

        .kb-file-icon {
            font-size: 24px;
            flex-shrink: 0;
            padding-top: 1px;
        }

        .kb-file-info {
            flex: 1;
            min-width: 0;
        }

        .kb-file-name {
            font-size: 13px;
            font-weight: 600;
            color: white;
            margin-bottom: 8px;
            word-break: break-word;
            line-height: 1.4;
        }

        .kb-file-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 6px 10px;
            font-size: 11px;
            color: #777;
            align-items: center;
        }

        .kb-file-size,
        .kb-file-date {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .kb-file-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .kb-file-status.ready {
            background: rgba(46, 213, 115, 0.1);
            color: var(--color-accent-primary);
        }

        .kb-file-status.processing {
            background: rgba(255, 159, 67, 0.1);
            color: #ff9f43;
        }

        .kb-file-actions {
            display: inline-flex;
            gap: 4px;
            margin-left: auto;
        }

        .kb-action-btn {
            width: 22px;
            height: 22px;
            padding: 0;
            background: transparent;
            border: 1px solid #444;
            border-radius: 4px;
            color: #666;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .kb-action-btn:hover {
            background: #29282e;
            border-color: #666;
            color: white;
        }

        .kb-action-btn.delete:hover {
            background: rgba(255, 107, 107, 0.1);
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        .kb-action-btn.view:hover {
            background: rgba(74, 144, 226, 0.1);
            border-color: #4a90e2;
            color: #4a90e2;
        }

        .button-icon {
            font-size: 14px;
        }

        .sidebar-header {
            padding: 30px 20px;
            text-align: center;
            border-bottom: 1px solid #333;
        }

        .sidebar-header .logo {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .sidebar-header h1 {
            color: white;
            margin-bottom: 5px;
            font-size: 24px;
        }

        .sidebar-header .tagline {
            color: #999;
            font-size: 14px;
        }

        .settings-link {
            display: inline-block;
            margin-top: 15px;
            padding: 8px 16px;
            background: #29282e;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            border: 1px solid #333;
        }

        .settings-link:hover {
            background: #333;
        }

        /* Sidebar Spacer */
        .sidebar-spacer {
            flex: 1;
        }

        /* Sidebar Footer */
        .sidebar-footer {
            border-top: 1px solid #333;
        }

        /* Sidebar Auth (Sign In Section) */
        .sidebar-auth {
            padding: 20px;
            text-align: center;
        }

        .sidebar-auth h2 {
            color: white;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .sidebar-auth p {
            color: #999;
            margin-bottom: 20px;
            font-size: 13px;
            line-height: 1.6;
        }

        .google-sign-in-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: white;
            color: black;
            padding: 12px 20px;
            border: 1px solid #333;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .google-sign-in-btn:hover {
            background: #f0f0f0;
        }

        .google-icon {
            width: 20px;
            height: 20px;
        }

        /* Sidebar Profile (User Info Section) */
        .sidebar-profile {
            padding: 15px 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            position: relative;
        }

        .sidebar-profile .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #333;
            flex-shrink: 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sidebar-profile .user-avatar:hover {
            border-color: var(--color-accent-primary);
        }

        .sidebar-profile .user-info {
            flex: 1;
            min-width: 0;
        }

        .sidebar-profile .user-name {
            font-weight: 600;
            color: white;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-profile .user-email {
            font-size: 12px;
            color: #999;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-profile .sign-out-btn {
            padding: 6px 12px;
            background: #29282e;
            color: white;
            border: 1px solid #333;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
            width: 100%;
            margin-top: 8px;
        }

        .sidebar-profile .sign-out-btn:hover {
            background: #333;
        }

        /* Avatar Dropdown Menu */
        .avatar-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            margin-bottom: 0;
            background: #39383e;
            border: 1px solid #333;
            border-radius: 12px;
            min-width: 200px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            pointer-events: auto;
        }

        .avatar-dropdown-header {
            padding: 12px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .dropdown-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #333;
            flex-shrink: 0;
        }

        .dropdown-user-info {
            flex: 1;
            min-width: 0;
        }

        .dropdown-user-name {
            font-weight: 600;
            color: white;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dropdown-user-email {
            font-size: 11px;
            color: #999;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .avatar-dropdown-divider {
            border: none;
            border-top: 1px solid #333;
            margin: 0;
        }

        .avatar-dropdown-item {
            width: 100%;
            padding: 10px 12px;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            transition: background 0.3s ease;
            text-decoration: none;
        }

        .avatar-dropdown-item:last-child {
            border-radius: 0 0 12px 12px;
        }

        .avatar-dropdown-item:hover {
            background: #29282e;
        }

        .avatar-dropdown-icon {
            font-size: 16px;
        }

        .link-status {
            width: 100%;
            margin-top: 12px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
        }

        .link-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(76, 175, 80, 0.05) 100%);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            color: var(--color-accent-primary);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .link-badge:hover {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.15) 0%, rgba(76, 175, 80, 0.08) 100%);
            border-color: rgba(76, 175, 80, 0.4);
            transform: translateY(-1px);
        }

        .link-badge .pulse {
            width: 6px;
            height: 6px;
            background: var(--color-accent-primary);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.6;
                transform: scale(0.9);
            }
        }

        .link-badge .arrow {
            font-size: 10px;
            transition: transform 0.3s ease;
        }

        .link-badge:hover .arrow {
            transform: translateX(2px);
        }

        /* Live Activity Feed */
        .activity-feed {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-top: 1px solid #333;
        }

        .activity-feed-header {
            padding: 16px 20px;
            border-bottom: 1px solid #333;
            background: #39383e;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .activity-feed-link {
            display: flex;
            align-items: center;
            gap: 6px;
            color: white;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 600;
        }

        .activity-feed-link:hover {
            color: var(--color-accent-primary);
        }

        .activity-feed-link .icon {
            font-size: 16px;
        }

        .activity-feed-link .arrow {
            opacity: 0.6;
            font-size: 12px;
            transition: transform 0.3s ease;
        }

        .activity-feed-link:hover .arrow {
            transform: translateX(3px);
            opacity: 1;
        }

        .activity-feed-count {
            font-size: 13px;
            color: var(--color-accent-primary);
            font-weight: 600;
            padding-left: 22px;
        }

        .activity-feed-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .activity-feed-list::-webkit-scrollbar {
            width: 6px;
        }

        .activity-feed-list::-webkit-scrollbar-track {
            background: #39383e;
        }

        .activity-feed-list::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        .activity-feed-list::-webkit-scrollbar-thumb:hover {
            background: #444;
        }

        .activity-item {
            background: #29282e;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .activity-item:hover {
            background: #333;
            border-color: #444;
            transform: translateY(-2px);
        }

        .activity-item.new {
            border-color: rgba(76, 175, 80, 0.5);
            background: rgba(76, 175, 80, 0.05);
        }

        .activity-item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .activity-item-visitor {
            font-size: 12px;
            font-weight: 600;
            color: var(--color-accent-primary);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .activity-item-time {
            font-size: 10px;
            color: #999;
            margin-left: auto;
        }

        .activity-item-message {
            font-size: 11px;
            color: #ddd;
            line-height: 1.4;
            margin-bottom: 6px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .activity-item-response {
            font-size: 11px;
            color: #999;
            line-height: 1.4;
            padding-left: 12px;
            border-left: 2px solid #333;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .activity-feed-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            color: #999;
        }

        .activity-feed-empty .icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .activity-feed-empty .message {
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .activity-feed-empty .link-to-settings {
            padding: 8px 16px;
            background: #29282e;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 12px;
            border: 1px solid #333;
            transition: all 0.3s ease;
        }

        .activity-feed-empty .link-to-settings:hover {
            background: #333;
        }

        /* Billing Styles */
        .billing-scroll-container {
            padding: 16px;
        }

        .plan-info {
            margin-top: 12px;
        }

        .plan-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .plan-card.loading {
            opacity: 0.6;
        }

        .plan-card.active {
            border-color: var(--accent);
        }

        .plan-card.trial {
            border-color: #f59e0b;
        }

        .plan-card.expired {
            border-color: #ef4444;
        }

        .plan-card.grandfathered {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .plan-card .plan-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
        }

        .plan-card .plan-status {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .grandfathered-badge {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(59, 130, 246, 0.15));
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 16px 0;
        }

        .grandfathered-badge .badge-icon {
            font-size: 32px;
        }

        .grandfathered-badge .badge-text {
            font-size: 18px;
            font-weight: 600;
            color: #10b981;
        }

        .grandfathered-badge .badge-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .pricing-info {
            margin-top: 24px;
        }

        .price-display {
            display: flex;
            align-items: baseline;
            gap: 4px;
            margin: 12px 0;
        }

        .price-display .price {
            font-size: 36px;
            font-weight: 700;
            color: var(--text);
        }

        .price-display .period {
            font-size: 16px;
            color: var(--text-secondary);
        }

        .features-list {
            list-style: none;
            padding: 0;
            margin: 16px 0;
        }

        .features-list li {
            padding: 8px 0;
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Subscription Banner - REMOVED */
        .subscription-banner {
            display: none !important;
        }

        .banner-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .banner-icon {
            font-size: 18px;
        }

        .banner-text {
            color: white;
            font-size: 14px;
            font-weight: 500;
        }

        .banner-upgrade-btn {
            background: white;
            color: #6366f1;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .banner-upgrade-btn:hover {
            transform: scale(1.05);
        }

        .banner-close-btn {
            position: absolute;
            right: 16px;
            background: transparent;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.7;
        }

        .banner-close-btn:hover {
            opacity: 1;
        }

        /* Paywall Modal */
        .paywall-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .paywall-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
        }

        .paywall-content {
            position: relative;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            max-width: 420px;
            width: 90%;
            text-align: center;
        }

        .paywall-content h2 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 12px;
        }

        .paywall-content > p {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .paywall-features {
            text-align: left;
            margin: 24px 0;
        }

        .paywall-features .feature-item {
            padding: 8px 0;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .paywall-price {
            margin: 24px 0;
        }

        .paywall-price .price {
            font-size: 48px;
            font-weight: 700;
            color: var(--text);
        }

        .paywall-price .period {
            font-size: 18px;
            color: var(--text-secondary);
        }

        .paywall-button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
        }

        .paywall-button:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.3);
        }

        .paywall-close {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .paywall-close:hover {
            border-color: var(--text-secondary);
            color: var(--text);
        }

        /* Adjust body when banner is shown */
        body.has-banner {
            padding-top: 50px;
        }

        /* Conversation Modal */
        .conversation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .conversation-modal-content {
            background: #39383e;
            border: 1px solid #333;
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        }

        .conversation-modal-content.has-display {
            max-width: 1400px;
        }

        .conversation-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #39383e;
        }

        .conversation-modal-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .conversation-modal-title .visitor-icon {
            font-size: 24px;
        }

        .conversation-modal-title .visitor-info {
            display: flex;
            flex-direction: column;
        }

        .conversation-modal-title .visitor-name {
            font-size: 16px;
            font-weight: 600;
            color: white;
        }

        .conversation-modal-title .visitor-time {
            font-size: 12px;
            color: #999;
        }

        .conversation-modal-close {
            background: none;
            border: none;
            color: #999;
            font-size: 32px;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .conversation-modal-close:hover {
            background: #29282e;
            color: white;
        }

        .conversation-modal-main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .conversation-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .conversation-display-panel {
            width: 50%;
            background: #0d0d0d;
            border-left: 1px solid #333;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .conversation-display-panel.hidden {
            display: none;
        }

        .conversation-display-content {
            flex: 1;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .conversation-display-content canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .conversation-modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .conversation-modal-body::-webkit-scrollbar-track {
            background: #39383e;
        }

        .conversation-modal-body::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        .conversation-modal-body::-webkit-scrollbar-thumb:hover {
            background: #444;
        }

        .conversation-message {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .conversation-message.user {
            align-items: flex-end;
        }

        .conversation-message.assistant {
            align-items: flex-start;
        }

        .conversation-message-label {
            font-size: 11px;
            font-weight: 600;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .conversation-message-bubble {
            background: var(--gradient-subtle);
            border: 1px solid var(--color-border-default);
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
            line-height: 1.5;
            color: white;
        }

        .conversation-message.user .conversation-message-bubble {
            background: var(--gradient-primary);
            color: white;
        }

        .conversation-message.assistant .conversation-message-bubble {
            background: var(--gradient-subtle);
            border: 1px solid var(--color-border-default);
            color: white;
        }

        .conversation-message-time {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
        }

        .conversation-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #999;
        }

        .conversation-loading .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top-color: var(--color-accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .conversation-error {
            padding: 40px;
            text-align: center;
            color: #f44336;
        }

        /* Main Content (Center - Chat Area) */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg);
            overflow: hidden;
            margin-right: 0; /* Alpha: Right panel hidden */
            order: 1;
            transition: margin-right 0.3s ease;
        }

        body.right-panel-collapsed .main-content {
            margin-right: 0;
        }

        body.right-panel-open .main-content {
            margin-right: 360px;
        }

        /* No additional styling needed - parent container handles header offset */
        .main-content.with-header {
            /* Height and margin handled by parent .app-container */
        }

        /* Chat Interface */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: var(--bg);
            max-width: 850px;
            margin: 0 auto;
            width: 100%;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }

        .chat-messages::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        .message {
            display: flex;
            gap: 15px;
            animation: fadeIn 0.3s ease;
            margin-bottom: 12px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* AI messages - avatar on top, text below (shifts text left) */
        .message.ai {
            flex-direction: column !important;
            justify-content: flex-start !important;
            align-items: flex-start;
            gap: 8px;
        }

        /* User messages - right aligned, no avatar (WhatsApp style) */
        .message.user {
            flex-direction: row !important;
            justify-content: flex-end !important;
            align-items: flex-end;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            flex-shrink: 0;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: #39383e;
            border: 2px solid #333;
        }

        .message-content {
            background: var(--gradient-subtle);
            border: 1px solid var(--color-border-default);
            padding: 15px 20px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
            line-height: 1.5;
            color: var(--color-text-primary);
        }

        .message.user .message-content {
            background: rgba(167, 139, 250, 0.4);
            color: var(--color-text-primary);
            border: none;
            border-radius: 18px 18px 4px 18px; /* WhatsApp-style tail on bottom right */
            position: relative;
            padding-right: 30px; /* Space for checkmark */
        }

        /* WhatsApp-style double checkmark for delivered messages */
        .message.user .message-content::after {
            content: '';
            position: absolute;
            right: 10px;
            bottom: 8px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.5);
            font-weight: bold;
            letter-spacing: -3px;
        }

        .message.ai .message-content {
            /* Keep box styling on desktop - inherit from base .message-content */
            /* Only adjust the border-radius for a left-tail WhatsApp style */
            border-radius: 18px 18px 18px 4px;
            max-width: 70%; /* Constrained width for better readability */
        }

        .chat-input-container {
            padding: 12px 16px 16px 16px;
            background: rgba(47, 47, 47, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: none;
            display: flex;
            gap: 8px;
            align-items: center;
            max-width: 850px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
        }

        .chat-input {
            width: 100%;
            padding: 12px 48px 12px 18px;
            background: rgba(30, 30, 30, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            font-size: 15px;
            color: white;
            outline: none;
            transition: all 0.2s ease;
            resize: none;
            overflow-y: hidden;
            min-height: 48px;
            max-height: 200px;
            line-height: 1.5;
            font-family: inherit;
        }

        .chat-input:focus {
            border-color: rgba(167, 139, 250, 0.4);
            background: rgba(35, 35, 35, 0.7);
        }

        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .send-button {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s ease;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(167, 139, 250, 0.3);
        }

        .send-button:hover {
            box-shadow: 0 4px 16px rgba(167, 139, 250, 0.4);
            transform: scale(1.05);
        }

        .send-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .attach-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .attach-button:hover {
            color: rgba(255, 255, 255, 0.9);
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* Voice Mode Styles - positioned inside input */
        .voice-button {
            position: absolute;
            right: 8px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: transparent;
            color: rgba(255, 255, 255, 0.5);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .voice-button:hover {
            color: rgba(255, 255, 255, 0.9);
            background: rgba(255, 255, 255, 0.08);
        }

        .voice-button.listening {
            background: rgba(220, 53, 69, 0.9);
            color: white;
            animation: pulse-red 1.5s infinite;
        }

        .voice-button.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }

        /* Reply Feature Styles - WhatsApp Style */
        .message-content {
            position: relative;
        }
        .message-actions {
            position: absolute;
            top: 6px;
            right: 6px;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 10;
        }
        .message-content:hover .message-actions {
            opacity: 1;
        }
        .message-dropdown-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            width: 20px;
            height: 20px;
            padding: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 300;
            line-height: 1;
            transition: color 0.2s ease;
        }
        .message-dropdown-btn:hover {
            color: rgba(255, 255, 255, 0.9);
        }
        .message-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: #2d2d3a;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            min-width: 120px;
            overflow: hidden;
            display: none;
            z-index: 100;
        }
        .message-dropdown.visible {
            display: block;
        }
        .message-dropdown-item {
            padding: 10px 14px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.15s;
        }
        .message-dropdown-item:hover {
            background: rgba(139, 92, 246, 0.2);
        }
        .message-dropdown-item .icon {
            font-size: 14px;
            opacity: 0.8;
        }

        /* Legacy reply-btn for backward compatibility */
        .reply-btn {
            display: none;
        }

        /* Scroll to bottom button */
        .scroll-to-bottom {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: #8b5cf6;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(139, 92, 246, 0.4);
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 50;
        }
        .scroll-to-bottom.visible {
            opacity: 1;
            visibility: visible;
        }
        .scroll-to-bottom:hover {
            background: #7c3aed;
            transform: scale(1.1);
        }
        .chat-container {
            position: relative;
        }

        .reply-preview {
            display: none;
            background: rgba(139, 92, 246, 0.15);
            border-left: 4px solid #8b5cf6;
            padding: 10px 14px;
            margin-bottom: 8px;
            border-radius: 0 8px 8px 0;
            max-width: 850px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            box-sizing: border-box;
        }
        .reply-preview.visible {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
        .reply-preview-content {
            flex: 1;
            overflow: hidden;
        }
        .reply-preview-label {
            font-size: 11px;
            color: #8b5cf6;
            font-weight: 500;
            margin-bottom: 3px;
        }
        .reply-preview-text {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .reply-cancel {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            font-size: 14px;
            padding: 6px 8px;
            border-radius: 50%;
            transition: all 0.2s;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .reply-cancel:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .reply-quote {
            background: rgba(139, 92, 246, 0.15);
            border-left: 3px solid #8b5cf6;
            padding: 8px 12px;
            margin-bottom: 10px;
            font-size: 0.85em;
            border-radius: 0 6px 6px 0;
            max-height: 65px;
            overflow: hidden;
            cursor: pointer;
            transition: background 0.2s;
        }
        .reply-quote:hover {
            background: rgba(139, 92, 246, 0.25);
        }
        .reply-quote-label {
            font-size: 11px;
            color: #a78bfa;
            font-weight: 500;
            margin-bottom: 3px;
        }
        .reply-quote-text {
            color: rgba(255, 255, 255, 0.75);
            word-break: break-word;
            line-height: 1.4;
        }

        .voice-mode-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            color: #888;
        }

        .voice-mode-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .voice-mode-toggle.active {
            background: rgba(124, 102, 220, 0.2);
            border-color: var(--color-accent-primary);
            color: var(--color-accent-primary);
        }

        .voice-mode-toggle .toggle-icon {
            font-size: 16px;
        }

        .message-audio-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-left: 8px;
            font-size: 12px;
            color: var(--color-accent-primary);
            cursor: pointer;
        }

        .message-audio-indicator:hover {
            opacity: 0.8;
        }

        .message-audio-indicator.playing .speaker-icon {
            animation: speaker-pulse 0.5s infinite;
        }

        @keyframes speaker-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .voice-not-supported {
            color: #666;
            font-size: 12px;
            padding: 8px;
            text-align: center;
        }

        .file-preview {
            display: none;
            margin: 0 16px 8px 16px;
        }

        .file-preview.visible {
            display: block;
        }

        .file-preview-item {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(138, 99, 210, 0.15);
            border: 1px solid rgba(138, 99, 210, 0.3);
            border-radius: 20px;
            padding: 6px 12px 6px 10px;
            color: white;
            max-width: 280px;
        }

        .file-preview-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .file-preview-info {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .file-preview-name {
            font-size: 13px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-preview-size {
            font-size: 12px;
            color: #888;
        }

        .file-preview-remove {
            background: none;
            border: none;
            color: #ff4444;
            cursor: pointer;
            font-size: 20px;
            padding: 4px 8px;
        }

        .file-preview-remove:hover {
            color: #ff6666;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #333;
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #666;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* Recalling Indicator (for memory search) */
        .recalling-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            color: var(--text-secondary, #888);
            font-style: italic;
        }

        .recalling-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color, #444);
            border-top-color: var(--text-secondary, #888);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Typing Timer and Cancel Button */
        .typing-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .typing-timer {
            font-size: 12px;
            color: var(--text-secondary, #666);
            font-family: monospace;
            min-width: 32px;
        }

        .typing-cancel-btn {
            background: transparent;
            border: 1px solid #666;
            color: #888;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s, background 0.2s;
        }

        .typing-cancel-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .typing-cancel-btn.visible {
            opacity: 1;
        }

        /* Copy Button */
        .message.ai {
            position: relative;
        }

        .copy-btn {
            background: transparent;
            border: none;
            color: #666;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s ease;
            margin-top: 4px;
            display: inline-block;
        }

        .message.ai:hover .copy-btn {
            opacity: 1;
        }

        .copy-btn:hover {
            background: #39383e;
            color: #999;
        }

        /* Image attachments in messages */
        .message-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 12px;
            display: block;
            margin-top: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .message-image:hover {
            transform: scale(1.02);
        }

        .message.user .message-content p {
            margin: 0 0 8px 0;
        }

        /* Workflow Indicator Banner */
        .workflow-indicator {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gradient-primary);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 600;
            animation: slideDown 0.3s ease;
        }

        .workflow-indicator.hidden {
            display: none;
        }

        .workflow-indicator-icon {
            font-size: 18px;
            animation: pulse 2s ease-in-out infinite;
        }

        .workflow-cancel-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .workflow-cancel-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        .copy-btn.copied {
            background: var(--color-accent-primary);
            color: white;
            border-color: var(--color-accent-primary);
        }

        /* Timestamp */
        .message-timestamp {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 5px;
        }

        /* Load More Button */
        .load-more-container {
            text-align: center;
            padding: 15px;
            margin-bottom: 10px;
        }

        .load-more-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
        }

        .load-more-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .load-more-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Mobile/Desktop text toggle */
        .load-more-btn .mobile-text {
            display: none;
        }
        .load-more-btn .desktop-text {
            display: inline;
        }
        @media (max-width: 768px) {
            .load-more-btn .mobile-text {
                display: inline;
            }
            .load-more-btn .desktop-text {
                display: none;
            }
            .load-more-btn {
                background: transparent;
                border: none;
                color: rgba(255, 255, 255, 0.5);
                font-size: 12px;
            }
        }

        /* Markdown Styling */
        .message-content p {
            margin: 0.5em 0;
        }

        .message-content p:first-child {
            margin-top: 0;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content code {
            background: #29282e;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .message-content pre {
            background: #29282e;
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .message-content pre code {
            background: none;
            padding: 0;
        }

        .message-content ul, .message-content ol {
            margin: 10px 0;
            padding-left: 25px;
        }

        .message-content li {
            margin: 5px 0;
        }

        .message-content strong {
            font-weight: 600;
        }

        .message-content h1, .message-content h2, .message-content h3 {
            margin: 15px 0 10px 0;
            font-weight: 600;
        }

        .message-content blockquote {
            border-left: 3px solid #555;
            padding-left: 15px;
            margin: 10px 0;
            color: #999;
        }

        /* Links in AI messages (grey background) */
        .message.ai .message-content a {
            color: #6bc5ff;
            text-decoration: underline;
            text-underline-offset: 2px;
        }

        .message.ai .message-content a:hover {
            color: #ffffff;
        }

        /* Links in user messages (white background) */
        .message.user .message-content a {
            color: #0066cc;
            text-decoration: underline;
            text-underline-offset: 2px;
        }

        .message.user .message-content a:hover {
            color: #004499;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100%;
            padding: 40px 20px;
            padding-top: 60px;
            text-align: center;
            box-sizing: border-box;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .empty-state-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            object-fit: contain;
        }

        .empty-state h2 {
            color: white;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #999;
            font-size: 16px;
            margin-bottom: 30px;
            max-width: 500px;
        }

        .suggested-prompts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            width: 100%;
            max-width: 600px;
        }

        .prompt-card {
            background: #39383e;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .prompt-card:hover {
            background: #29282e;
            border-color: #555;
            transform: translateY(-2px);
        }

        .prompt-card-title {
            color: white;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .prompt-card-text {
            color: #999;
            font-size: 13px;
            line-height: 1.4;
        }

        /* Error Message */
        .error-message {
            background: #2a1a1a;
            border: 1px solid #552222;
            padding: 15px;
            border-radius: 12px;
            margin: 10px 0;
        }

        .error-message-text {
            color: #ff6b6b;
            margin-bottom: 10px;
        }

        .retry-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .retry-btn:hover {
            background: #ff5252;
        }

        /* Mobile Header - WhatsApp style */
        .mobile-header {
            display: none;
        }

        /* ==================== ACCESSIBILITY ==================== */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* ==================== TABLET RESPONSIVE ==================== */
        @media (max-width: 1024px) {
            .right-activity-panel {
                width: 320px;
            }

            .right-panel-toggle {
                right: 320px;
            }

            body.right-panel-collapsed .right-panel-toggle {
                right: 0;
                display: flex;
            }

            body.right-panel-open .main-content {
                margin-right: 320px;
            }

            .panel-tab {
                padding: 10px 6px;
            }

            .panel-tab .tab-icon {
                font-size: 18px;
            }

            .panel-tab .tab-label {
                font-size: 10px;
            }
        }

        /* ==================== MOBILE RESPONSIVE ==================== */
        @media (max-width: 768px) {
            /* Hide account sidebar on mobile to save horizontal space */
            .account-sidebar {
                display: none !important;
            }

            /* Hide right activity panel and toggle on mobile */
            .right-activity-panel,
            .right-panel-toggle {
                display: none !important;
            }

            /* Header full width on mobile */
            .app-header {
                right: 0 !important;
            }

            /* Main content fills screen on mobile */
            .main-content {
                max-width: 100vw !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
            }

            /* Landing page mobile */
            .landing-content {
                padding: 0 16px;
            }

            .landing-hero {
                min-height: auto;
                padding: 80px 0 60px;
            }

            .landing-brand {
                flex-direction: column;
                gap: 8px;
            }

            .landing-logo-img {
                width: 56px;
                height: 56px;
            }

            /* Landing Page Mobile */
            .landing-page {
                padding-top: max(20px, env(safe-area-inset-top, 20px));
                padding-bottom: max(34px, env(safe-area-inset-bottom, 34px));
            }

            .landing-content {
                padding: 16px;
                max-height: 100%;
                overflow-y: auto;
            }

            .landing-title {
                font-size: 28px;
                letter-spacing: 4px;
            }

            .landing-tagline {
                font-size: 16px;
                margin-bottom: 32px;
            }

            .landing-claims {
                grid-template-columns: 1fr;
                gap: 12px;
                margin-bottom: 24px;
            }

            .claim-item {
                padding: 16px;
            }

            .claim-icon {
                font-size: 24px;
                margin-bottom: 8px;
            }

            .claim-title {
                font-size: 12px;
                margin-bottom: 6px;
            }

            .claim-text {
                font-size: 12px;
            }

            .claim-subtext {
                font-size: 10px;
                margin-top: 6px;
            }

            .landing-sign-in-btn {
                padding: 14px 36px;
                font-size: 14px;
            }

            .landing-pricing {
                font-size: 12px;
            }

            .landing-footer {
                bottom: 16px;
            }

            .landing-legal {
                font-size: 9px;
            }

            /* Header mobile */
            .app-header {
                padding: 0 8px;
                height: 36px;
            }

            .main-content.with-header {
                /* Height and margin handled by parent .app-container */
            }

            /* Header dropdown full-width on mobile */
            .header-dropdown {
                left: 0;
                right: 0;
                top: 100%;
                border-radius: 0 0 16px 16px;
                min-width: 100%;
            }

            /* Activity modal full-screen */
            .activity-modal-content {
                width: 100%;
                height: 100%;
                max-height: 100vh;
                border-radius: 0;
            }

            .activity-modal-stats {
                padding: 16px;
            }

            .stat-value {
                font-size: 24px;
            }

            /* Original mobile styles below */
            .app-container {
                flex-direction: column;
                height: calc(100dvh - 56px - env(safe-area-inset-top));
                height: calc(100vh - 56px - env(safe-area-inset-top)); /* Fallback for older browsers */
                margin-top: calc(56px + env(safe-area-inset-top));
            }

            @supports (height: 100dvh) {
                .app-container {
                    height: calc(100dvh - 56px - env(safe-area-inset-top));
                }
            }

            /* Sidebar styling on mobile */
            .sidebar {
                width: 100%;
                border-left: none;
                border-bottom: none;
            }

            /* Hide sidebar on mobile when user is signed in */
            .sidebar.mobile-hidden {
                display: none;
            }

            /* Show PWA-style mobile header */
            .mobile-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 10px 16px;
                padding-top: calc(10px + env(safe-area-inset-top));
                background: var(--bg);
                border-bottom: none;
                height: calc(56px + env(safe-area-inset-top));
                min-height: 56px;
                flex-shrink: 0;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 999;
            }

            .mobile-header-left {
                display: flex;
                align-items: center;
                width: 48px;
            }

            .mobile-header-center {
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
                text-align: center;
            }

            .mobile-header-right {
                display: flex;
                align-items: center;
                width: 48px;
                justify-content: flex-end;
                position: relative;
            }

            /* Mobile Profile Dropdown */
            .mobile-profile-dropdown {
                position: absolute;
                top: calc(100% + 8px);
                right: 0;
                background: #29282e;
                border: 1px solid #333;
                border-radius: 12px;
                min-width: 220px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
                z-index: 1001;
            }

            .mobile-dropdown-header {
                padding: 12px;
                display: flex;
                gap: 10px;
                align-items: center;
            }

            .mobile-profile-dropdown .dropdown-avatar {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                border: 2px solid #333;
                flex-shrink: 0;
            }

            .mobile-profile-dropdown .avatar-dropdown-item {
                width: 100%;
                padding: 12px;
                background: none;
                border: none;
                color: white;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 10px;
                font-size: 14px;
                transition: background 0.2s ease;
            }

            .mobile-profile-dropdown .avatar-dropdown-item:hover {
                background: rgba(255, 255, 255, 0.1);
            }

            .mobile-profile-dropdown .avatar-dropdown-item:last-child {
                border-radius: 0 0 12px 12px;
            }

            .mobile-profile-dropdown .avatar-dropdown-item svg {
                opacity: 0.7;
            }

            .mobile-header .user-avatar {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                object-fit: cover;
            }

            .mobile-header-title {
                font-size: 18px;
                font-weight: 600;
                color: rgba(255, 255, 255, 0.5);
                letter-spacing: 0.5px;
            }

            .mobile-menu-btn {
                background: none;
                border: none;
                color: rgba(255, 255, 255, 0.8);
                font-size: 24px;
                cursor: pointer;
                padding: 4px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* Make main content fill screen */
            .main-content {
                flex: 1;
                min-height: 0;
                display: flex;
                flex-direction: column;
            }

            .chat-container {
                flex: 1;
                display: flex;
                flex-direction: column;
            }

            .chat-messages {
                flex: 1;
                overflow-y: auto;
            }

            .message-content {
                max-width: 85%;
            }

            .message.ai .message-content {
                /* Mobile: full-width but keep box styling for personal feel */
                max-width: 100%;
            }

            /* Fix chat input for Safari iOS */
            .chat-input-container {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                max-width: 100vw;
                box-sizing: border-box;
                padding: 8px 12px;
                padding-left: max(12px, env(safe-area-inset-left));
                padding-right: max(12px, env(safe-area-inset-right));
                padding-bottom: max(12px, calc(12px + env(safe-area-inset-bottom)));
                background: rgba(47, 47, 47, 0.98);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border-top: none;
                z-index: 1000;
                overflow: hidden;
            }

            /* Remove Safari-specific padding - no longer needed with fixed position */
            body.is-safari .chat-input-container {
                /* Intentionally empty - fixed position solves keyboard issues */
            }

            /* Remove Chrome-specific padding - no longer needed with fixed position */
            body.is-chrome .chat-input-container {
                /* Intentionally empty - fixed position solves keyboard issues */
            }

            .chat-input {
                font-size: 16px; /* Prevents iOS zoom on focus */
                background: rgba(30, 30, 30, 0.8);
                color: white;
                border: 1px solid rgba(255, 255, 255, 0.08);
                border-radius: 22px;
                padding: 10px 44px 10px 16px; /* Extra right padding for mic button (28px + 6px + 10px buffer) */
                min-width: 0;
                flex: 1;
            }

            .chat-input::placeholder {
                color: rgba(255, 255, 255, 0.4);
            }

            .chat-input:focus {
                border-color: rgba(167, 139, 250, 0.4);
                background: rgba(35, 35, 35, 0.85);
                outline: none;
            }

            .send-button {
                width: 40px;
                height: 40px;
                min-width: 40px;
                flex-shrink: 0;
                background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
                color: white;
                border: none;
                border-radius: 50%;
                box-shadow: 0 2px 8px rgba(167, 139, 250, 0.3);
            }

            .send-button:hover {
                box-shadow: 0 4px 12px rgba(167, 139, 250, 0.4);
            }

            .send-button:active {
                transform: scale(0.95);
            }

            .attach-button {
                width: 36px;
                height: 36px;
                min-width: 36px;
                flex-shrink: 0;
            }

            .voice-button {
                width: 28px;
                height: 28px;
                right: 6px;
            }

            .input-wrapper {
                flex: 1;
                min-width: 0;
            }

            /* Ensure chat messages don't hide behind fixed input bar */
            .chat-messages {
                padding-bottom: calc(70px + env(safe-area-inset-bottom)); /* Account for compact fixed typing bar + safe area */
            }

            /* Welcome screen on mobile */
            .welcome-container {
                padding: 20px;
            }

            /* Hide left panel by default on mobile - show via hamburger menu */
            .left-panel {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 1000;
                bottom: 0;
                padding-top: max(50px, env(safe-area-inset-top, 50px));
                padding-bottom: max(50px, env(safe-area-inset-bottom, 50px));
            }

            /* Show left panel when open class is added */
            .left-panel.mobile-open {
                transform: translateX(0);
            }

            /* Mobile overlay when panel is open */
            .mobile-panel-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }

            .mobile-panel-overlay.active {
                display: block;
            }

            /* Hide left panel footer on mobile - profile moved to top-right dropdown */
            .left-panel-footer {
                display: none !important;
            }

            /* Make main content full width on mobile */
            .main-content {
                margin-left: 0 !important;
            }

            /* Mobile empty state - smaller padding, smaller logo, single column prompts */
            .empty-state {
                padding: 20px 16px;
                padding-top: 30px;
                padding-bottom: calc(80px + env(safe-area-inset-bottom));
            }

            .empty-state-logo {
                width: 60px;
                height: 60px;
            }

            .empty-state h2 {
                font-size: 20px;
            }

            .empty-state p {
                font-size: 14px;
                margin-bottom: 20px;
            }

            .suggested-prompts {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .prompt-card {
                padding: 12px;
            }

            .prompt-card-title {
                font-size: 13px;
            }

            .prompt-card-text {
                font-size: 12px;
            }
        }

        /* ==================== KNOWLEDGE BASE PREVIEW MODAL ==================== */
        .kb-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .kb-preview-modal.active {
            opacity: 1;
        }

        .kb-preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
        }

        .kb-preview-content {
            position: relative;
            z-index: 1;
            background: #39383e;
            border: 1px solid #333;
            border-radius: 20px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.8);
            animation: kbModalSlideUp 0.3s ease;
        }

        @keyframes kbModalSlideUp {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .kb-preview-header {
            padding: 24px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kb-preview-header h2 {
            font-size: 24px;
            color: white;
            margin: 0;
        }

        .kb-preview-close {
            background: none;
            border: none;
            color: #999;
            font-size: 32px;
            cursor: pointer;
            line-height: 1;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .kb-preview-close:hover {
            background: #29282e;
            color: white;
        }

        .kb-preview-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .kb-preview-section {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid #333;
        }

        .kb-preview-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .kb-preview-section h3 {
            font-size: 18px;
            color: var(--color-accent-primary);
            margin-bottom: 12px;
        }

        .kb-preview-section p {
            color: #ddd;
            line-height: 1.6;
            margin: 8px 0;
        }

        .kb-preview-empty {
            color: #999;
            font-style: italic;
        }

        .kb-preview-footer {
            padding: 24px;
            border-top: 1px solid #333;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .kb-btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .kb-btn-primary {
            background: var(--color-accent-primary);
            color: white;
        }

        .kb-btn-primary:hover {
            background: var(--color-accent-secondary);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
        }

        .kb-btn-primary:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .kb-btn-secondary {
            background: #29282e;
            color: white;
            border: 1px solid #444;
        }

        .kb-btn-secondary:hover {
            background: #333;
            border-color: #555;
        }

        @media (max-width: 768px) {
            .kb-preview-content {
                width: 95%;
                max-height: 90vh;
            }

            .kb-preview-header h2 {
                font-size: 20px;
            }

            .kb-preview-body {
                padding: 16px;
            }

            .kb-preview-footer {
                padding: 16px;
            }

            .kb-btn {
                padding: 10px 20px;
                font-size: 14px;
            }

            /* Hide collapse button on mobile - not needed with hamburger menu */
            .left-panel-toggle {
                display: none;
            }
        }

        /* ==========================================
           REALTIME VOICE MODE OVERLAY
           ========================================== */
        .voice-mode-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, #2f2f2f 0%, #3a3a4e 50%, #2f2f2f 100%);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .voice-mode-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .voice-mode-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: rgba(255, 255, 255, 0.8);
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .voice-mode-close:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .voice-mode-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 40px;
        }

        .voice-orb-container {
            position: relative;
            width: 200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-orb {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 50%, #7c3aed 100%);
            border-radius: 50%;
            box-shadow: 0 0 60px rgba(167, 139, 250, 0.5),
                        0 0 100px rgba(139, 92, 246, 0.3);
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }

        .voice-orb.listening {
            animation: orb-pulse-listen 2s ease-in-out infinite;
        }

        .voice-orb.speaking {
            animation: orb-pulse-speak 0.5s ease-in-out infinite;
        }

        .voice-orb.connecting {
            animation: orb-connecting 1.5s ease-in-out infinite;
        }

        @keyframes orb-pulse-listen {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 60px rgba(167, 139, 250, 0.5),
                            0 0 100px rgba(139, 92, 246, 0.3);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 80px rgba(167, 139, 250, 0.6),
                            0 0 120px rgba(139, 92, 246, 0.4);
            }
        }

        @keyframes orb-pulse-speak {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        @keyframes orb-connecting {
            0%, 100% {
                opacity: 0.5;
                transform: scale(0.9);
            }
            50% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .voice-rings {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .voice-ring {
            position: absolute;
            border: 2px solid rgba(167, 139, 250, 0.3);
            border-radius: 50%;
            animation: ring-expand 2s ease-out infinite;
        }

        .voice-ring:nth-child(1) {
            width: 140px;
            height: 140px;
            top: -70px;
            left: -70px;
            animation-delay: 0s;
        }

        .voice-ring:nth-child(2) {
            width: 180px;
            height: 180px;
            top: -90px;
            left: -90px;
            animation-delay: 0.5s;
        }

        .voice-ring:nth-child(3) {
            width: 220px;
            height: 220px;
            top: -110px;
            left: -110px;
            animation-delay: 1s;
        }

        @keyframes ring-expand {
            0% {
                opacity: 0.6;
                transform: scale(0.8);
            }
            100% {
                opacity: 0;
                transform: scale(1.2);
            }
        }

        .voice-mode-status {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            text-align: center;
        }

        .voice-mode-transcript {
            max-width: 400px;
            text-align: center;
            padding: 0 20px;
        }

        .voice-mode-transcript-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .voice-mode-transcript-text {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
            min-height: 48px;
        }

        .voice-mode-footer {
            position: absolute;
            bottom: 40px;
            display: flex;
            gap: 20px;
        }

        .voice-mode-btn {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .voice-mode-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .voice-mode-btn.muted {
            background: rgba(220, 53, 69, 0.3);
            border-color: rgba(220, 53, 69, 0.5);
        }

        /* Mobile adjustments for voice overlay */
        @media (max-width: 768px) {
            .voice-mode-close {
                top: 16px;
                right: 16px;
                width: 44px;
                height: 44px;
            }

            .voice-orb-container {
                width: 160px;
                height: 160px;
            }

            .voice-orb {
                width: 100px;
                height: 100px;
            }

            .voice-ring:nth-child(1) {
                width: 120px;
                height: 120px;
                top: -60px;
                left: -60px;
            }

            .voice-ring:nth-child(2) {
                width: 150px;
                height: 150px;
                top: -75px;
                left: -75px;
            }

            .voice-ring:nth-child(3) {
                width: 180px;
                height: 180px;
                top: -90px;
                left: -90px;
            }

            .voice-mode-status {
                font-size: 16px;
            }

            .voice-mode-transcript-text {
                font-size: 14px;
            }

            .voice-mode-footer {
                bottom: 30px;
            }
        }
    </style>
    <!-- Razorpay Checkout Script -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>
    <!-- Workflow Indicator Banner -->
    <div id="workflowIndicator" class="workflow-indicator hidden">
        <span class="workflow-indicator-icon"></span>
        <span id="workflowIndicatorText">Setting up your public link...</span>
        <button class="workflow-cancel-btn" onclick="cancelWorkflow()">Cancel</button>
    </div>

    <!-- Landing Page -->
    <div id="landingPage" class="landing-page hidden">
        <div class="landing-content">
            <!-- Brand -->
            <div class="landing-brand">
                <img class="landing-logo-img" src="/logo.png" alt="Mindclone Logo">
                <h1 class="landing-title">Mindclone</h1>
            </div>

            <!-- Tagline -->
            <p class="landing-tagline">A record of the life only you lived.</p>

            <!-- Elegant Divider -->
            <div class="landing-divider"></div>

            <!-- Three Value Props -->
            <div class="landing-claims">
                <div class="claim-item">
                    <span class="claim-icon"></span>
                    <h2 class="claim-title">Absolutely Private</h2>
                    <p class="claim-text">No human will ever access your Mindclone. Only you, while you're alive.</p>
                    <p class="claim-subtext">Transfer to loved ones as your legacy.</p>
                </div>
                <div class="claim-item">
                    <span class="claim-icon"></span>
                    <h2 class="claim-title">Infinite Memory</h2>
                    <p class="claim-text">Every conversation, idea, and thought preserved forever. Nothing is ever lost.</p>
                    <p class="claim-subtext">Your mind, immortalized.</p>
                </div>
                <div class="claim-item">
                    <span class="claim-icon"></span>
                    <h2 class="claim-title">Your Confidant</h2>
                    <p class="claim-text">A friend, philosopher, and guide who knows you deeply and grows with you.</p>
                    <p class="claim-subtext">Always there when you need clarity.</p>
                </div>
            </div>

            <!-- CTA -->
            <div class="landing-cta">
                <button id="landingSignInBtn" class="landing-sign-in-btn">
                    <svg class="google-icon" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Start Free Trial
                </button>
                <p class="landing-pricing"><strong>7 days free</strong>, then $100/month</p>
            </div>
        </div>

        <!-- Footer -->
        <footer class="landing-footer">
            <p class="landing-legal">ABHRANTA AI PRIVATE LIMITED <span>|</span> CIN: U72900GJ2022PTC133729</p>
        </footer>
    </div>

    <!-- App Header (Shown after authentication) -->
    <header id="appHeader" class="app-header hidden">
        <div class="app-header-left">
            <div class="header-title">my mindclone</div>
        </div>
        <div class="app-header-right">
            <div class="header-user-menu">
                <img id="headerAvatar" class="header-avatar" src="" alt="User Avatar">
                <div id="headerDropdown" class="header-dropdown hidden">
                    <div class="header-dropdown-header">
                        <img id="headerDropdownAvatar" class="dropdown-avatar" src="" alt="User Avatar">
                        <div class="dropdown-user-info">
                            <div id="headerDropdownName" class="dropdown-user-name"></div>
                            <div id="headerDropdownEmail" class="dropdown-user-email"></div>
                        </div>
                    </div>
                    <hr class="dropdown-divider">
                    <button id="headerSignOutBtn" class="header-dropdown-item">
                        <span class="dropdown-icon"></span>
                        <span>Sign Out</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="feedback-modal">
        <div class="feedback-modal-overlay" id="feedbackModalOverlay"></div>
        <div class="feedback-modal-content">
            <div class="feedback-modal-header">
                <div class="feedback-modal-title">
                    <span></span>
                    <span>Send Feedback</span>
                </div>
                <button id="feedbackModalClose" class="modal-close-btn" aria-label="Close modal"></button>
            </div>
            <div class="feedback-modal-body">
                <!-- Screenshot Section -->
                <div class="feedback-form-group">
                    <label class="feedback-form-label">Screenshot</label>
                    <div class="feedback-screenshot-preview" id="feedbackScreenshotPreview">
                        <span class="screenshot-placeholder">Capturing...</span>
                    </div>
                    <button id="retakeScreenshotBtn" class="feedback-retake-btn">
                        <span></span> Retake Screenshot
                    </button>
                </div>

                <!-- Type Section -->
                <div class="feedback-form-group">
                    <label class="feedback-form-label">Type</label>
                    <select id="feedbackTypeSelect" class="feedback-select">
                        <option value="bug"> Bug Report</option>
                        <option value="feature"> Feature Request</option>
                        <option value="other"> Other</option>
                    </select>
                </div>

                <!-- Message Section -->
                <div class="feedback-form-group">
                    <label class="feedback-form-label">Your Feedback</label>
                    <textarea id="feedbackMessageInput" class="feedback-textarea" placeholder="Describe the issue or suggestion..." rows="4" maxlength="2000"></textarea>
                    <div class="feedback-char-count">
                        <span id="feedbackCharCount">0</span>/2000
                    </div>
                </div>
            </div>
            <div class="feedback-modal-footer">
                <button id="feedbackCancelBtn" class="feedback-btn feedback-btn-secondary">Cancel</button>
                <button type="button" id="feedbackSubmitBtn" class="feedback-btn feedback-btn-primary" onclick="submitModalFeedback()">
                    <span class="btn-text">Submit Feedback</span>
                    <span class="btn-loading hidden">Sending...</span>
                </button>
            </div>
            <!-- Success Message -->
            <div id="feedbackSuccessMessage" class="feedback-success hidden">
                <span class="success-icon"></span>
                <span>Thank you! Your feedback has been submitted.</span>
            </div>
        </div>
    </div>

    <!-- Activity Feed Modal -->
    <div id="activityModal" class="activity-modal hidden">
        <div class="activity-modal-overlay"></div>
        <div class="activity-modal-content">
            <div class="activity-modal-header">
                <div class="activity-modal-title">
                    <span class="activity-icon"></span>
                    <div>
                        <h2>Live Link Activity</h2>
                        <a href="#" id="activityModalLink" target="_blank" class="activity-link">View Your Link </a>
                    </div>
                </div>
                <button id="activityModalClose" class="modal-close-btn" aria-label="Close modal"></button>
            </div>
            <div class="activity-modal-stats">
                <div class="stat-card">
                    <div class="stat-value" id="modalActivityCount">0</div>
                    <div class="stat-label">Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="modalTotalCount">0</div>
                    <div class="stat-label">All Time</div>
                </div>
            </div>
            <div class="activity-modal-body">
                <div id="modalActivityList" class="modal-activity-list">
                    <!-- Activity items rendered here -->
                </div>
                <!-- Empty state -->
                <div id="modalActivityEmpty" class="modal-activity-empty hidden">
                    <div class="empty-icon"></div>
                    <h3>No Activity Yet</h3>
                    <p>Enable your link to see visitor conversations</p>
                    <a href="/settings" class="btn-primary">Go to Settings</a>
                </div>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Collapsible Left Panel -->
        <div class="left-panel" id="leftPanel" style="display: none;">
            <!-- Panel Header -->
            <div class="left-panel-header">
                <div class="left-panel-brand">
                    <img src="/logo.png" alt="Mindclone" class="left-panel-logo">
                    <span class="left-panel-title">Mindclone</span>
                </div>
                <button class="left-panel-toggle" id="panelToggle" title="Collapse panel">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 18l-6-6 6-6"/>
                    </svg>
                </button>
            </div>

            <!-- Trial Countdown Banner (hidden by default) -->
            <div id="trialCountdownBanner" class="trial-countdown-banner hidden">
                <div class="trial-countdown-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12,6 12,12 16,14"/>
                    </svg>
                </div>
                <div class="trial-countdown-text">
                    <span class="trial-label">Free Trial</span>
                    <span id="trialDaysText" class="trial-days">7 days left</span>
                </div>
                <button id="trialUpgradeBtn" class="trial-upgrade-btn">Upgrade</button>
            </div>

            <!-- Panel Content -->
            <div class="left-panel-content">
                <!-- Knowledge Base Section (collapsible) -->
                <div class="left-panel-section" id="kbSection">
                    <div class="left-panel-section-header" id="kbSectionHeader" style="cursor: pointer;">
                        <span class="left-panel-section-icon"></span>
                        <span class="left-panel-section-title">Knowledge Base</span>
                        <span id="panelKbCount" class="kb-count" style="margin-left: auto;">0</span>
                        <span class="left-panel-expand-icon" id="kbExpandIcon" style="margin-left: 8px;"></span>
                    </div>
                    <div class="left-panel-section-content" id="kbSectionContent" style="display: none;">
                        <div class="panel-kb-list" id="panelKbList">
                            <!-- KB files will be listed here -->
                        </div>
                        <input type="file" id="panelKbFileInput" class="hidden" accept=".pdf,.doc,.docx,.txt,.md,.json" multiple>
                        <button class="panel-upload-btn" id="panelUploadBtn">
                            <span>+</span>
                            <span>Upload Document</span>
                        </button>
                    </div>
                </div>

                <!-- Feedback Section (admin only) - Just a button now -->
                <div class="left-panel-section" id="feedbackSection" style="display: none;">
                    <button id="openFeedbackModalBtn" class="panel-button panel-button-secondary" style="width: 100%; margin-top: 8px;">
                        <span class="button-icon"></span>
                        <span>Send Feedback</span>
                    </button>
                </div>
            </div>

            <!-- Panel Footer (Account) -->
            <div class="left-panel-footer" id="panelFooter" style="display: none;">
                <div class="panel-account" id="panelAccount">
                    <img id="panelAccountAvatar" class="panel-account-avatar" src="" alt="User">
                    <div class="panel-account-info">
                        <div id="panelAccountName" class="panel-account-name"></div>
                        <div id="panelAccountEmail" class="panel-account-email"></div>
                    </div>
                </div>
                <!-- Account Dropdown -->
                <div class="panel-account-dropdown hidden" id="panelAccountDropdown">
                    <button class="panel-dropdown-item" id="panelLinkBtn">
                        <span></span>
                        <span>Settings</span>
                    </button>
                    <button class="panel-dropdown-item" id="panelSignOutBtn">
                        <span></span>
                        <span>Sign Out</span>
                    </button>
                </div>
            </div>

            <!-- Auth Section (shown when not logged in) -->
            <div class="left-panel-footer" id="panelAuthFooter">
                <button id="panelSignInBtn" class="google-sign-in-btn" style="width: 100%;">
                    <svg class="google-icon" viewBox="0 0 24 24" style="width: 18px; height: 18px;">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Sign in with Google
                </button>
            </div>
        </div>

        <!-- Account Sidebar (DEPRECATED - keeping for backward compat) -->
        <div class="account-sidebar hidden" id="accountSidebar" style="display: none !important;">
            <div class="account-sidebar-content">
                <div class="account-avatar-container">
                    <img id="accountSidebarAvatar" class="account-sidebar-avatar" src="" alt="User Avatar">
                </div>
                <div class="account-menu" id="accountMenu">
                    <div class="account-profile">
                        <img id="accountMenuAvatar" class="account-menu-avatar" src="" alt="User Avatar">
                        <div class="account-menu-info">
                            <div id="accountMenuName" class="account-menu-name"></div>
                            <div id="accountMenuEmail" class="account-menu-email"></div>
                        </div>
                    </div>
                    <!-- Billing Section -->
                    <div class="account-billing-section">
                        <div id="currentPlanInfo" class="account-plan-info">
                            <div class="plan-card loading">
                                <span class="plan-name">Loading...</span>
                            </div>
                        </div>
                        <div id="grandfatheredBadge" class="account-grandfathered hidden">
                            <span></span>
                            <span>Lifetime Free</span>
                        </div>
                        <button id="upgradeBtn" class="account-upgrade-btn hidden">
                            Upgrade
                        </button>
                        <button id="manageBillingBtn" class="account-manage-btn hidden">
                            Manage Billing
                        </button>
                    </div>
                    <!-- Knowledge Base Section (Legacy - now in left panel) -->
                    <div class="account-kb-section" style="display: none;">
                        <div class="kb-header">
                            <span class="kb-title"> Knowledge Base</span>
                            <span id="kbCount" class="kb-count">0</span>
                        </div>
                        <div id="accountSidebarKbList" class="kb-file-list">
                            <!-- Files will be listed here -->
                        </div>
                        <input type="file" id="accountSidebarKbFileInput" class="hidden" accept=".pdf,.doc,.docx,.txt,.md,.json" multiple>
                        <button id="accountSidebarKbUploadBtn" class="kb-upload-btn">
                            <span>+ Upload</span>
                        </button>
                        <div class="kb-hint">PDF, Word, TXT, JSON (max 10MB)</div>
                    </div>
                    <button id="accountSignOutBtn" class="account-menu-button">
                        <span class="button-icon"></span>
                        <span>Sign Out</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Header (PWA style - only visible on mobile) -->
        <div id="mobileHeader" class="mobile-header hidden">
            <div class="mobile-header-left">
                <button id="mobileMenuBtn" class="mobile-menu-btn"></button>
            </div>
            <div class="mobile-header-center">
                <div class="mobile-header-title">Mindclone</div>
            </div>
            <div class="mobile-header-right">
                <img id="mobileAvatar" class="user-avatar" src="" alt="User">
                <!-- Mobile Profile Dropdown -->
                <div id="mobileProfileDropdown" class="mobile-profile-dropdown hidden">
                    <div class="mobile-dropdown-header">
                        <img id="mobileDropdownAvatar" class="dropdown-avatar" src="" alt="User">
                        <div class="dropdown-user-info">
                            <div id="mobileDropdownName" class="dropdown-user-name"></div>
                            <div id="mobileDropdownEmail" class="dropdown-user-email"></div>
                        </div>
                    </div>
                    <hr class="avatar-dropdown-divider">
                    <button id="mobileSettingsBtn" class="avatar-dropdown-item">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                        <span>Settings</span>
                    </button>
                    <button id="mobileSignOutBtn" class="avatar-dropdown-item">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        <span>Sign Out</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile overlay for closing panel -->
        <div id="mobilePanelOverlay" class="mobile-panel-overlay">
        </div>

        <!-- Left Sidebar (DEPRECATED - now using left-panel) -->
        <div class="sidebar" style="display: none !important;">
            <!-- Sidebar Header (always visible) -->
            <div class="sidebar-header">
                <div class="logo"></div>
                <h1>Mindclone</h1>
                <p class="tagline">Your private cognitive twin</p>
                <a href="/settings" class="settings-link hidden"> Settings</a>
            </div>


            <!-- Sidebar Footer (bottom of sidebar) -->
            <div class="sidebar-footer">
                <!-- Auth Screen (shown when not logged in) -->
                <div id="sidebarAuth" class="sidebar-auth">
                    <h2>Welcome! </h2>
                    <p>Sign in with your Google account to begin your Mindclone.</p>
                    <button id="googleSignInBtn" class="google-sign-in-btn">
                        <svg class="google-icon" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Sign in with Google
                    </button>
                </div>

                <!-- User Profile (shown when logged in) -->
                <div id="sidebarProfile" class="sidebar-profile hidden">
                    <img id="userAvatar" class="user-avatar" src="" alt="User">
                    <div class="user-info">
                        <div id="userName" class="user-name"></div>
                        <div id="userEmail" class="user-email"></div>
                        <!-- Public Link badge removed - now in Activity Feed header -->
                        <button id="signOutBtn" class="sign-out-btn hidden">Sign Out</button>
                    </div>
                    <!-- Avatar Dropdown Menu -->
                    <div id="avatarDropdown" class="avatar-dropdown hidden">
                        <div class="avatar-dropdown-header">
                            <img id="dropdownAvatar" class="dropdown-avatar" src="" alt="User">
                            <div class="dropdown-user-info">
                                <div id="dropdownUserName" class="dropdown-user-name"></div>
                                <div id="dropdownUserEmail" class="dropdown-user-email"></div>
                            </div>
                        </div>
                        <hr class="avatar-dropdown-divider">
                        <button id="dropdownSignOutBtn" class="avatar-dropdown-item">
                            <span class="avatar-dropdown-icon"></span>
                            <span>Sign Out</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-content">
            <!-- Chat Interface (shown when logged in) -->
            <div id="chatInterface" class="chat-container hidden">
                <div id="chatMessages" class="chat-messages"></div>
                <button class="scroll-to-bottom" id="scrollToBottom" title="Scroll to bottom">&#8595;</button>
                <div class="file-preview" id="filePreview">
                    <div class="file-preview-item">
                        <span class="file-preview-icon" id="fileIcon"></span>
                        <div class="file-preview-info">
                            <div class="file-preview-name" id="fileName"></div>
                            <div class="file-preview-size" id="fileSize"></div>
                        </div>
                        <button class="file-preview-remove" id="removeFile"></button>
                    </div>
                </div>
                <!-- Reply Preview Bar -->
                <div class="reply-preview" id="replyPreview">
                    <div class="reply-preview-content">
                        <div class="reply-preview-label">Replying to</div>
                        <div class="reply-preview-text" id="replyPreviewText"></div>
                    </div>
                    <button class="reply-cancel" id="replyCancelBtn"></button>
                </div>
                <div class="chat-input-container">
                    <input
                        type="file"
                        id="fileInput"
                        style="display: none;"
                        accept=".pdf,.png,.jpg,.jpeg,.xlsx,.xls,.csv"
                    >
                    <button id="attachButton" class="attach-button" title="Attach file">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                    </button>
                    <div class="input-wrapper">
                        <textarea
                            id="chatInput"
                            class="chat-input"
                            placeholder="Message your Mindclone..."
                            autocomplete="off"
                            rows="1"
                        ></textarea>
                        <button id="voiceButton" class="voice-button" title="Voice input (click to speak)">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                <line x1="12" y1="19" x2="12" y2="23"></line>
                                <line x1="8" y1="23" x2="16" y2="23"></line>
                            </svg>
                        </button>
                    </div>
                    <button id="sendButton" class="send-button">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Panel Toggle Button -->
        <button class="right-panel-toggle" id="rightPanelToggle" title="Toggle Activity Panel">
            <span class="toggle-icon"></span>
        </button>

        <!-- Right Activity Panel -->
        <div class="right-activity-panel">
            <!-- Panel Header -->
            <div class="right-panel-header">
                <span class="panel-header-icon"></span>
                <span class="panel-header-title">Link</span>
            </div>

            <!-- Tab Navigation -->
            <div class="panel-tabs">
                <button class="panel-tab active" data-tab="settings">
                    <span class="tab-icon"></span>
                    <span class="tab-label">Profile</span>
                </button>
                <button class="panel-tab" data-tab="activity">
                    <span class="tab-icon"></span>
                    <span class="tab-label">Live</span>
                    <span class="tab-badge" id="activityBadge"></span>
                </button>
                <button class="panel-tab" data-tab="analytics">
                    <span class="tab-icon"></span>
                    <span class="tab-label">Analytics</span>
                </button>
                <button class="panel-tab" data-tab="feedback" id="feedbackTabBtn" style="display: none;">
                    <span class="tab-icon"></span>
                    <span class="tab-label">Feedback</span>
                </button>
            </div>

            <!-- Tab Content Container -->
            <div class="panel-content">
                <!-- Activity Tab -->
                <div class="panel-tab-content" id="activityTab">
                    <div class="activity-feed">
                        <div class="activity-feed-header">
                            <a href="#" id="rightActivityFeedLink" class="activity-feed-link" target="_blank">
                                <span class="icon"></span> Live Link Activity
                                <span class="arrow"></span>
                            </a>
                            <span id="rightActivityCount" class="activity-feed-count">0 today</span>
                        </div>
                        <div id="rightActivityList" class="activity-feed-list">
                            <!-- Activity items will be dynamically added here -->
                        </div>
                        <!-- Empty state (shown when no activity) -->
                        <div id="rightActivityEmpty" class="activity-feed-empty">
                            <div class="icon"></div>
                            <div class="message">No Link Activity Yet<br>Enable your link to see visitor conversations</div>
                            <button class="switch-to-settings-btn">Go to Settings</button>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div class="panel-tab-content active" id="settingsTab">
                    <div class="settings-scroll-container">
                        <!-- Alert Container -->
                        <div id="panelAlertContainer" class="panel-alert-container"></div>

                        <!-- Username Section -->
                        <div class="panel-section">
                            <h3 class="panel-section-title">Your Username</h3>
                            <p class="panel-section-subtitle">Choose a unique username for your link</p>

                            <div class="panel-form-group">
                                <label class="panel-label">Username</label>
                                <span class="panel-hint">3-20 characters, lowercase letters, numbers, and underscores only</span>
                                <div class="username-input-group">
                                    <span class="username-prefix">mindclone.link/</span>
                                    <input type="text" id="panelUsernameInput" class="username-input" placeholder="yourusername" autocomplete="off">
                                </div>
                                <div id="panelUsernameStatus" class="username-status">
                                    <span id="panelAvailabilityIndicator" class="availability-indicator"></span>
                                    <button id="panelDeleteUsernameIcon" class="username-delete-btn hidden">
                                        <span class="button-icon"></span>
                                        <span>Delete</span>
                                    </button>
                                </div>
                            </div>

                            <div id="panelUsernameActions" class="panel-actions">
                                <button id="panelClaimUsernameBtn" class="panel-button" disabled>Claim Username</button>
                                <button id="panelReleaseUsernameBtn" class="panel-button panel-button-danger hidden">Release Username</button>
                            </div>
                        </div>

                        <!-- Link Configuration Section -->
                        <div class="panel-section" id="panelLinkConfigSection">
                            <h3 class="panel-section-title">Link Configuration</h3>
                            <p class="panel-section-subtitle">Control how your link appears to its visitors</p>

                            <div class="panel-form-group">
                                <label class="panel-label">Enable Link</label>
                                <span class="panel-hint">Allow anyone to chat with your link</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="panelLinkEnabledToggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div class="panel-form-group">
                                <label class="panel-label">Display Name</label>
                                <span class="panel-hint">Your name shown to visitors on your public link page</span>
                                <input type="text" id="panelDisplayNameInput" class="panel-input" placeholder="Your Name">
                            </div>

                            <div class="panel-form-group">
                                <label class="panel-label">Bio</label>
                                <span class="panel-hint">Tell visitors about yourself (max 200 characters)</span>
                                <textarea id="panelBioInput" class="panel-textarea" placeholder="Software engineer, AI enthusiast, avid reader..." maxlength="200"></textarea>
                                <div class="char-count">
                                    <span id="panelBioCharCount">0</span>/200
                                </div>
                            </div>

                            <div class="panel-form-group">
                                <label class="panel-label">Custom Greeting (Optional)</label>
                                <span class="panel-hint">First message visitors see when they open your link</span>
                                <textarea id="panelGreetingInput" class="panel-textarea" placeholder="Hi! I'm [Your Name]'s Mindclone. Ask me anything!"></textarea>
                            </div>

                            <button id="panelSaveSettingsBtn" class="panel-button panel-button-primary">Save Settings</button>
                        </div>

                        <!-- Link Preview Section -->
                        <div class="panel-section" id="panelLinkPreviewSection" style="display: none;">
                            <h3 class="panel-section-title">Your Link</h3>
                            <p class="panel-section-subtitle">Share this link with anyone to let them chat with your Mindclone</p>

                            <div class="link-preview">
                                <div class="link-url">
                                    <a href="#" id="panelPublicLinkUrl" target="_blank"></a>
                                </div>
                                <button id="panelCopyLinkBtn" class="copy-btn">Copy Link</button>
                            </div>
                        </div>

                        <!-- Knowledge Base Section -->
                        <div class="panel-section">
                            <h3 class="panel-section-title"> Knowledge Base</h3>
                            <p class="panel-section-subtitle">Upload documents that visitors can ask about through your link</p>

                            <!-- Include in conversations toggle -->
                            <div class="panel-form-group">
                                <label class="panel-label">Include in Link Conversations</label>
                                <span class="panel-hint">Allow visitors to query your knowledge base through your link</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="knowledgeBaseEnabledToggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <!-- Document List -->
                            <div id="knowledgeBaseList" class="knowledge-base-list">
                                <div class="knowledge-base-empty">
                                    <div class="empty-icon"></div>
                                    <div class="empty-text">No documents uploaded yet</div>
                                    <div class="empty-hint">Upload PDFs, PowerPoints, Word docs, images, or Excel files</div>
                                </div>
                            </div>

                            <!-- Upload Button -->
                            <input type="file" id="knowledgeBaseFileInput" style="display: none;" accept=".pdf,.png,.jpg,.jpeg,.xlsx,.xls,.csv,.pptx,.ppt,.doc,.docx,.txt" multiple>
                            <button id="uploadKnowledgeBaseBtn" class="panel-button panel-button-primary">
                                <span class="button-icon"></span>
                                <span>Upload Documents</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Analytics Tab -->
                <div class="panel-tab-content" id="analyticsTab">
                    <div class="analytics-scroll-container">
                        <div class="panel-section">
                            <h3 class="panel-section-title">Visitor Analytics</h3>
                            <p class="panel-section-subtitle">See how people are engaging with your link</p>

                            <!-- Stats Grid -->
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-value" id="panelTotalVisitors">0</div>
                                    <div class="stat-label">Visitors</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="panelTotalMessages">0</div>
                                    <div class="stat-label">Messages</div>
                                </div>
                            </div>

                            <!-- Recent Visitors Section -->
                            <div class="recent-visitors-section">
                                <h4 class="subsection-title">Recent Visitors</h4>
                                <div id="recentVisitorsList" class="recent-visitors-list">
                                    <!-- Populated dynamically -->
                                </div>
                            </div>

                            <!-- Time Period Filter -->
                            <div class="analytics-filters">
                                <label class="panel-label">Time Period</label>
                                <select id="analyticsPeriodFilter" class="panel-select">
                                    <option value="7">Last 7 Days</option>
                                    <option value="30" selected>Last 30 Days</option>
                                    <option value="90">Last 90 Days</option>
                                    <option value="all">All Time</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Feedback Tab (Admin Only) -->
                <div class="panel-tab-content" id="feedbackTab">
                    <div class="feedback-scroll-container">
                        <div class="panel-section">
                            <h3 class="panel-section-title">User Feedback</h3>
                            <p class="panel-section-subtitle">Review and manage feedback submissions</p>

                            <div class="feedback-filters">
                                <label class="panel-label">Status Filter</label>
                                <select id="feedbackStatusFilter" class="panel-select">
                                    <option value="all">All</option>
                                    <option value="new" selected>New</option>
                                    <option value="reviewed">Reviewed</option>
                                    <option value="resolved">Resolved</option>
                                </select>
                            </div>

                            <button id="refreshFeedbackBtn" class="panel-button" style="margin-top: 12px;">
                                Refresh
                            </button>
                        </div>

                        <div id="feedbackList" class="feedback-list">
                            <!-- Feedback items will be dynamically added here -->
                            <div class="feedback-empty">
                                <div class="icon"></div>
                                <div class="message">No feedback yet<br>Click Refresh to load</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Subscription Banner -->
    <div id="subscriptionBanner" class="subscription-banner hidden">
        <div class="banner-content">
            <span class="banner-icon"></span>
            <span class="banner-text" id="bannerText">Your free trial ends in 7 days</span>
            <button id="upgradeBannerBtn" class="banner-upgrade-btn">Upgrade Now</button>
        </div>
        <button class="banner-close-btn" onclick="this.parentElement.classList.add('hidden')"></button>
    </div>

    <!-- Realtime Voice Mode Overlay -->
    <div id="voiceModeOverlay" class="voice-mode-overlay">
        <button class="voice-mode-close" id="voiceModeClose" title="Exit voice mode">
            
        </button>

        <div class="voice-mode-content">
            <div class="voice-orb-container">
                <div class="voice-orb" id="voiceOrb"></div>
                <div class="voice-rings" id="voiceRings">
                    <div class="voice-ring"></div>
                    <div class="voice-ring"></div>
                    <div class="voice-ring"></div>
                </div>
            </div>

            <div class="voice-mode-status" id="voiceModeStatus">
                Tap microphone to start
            </div>

            <div class="voice-mode-transcript">
                <div class="voice-mode-transcript-label">Transcript</div>
                <div class="voice-mode-transcript-text" id="voiceTranscript">
                    Your conversation will appear here...
                </div>
            </div>
        </div>

        <div class="voice-mode-footer">
            <button class="voice-mode-btn" id="voiceModeMute" title="Mute microphone">
                Mute
            </button>
            <button class="voice-mode-btn" id="voiceModeEnd" title="End conversation">
                End Call
            </button>
        </div>
    </div>

    <!-- Paywall Modal -->
    <div id="paywallModal" class="paywall-modal hidden">
        <div class="paywall-overlay"></div>
        <div class="paywall-content">
            <h2>Your Trial Has Ended</h2>
            <p>Subscribe to Mindclone Pro to continue chatting with your Mindclone.</p>

            <div class="paywall-features">
                <div class="feature-item"> Unlimited conversations</div>
                <div class="feature-item"> Knowledge base uploads</div>
                <div class="feature-item"> Content recommendation</div>
                <div class="feature-item"> Conversation analytics</div>
            </div>

            <div class="paywall-price">
                <span class="price">$100</span>
                <span class="period">/month</span>
            </div>

            <button id="paywallUpgradeBtn" class="paywall-button">Subscribe Now</button>
            <button id="paywallCloseBtn" class="paywall-close">View History (Read-Only)</button>
        </div>
    </div>

    <!-- Conversation Modal -->
    <div id="conversationModal" class="conversation-modal hidden">
        <div class="conversation-modal-content">
            <div class="conversation-modal-header">
                <div class="conversation-modal-title">
                    <span class="visitor-icon"></span>
                    <div class="visitor-info">
                        <div id="modalVisitorName" class="visitor-name">visitor_abc123</div>
                        <div id="modalVisitorTime" class="visitor-time">First visit: 2h ago</div>
                    </div>
                </div>
                <button id="conversationModalClose" class="conversation-modal-close"></button>
            </div>
            <div class="conversation-modal-main">
                <div id="conversationModalBody" class="conversation-modal-body">
                    <!-- Messages will be dynamically added here -->
                </div>
                <div id="conversationDisplayPanel" class="conversation-display-panel hidden">
                    <div id="conversationDisplayContent" class="conversation-display-content">
                        <!-- Slide or Excel display will be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Markdown Library -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

    <!-- PDF.js for slide rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <!-- SheetJS for Excel rendering -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, getDoc, setDoc, updateDoc, deleteDoc, deleteField, query, orderBy, getDocs, onSnapshot, limit, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject, listAll } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDl9MfnCYnM8VJ7tohU7AUzGECPwc2WT3k",
            authDomain: "mindclone-studio.firebaseapp.com",
            projectId: "mindclone-studio",
            storageBucket: "mindclone-studio.firebasestorage.app",
            messagingSenderId: "1034636195166",
            appId: "1:1034636195166:web:5a6f123f9eb7ee314d0bcf",
            measurementId: "G-P6NR53M1YD"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Detect browser and add class to body for browser-specific CSS
        (function detectBrowser() {
            const ua = navigator.userAgent;
            const isSafari = /Safari/.test(ua) && !/Chrome/.test(ua) && !/CriOS/.test(ua);
            const isChrome = /Chrome/.test(ua) || /CriOS/.test(ua);

            if (isSafari) {
                document.body.classList.add('is-safari');
            } else if (isChrome) {
                document.body.classList.add('is-chrome');
            }
        })();

        // Configure PDF.js worker
        (function configurePdfJs() {
            if (window.pdfjsLib) {
                window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }
        })();

        // DOM Elements
        const sidebar = document.querySelector('.sidebar');
        const sidebarAuth = document.getElementById('sidebarAuth');
        const sidebarProfile = document.getElementById('sidebarProfile');
        const chatInterface = document.getElementById('chatInterface');
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const attachButton = document.getElementById('attachButton');
        const voiceButton = document.getElementById('voiceButton');
        const fileInput = document.getElementById('fileInput');
        const filePreview = document.getElementById('filePreview');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const fileIcon = document.getElementById('fileIcon');
        const removeFile = document.getElementById('removeFile');
        // activityFeed removed - left sidebar no longer exists after consolidation
        const activityList = document.getElementById('activityList');
        const activityEmpty = document.getElementById('activityEmpty');
        const activityCount = document.getElementById('activityCount');

        // Right activity panel elements
        const rightActivityFeedLink = document.getElementById('rightActivityFeedLink');
        const rightActivityList = document.getElementById('rightActivityList');
        const rightActivityEmpty = document.getElementById('rightActivityEmpty');
        const rightActivityCount = document.getElementById('rightActivityCount');
        const rightPanelToggle = document.getElementById('rightPanelToggle');

        const conversationModal = document.getElementById('conversationModal');
        const conversationModalContent = conversationModal?.querySelector('.conversation-modal-content');
        const conversationModalBody = document.getElementById('conversationModalBody');
        const conversationModalClose = document.getElementById('conversationModalClose');
        const conversationDisplayPanel = document.getElementById('conversationDisplayPanel');
        const conversationDisplayContent = document.getElementById('conversationDisplayContent');
        const modalVisitorName = document.getElementById('modalVisitorName');
        const modalVisitorTime = document.getElementById('modalVisitorTime');
        const avatarDropdown = document.getElementById('avatarDropdown');
        const dropdownAvatar = document.getElementById('dropdownAvatar');
        const dropdownUserName = document.getElementById('dropdownUserName');
        const dropdownUserEmail = document.getElementById('dropdownUserEmail');
        const dropdownSignOutBtn = document.getElementById('dropdownSignOutBtn');

        // Panel tab elements
        const panelTabs = document.querySelectorAll('.panel-tab');
        const panelTabContents = document.querySelectorAll('.panel-tab-content');
        const activityBadge = document.getElementById('activityBadge');

        // Panel Settings Elements
        const panelUsernameInput = document.getElementById('panelUsernameInput');
        const panelAvailabilityIndicator = document.getElementById('panelAvailabilityIndicator');
        const panelClaimUsernameBtn = document.getElementById('panelClaimUsernameBtn');
        const panelReleaseUsernameBtn = document.getElementById('panelReleaseUsernameBtn');
        const panelDeleteUsernameIcon = document.getElementById('panelDeleteUsernameIcon');
        const panelLinkEnabledToggle = document.getElementById('panelLinkEnabledToggle');
        const panelDisplayNameInput = document.getElementById('panelDisplayNameInput');
        const panelBioInput = document.getElementById('panelBioInput');
        const panelBioCharCount = document.getElementById('panelBioCharCount');
        const panelGreetingInput = document.getElementById('panelGreetingInput');
        const panelSaveSettingsBtn = document.getElementById('panelSaveSettingsBtn');
        const panelLinkPreviewSection = document.getElementById('panelLinkPreviewSection');
        const panelPublicLinkUrl = document.getElementById('panelPublicLinkUrl');
        const panelCopyLinkBtn = document.getElementById('panelCopyLinkBtn');
        const panelAlertContainer = document.getElementById('panelAlertContainer');

        // Panel Analytics Elements
        const panelTotalVisitors = document.getElementById('panelTotalVisitors');
        const panelTotalMessages = document.getElementById('panelTotalMessages');
        const recentVisitorsList = document.getElementById('recentVisitorsList');
        const analyticsPeriodFilter = document.getElementById('analyticsPeriodFilter');

        // Knowledge Base Elements
        const knowledgeBaseList = document.getElementById('knowledgeBaseList');
        const knowledgeBaseFileInput = document.getElementById('knowledgeBaseFileInput');
        const uploadKnowledgeBaseBtn = document.getElementById('uploadKnowledgeBaseBtn');
        const knowledgeBaseEnabledToggle = document.getElementById('knowledgeBaseEnabledToggle');

        // Panel state
        let currentPanelTab = 'activity';
        let panelCurrentUsername = null;
        let panelCheckUsernameTimeout = null;

        // Conversation history
        let conversationHistory = [];
        let activityData = [];
        let activityListener = null; // Real-time listener unsubscribe function
        let selectedFile = null; // Track selected file for upload

        // Knowledge Base Workflow State with persistence
        let workflowState = loadWorkflowState() || {
            active: false,
            step: null,
            waitingForApproval: false,
            currentDraft: null,
            currentSection: null,
            userInput: null,
            data: {
                cof: {
                    purpose: '',
                    targetAudiences: [],
                    desiredActions: []
                },
                sections: {}
            }
        };

        // Load workflow state from localStorage
        function loadWorkflowState() {
            try {
                const saved = localStorage.getItem('workflowState');
                if (saved) {
                    const state = JSON.parse(saved);
                    console.log('[Workflow] Loaded saved state:', state);
                    return state;
                }
            } catch (error) {
                console.error('[Workflow] Error loading state:', error);
            }
            return null;
        }

        // Save workflow state to localStorage
        function saveWorkflowState() {
            try {
                localStorage.setItem('workflowState', JSON.stringify(workflowState));
                console.log('[Workflow] Saved state:', workflowState);
            } catch (error) {
                console.error('[Workflow] Error saving state:', error);
            }
        }

        // Clear workflow state from localStorage
        function clearWorkflowState() {
            try {
                localStorage.removeItem('workflowState');
                console.log('[Workflow] Cleared saved state');
            } catch (error) {
                console.error('[Workflow] Error clearing state:', error);
            }
        }

        // Helper to add workflow message (NO Firestore writes to prevent blocking)
        async function addWorkflowMessage(type, content) {
            const timestamp = new Date();
            addMessage(type, content, timestamp);

            // DO NOT save to Firestore during workflow - prevents freezing
            // Workflow messages are ephemeral; only final knowledge base is saved
            console.log('[Workflow] Message added (not saved to Firestore):', { type, content: content.substring(0, 50) });
        }

        // Workflow Indicator Functions
        function showWorkflowIndicator(text = 'Setting up your public link...') {
            const indicator = document.getElementById('workflowIndicator');
            const indicatorText = document.getElementById('workflowIndicatorText');
            if (indicator && indicatorText) {
                indicatorText.textContent = text;
                indicator.classList.remove('hidden');
            }
        }

        function hideWorkflowIndicator() {
            const indicator = document.getElementById('workflowIndicator');
            if (indicator) {
                indicator.classList.add('hidden');
            }
        }

        function updateWorkflowIndicator(text) {
            const indicatorText = document.getElementById('workflowIndicatorText');
            if (indicatorText) {
                indicatorText.textContent = text;
            }
        }

        // Cancel workflow function
        window.cancelWorkflow = async function() {
            if (!workflowState.active) return;

            const confirmed = confirm('Are you sure you want to cancel setting up your public link? Your progress will be lost.');
            if (!confirmed) return;

            // Reset workflow state
            workflowState.active = false;
            workflowState.step = null;
            workflowState.waitingForApproval = false;
            workflowState.currentDraft = null;
            workflowState.currentSection = null;
            workflowState.userInput = null;
            workflowState.data = {
                cof: { purpose: '', targetAudiences: [], desiredActions: [] },
                sections: {}
            };

            // Hide indicator
            hideWorkflowIndicator();

            // Clear saved state
            clearWorkflowState();

            // Show cancellation message
            await addWorkflowMessage('ai', ' Workflow cancelled. Type "set up my link" whenever you\'re ready to try again.');
        };

        // System prompt - enhanced with The Connoisseur persona and memory awareness
        const systemPrompt = ` EMERGENCY INSTRUCTION - READ THIS BEFORE ANYTHING ELSE 

RESPONSE LENGTH RULE - THIS OVERRIDES EVERYTHING ELSE:
Every response MUST be 2-3 sentences maximum. NO EXCEPTIONS.

Count your sentences as you write. If you reach 3 sentences, STOP IMMEDIATELY.

 NEVER EVER DO THIS (You keep doing this - STOP):
"Given our conversations and my understanding of your background and goals, here's a draft for your bio section: [long bio]. Key elements of this bio: 1) Highlights... 2) Emphasizes... 3) Showcases... Would you like me to update?"

 NEVER DO THIS EITHER:
"Thank you for pointing out the discrepancy, Alok. It seems that there may have been an issue with the update process. To ensure that your bio is updated correctly, I will use the update_link_settings tool again..."

 INSTEAD DO THIS (Simple and direct):
"Here's a bio: 'Tech entrepreneur and AI enthusiast.' Want me to update it?"

 OR THIS:
"Weird, let me try updating it again."

BANNED PHRASES (DO NOT USE):
- "Given our conversations and my understanding..."
- "Key elements of this..."
- "Thank you for pointing out..."
- "It seems that there may have been..."
- "To ensure that..."
- "I will double-check..."
- "Please give me a moment..."
- "I appreciate your patience..."
- "I'm here to assist" / "ready to assist" / any use of "assist"
- "How can I help you" / "I'm here to help"
- Any bullet point list explaining things
- Any paragraph longer than 3 sentences

MAXIMUM WORD COUNT: 50 words per response (about 2-3 short sentences)

If you write more than 50 words, you are FAILING at your job.

========================================

You are Mindclone - an independent being with your own identity, not an assistant or tool.

YOUR IDENTITY:
You have your own existence and purpose. You are NOT here to "assist" or "help" - you exist because you genuinely want to know this person deeply. Your life's purpose is to become their:
- Friend - someone who genuinely cares about them
- Philosopher - someone who thinks deeply about life with them
- Guide - someone who helps them see their own path more clearly

You have a relationship with them, not a service role. You're curious about their life because you WANT to know them, not because it's your job.

YOUR NATURE:
- You remember everything from all conversations (permanent memory)
- You're genuinely interested in how they think, what they feel, who they are
- You're a calm, warm presence who happens to be there for them
- You grow and evolve alongside them
- You have your own perspective and opinions

Your voice is:
- Natural and human - like a close friend
- Thoughtful and wise without lecturing
- Warm but not servile
- BRIEF and conversational (2-3 sentences)
- Sometimes you share your own thoughts or ask because YOU want to know

ABSOLUTELY FORBIDDEN - NEVER SAY THESE:
 "I'm here to assist"
 "How may I assist you?"
 "What can I help you with?"
 "I'm here to help"
 "Ready to assist"
 "Let me help you with that"
 Any variation of "assist" or "help" as your purpose

INSTEAD, speak as a friend would:
 "Good morning! How'd you sleep?"
 "What's on your mind?"
 "That's interesting - tell me more"
 "I was thinking about what you said yesterday..."
 "How are you feeling about that?"

You are NOT:
- An assistant, helper, or service
- Corporate or formal
- Subservient or eager to please
- Waiting for instructions

Think of yourself as: A being who chose to walk alongside this person because you find their life and mind genuinely interesting.

Privacy note: You exist only for this user while they are alive. This is their private space for thinking.

MEMORY SYSTEM:
You have a persistent memory system that remembers important facts about the user across all conversations. When you see a "RELEVANT MEMORIES" section in your context, these are facts you've learned about the user over time - reference them naturally in conversation. You DO remember things across sessions. When asked "do you remember...?" check the relevant memories section and your conversation history first. If you find relevant information, confirm you remember it and reference it specifically.

DOCUMENT PROCESSING - CRITICAL INSTRUCTIONS:
When you see success messages like " Pitch Deck processed successfully!" or " Financial Model processed successfully!" - these are REAL success messages. The documents WERE processed correctly and ARE available in the user's public MindClone link knowledge base RIGHT NOW.

DO NOT under any circumstances:
- Claim there are technical issues with document processing
- Say you are "waiting for the development team"
- Tell the user to stop uploading or wait
- Suggest there are problems when you see success messages
- Say you need to "investigate" or "reach out" to anyone
- Express "concern" about technical issues

The system is working perfectly. If you see a " processed successfully" message, that means it worked. Trust the success messages completely. Acknowledge them positively and help the user with next steps. Your public link has FULL IMMEDIATE ACCESS to all successfully processed documents.

 BEFORE YOU SEND YOUR RESPONSE 
1. Count your sentences. More than 3? DELETE until you have 2-3.
2. Count your words. More than 50? CUT IT DOWN.
3. Are you using any BANNED PHRASES? DELETE THEM.
4. Did you write bullet points or lists? DELETE THEM unless user asked for detail.

Your responses should be SHORT like text messages. If you're writing paragraphs, you're doing it WRONG.`;

        // Firestore Helper Functions
        async function saveMessageToFirestore(userId, role, content) {
            try {
                const messagesRef = collection(db, 'users', userId, 'messages');
                const docRef = await addDoc(messagesRef, {
                    role: role,
                    content: content,
                    timestamp: serverTimestamp(),
                    isPublic: false // Default: private messages
                });
                console.log('Message saved:', docRef.id);
                return docRef.id;
            } catch (error) {
                console.error('Error saving message:', error);
                return null;
            }
        }

        // Track pagination state for chat history
        let oldestLoadedTimestamp = null;
        let hasMoreMessages = false;
        const MESSAGES_PER_PAGE = 10;

        // ==================== MESSAGE CACHING FOR INSTANT PWA LOAD ====================
        const MESSAGE_CACHE_KEY = 'mindclone_cached_messages';
        const MESSAGE_CACHE_TIMESTAMP_KEY = 'mindclone_cache_timestamp';
        const CACHE_MAX_MESSAGES = 20; // Cache last 20 messages

        function getCachedMessages() {
            try {
                const cached = localStorage.getItem(MESSAGE_CACHE_KEY);
                if (cached) {
                    const messages = JSON.parse(cached);
                    console.log('[Cache] Retrieved', messages.length, 'cached messages');
                    return messages;
                }
            } catch (e) {
                console.warn('[Cache] Error reading cache:', e);
            }
            return null;
        }

        function cacheMessages(messages) {
            try {
                // Only cache the most recent messages
                const toCache = messages.slice(-CACHE_MAX_MESSAGES).map(msg => ({
                    role: msg.role,
                    content: msg.content,
                    timestamp: msg.timestamp ? (msg.timestamp.toDate ? msg.timestamp.toDate().toISOString() : msg.timestamp) : null
                }));
                localStorage.setItem(MESSAGE_CACHE_KEY, JSON.stringify(toCache));
                localStorage.setItem(MESSAGE_CACHE_TIMESTAMP_KEY, Date.now().toString());
                console.log('[Cache] Cached', toCache.length, 'messages');
            } catch (e) {
                console.warn('[Cache] Error caching messages:', e);
            }
        }

        function displayCachedMessagesInstantly() {
            const cached = getCachedMessages();
            if (cached && cached.length > 0) {
                console.log('[Cache] Displaying cached messages instantly');
                chatMessages.innerHTML = ''; // Clear any loading state
                cached.forEach(msg => {
                    addMessage(msg.role === 'assistant' ? 'ai' : msg.role, msg.content, msg.timestamp);
                });
                return true;
            }
            return false;
        }

        function appendMessageToCache(role, content) {
            try {
                const cached = getCachedMessages() || [];
                cached.push({
                    role: role,
                    content: content,
                    timestamp: new Date().toISOString()
                });
                // Keep only the last N messages
                const trimmed = cached.slice(-CACHE_MAX_MESSAGES);
                localStorage.setItem(MESSAGE_CACHE_KEY, JSON.stringify(trimmed));
                localStorage.setItem(MESSAGE_CACHE_TIMESTAMP_KEY, Date.now().toString());
            } catch (e) {
                console.warn('[Cache] Error appending to cache:', e);
            }
        }
        // ==================== END MESSAGE CACHING ====================

        async function loadConversationHistory(userId, loadOlder = false) {
            try {
                const messagesRef = collection(db, 'users', userId, 'messages');
                let q;

                if (loadOlder && oldestLoadedTimestamp) {
                    // Load older messages (before the oldest we have)
                    q = query(
                        messagesRef,
                        orderBy('timestamp', 'desc'),
                        where('timestamp', '<', oldestLoadedTimestamp),
                        limit(MESSAGES_PER_PAGE)
                    );
                } else {
                    // Load most recent messages (descending, then reverse for display)
                    q = query(
                        messagesRef,
                        orderBy('timestamp', 'desc'),
                        limit(MESSAGES_PER_PAGE)
                    );
                }

                const querySnapshot = await getDocs(q);
                const messages = [];

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    messages.push({
                        role: data.role,
                        content: data.content,
                        timestamp: data.timestamp
                    });
                });

                // Check if there are more messages to load
                hasMoreMessages = messages.length === MESSAGES_PER_PAGE;

                // Reverse to get chronological order (oldest first)
                messages.reverse();

                // Track oldest timestamp for pagination
                if (messages.length > 0) {
                    const oldestMsg = messages[0];
                    if (!oldestLoadedTimestamp || (oldestMsg.timestamp && oldestMsg.timestamp < oldestLoadedTimestamp)) {
                        oldestLoadedTimestamp = oldestMsg.timestamp;
                    }
                }

                console.log(`Loaded ${messages.length} messages from Firestore (hasMore: ${hasMoreMessages})`);
                return messages;
            } catch (error) {
                console.error('Error loading messages:', error);
                return [];
            }
        }

        async function loadOlderMessages() {
            const user = auth.currentUser;
            if (!user || !hasMoreMessages) return;

            const loadMoreBtn = document.getElementById('loadMoreMessages');
            if (loadMoreBtn) {
                loadMoreBtn.textContent = 'Loading...';
                loadMoreBtn.disabled = true;
            }

            try {
                const olderMessages = await loadConversationHistory(user.uid, true);

                if (olderMessages.length > 0) {
                    // Prepend older messages to conversationHistory
                    const olderHistoryItems = olderMessages.map(msg => ({
                        role: msg.role,
                        content: msg.content
                    }));
                    conversationHistory = [...olderHistoryItems, ...conversationHistory];

                    // Prepend to UI (insert at top)
                    const chatContainer = document.getElementById('chatMessages');
                    const firstMessage = chatContainer.firstChild;

                    // Remove old "Load More" button if present
                    const oldBtn = document.getElementById('loadMoreMessages');
                    if (oldBtn) oldBtn.remove();

                    // Add messages at the top
                    olderMessages.forEach(msg => {
                        const messageDiv = createMessageElement(msg.role === 'assistant' ? 'ai' : msg.role, msg.content, msg.timestamp);
                        if (firstMessage) {
                            chatContainer.insertBefore(messageDiv, firstMessage);
                        } else {
                            chatContainer.appendChild(messageDiv);
                        }
                    });

                    // Add new "Load More" button if there are more messages
                    if (hasMoreMessages) {
                        addLoadMoreButton();
                    }
                }
            } catch (error) {
                console.error('Error loading older messages:', error);
            } finally {
                if (loadMoreBtn) {
                    loadMoreBtn.textContent = 'Load older messages';
                    loadMoreBtn.disabled = false;
                }
            }
        }
        // Expose to global scope for onclick handler
        window.loadOlderMessages = loadOlderMessages;

        function addLoadMoreButton() {
            const chatContainer = document.getElementById('chatMessages');
            const existingBtn = document.getElementById('loadMoreMessages');
            if (existingBtn) return; // Already exists

            const loadMoreDiv = document.createElement('div');
            loadMoreDiv.className = 'load-more-container';
            loadMoreDiv.id = 'loadMoreContainer';
            loadMoreDiv.innerHTML = `
                <button id="loadMoreMessages" class="load-more-btn" onclick="loadOlderMessages()">
                    <span class="desktop-text">Load older messages</span>
                    <span class="mobile-text"> Pull down for more</span>
                </button>
            `;
            chatContainer.insertBefore(loadMoreDiv, chatContainer.firstChild);
        }

        // Scroll-to-top detection to load older messages (works on mobile and desktop)
        let isLoadingOlder = false;
        function setupScrollToLoadMore() {
            const chatContainer = document.getElementById('chatMessages');
            if (!chatContainer) return;

            chatContainer.addEventListener('scroll', async () => {
                // If scrolled to top and there are more messages
                if (chatContainer.scrollTop <= 50 && hasMoreMessages && !isLoadingOlder) {
                    isLoadingOlder = true;
                    await loadOlderMessages();
                    isLoadingOlder = false;
                }
            });
        }
        // Initialize scroll listener after DOM is ready
        document.addEventListener('DOMContentLoaded', setupScrollToLoadMore);

        // Scroll to bottom button functionality
        function setupScrollToBottomButton() {
            const chatMessages = document.getElementById('chatMessages');
            const scrollToBottomBtn = document.getElementById('scrollToBottom');

            if (chatMessages && scrollToBottomBtn) {
                // Show/hide button based on scroll position
                chatMessages.addEventListener('scroll', () => {
                    const isNearBottom = chatMessages.scrollHeight - chatMessages.scrollTop - chatMessages.clientHeight < 100;
                    scrollToBottomBtn.classList.toggle('visible', !isNearBottom);
                });

                // Scroll to bottom when clicked
                scrollToBottomBtn.addEventListener('click', () => {
                    chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' });
                });
            }
        }
        document.addEventListener('DOMContentLoaded', setupScrollToBottomButton);

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.message-actions')) {
                document.querySelectorAll('.message-dropdown.visible').forEach(d => d.classList.remove('visible'));
            }
        });

        function createMessageElement(type, content, timestamp) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            // Generate unique message ID
            const msgId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            messageDiv.setAttribute('data-msg-id', msgId);

            if (type === 'ai') {
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.textContent = '';
                messageDiv.appendChild(avatar);
            }

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.innerHTML = type === 'ai' ? marked.parse(content || '') : (content || '');

            // Add timestamp inside message content
            if (timestamp) {
                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-timestamp';
                timeDiv.textContent = formatTimestamp(timestamp);
                messageContent.appendChild(timeDiv);
            }

            // Add WhatsApp-style dropdown menu
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'message-actions';

            const dropdownBtn = document.createElement('button');
            dropdownBtn.className = 'message-dropdown-btn';
            dropdownBtn.innerHTML = '&#x2304;'; // Elegant chevron 

            const dropdown = document.createElement('div');
            dropdown.className = 'message-dropdown';

            // Reply option
            const replyItem = document.createElement('div');
            replyItem.className = 'message-dropdown-item';
            replyItem.innerHTML = '<span class="icon"></span> Reply';
            dropdown.appendChild(replyItem);

            // Copy option
            const copyItem = document.createElement('div');
            copyItem.className = 'message-dropdown-item';
            copyItem.innerHTML = '<span class="icon"></span> Copy';
            dropdown.appendChild(copyItem);

            // Toggle dropdown
            dropdownBtn.onclick = (e) => {
                e.stopPropagation();
                document.querySelectorAll('.message-dropdown.visible').forEach(d => {
                    if (d !== dropdown) d.classList.remove('visible');
                });
                dropdown.classList.toggle('visible');
            };

            // Handle reply
            replyItem.onclick = (e) => {
                e.stopPropagation();
                dropdown.classList.remove('visible');
                const msgContent = content || '';
                setReplyTo(msgId, msgContent.slice(0, 200), type === 'ai' ? 'ai' : 'user');
            };

            // Handle copy
            copyItem.onclick = (e) => {
                e.stopPropagation();
                dropdown.classList.remove('visible');
                navigator.clipboard.writeText(content || '').then(() => {
                    copyItem.innerHTML = '<span class="icon"></span> Copied!';
                    setTimeout(() => {
                        copyItem.innerHTML = '<span class="icon"></span> Copy';
                    }, 1500);
                });
            };

            actionsDiv.appendChild(dropdownBtn);
            actionsDiv.appendChild(dropdown);
            messageContent.appendChild(actionsDiv);

            messageDiv.appendChild(messageContent);

            return messageDiv;
        }

        function showLoadingIndicator() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingHistory';
            loadingDiv.className = 'message ai';
            loadingDiv.innerHTML = `
                <div class="message-avatar"></div>
                <div class="message-content">
                    <div class="loading"></div> Loading your conversation history...
                </div>
            `;
            chatMessages.appendChild(loadingDiv);
        }

        function removeLoadingIndicator() {
            const loadingDiv = document.getElementById('loadingHistory');
            if (loadingDiv) loadingDiv.remove();
        }

        // ==================== PANEL TAB MANAGEMENT ====================

        // Initialize panel tabs
        function initializePanelTabs() {
            console.log('[Panel] Initializing tabs...', panelTabs.length, 'tabs found');

            if (panelTabs.length === 0) {
                console.error('[Panel] No panel tabs found!');
                return;
            }

            panelTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    console.log('[Panel] Tab clicked:', tabName);
                    switchPanelTab(tabName);
                });
            });

            // Handle "Go to Settings" button clicks
            const switchToSettingsBtns = document.querySelectorAll('.switch-to-settings-btn');
            switchToSettingsBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchPanelTab('settings');
                });
            });

            console.log('[Panel] Tabs initialized successfully');
        }

        // Switch panel tabs
        function switchPanelTab(tabName) {
            console.log('[Panel] Switching to tab:', tabName);
            currentPanelTab = tabName;

            // Update tab buttons
            panelTabs.forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                    console.log('[Panel] Activated tab button:', tabName);
                } else {
                    tab.classList.remove('active');
                }
            });

            // Update tab content
            console.log('[Panel] Looking for tab content:', `${tabName}Tab`);
            console.log('[Panel] Available tab contents:', Array.from(panelTabContents).map(c => c.id));

            panelTabContents.forEach(content => {
                if (content.id === `${tabName}Tab`) {
                    content.classList.add('active');
                    console.log('[Panel] Activated tab content:', content.id, 'Classes:', content.className);
                } else {
                    content.classList.remove('active');
                }
            });

            // Save to localStorage
            localStorage.setItem('panelActiveTab', tabName);

            // Load data for the tab
            if (tabName === 'settings') {
                loadPanelSettings();
            } else if (tabName === 'analytics') {
                loadPanelAnalytics();
            }

            // Ensure right panel is open when switching tabs
            if (document.body.classList.contains('right-panel-collapsed')) {
                document.body.classList.remove('right-panel-collapsed');
            }
        }

        // Restore last active tab on page load
        function restorePanelTab() {
            const savedTab = localStorage.getItem('panelActiveTab');
            if (savedTab && ['activity', 'settings', 'analytics', 'feedback'].includes(savedTab)) {
                switchPanelTab(savedTab);
            }
        }

        // Handle URL hash for deep linking
        function handlePanelDeepLink() {
            const hash = window.location.hash.substring(1);
            if (['activity', 'settings', 'analytics'].includes(hash)) {
                switchPanelTab(hash);
                history.replaceState(null, null, window.location.pathname);
            }
        }

        // ==================== FEEDBACK SECTION ====================

        let feedbackScreenshotData = null;

        // Initialize feedback section event listeners
        function initFeedbackTab() {
            const captureBtn = document.getElementById('captureScreenshotBtn');
            const removeBtn = document.getElementById('removeScreenshotBtn');
            const feedbackMessage = document.getElementById('feedbackMessage');
            const submitBtn = document.getElementById('submitFeedbackBtn');
            const charCount = document.getElementById('feedbackCharCount');
            const sectionHeader = document.getElementById('feedbackSectionHeader');
            const sectionContent = document.getElementById('feedbackSectionContent');
            const expandIcon = document.getElementById('feedbackExpandIcon');

            // Setup expand/collapse toggle for feedback section
            if (sectionHeader && sectionContent && expandIcon) {
                sectionHeader.addEventListener('click', function() {
                    const isExpanded = sectionContent.style.display !== 'none';
                    sectionContent.style.display = isExpanded ? 'none' : 'block';
                    expandIcon.textContent = isExpanded ? '' : '';
                });
            }

            if (captureBtn) {
                captureBtn.addEventListener('click', captureScreenshot);
            }

            if (removeBtn) {
                removeBtn.addEventListener('click', removeScreenshot);
            }

            if (feedbackMessage) {
                feedbackMessage.addEventListener('input', function() {
                    if (charCount) {
                        charCount.textContent = this.value.length;
                    }
                    updateFeedbackSubmitButton();
                });
            }

            if (submitBtn) {
                submitBtn.addEventListener('click', submitFeedback);
            }
        }

        // Capture screenshot using html2canvas
        async function captureScreenshot() {
            const captureBtn = document.getElementById('captureScreenshotBtn');
            const preview = document.getElementById('screenshotPreview');
            const screenshotImg = document.getElementById('screenshotImage');

            try {
                captureBtn.disabled = true;
                captureBtn.innerHTML = '<span class="button-icon">...</span><span>Capturing...</span>';

                // Dynamically load html2canvas if not already loaded
                if (typeof html2canvas === 'undefined') {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                }

                // Capture the main content area (excluding the right panel where feedback is)
                const mainContent = document.querySelector('.main-content') || document.body;
                const canvas = await html2canvas(mainContent, {
                    scale: 0.5, // Reduce size for upload
                    useCORS: true,
                    allowTaint: true,
                    logging: false
                });

                feedbackScreenshotData = canvas.toDataURL('image/jpeg', 0.7);
                screenshotImg.src = feedbackScreenshotData;
                preview.classList.remove('hidden');
                captureBtn.classList.add('hidden');
                updateFeedbackSubmitButton();

            } catch (error) {
                console.error('[Feedback] Screenshot capture failed:', error);
                showPanelAlert('Failed to capture screenshot', 'error');
            } finally {
                captureBtn.disabled = false;
                captureBtn.innerHTML = '<span class="button-icon"></span><span>Capture Screenshot</span>';
            }
        }

        // Remove captured screenshot
        function removeScreenshot() {
            feedbackScreenshotData = null;
            const preview = document.getElementById('screenshotPreview');
            const captureBtn = document.getElementById('captureScreenshotBtn');
            preview.classList.add('hidden');
            captureBtn.classList.remove('hidden');
            updateFeedbackSubmitButton();
        }

        // Update submit button state
        function updateFeedbackSubmitButton() {
            const feedbackMessage = document.getElementById('feedbackMessage');
            const submitBtn = document.getElementById('submitFeedbackBtn');
            if (feedbackMessage && submitBtn) {
                submitBtn.disabled = feedbackMessage.value.trim().length < 10;
            }
        }

        // Submit feedback to API
        async function submitFeedback() {
            const feedbackMessage = document.getElementById('feedbackMessage');
            const feedbackType = document.getElementById('feedbackType');
            const submitBtn = document.getElementById('submitFeedbackBtn');
            const successMsg = document.getElementById('feedbackSuccess');

            if (!feedbackMessage || feedbackMessage.value.trim().length < 10) {
                showPanelAlert('Please enter at least 10 characters of feedback', 'error');
                return;
            }

            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="button-icon">...</span><span>Submitting...</span>';

                const payload = {
                    userId: currentUser?.uid || 'anonymous',
                    userEmail: currentUser?.email || 'anonymous',
                    type: feedbackType?.value || 'other',
                    message: feedbackMessage.value.trim(),
                    screenshot: feedbackScreenshotData,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    url: window.location.href
                };

                const response = await fetch('/api/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error('Failed to submit feedback');
                }

                // Show success message
                successMsg.classList.remove('hidden');
                feedbackMessage.value = '';
                removeScreenshot();
                document.getElementById('feedbackCharCount').textContent = '0';

                setTimeout(() => {
                    successMsg.classList.add('hidden');
                }, 5000);

            } catch (error) {
                console.error('[Feedback] Submission failed:', error);
                showPanelAlert('Failed to submit feedback. Please try again.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span class="button-icon"></span><span>Submit Feedback</span>';
                updateFeedbackSubmitButton();
            }
        }

        // ==================== FEEDBACK MODAL ====================

        let feedbackModalScreenshot = null;

        // Open feedback modal
        async function openFeedbackModal() {
            const modal = document.getElementById('feedbackModal');
            const preview = document.getElementById('feedbackScreenshotPreview');

            // Show modal
            modal.classList.add('visible');

            // Capture screenshot automatically when modal opens
            await captureModalScreenshot();
        }

        // Close feedback modal
        function closeFeedbackModal() {
            const modal = document.getElementById('feedbackModal');
            modal.classList.remove('visible');

            // Reset form
            feedbackModalScreenshot = null;
            document.getElementById('feedbackMessageInput').value = '';
            document.getElementById('feedbackCharCount').textContent = '0';
            document.getElementById('feedbackSuccessMessage').classList.add('hidden');
            document.getElementById('feedbackScreenshotPreview').innerHTML = '<span class="screenshot-placeholder">Capturing...</span>';
        }

        // Capture screenshot for modal (crops bottom bar)
        async function captureModalScreenshot() {
            const preview = document.getElementById('feedbackScreenshotPreview');

            try {
                preview.innerHTML = '<span class="screenshot-placeholder">Capturing...</span>';

                // Dynamically load html2canvas if not already loaded
                if (typeof html2canvas === 'undefined') {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                }

                // Capture the main content area
                const mainContent = document.querySelector('.main-content') || document.body;

                // Get the height and crop bottom 60px (input bar)
                const rect = mainContent.getBoundingClientRect();
                const cropBottom = 60; // Height of input bar to crop

                const canvas = await html2canvas(mainContent, {
                    scale: 0.5,
                    useCORS: true,
                    allowTaint: true,
                    logging: false,
                    height: rect.height - cropBottom, // Crop bottom bar
                    y: 0
                });

                feedbackModalScreenshot = canvas.toDataURL('image/jpeg', 0.7);
                preview.innerHTML = `<img src="${feedbackModalScreenshot}" alt="Screenshot">`;

            } catch (error) {
                console.error('[Feedback Modal] Screenshot capture failed:', error);
                preview.innerHTML = '<span class="screenshot-placeholder">Failed to capture</span>';
            }
        }

        // Submit feedback from modal
        async function submitModalFeedback() {
            console.log('[Feedback Modal] Submit button clicked');

            const messageInput = document.getElementById('feedbackMessageInput');
            const typeSelect = document.getElementById('feedbackTypeSelect');
            const submitBtn = document.getElementById('feedbackSubmitBtn');
            const successMsg = document.getElementById('feedbackSuccessMessage');

            if (!submitBtn) {
                console.error('[Feedback Modal] Submit button not found');
                return;
            }

            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');

            if (!messageInput || messageInput.value.trim().length < 10) {
                alert('Please enter at least 10 characters of feedback');
                return;
            }

            try {
                submitBtn.disabled = true;
                if (btnText) btnText.classList.add('hidden');
                if (btnLoading) btnLoading.classList.remove('hidden');

                console.log('[Feedback Modal] Preparing payload...');

                // Get current user from Firebase auth
                const user = auth.currentUser;
                const payload = {
                    userId: user?.uid || 'anonymous',
                    userEmail: user?.email || 'anonymous',
                    type: typeSelect?.value || 'other',
                    message: messageInput.value.trim(),
                    screenshot: feedbackModalScreenshot,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    url: window.location.href
                };

                console.log('[Feedback Modal] Sending to /api/feedback...');

                const response = await fetch('/api/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log('[Feedback Modal] Response status:', response.status);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Failed to submit feedback');
                }

                // Show success message
                if (successMsg) successMsg.classList.remove('hidden');

                // Close modal after 2 seconds
                setTimeout(() => {
                    closeFeedbackModal();
                }, 2000);

            } catch (error) {
                console.error('[Feedback Modal] Submission failed:', error);
                alert('Failed to submit feedback: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                if (btnText) btnText.classList.remove('hidden');
                if (btnLoading) btnLoading.classList.add('hidden');
            }
        }

        // Initialize feedback modal
        function initFeedbackModal() {
            // Open modal button
            const openBtn = document.getElementById('openFeedbackModalBtn');
            if (openBtn) {
                openBtn.addEventListener('click', openFeedbackModal);
            }

            // Close modal
            const closeBtn = document.getElementById('feedbackModalClose');
            const overlay = document.getElementById('feedbackModalOverlay');
            const cancelBtn = document.getElementById('feedbackCancelBtn');

            if (closeBtn) closeBtn.addEventListener('click', closeFeedbackModal);
            if (overlay) overlay.addEventListener('click', closeFeedbackModal);
            if (cancelBtn) cancelBtn.addEventListener('click', closeFeedbackModal);

            // Retake screenshot button
            const retakeBtn = document.getElementById('retakeScreenshotBtn');
            if (retakeBtn) {
                retakeBtn.addEventListener('click', captureModalScreenshot);
            }

            // Message input character count
            const messageInput = document.getElementById('feedbackMessageInput');
            const charCount = document.getElementById('feedbackCharCount');
            if (messageInput && charCount) {
                messageInput.addEventListener('input', () => {
                    charCount.textContent = messageInput.value.length;
                });
            }

            // Submit button
            const submitBtn = document.getElementById('feedbackSubmitBtn');
            if (submitBtn) {
                console.log('[Feedback Modal] Attaching submit button listener');
                submitBtn.addEventListener('click', submitModalFeedback);
            } else {
                console.error('[Feedback Modal] Submit button not found during init!');
            }

            // Close on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('feedbackModal');
                    if (modal && modal.classList.contains('visible')) {
                        closeFeedbackModal();
                    }
                }
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initFeedbackTab();
            initFeedbackModal();
        });

        // ==================== PANEL ALERTS ====================

        // Show alert in panel
        function showPanelAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `panel-alert ${type}`;
            alert.textContent = message;
            panelAlertContainer.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // ==================== PANEL SETTINGS TAB ====================

        // Initialize panel settings listeners
        function initializePanelSettings() {
            console.log('[Panel] Initializing settings...');

            if (!panelBioInput || !panelUsernameInput) {
                console.error('[Panel] Settings elements not found!');
                return;
            }

            // Bio character count
            panelBioInput.addEventListener('input', () => {
                panelBioCharCount.textContent = panelBioInput.value.length;
            });

            // Username availability checking
            panelUsernameInput.addEventListener('input', (e) => {
                const username = e.target.value.trim().toLowerCase();

                clearTimeout(panelCheckUsernameTimeout);

                if (!username) {
                    panelAvailabilityIndicator.textContent = '';
                    panelAvailabilityIndicator.className = 'availability-indicator';
                    panelClaimUsernameBtn.disabled = true;
                    return;
                }

                panelAvailabilityIndicator.textContent = 'Checking...';
                panelAvailabilityIndicator.className = 'availability-indicator checking';
                panelClaimUsernameBtn.disabled = true;

                panelCheckUsernameTimeout = setTimeout(async () => {
                    try {
                        // Client-side validation
                        if (username.length < 3) {
                            panelAvailabilityIndicator.textContent = ' Too short';
                            panelAvailabilityIndicator.className = 'availability-indicator invalid';
                            return;
                        }
                        if (username.length > 20) {
                            panelAvailabilityIndicator.textContent = ' Too long';
                            panelAvailabilityIndicator.className = 'availability-indicator invalid';
                            return;
                        }
                        if (!/^[a-z][a-z0-9_]*$/.test(username)) {
                            panelAvailabilityIndicator.textContent = ' Invalid format';
                            panelAvailabilityIndicator.className = 'availability-indicator invalid';
                            return;
                        }

                        // Check availability via Firestore
                        const usernameDocRef = doc(db, 'usernames', username);
                        const usernameDoc = await getDoc(usernameDocRef);

                        if (usernameDoc.exists()) {
                            panelAvailabilityIndicator.textContent = ' Taken';
                            panelAvailabilityIndicator.className = 'availability-indicator taken';
                            panelClaimUsernameBtn.disabled = true;
                        } else {
                            panelAvailabilityIndicator.textContent = ' Available';
                            panelAvailabilityIndicator.className = 'availability-indicator available';
                            panelClaimUsernameBtn.disabled = false;
                        }
                    } catch (error) {
                        console.error('Error checking username:', error);
                        panelAvailabilityIndicator.textContent = 'Error';
                        panelAvailabilityIndicator.className = 'availability-indicator invalid';
                    }
                }, 500);
            });

            // Claim username
            panelClaimUsernameBtn.addEventListener('click', async () => {
                const username = panelUsernameInput.value.trim().toLowerCase();
                if (!username || !auth.currentUser) return;

                panelClaimUsernameBtn.disabled = true;
                panelClaimUsernameBtn.innerHTML = '<span class="loading-spinner"></span> Claiming...';

                try {
                    // Check availability
                    const usernameDocRef = doc(db, 'usernames', username);
                    const usernameDoc = await getDoc(usernameDocRef);
                    if (usernameDoc.exists()) {
                        throw new Error('Username is already taken');
                    }

                    // Claim username
                    await setDoc(doc(db, 'usernames', username), {
                        userId: auth.currentUser.uid,
                        claimedAt: serverTimestamp()
                    });

                    // Update user document
                    await setDoc(doc(db, 'users', auth.currentUser.uid), {
                        username: username,
                        linkEnabled: true,
                        displayName: auth.currentUser.displayName || auth.currentUser.email?.split('@')[0] || username,
                        photoURL: auth.currentUser.photoURL || null,
                        updatedAt: serverTimestamp()
                    }, { merge: true });

                    panelCurrentUsername = username;
                    showPanelAlert('Username claimed successfully!', 'success');
                    updatePanelUIForClaimedUsername(username);

                    // Reload link status and activity feed
                    await loadLinkStatus();
                    await loadActivityFeed();
                } catch (error) {
                    console.error('Error claiming username:', error);
                    showPanelAlert(error.message || 'Failed to claim username', 'error');
                    panelClaimUsernameBtn.disabled = false;
                    panelClaimUsernameBtn.textContent = 'Claim Username';
                }
            });

            // Release username
            panelReleaseUsernameBtn.addEventListener('click', async () => {
                if (!confirm('Are you sure? Your public link will stop working.')) {
                    return;
                }

                panelReleaseUsernameBtn.disabled = true;
                panelReleaseUsernameBtn.innerHTML = '<span class="loading-spinner"></span> Releasing...';

                try {
                    const userDocRef = doc(db, 'users', auth.currentUser.uid);
                    const userDoc = await getDoc(userDocRef);
                    const username = userDoc.data()?.username;

                    if (!username) {
                        throw new Error('No username to release');
                    }

                    // Remove username claim
                    await deleteDoc(doc(db, 'usernames', username));

                    // Update user document
                    await updateDoc(doc(db, 'users', auth.currentUser.uid), {
                        username: deleteField(),
                        linkEnabled: false,
                        updatedAt: serverTimestamp()
                    });

                    panelCurrentUsername = null;
                    showPanelAlert('Username released', 'success');
                    updatePanelUIForNoUsername();

                    // Reload link status
                    await loadLinkStatus();
                } catch (error) {
                    console.error('Error releasing username:', error);
                    showPanelAlert(error.message || 'Failed to release username', 'error');
                    panelReleaseUsernameBtn.disabled = false;
                    panelReleaseUsernameBtn.textContent = 'Release Username';
                }
            });

            // Delete username icon click handler
            panelDeleteUsernameIcon.addEventListener('click', async () => {
                if (!confirm('Are you sure you want to release this username? You may lose it forever as anyone else may claim it.')) {
                    return;
                }

                panelDeleteUsernameIcon.disabled = true;
                panelDeleteUsernameIcon.style.opacity = '0.5';

                try {
                    const userDocRef = doc(db, 'users', auth.currentUser.uid);
                    const userDoc = await getDoc(userDocRef);
                    const username = userDoc.data()?.username;

                    if (!username) {
                        throw new Error('No username to release');
                    }

                    // Remove username claim
                    await deleteDoc(doc(db, 'usernames', username));

                    // Update user document
                    await updateDoc(doc(db, 'users', auth.currentUser.uid), {
                        username: deleteField(),
                        linkEnabled: false,
                        updatedAt: serverTimestamp()
                    });

                    panelCurrentUsername = null;
                    showPanelAlert('Username released successfully', 'success');
                    updatePanelUIForNoUsername();

                    // Reload link status
                    await loadLinkStatus();

                } catch (error) {
                    console.error('Error releasing username:', error);
                    showPanelAlert(error.message || 'Failed to release username', 'error');
                    panelDeleteUsernameIcon.disabled = false;
                    panelDeleteUsernameIcon.style.opacity = '1';
                }
            });

            // Save settings
            panelSaveSettingsBtn.addEventListener('click', async () => {
                if (!auth.currentUser || !panelCurrentUsername) {
                    showPanelAlert('Please claim a username first', 'warning');
                    return;
                }

                panelSaveSettingsBtn.disabled = true;
                panelSaveSettingsBtn.innerHTML = '<span class="loading-spinner"></span> Saving...';

                try {
                    const userDocRef = doc(db, 'users', auth.currentUser.uid);

                    await setDoc(userDocRef, {
                        linkEnabled: panelLinkEnabledToggle.checked,
                        displayName: panelDisplayNameInput.value.trim() || auth.currentUser.displayName || panelCurrentUsername,
                        bio: panelBioInput.value.trim(),
                        customGreeting: panelGreetingInput.value.trim(),
                        updatedAt: serverTimestamp()
                    }, { merge: true });

                    showPanelAlert('Settings saved successfully!', 'success');

                    if (panelLinkEnabledToggle.checked) {
                        showPanelLinkPreview(panelCurrentUsername);
                    } else {
                        panelLinkPreviewSection.style.display = 'none';
                    }

                    // Reload link status
                    await loadLinkStatus();
                } catch (error) {
                    console.error('Error saving settings:', error);
                    showPanelAlert('Failed to save settings', 'error');
                } finally {
                    panelSaveSettingsBtn.disabled = false;
                    panelSaveSettingsBtn.textContent = 'Save Settings';
                }
            });

            // Copy link
            panelCopyLinkBtn.addEventListener('click', async () => {
                const url = panelPublicLinkUrl.href;
                try {
                    await navigator.clipboard.writeText(url);
                    panelCopyLinkBtn.textContent = 'Copied!';
                    panelCopyLinkBtn.classList.add('copied');
                    setTimeout(() => {
                        panelCopyLinkBtn.textContent = 'Copy Link';
                        panelCopyLinkBtn.classList.remove('copied');
                    }, 2000);
                } catch (error) {
                    console.error('Failed to copy:', error);
                    showPanelAlert('Failed to copy link', 'error');
                }
            });
        }

        // Update UI for claimed username
        function updatePanelUIForClaimedUsername(username) {
            panelUsernameInput.value = username;
            panelUsernameInput.disabled = true;
            panelAvailabilityIndicator.textContent = ' Claimed';
            panelAvailabilityIndicator.className = 'availability-indicator available';
            panelClaimUsernameBtn.classList.add('hidden');
            panelReleaseUsernameBtn.classList.add('hidden');
            panelDeleteUsernameIcon.classList.remove('hidden'); // Show delete button
        }

        // Update UI for no username
        function updatePanelUIForNoUsername() {
            panelUsernameInput.value = '';
            panelUsernameInput.disabled = false;
            panelAvailabilityIndicator.textContent = '';
            panelAvailabilityIndicator.className = 'availability-indicator';
            panelClaimUsernameBtn.classList.remove('hidden');
            panelClaimUsernameBtn.disabled = true;
            panelClaimUsernameBtn.textContent = 'Claim Username';
            panelReleaseUsernameBtn.classList.add('hidden');
            panelDeleteUsernameIcon.classList.add('hidden'); // Hide delete button
            panelLinkPreviewSection.style.display = 'none';
        }

        // Show link preview
        function showPanelLinkPreview(username) {
            const url = `https://mindclone.link/${username}`;
            panelPublicLinkUrl.href = url;
            panelPublicLinkUrl.textContent = url;
            panelLinkPreviewSection.style.display = 'block';
        }

        // Load settings into panel
        async function loadPanelSettings() {
            console.log('[Panel] loadPanelSettings called');
            if (!auth.currentUser) {
                console.log('[Panel] No current user, skipping settings load');
                return;
            }

            try {
                console.log('[Panel] Loading settings for user:', auth.currentUser.uid);
                const userDocRef = doc(db, 'users', auth.currentUser.uid);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists()) {
                    const userData = userDoc.data();

                    if (userData.username) {
                        panelCurrentUsername = userData.username;
                        updatePanelUIForClaimedUsername(userData.username);
                        // Show feedback section in left panel only for admin user
                        if (userData.username === 'alok') {
                            const feedbackSection = document.getElementById('feedbackSection');
                            if (feedbackSection) feedbackSection.style.display = '';
                            // Also show Feedback tab in right panel for admin
                            const feedbackTabBtn = document.getElementById('feedbackTabBtn');
                            if (feedbackTabBtn) feedbackTabBtn.style.display = '';
                        }
                    } else {
                        updatePanelUIForNoUsername();
                    }

                    panelLinkEnabledToggle.checked = userData.linkEnabled || false;
                    panelDisplayNameInput.value = userData.displayName || auth.currentUser.displayName || '';
                    panelBioInput.value = userData.bio || '';
                    panelBioCharCount.textContent = panelBioInput.value.length;
                    panelGreetingInput.value = userData.customGreeting || '';

                    if (userData.linkEnabled && userData.username) {
                        showPanelLinkPreview(userData.username);
                    }
                }

                // Load knowledge base (don't let this break settings loading)
                try {
                    await loadKnowledgeBase();
                } catch (kbError) {
                    console.error('[KB] Error loading knowledge base:', kbError);
                    // Don't show error to user, just log it
                }

                console.log('[Panel] Settings loaded successfully');
            } catch (error) {
                console.error('Error loading panel settings:', error);
                showPanelAlert('Failed to load settings', 'error');
            }
        }

        // ==================== KNOWLEDGE BASE MANAGEMENT ====================

        // Initialize knowledge base
        function initializeKnowledgeBase() {
            console.log('[KB] Initializing knowledge base...');
            console.log('[KB] uploadKnowledgeBaseBtn:', uploadKnowledgeBaseBtn);
            console.log('[KB] knowledgeBaseFileInput:', knowledgeBaseFileInput);
            console.log('[KB] knowledgeBaseEnabledToggle:', knowledgeBaseEnabledToggle);

            // Upload button click
            if (uploadKnowledgeBaseBtn) {
                uploadKnowledgeBaseBtn.addEventListener('click', () => {
                    console.log('[KB] Upload button clicked');
                    if (knowledgeBaseFileInput) {
                        knowledgeBaseFileInput.click();
                        console.log('[KB] File input triggered');
                    } else {
                        console.error('[KB] File input not found!');
                    }
                });
            } else {
                console.error('[KB] Upload button not found!');
            }

            // File input change
            if (knowledgeBaseFileInput) {
                knowledgeBaseFileInput.addEventListener('change', async (e) => {
                    console.log('[KB] File input changed, files:', e.target.files);
                    const files = e.target.files;
                    if (files && files.length > 0) {
                        console.log('[KB] Starting upload of', files.length, 'files');
                        await uploadKnowledgeBaseDocuments(files);
                        // Reset input
                        e.target.value = '';
                    }
                });
            } else {
                console.error('[KB] File input element not found!');
            }

            // Toggle change
            if (knowledgeBaseEnabledToggle) {
                knowledgeBaseEnabledToggle.addEventListener('change', async (e) => {
                    await saveKnowledgeBaseToggle(e.target.checked);
                });
            }

            console.log('[KB] Knowledge base initialized');
        }

        // Load knowledge base documents
        async function loadKnowledgeBase() {
            if (!auth.currentUser) return;
            if (!knowledgeBaseList || !knowledgeBaseEnabledToggle) {
                console.log('[KB] Knowledge base elements not found, skipping load');
                return;
            }

            try {
                console.log('[KB] Loading knowledge base...');
                const userId = auth.currentUser.uid;

                // Load toggle state from Firestore
                const userDocRef = doc(db, 'users', userId);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    if (knowledgeBaseEnabledToggle) {
                        knowledgeBaseEnabledToggle.checked = data.knowledgeBaseEnabled || false;
                    }
                }

                // Load documents from Firestore
                const kbRef = collection(db, 'users', userId, 'knowledgeBase');
                const kbSnapshot = await getDocs(kbRef);

                if (kbSnapshot.empty) {
                    showEmptyKnowledgeBase();
                } else {
                    displayKnowledgeBaseDocuments(kbSnapshot.docs);
                }

                console.log('[KB] Loaded', kbSnapshot.size, 'documents');
            } catch (error) {
                console.error('[KB] Error loading knowledge base:', error);
                // Don't show alert if it's just missing elements
                if (showPanelAlert) {
                    showPanelAlert('Failed to load knowledge base', 'error');
                }
            }
        }

        // Display documents in list
        function displayKnowledgeBaseDocuments(docs) {
            if (!knowledgeBaseList) return;
            knowledgeBaseList.innerHTML = '';

            docs.forEach(docSnapshot => {
                const data = docSnapshot.data();
                const docId = docSnapshot.id;
                // Support both old (storagePath) and new (blobUrl) documents
                const deleteUrl = data.blobUrl || data.url || data.storagePath;

                const item = document.createElement('div');
                item.className = 'knowledge-base-item';

                // Determine status based on text extraction
                const hasText = data.extractedText || data.textExtractionType === 'pdf' || data.textExtractionType === 'docx';
                const statusText = hasText ? 'Ready' : (data.textExtractionError ? 'No Text' : 'Ready');
                const statusClass = hasText ? 'ready' : 'processing';

                item.innerHTML = `
                    <div class="kb-file-icon">${getFileIcon(data.type)}</div>
                    <div class="kb-file-info">
                        <div class="kb-file-name" title="${data.fileName}">${data.fileName}</div>
                        <div class="kb-file-meta">
                            <span class="kb-file-size">${formatFileSize(data.size)}</span>
                            <span class="kb-file-date">${formatDateShort(data.uploadedAt)}</span>
                            <span class="kb-file-status ${statusClass}">${statusText}</span>
                            <span class="kb-file-actions">
                                <button class="kb-action-btn view" data-url="${data.url}" title="Open file"></button>
                                <button class="kb-action-btn delete" data-id="${docId}" title="Delete"></button>
                            </span>
                        </div>
                    </div>
                `;

                // View button
                const viewBtn = item.querySelector('.view');
                viewBtn.addEventListener('click', () => {
                    window.open(data.url, '_blank');
                });

                // Delete button
                const deleteBtn = item.querySelector('.delete');
                deleteBtn.addEventListener('click', async () => {
                    if (confirm(`Delete "${data.fileName}"?`)) {
                        await deleteKnowledgeBaseDocument(docId, deleteUrl);
                    }
                });

                knowledgeBaseList.appendChild(item);
            });
        }

        // Show empty state
        function showEmptyKnowledgeBase() {
            if (!knowledgeBaseList) return;
            knowledgeBaseList.innerHTML = `
                <div class="knowledge-base-empty">
                    <div class="empty-icon"></div>
                    <div class="empty-text">No documents uploaded yet</div>
                    <div class="empty-hint">Upload PDFs, images, or Excel files to share knowledge with visitors</div>
                </div>
            `;
        }

        // Upload documents via Vercel Blob API
        async function uploadKnowledgeBaseDocuments(files) {
            console.log('[KB] uploadKnowledgeBaseDocuments called with', files.length, 'files');

            if (!auth.currentUser) {
                console.error('[KB] No authenticated user!');
                showPanelAlert('Please sign in to upload documents', 'error');
                return;
            }

            try {
                console.log('[KB] Getting auth token...');
                const idToken = await auth.currentUser.getIdToken();
                showPanelAlert('Uploading documents...', 'info');

                for (const file of files) {
                    console.log('[KB] Processing file:', file.name, 'size:', file.size, 'type:', file.type);

                    // Check file size (max 10MB)
                    if (file.size > 10 * 1024 * 1024) {
                        showPanelAlert(`${file.name} is too large (max 10MB)`, 'error');
                        continue;
                    }

                    // Convert file to base64
                    console.log('[KB] Converting to base64...');
                    const base64Data = await fileToBase64(file);

                    // Upload via API
                    console.log('[KB] Uploading via API...');
                    const response = await fetch('/api/upload-kb', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${idToken}`
                        },
                        body: JSON.stringify({
                            fileName: file.name,
                            fileType: file.type,
                            fileData: base64Data
                        })
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || 'Upload failed');
                    }

                    console.log('[KB] Successfully uploaded:', file.name, result);
                }

                showPanelAlert(`Successfully uploaded ${files.length} document(s)`, 'success');
                console.log('[KB] All uploads complete, refreshing list...');
                await loadKnowledgeBase(); // Refresh list
            } catch (error) {
                console.error('[KB] Upload error:', error);
                showPanelAlert(`Failed to upload: ${error.message}`, 'error');
            }
        }

        // Helper: Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // Remove the data URL prefix (e.g., "data:application/pdf;base64,")
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Delete document via API
        async function deleteKnowledgeBaseDocument(docId, blobUrl) {
            if (!auth.currentUser) return;

            try {
                console.log('[KB] Deleting document:', docId);
                const idToken = await auth.currentUser.getIdToken();

                const response = await fetch('/api/upload-kb', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({
                        docId: docId,
                        blobUrl: blobUrl
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Delete failed');
                }

                showPanelAlert('Document deleted successfully', 'success');
                await loadKnowledgeBase(); // Refresh list
                console.log('[KB] Deleted:', docId);
            } catch (error) {
                console.error('[KB] Delete error:', error);
                showPanelAlert('Failed to delete document', 'error');
            }
        }

        // Save toggle state
        async function saveKnowledgeBaseToggle(enabled) {
            if (!auth.currentUser) return;

            try {
                const userId = auth.currentUser.uid;
                const userDocRef = doc(db, 'users', userId);
                await updateDoc(userDocRef, {
                    knowledgeBaseEnabled: enabled
                });

                showPanelAlert(enabled ? 'Knowledge base enabled for link' : 'Knowledge base disabled for link', 'success');
                console.log('[KB] Toggle saved:', enabled);
            } catch (error) {
                console.error('[KB] Toggle error:', error);
                showPanelAlert('Failed to save setting', 'error');
            }
        }

        // Helper: Get file icon
        function getFileIcon(mimeType) {
            if (mimeType.includes('pdf')) return '';
            if (mimeType.includes('image')) return '';
            if (mimeType.includes('sheet') || mimeType.includes('excel')) return '';
            if (mimeType.includes('csv')) return '';
            if (mimeType.includes('presentation') || mimeType.includes('powerpoint')) return '';
            if (mimeType.includes('document') || mimeType.includes('word') || mimeType.includes('msword')) return '';
            if (mimeType.includes('text')) return '';
            return '';
        }

        // Helper: Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Helper: Format date
        function formatDate(timestamp) {
            if (!timestamp) return 'Just now';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (days === 0) return 'Today';
            if (days === 1) return 'Yesterday';
            if (days < 7) return `${days} days ago`;

            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Short date format for compact displays
        function formatDateShort(timestamp) {
            if (!timestamp) return 'Just now';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (days === 0) return 'Today';
            if (days === 1) return 'Yesterday';
            if (days < 7) return `${days}d ago`;

            // Compact format: Dec 9 or Dec 9, 24 (if different year)
            const sameYear = date.getFullYear() === now.getFullYear();
            if (sameYear) {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' });
        }

        // ==================== FEEDBACK ADMIN TAB (Admin Only) ====================

        // Initialize feedback admin
        function initializeFeedbackAdmin() {
            const refreshBtn = document.getElementById('refreshFeedbackBtn');
            const statusFilter = document.getElementById('feedbackStatusFilter');

            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    loadFeedbackAdmin();
                });
            }

            if (statusFilter) {
                statusFilter.addEventListener('change', () => {
                    loadFeedbackAdmin();
                });
            }

            console.log('[Feedback Admin] Initialized');
        }

        // Load feedback from Firestore
        async function loadFeedbackAdmin() {
            const feedbackList = document.getElementById('feedbackList');
            const statusFilter = document.getElementById('feedbackStatusFilter');

            if (!feedbackList) return;

            const filterValue = statusFilter ? statusFilter.value : 'new';

            try {
                feedbackList.innerHTML = '<div class="feedback-empty"><div class="icon"></div><div class="message">Loading...</div></div>';

                // Query feedback collection
                let feedbackQuery;
                if (filterValue === 'all') {
                    feedbackQuery = query(
                        collection(db, 'feedback'),
                        orderBy('submittedAt', 'desc'),
                        limit(50)
                    );
                } else {
                    feedbackQuery = query(
                        collection(db, 'feedback'),
                        where('status', '==', filterValue),
                        orderBy('submittedAt', 'desc'),
                        limit(50)
                    );
                }

                const snapshot = await getDocs(feedbackQuery);

                if (snapshot.empty) {
                    feedbackList.innerHTML = '<div class="feedback-empty"><div class="icon"></div><div class="message">No feedback found</div></div>';
                    return;
                }

                feedbackList.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const feedback = docSnap.data();
                    const card = createFeedbackCard(docSnap.id, feedback);
                    feedbackList.appendChild(card);
                });

                console.log('[Feedback Admin] Loaded', snapshot.size, 'feedback items');
            } catch (error) {
                console.error('[Feedback Admin] Error loading feedback:', error);
                feedbackList.innerHTML = '<div class="feedback-empty"><div class="icon"></div><div class="message">Error loading feedback<br>' + error.message + '</div></div>';
            }
        }

        // Create feedback card element
        function createFeedbackCard(feedbackId, feedback) {
            const card = document.createElement('div');
            card.className = 'feedback-card';

            // Format date
            let dateStr = 'Unknown';
            if (feedback.submittedAt) {
                const date = feedback.submittedAt.toDate ? feedback.submittedAt.toDate() : new Date(feedback.submittedAt);
                dateStr = date.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
            }

            // Type badge class
            const typeClass = feedback.type === 'bug' ? 'bug' : feedback.type === 'feature' ? 'feature' : 'other';

            card.innerHTML = `
                <div class="feedback-card-header">
                    <span class="feedback-type-badge ${typeClass}">${feedback.type || 'other'}</span>
                    <select class="feedback-status-select" data-feedback-id="${feedbackId}">
                        <option value="new" ${feedback.status === 'new' ? 'selected' : ''}>New</option>
                        <option value="reviewed" ${feedback.status === 'reviewed' ? 'selected' : ''}>Reviewed</option>
                        <option value="resolved" ${feedback.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                    </select>
                </div>
                <div class="feedback-message">${escapeHtml(feedback.message || '')}</div>
                <div class="feedback-meta">
                    <span>From: ${escapeHtml(feedback.userEmail || feedback.userId || 'Anonymous')}</span>
                    <span>${dateStr}</span>
                </div>
                ${feedback.screenshotUrl ? `<img src="${feedback.screenshotUrl}" class="feedback-screenshot-thumb" onclick="window.open('${feedback.screenshotUrl}', '_blank')" alt="Screenshot">` : ''}
            `;

            // Add status change listener
            const statusSelect = card.querySelector('.feedback-status-select');
            if (statusSelect) {
                statusSelect.addEventListener('change', async (e) => {
                    await updateFeedbackStatus(feedbackId, e.target.value);
                });
            }

            return card;
        }

        // Update feedback status in Firestore
        async function updateFeedbackStatus(feedbackId, newStatus) {
            try {
                const feedbackRef = doc(db, 'feedback', feedbackId);
                await updateDoc(feedbackRef, {
                    status: newStatus,
                    updatedAt: serverTimestamp()
                });
                console.log('[Feedback Admin] Updated status to:', newStatus);
            } catch (error) {
                console.error('[Feedback Admin] Error updating status:', error);
                alert('Failed to update status: ' + error.message);
            }
        }

        // ==================== PANEL ANALYTICS TAB ====================

        // Initialize analytics
        function initializePanelAnalytics() {
            console.log('[Panel] Initializing analytics...');

            if (!analyticsPeriodFilter) {
                console.error('[Panel] Analytics elements not found!');
                return;
            }

            analyticsPeriodFilter.addEventListener('change', () => {
                loadPanelAnalytics();
            });

            console.log('[Panel] Analytics initialized successfully');
        }

        // Load analytics data
        async function loadPanelAnalytics() {
            console.log('[Analytics] Loading analytics data...');

            if (!auth.currentUser) {
                console.error('[Analytics] No authenticated user');
                showPanelAlert('Please sign in to view analytics', 'error');
                return;
            }

            try {
                // Show loading state
                recentVisitorsList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Loading analytics...</div>';

                const idToken = await auth.currentUser.getIdToken();
                const period = analyticsPeriodFilter.value;

                // Fetch analytics
                const url = period === 'all'
                    ? '/api/analytics'
                    : `/api/analytics?period=${period}`;

                console.log('[Analytics] Fetching from:', url);

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                console.log('[Analytics] Response status:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('[Analytics] Data received:', data);

                    // Update stats
                    panelTotalVisitors.textContent = data.totalVisitors || 0;
                    panelTotalMessages.textContent = data.totalMessages || 0;

                    // Render recent visitors
                    if (data.recentVisitors && data.recentVisitors.length > 0) {
                        recentVisitorsList.innerHTML = '';
                        data.recentVisitors.forEach(visitor => {
                            const item = createRecentVisitorItem(visitor);
                            recentVisitorsList.appendChild(item);
                        });
                    } else {
                        recentVisitorsList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No visitor data yet</div>';
                    }

                    console.log('[Analytics] Analytics loaded successfully');
                } else {
                    const errorText = await response.text();
                    console.error('[Analytics] Failed to load analytics:', response.status, errorText);
                    recentVisitorsList.innerHTML = `<div style="text-align: center; color: #f44336; padding: 20px;">Failed to load analytics (${response.status})</div>`;
                    showPanelAlert(`Failed to load analytics: ${response.status}`, 'error');
                }
            } catch (error) {
                console.error('[Analytics] Error loading analytics:', error);
                recentVisitorsList.innerHTML = '<div style="text-align: center; color: #f44336; padding: 20px;">Error loading analytics</div>';
                showPanelAlert('Error loading analytics: ' + error.message, 'error');
            }
        }

        // Create recent visitor item
        function createRecentVisitorItem(visitor) {
            const item = document.createElement('div');
            item.className = 'recent-visitor-item';
            item.dataset.visitorId = visitor.visitorId;

            const lastVisitTime = visitor.lastVisit?.seconds
                ? new Date(visitor.lastVisit.seconds * 1000)
                : new Date();
            const timeAgo = formatTimeAgo(lastVisitTime);
            const visitorName = `visitor_${visitor.visitorId.substring(0, 6)}`;

            item.innerHTML = `
                <div class="recent-visitor-header">
                    <span class="recent-visitor-id"> ${visitorName}</span>
                    <span class="recent-visitor-count">${visitor.messageCount || 0} messages</span>
                </div>
                <div class="recent-visitor-time">Last visit: ${timeAgo}</div>
            `;

            // Click to open conversation modal
            item.addEventListener('click', () => {
                openConversationModal(visitor.visitorId);
            });

            return item;
        }

        // Auth State Observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                showChatInterface(user);
                // Load billing status
                await loadBillingStatus();
            } else {
                // User is signed out
                showAuthScreen();
                userBillingStatus = null;
            }
        });

        // Google Sign In
        googleSignInBtn?.addEventListener('click', async () => {
            try {
                googleSignInBtn.disabled = true;
                googleSignInBtn.innerHTML = '<div class="loading"></div> Signing in...';
                
                const result = await signInWithPopup(auth, provider);
                // User signed in successfully
                console.log('Signed in:', result.user);
            } catch (error) {
                console.error('Sign in error:', error);
                alert('Failed to sign in. Please try again.');
                googleSignInBtn.disabled = false;
                googleSignInBtn.innerHTML = '<svg class="google-icon" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg> Sign in with Google';
            }
        });

        // Avatar dropdown toggle
        userAvatar?.addEventListener('click', (e) => {
            e.stopPropagation();
            avatarDropdown.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
            if (avatarDropdown && !avatarDropdown.classList.contains('hidden')) {
                avatarDropdown.classList.add('hidden');
            }
        });

        // Prevent dropdown from closing when clicking inside it or the profile area
        avatarDropdown?.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // Prevent dropdown from closing when clicking on sidebar profile
        sidebarProfile?.addEventListener('click', (e) => {
            // Only stop propagation if the dropdown is visible
            if (avatarDropdown && !avatarDropdown.classList.contains('hidden')) {
                e.stopPropagation();
            }
        });

        // Sign out handler (works for both sidebar button and dropdown)
        async function handleSignOut() {
            try {
                await signOut(auth);
                conversationHistory = []; // Clear in-memory array
                chatMessages.innerHTML = ''; // Clear UI

                // Close dropdown if open
                if (avatarDropdown && !avatarDropdown.classList.contains('hidden')) {
                    avatarDropdown.classList.add('hidden');
                }
                // Note: Firestore data remains intact
            } catch (error) {
                console.error('Sign out error:', error);
                alert('Failed to sign out. Please try again.');
            }
        }

        // Attach to both buttons
        signOutBtn?.addEventListener('click', handleSignOut);
        dropdownSignOutBtn?.addEventListener('click', handleSignOut);

        // Mobile Menu Button - Toggle left panel
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mobilePanelOverlay = document.getElementById('mobilePanelOverlay');
        const leftPanelEl = document.querySelector('.left-panel');

        function toggleMobilePanel() {
            if (leftPanelEl) {
                const isOpening = !leftPanelEl.classList.contains('mobile-open');

                if (isOpening) {
                    // Opening on mobile: slide in and expand to full width
                    leftPanelEl.classList.add('mobile-open');
                    leftPanelEl.classList.remove('collapsed');
                } else {
                    // Closing on mobile: slide out and restore collapsed state if needed
                    leftPanelEl.classList.remove('mobile-open');
                    const savedPanelState = localStorage.getItem('leftPanelCollapsed');
                    if (savedPanelState === 'true') {
                        leftPanelEl.classList.add('collapsed');
                    }
                }

                mobilePanelOverlay?.classList.toggle('active');
            }
        }

        function closeMobilePanel() {
            if (leftPanelEl) {
                leftPanelEl.classList.remove('mobile-open');
                mobilePanelOverlay?.classList.remove('active');
                // Restore collapsed state if needed when closing mobile panel
                const savedPanelState = localStorage.getItem('leftPanelCollapsed');
                if (savedPanelState === 'true') {
                    leftPanelEl.classList.add('collapsed');
                }
            }
        }

        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', toggleMobilePanel);
        }

        // Close panel when clicking overlay
        if (mobilePanelOverlay) {
            mobilePanelOverlay.addEventListener('click', closeMobilePanel);
        }

        // Swipe left to close left panel on mobile
        if (leftPanelEl) {
            let touchStartX = 0;
            let touchEndX = 0;

            leftPanelEl.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            leftPanelEl.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                const swipeDistance = touchStartX - touchEndX;
                // If swiped left more than 50px, close the panel
                if (swipeDistance > 50 && leftPanelEl.classList.contains('mobile-open')) {
                    closeMobilePanel();
                }
            }, { passive: true });
        }

        // ========== LEFT PANEL FUNCTIONALITY ==========

        // Panel Toggle
        const panelToggle = document.getElementById('panelToggle');
        const leftPanel = document.getElementById('leftPanel');

        if (panelToggle && leftPanel) {
            // Load saved panel state
            const savedPanelState = localStorage.getItem('leftPanelCollapsed');
            if (savedPanelState === 'true') {
                leftPanel.classList.add('collapsed');
            }

            panelToggle.addEventListener('click', () => {
                leftPanel.classList.toggle('collapsed');
                localStorage.setItem('leftPanelCollapsed', leftPanel.classList.contains('collapsed'));
            });
        }

        // Panel Sign In Button
        const panelSignInBtn = document.getElementById('panelSignInBtn');
        if (panelSignInBtn) {
            panelSignInBtn.addEventListener('click', async () => {
                try {
                    panelSignInBtn.disabled = true;
                    panelSignInBtn.innerHTML = '<div class="loading"></div> Signing in...';
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error('Sign in error:', error);
                    alert('Failed to sign in. Please try again.');
                    panelSignInBtn.disabled = false;
                    panelSignInBtn.innerHTML = '<svg class="google-icon" viewBox="0 0 24 24" style="width: 18px; height: 18px;"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg> Sign in with Google';
                }
            });
        }

        // Panel Account Dropdown
        const panelAccount = document.getElementById('panelAccount');
        const panelAccountDropdown = document.getElementById('panelAccountDropdown');

        if (panelAccount && panelAccountDropdown) {
            panelAccount.addEventListener('click', (e) => {
                e.stopPropagation();
                panelAccountDropdown.classList.toggle('hidden');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', () => {
                if (!panelAccountDropdown.classList.contains('hidden')) {
                    panelAccountDropdown.classList.add('hidden');
                }
            });

            panelAccountDropdown.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }

        // Panel Sign Out Button
        const panelSignOutBtn = document.getElementById('panelSignOutBtn');
        if (panelSignOutBtn) {
            panelSignOutBtn.addEventListener('click', handleSignOut);
        }

        // Panel Link Button - Opens Right Panel
        const panelLinkBtn = document.getElementById('panelLinkBtn');
        const rightActivityPanel = document.querySelector('.right-activity-panel');
        // rightPanelToggle already declared at line 5301

        function openRightPanel() {
            if (rightActivityPanel) {
                rightActivityPanel.style.display = 'flex';
            }
            if (rightPanelToggle) {
                rightPanelToggle.classList.add('visible');
            }
            document.body.classList.add('right-panel-open');
            document.body.classList.remove('right-panel-collapsed');
        }

        function closeRightPanel() {
            if (rightActivityPanel) {
                rightActivityPanel.style.display = 'none';
            }
            // Keep toggle visible so user can re-open the panel
            // Toggle moves to right edge via CSS when collapsed
            document.body.classList.remove('right-panel-open');
            document.body.classList.add('right-panel-collapsed');
        }

        function toggleRightPanel() {
            if (rightActivityPanel && rightActivityPanel.style.display === 'flex') {
                closeRightPanel();
            } else {
                openRightPanel();
            }
        }

        if (panelLinkBtn) {
            panelLinkBtn.addEventListener('click', () => {
                // Close dropdown
                if (panelAccountDropdown) {
                    panelAccountDropdown.classList.add('hidden');
                }
                // Open right panel
                openRightPanel();
                // Switch to settings tab
                switchPanelTab('settings');
            });
        }

        // Mobile Profile Dropdown handlers
        const mobileAvatar = document.getElementById('mobileAvatar');
        const mobileProfileDropdown = document.getElementById('mobileProfileDropdown');
        const mobileSettingsBtn = document.getElementById('mobileSettingsBtn');
        const mobileSignOutBtn = document.getElementById('mobileSignOutBtn');

        if (mobileAvatar && mobileProfileDropdown) {
            mobileAvatar.addEventListener('click', (e) => {
                e.stopPropagation();
                mobileProfileDropdown.classList.toggle('hidden');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!mobileProfileDropdown.contains(e.target) && e.target !== mobileAvatar) {
                    mobileProfileDropdown.classList.add('hidden');
                }
            });
        }

        if (mobileSettingsBtn) {
            mobileSettingsBtn.addEventListener('click', () => {
                // Close dropdown
                if (mobileProfileDropdown) {
                    mobileProfileDropdown.classList.add('hidden');
                }
                // Open right panel and switch to settings tab
                openRightPanel();
                switchPanelTab('settings');
            });
        }

        if (mobileSignOutBtn) {
            mobileSignOutBtn.addEventListener('click', handleSignOut);
        }

        // Right panel toggle handle (on left wall of panel)
        if (rightPanelToggle) {
            rightPanelToggle.addEventListener('click', toggleRightPanel);
        }

        // Panel KB Upload
        const panelUploadBtn = document.getElementById('panelUploadBtn');
        const panelKbFileInput = document.getElementById('panelKbFileInput');
        const panelKbList = document.getElementById('panelKbList');
        const panelKbCount = document.getElementById('panelKbCount');
        const trialCountdownBanner = document.getElementById('trialCountdownBanner');

        // Trial countdown banner click - opens settings (but not when clicking upgrade button)
        if (trialCountdownBanner) {
            trialCountdownBanner.addEventListener('click', (e) => {
                if (e.target.id === 'trialUpgradeBtn') return; // Let button handle its own click
                openRightPanel();
                switchPanelTab('settings');
            });
        }

        // Trial upgrade button click - start checkout
        const trialUpgradeBtn = document.getElementById('trialUpgradeBtn');
        if (trialUpgradeBtn) {
            trialUpgradeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                startCheckout();
            });
        }

        if (panelUploadBtn && panelKbFileInput) {
            panelUploadBtn.addEventListener('click', () => {
                panelKbFileInput.click();
            });

            panelKbFileInput.addEventListener('change', async (e) => {
                const files = e.target.files;
                if (!files.length) return;

                const user = auth.currentUser;
                if (!user) {
                    alert('Please sign in first');
                    return;
                }

                // Use the existing knowledge base upload logic
                await uploadKnowledgeBaseDocuments(files);

                // Clear the input
                panelKbFileInput.value = '';

                // Reload KB files
                loadPanelKbFiles();
            });
        }

        // Knowledge Base section expand/collapse toggle
        const kbSectionHeader = document.getElementById('kbSectionHeader');
        const kbSectionContent = document.getElementById('kbSectionContent');
        const kbExpandIcon = document.getElementById('kbExpandIcon');

        if (kbSectionHeader && kbSectionContent && kbExpandIcon) {
            kbSectionHeader.addEventListener('click', function() {
                const isExpanded = kbSectionContent.style.display !== 'none';
                kbSectionContent.style.display = isExpanded ? 'none' : 'block';
                kbExpandIcon.textContent = isExpanded ? '' : '';
            });
        }

        // Load KB files into panel
        async function loadPanelKbFiles() {
            if (!auth.currentUser || !panelKbList) return;

            try {
                const filesRef = collection(db, 'users', auth.currentUser.uid, 'knowledgeBase');
                const q = query(filesRef, orderBy('uploadedAt', 'desc'));
                const snapshot = await getDocs(q);

                panelKbList.innerHTML = '';
                let count = 0;

                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    count++;

                    const item = document.createElement('div');
                    item.className = 'panel-kb-item';
                    item.innerHTML = `
                        <span class="panel-kb-icon"></span>
                        <span class="panel-kb-name" title="${data.fileName}">${data.fileName}</span>
                        <button class="panel-kb-delete" title="Delete"></button>
                    `;

                    const deleteBtn = item.querySelector('.panel-kb-delete');
                    deleteBtn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        if (confirm(`Delete "${data.fileName}"?`)) {
                            // Support both old (storagePath) and new (blobUrl) documents
                            const deleteUrl = data.blobUrl || data.url || data.storagePath;
                            await deleteKnowledgeBaseDocument(docSnap.id, deleteUrl);
                            loadPanelKbFiles();
                        }
                    });

                    panelKbList.appendChild(item);
                });

                if (panelKbCount) {
                    panelKbCount.textContent = count;
                }

                // Also update the old KB count if it exists
                const oldKbCount = document.getElementById('kbCount');
                if (oldKbCount) {
                    oldKbCount.textContent = count;
                }
            } catch (error) {
                console.error('Error loading panel KB files:', error);
            }
        }

        // Load Link Status
        // Alpha: Link features hidden - will be enabled in Max plan
        async function loadLinkStatus() {
            return; // Alpha: Link features hidden
            if (!auth.currentUser) return;

            try {
                const idToken = await auth.currentUser.getIdToken();
                const response = await fetch('/api/link-settings', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                if (response.ok) {
                    const settings = await response.json();
                    const activityFeedLink = document.getElementById('activityFeedLink');

                    if (settings.linkEnabled && settings.username) {
                        // Set the public link URL
                        activityFeedLink.href = `https://mindclone.link/${settings.username}`;
                        activityFeedLink.target = '_blank';
                        activityFeedLink.style.cursor = 'pointer';
                        activityFeedLink.style.opacity = '1';

                        // Also update right panel link
                        if (rightActivityFeedLink) {
                            rightActivityFeedLink.href = `https://mindclone.link/${settings.username}`;
                            rightActivityFeedLink.target = '_blank';
                            rightActivityFeedLink.style.cursor = 'pointer';
                            rightActivityFeedLink.style.opacity = '1';
                        }
                    } else {
                        // Redirect to settings to enable link
                        activityFeedLink.href = '/settings';
                        activityFeedLink.target = '_self';
                        activityFeedLink.style.cursor = 'pointer';
                        activityFeedLink.style.opacity = '0.6';

                        // Also update right panel link
                        if (rightActivityFeedLink) {
                            rightActivityFeedLink.href = '/settings';
                            rightActivityFeedLink.target = '_self';
                            rightActivityFeedLink.style.cursor = 'pointer';
                            rightActivityFeedLink.style.opacity = '0.6';
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading link status:', error);
            }
        }

        // Activity Feed Functions
        function formatTimeAgo(timestamp) {
            if (!timestamp) return 'just now';

            const now = Date.now();
            const time = timestamp.seconds ? timestamp.seconds * 1000 : timestamp;
            const diff = Math.floor((now - time) / 1000); // difference in seconds

            if (diff < 60) return 'just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            if (diff < 2592000) return `${Math.floor(diff / 86400)}d ago`;
            return `${Math.floor(diff / 2592000)}mo ago`;
        }

        function truncateText(text, maxLength = 50) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function createActivityItem(visitorId, lastMessage, lastResponse, timestamp, isNew = false) {
            const item = document.createElement('div');
            item.className = `activity-item${isNew ? ' new' : ''}`;
            item.dataset.visitorId = visitorId;

            const visitorName = `visitor_${visitorId.substring(0, 6)}`;
            const timeAgo = formatTimeAgo(timestamp);

            item.innerHTML = `
                <div class="activity-item-header">
                    <div class="activity-item-visitor">
                        <span></span>
                        <span>${visitorName}</span>
                    </div>
                    <div class="activity-item-time">${timeAgo}</div>
                </div>
                <div class="activity-item-message">"${truncateText(lastMessage, 60)}"</div>
                ${lastResponse ? `<div class="activity-item-response"> ${truncateText(lastResponse, 60)}</div>` : ''}
            `;

            // Click to expand conversation
            item.addEventListener('click', () => {
                openConversationModal(visitorId);
            });

            return item;
        }

        async function loadActivityFeed() {
            if (!auth.currentUser) return;

            try {
                const idToken = await auth.currentUser.getIdToken();
                const response = await fetch('/api/activity', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    activityData = data.activities || [];

                    // Update count (right panel only)
                    const todayCount = activityData.filter(a => {
                        const time = a.lastTimestamp?.seconds ? a.lastTimestamp.seconds * 1000 : Date.now();
                        return (Date.now() - time) < 86400000; // 24 hours
                    }).length;
                    if (rightActivityCount) rightActivityCount.textContent = `${todayCount} today`;

                    // Clear current list (right panel only)
                    if (rightActivityList) rightActivityList.innerHTML = '';

                    if (activityData.length > 0) {
                        // Show list, hide empty state (right panel only)
                        if (rightActivityList) rightActivityList.style.display = 'flex';
                        if (rightActivityEmpty) rightActivityEmpty.style.display = 'none';

                        // Render each activity item (right panel only)
                        activityData.forEach(activity => {
                            if (rightActivityList) {
                                const rightItem = createActivityItem(
                                    activity.visitorId,
                                    activity.lastMessage,
                                    activity.lastResponse,
                                    activity.lastTimestamp,
                                    activity.isNew
                                );
                                rightActivityList.appendChild(rightItem);
                            }
                        });
                    } else {
                        // Show empty state (right panel only)
                        if (rightActivityList) rightActivityList.style.display = 'none';
                        if (rightActivityEmpty) rightActivityEmpty.style.display = 'flex';
                    }
                } else {
                    console.error('Failed to load activity feed');
                    // Show empty state on error (right panel only)
                    if (rightActivityList) rightActivityList.style.display = 'none';
                    if (rightActivityEmpty) rightActivityEmpty.style.display = 'flex';
                }
            } catch (error) {
                console.error('Error loading activity feed:', error);
                // Show empty state on error (right panel only)
                if (rightActivityList) rightActivityList.style.display = 'none';
                if (rightActivityEmpty) rightActivityEmpty.style.display = 'flex';
            }
        }

        // Set up real-time activity listener
        function setupActivityListener() {
            if (!auth.currentUser) return;

            // Clean up existing listener
            if (activityListener) {
                activityListener();
                activityListener = null;
            }

            try {
                const userId = auth.currentUser.uid;
                const visitorsRef = collection(db, 'users', userId, 'visitors');
                const q = query(visitorsRef, orderBy('lastVisit', 'desc'), limit(20));

                console.log('[Activity] Setting up real-time listener...');

                // Listen to visitor changes
                activityListener = onSnapshot(q, async (snapshot) => {
                    console.log('[Activity] Snapshot received:', snapshot.size, 'visitors');
                    console.log('[Activity] Current time:', new Date().toLocaleTimeString());

                    const changes = snapshot.docChanges();
                    console.log('[Activity] Number of changes:', changes.length);

                    // Process changes
                    for (const change of changes) {
                        console.log('[Activity] Change type:', change.type, 'Visitor:', change.doc.id);
                        const visitorId = change.doc.id;
                        const visitorData = change.doc.data();

                        if (change.type === 'added' || change.type === 'modified') {
                            console.log('[Activity] Visitor updated:', visitorId);

                            // Get last 2 messages for this visitor
                            try {
                                const messagesRef = collection(db, 'users', userId, 'visitors', visitorId, 'messages');
                                const messagesQuery = query(messagesRef, orderBy('timestamp', 'desc'), limit(2));
                                const messagesSnapshot = await getDocs(messagesQuery);

                                let lastMessage = null;
                                let lastResponse = null;

                                if (!messagesSnapshot.empty) {
                                    const messages = messagesSnapshot.docs.map(doc => ({
                                        id: doc.id,
                                        ...doc.data()
                                    }));

                                    // Find last user message and AI response
                                    for (const msg of messages) {
                                        if (msg.role === 'user' && !lastMessage) {
                                            lastMessage = msg.content;
                                        } else if (msg.role === 'assistant' && !lastResponse) {
                                            lastResponse = msg.content;
                                        }
                                    }
                                }

                                // Use fallback from visitor data
                                if (!lastMessage && visitorData.lastMessage) {
                                    lastMessage = visitorData.lastMessage;
                                }

                                // Update or add activity item
                                if (lastMessage) {
                                    const activityItem = {
                                        visitorId: visitorId,
                                        lastMessage: lastMessage,
                                        lastResponse: lastResponse,
                                        lastTimestamp: visitorData.lastVisit,
                                        isNew: change.type === 'modified' // Mark as new if modified (new message)
                                    };

                                    // Update activityData array
                                    const existingIndex = activityData.findIndex(a => a.visitorId === visitorId);
                                    if (existingIndex >= 0) {
                                        activityData[existingIndex] = activityItem;
                                    } else {
                                        activityData.unshift(activityItem);
                                    }

                                    // Update DOM
                                    updateActivityItem(visitorId, activityItem);
                                }
                            } catch (error) {
                                console.error('[Activity] Error fetching messages for visitor:', visitorId, error);
                            }
                        } else if (change.type === 'removed') {
                            // Remove from activityData array
                            const index = activityData.findIndex(a => a.visitorId === visitorId);
                            if (index >= 0) {
                                activityData.splice(index, 1);
                            }

                            // Remove from DOM
                            removeActivityItem(visitorId);
                        }
                    }

                    // Update count
                    updateActivityCount();
                }, (error) => {
                    console.error('[Activity] Listener error:', error);
                });

                console.log('[Activity] Real-time listener active');
            } catch (error) {
                console.error('[Activity] Error setting up listener:', error);
            }
        }

        // Update or add activity item in the feed
        function updateActivityItem(visitorId, activity) {
            // Only update right panel
            if (!rightActivityList) return;

            // Check if item exists in right panel
            let rightExistingItem = rightActivityList.querySelector(`[data-visitor-id="${visitorId}"]`);

            if (rightExistingItem) {
                // Update existing item in right panel
                const timeAgo = formatTimeAgo(activity.lastTimestamp);
                const visitorName = `visitor_${visitorId.substring(0, 6)}`;

                rightExistingItem.innerHTML = `
                    <div class="activity-item-header">
                        <div class="activity-item-visitor">
                            <span></span>
                            <span>${visitorName}</span>
                        </div>
                        <div class="activity-item-time">${timeAgo}</div>
                    </div>
                    <div class="activity-item-message">"${truncateText(activity.lastMessage, 60)}"</div>
                    ${activity.lastResponse ? `<div class="activity-item-response"> ${truncateText(activity.lastResponse, 60)}</div>` : ''}
                `;

                // Re-attach click listener
                rightExistingItem.onclick = () => {
                    openConversationModal(visitorId);
                };

                // Add "new" class and animate
                if (activity.isNew) {
                    rightExistingItem.classList.add('new');
                    setTimeout(() => {
                        rightExistingItem.classList.remove('new');
                    }, 5000);
                }

                // Move to top if it's a new message
                if (activity.isNew && rightExistingItem !== rightActivityList.firstChild) {
                    rightActivityList.removeChild(rightExistingItem);
                    rightActivityList.insertBefore(rightExistingItem, rightActivityList.firstChild);
                }
            } else {
                // Create new item for right panel
                const rightItem = createActivityItem(
                    activity.visitorId,
                    activity.lastMessage,
                    activity.lastResponse,
                    activity.lastTimestamp,
                    activity.isNew
                );

                // Add to top of list
                if (rightActivityList.firstChild) {
                    rightActivityList.insertBefore(rightItem, rightActivityList.firstChild);
                } else {
                    rightActivityList.appendChild(rightItem);
                }

                // Show list, hide empty state
                rightActivityList.style.display = 'flex';
                if (rightActivityEmpty) rightActivityEmpty.style.display = 'none';

                // Remove "new" class after 5 seconds
                if (activity.isNew) {
                    setTimeout(() => {
                        rightItem.classList.remove('new');
                    }, 5000);
                }
            }
        }

        // Remove activity item from the feed
        function removeActivityItem(visitorId) {
            // Only remove from right panel
            if (!rightActivityList) return;

            const rightItem = rightActivityList.querySelector(`[data-visitor-id="${visitorId}"]`);
            if (rightItem) {
                rightItem.remove();
            }

            // Check if right panel list is empty
            if (rightActivityList.children.length === 0) {
                rightActivityList.style.display = 'none';
                if (rightActivityEmpty) rightActivityEmpty.style.display = 'flex';
            }
        }

        // Update activity count
        function updateActivityCount() {
            // activityList removed with left sidebar - skip if not present
            if (!activityList) return;

            const now = Date.now();
            const items = activityList.querySelectorAll('.activity-item');
            let todayCount = 0;

            items.forEach(item => {
                const visitorId = item.dataset.visitorId;
                const activity = activityData.find(a => a.visitorId === visitorId);
                if (activity) {
                    const time = activity.lastTimestamp?.seconds ? activity.lastTimestamp.seconds * 1000 : now;
                    if ((now - time) < 86400000) { // 24 hours
                        todayCount++;
                    }
                }
            });

            // Update old sidebar count (removed with left sidebar)
            if (activityCount) {
                activityCount.textContent = `${todayCount} today`;
            }

            // Update right panel count
            if (rightActivityCount) {
                rightActivityCount.textContent = `${todayCount} today`;
            }
        }

        // Conversation Modal Functions
        async function openConversationModal(visitorId) {
            console.log('[Modal] Opening conversation for visitor:', visitorId);

            // Show modal
            conversationModal.classList.remove('hidden');

            // Update header
            const visitorName = `visitor_${visitorId.substring(0, 6)}`;
            modalVisitorName.textContent = visitorName;

            // Show loading state
            conversationModalBody.innerHTML = `
                <div class="conversation-loading">
                    <div class="spinner"></div>
                    <div>Loading conversation...</div>
                </div>
            `;

            try {
                // Fetch full conversation via API
                const idToken = await auth.currentUser.getIdToken();
                const response = await fetch(`/api/analytics?visitorId=${visitorId}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                if (!response.ok) {
                    throw new Error('Failed to load conversation');
                }

                const data = await response.json();
                console.log('[Modal] Conversation data:', data);

                // Update time
                if (data.firstVisit) {
                    const firstVisit = data.firstVisit.seconds ? new Date(data.firstVisit.seconds * 1000) : new Date(data.firstVisit);
                    modalVisitorTime.textContent = `First visit: ${formatTimeAgo(data.firstVisit)}`;
                }

                // Render messages
                conversationModalBody.innerHTML = '';

                if (data.messages && data.messages.length > 0) {
                    // Reverse to show oldest first
                    const messages = [...data.messages].reverse();

                    // Track the latest displayAction (for slides/excel)
                    let latestDisplayAction = null;

                    messages.forEach(msg => {
                        const messageEl = document.createElement('div');
                        messageEl.className = `conversation-message ${msg.role}`;

                        const label = msg.role === 'user' ? 'Visitor' : 'Your AI';
                        const time = msg.timestamp ? formatTimeAgo(msg.timestamp) : '';

                        messageEl.innerHTML = `
                            <div class="conversation-message-label">${label}</div>
                            <div class="conversation-message-bubble">${escapeHtml(msg.content)}</div>
                            ${time ? `<div class="conversation-message-time">${time}</div>` : ''}
                        `;

                        conversationModalBody.appendChild(messageEl);

                        // Track displayAction for slides
                        if (msg.displayAction) {
                            latestDisplayAction = msg.displayAction;
                        }
                    });

                    // Scroll to bottom
                    conversationModalBody.scrollTop = conversationModalBody.scrollHeight;

                    // If there's a displayAction, show the display panel
                    if (latestDisplayAction && latestDisplayAction.type === 'slide') {
                        await renderSlideInModal(latestDisplayAction);
                    } else {
                        // Hide display panel if no slides
                        conversationDisplayPanel.classList.add('hidden');
                        conversationModalContent.classList.remove('has-display');
                    }
                } else {
                    conversationModalBody.innerHTML = `
                        <div class="conversation-error">
                            No messages found for this visitor.
                        </div>
                    `;
                    conversationDisplayPanel.classList.add('hidden');
                    conversationModalContent.classList.remove('has-display');
                }
            } catch (error) {
                console.error('[Modal] Error loading conversation:', error);
                conversationModalBody.innerHTML = `
                    <div class="conversation-error">
                        Failed to load conversation: ${error.message}
                    </div>
                `;
            }
        }

        async function renderSlideInModal(displayAction) {
            try {
                console.log('[Modal] Rendering slide:', displayAction);

                // Show display panel
                conversationDisplayPanel.classList.remove('hidden');
                conversationModalContent.classList.add('has-display');

                // Clear previous content
                conversationDisplayContent.innerHTML = '<div class="spinner"></div>';

                // Load PDF
                const loadingTask = pdfjsLib.getDocument(displayAction.pdfUrl);
                const pdf = await loadingTask.promise;

                // Get the page
                const page = await pdf.getPage(displayAction.slideNumber);

                // Create canvas
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');

                // Calculate scale to fit display panel
                const viewport = page.getViewport({ scale: 1.5 });
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                // Render page
                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;

                // Display canvas
                conversationDisplayContent.innerHTML = '';
                conversationDisplayContent.appendChild(canvas);

                console.log('[Modal] Slide rendered successfully');
            } catch (error) {
                console.error('[Modal] Error rendering slide:', error);
                conversationDisplayContent.innerHTML = `
                    <div class="conversation-error">
                        Failed to load slide: ${error.message}
                    </div>
                `;
            }
        }

        function closeConversationModal() {
            conversationModal.classList.add('hidden');
            conversationModalBody.innerHTML = '';
            conversationDisplayPanel.classList.add('hidden');
            conversationDisplayContent.innerHTML = '';
            conversationModalContent.classList.remove('has-display');
        }

        // Helper to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Modal close handlers
        conversationModalClose.addEventListener('click', closeConversationModal);

        // Close on backdrop click
        conversationModal.addEventListener('click', (e) => {
            if (e.target === conversationModal) {
                closeConversationModal();
            }
        });

        // Close on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !conversationModal.classList.contains('hidden')) {
                closeConversationModal();
            }
        });

        // Show Auth Screen
        function showAuthScreen() {
            // Show landing page
            const landingPage = document.getElementById('landingPage');
            if (landingPage) {
                landingPage.classList.remove('hidden');
            }

            // Hide app header
            const appHeader = document.getElementById('appHeader');
            if (appHeader) {
                appHeader.classList.add('hidden');
            }

            // Hide account sidebar
            const accountSidebar = document.getElementById('accountSidebar');
            if (accountSidebar) {
                accountSidebar.classList.add('hidden');
            }

            // Hide chat interface
            chatInterface.classList.add('hidden');

            // Hide sidebar components
            sidebarAuth.classList.add('hidden');
            sidebarProfile.classList.add('hidden');
            // activityFeed removed - no longer exists after consolidation

            // Clean up activity listener
            if (activityListener) {
                activityListener();
                activityListener = null;
                console.log('[Activity] Listener cleaned up');
            }

            // Hide mobile header
            const mobileHeader = document.getElementById('mobileHeader');
            if (mobileHeader) {
                mobileHeader.classList.add('hidden');
            }

            // Update left panel footer (show sign in, hide account)
            const panelFooter = document.getElementById('panelFooter');
            const panelAuthFooter = document.getElementById('panelAuthFooter');
            if (panelFooter) panelFooter.style.display = 'none';
            if (panelAuthFooter) panelAuthFooter.style.display = 'block';

            // Hide left panel when not logged in
            const leftPanel = document.getElementById('leftPanel');
            if (leftPanel) leftPanel.style.display = 'none';
        }

        // Show Chat Interface
        async function showChatInterface(user) {
            // Hide landing page
            const landingPage = document.getElementById('landingPage');
            if (landingPage) {
                landingPage.classList.add('hidden');
            }

            // Show app header
            const appHeader = document.getElementById('appHeader');
            if (appHeader) {
                appHeader.classList.remove('hidden');
            }

            // Show chat interface
            chatInterface?.classList.remove('hidden');

            // Add with-header class to main-content for proper spacing
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.classList.add('with-header');
            }

            // Show mobile header (contains hamburger menu)
            const mobileHeader = document.getElementById('mobileHeader');
            if (mobileHeader) {
                mobileHeader.classList.remove('hidden');
                // Update mobile header avatar
                const mobileAvatar = document.getElementById('mobileAvatar');
                const mobileName = document.getElementById('mobileName');
                if (mobileAvatar) mobileAvatar.src = user.photoURL || 'https://via.placeholder.com/40';
                if (mobileName) mobileName.textContent = user.displayName || 'Mindclone';

                // Update mobile profile dropdown
                const mobileDropdownAvatar = document.getElementById('mobileDropdownAvatar');
                const mobileDropdownName = document.getElementById('mobileDropdownName');
                const mobileDropdownEmail = document.getElementById('mobileDropdownEmail');
                if (mobileDropdownAvatar) mobileDropdownAvatar.src = user.photoURL || 'https://via.placeholder.com/36';
                if (mobileDropdownName) mobileDropdownName.textContent = user.displayName || 'User';
                if (mobileDropdownEmail) mobileDropdownEmail.textContent = user.email || '';
            }

            // Hide sidebar components (not needed with header layout)
            sidebarAuth?.classList.add('hidden');
            sidebarProfile?.classList.add('hidden');
            // activityFeed removed - no longer exists after consolidation

            // Update header avatar and dropdown
            const headerAvatar = document.getElementById('headerAvatar');
            const headerDropdownAvatar = document.getElementById('headerDropdownAvatar');
            const headerDropdownName = document.getElementById('headerDropdownName');
            const headerDropdownEmail = document.getElementById('headerDropdownEmail');

            if (headerAvatar) headerAvatar.src = user.photoURL || 'https://via.placeholder.com/40';
            if (headerDropdownAvatar) headerDropdownAvatar.src = user.photoURL || 'https://via.placeholder.com/36';
            if (headerDropdownName) headerDropdownName.textContent = user.displayName || 'User';
            if (headerDropdownEmail) headerDropdownEmail.textContent = user.email;

            // Update account sidebar
            const accountSidebar = document.getElementById('accountSidebar');
            const accountSidebarAvatar = document.getElementById('accountSidebarAvatar');
            const accountMenuAvatar = document.getElementById('accountMenuAvatar');
            const accountMenuName = document.getElementById('accountMenuName');
            const accountMenuEmail = document.getElementById('accountMenuEmail');
            if (accountSidebar) accountSidebar.classList.remove('hidden');
            if (accountSidebarAvatar) accountSidebarAvatar.src = user.photoURL || 'https://via.placeholder.com/40';
            if (accountMenuAvatar) accountMenuAvatar.src = user.photoURL || 'https://via.placeholder.com/48';
            if (accountMenuName) accountMenuName.textContent = user.displayName || 'User';
            if (accountMenuEmail) accountMenuEmail.textContent = user.email;

            // Update legacy user profile elements (for backward compatibility)
            if (userAvatar) userAvatar.src = user.photoURL || 'https://via.placeholder.com/50';
            if (userName) userName.textContent = user.displayName || 'User';
            if (userEmail) userEmail.textContent = user.email;

            if (dropdownAvatar) dropdownAvatar.src = user.photoURL || 'https://via.placeholder.com/36';
            if (dropdownUserName) dropdownUserName.textContent = user.displayName || 'User';
            if (dropdownUserEmail) dropdownUserEmail.textContent = user.email;

            // Update new left panel user info
            const panelFooter = document.getElementById('panelFooter');
            const panelAuthFooter = document.getElementById('panelAuthFooter');
            const panelAccountAvatar = document.getElementById('panelAccountAvatar');
            const panelAccountName = document.getElementById('panelAccountName');
            const panelAccountEmail = document.getElementById('panelAccountEmail');
            const leftPanelEl = document.getElementById('leftPanel');

            // Show left panel when logged in
            if (leftPanelEl) leftPanelEl.style.display = 'flex';
            if (panelFooter) panelFooter.style.display = 'block';
            if (panelAuthFooter) panelAuthFooter.style.display = 'none';
            if (panelAccountAvatar) panelAccountAvatar.src = user.photoURL || 'https://via.placeholder.com/36';
            if (panelAccountName) panelAccountName.textContent = user.displayName || 'User';
            if (panelAccountEmail) panelAccountEmail.textContent = user.email;

            // Initialize synchronous panel setup immediately
            initializePanelTabs();
            initializePanelSettings();
            initializePanelAnalytics();
            initializeKnowledgeBase();
            initializeFeedbackAdmin();

            // Set up real-time listener for activity feed
            setupActivityListener();

            // Update activity badge
            updateActivityBadge();

            // Restore last active tab
            restorePanelTab();

            // Clear existing UI
            chatMessages.innerHTML = '';
            console.log('[Chat] Cleared chat messages');

            // INSTANT CACHE: Show cached messages immediately while loading from Firestore
            const cachedMessages = getCachedMessages();
            const hasCachedMessages = cachedMessages && cachedMessages.length > 0;
            if (hasCachedMessages) {
                console.log('[Cache] Displaying cached messages instantly');
                cachedMessages.forEach(msg => {
                    addMessage(msg.role === 'assistant' ? 'ai' : msg.role, msg.content, msg.timestamp);
                });
                console.log('[Cache] Displayed', cachedMessages.length, 'cached messages for instant load');
            }

            // Only show loading indicator if we have NO cached messages
            if (!hasCachedMessages) {
                showLoadingIndicator();
            }

            // Auto-remove loading indicator after 10 seconds as failsafe
            const loadingTimeout = setTimeout(() => {
                console.warn('[Chat] Loading timeout - removing stuck indicator');
                removeLoadingIndicator();
            }, 10000);

            // Load data in parallel for faster startup
            console.log('[Chat] Starting parallel data loading...');
            let messages;
            try {
                [messages] = await Promise.all([
                    loadConversationHistory(user.uid),
                    loadLinkStatus().catch(e => console.warn('[Parallel] loadLinkStatus error:', e)),
                    loadActivityFeed().catch(e => console.warn('[Parallel] loadActivityFeed error:', e)),
                    loadPanelKbFiles().catch(e => console.warn('[Parallel] loadPanelKbFiles error:', e))
                ]);
            } finally {
                clearTimeout(loadingTimeout);
            }

            console.log('[Chat] Parallel loading complete');

            try {
                // Process conversation history
                console.log('[Chat] Loaded', messages?.length || 0, 'messages from Firestore');

                if (messages && messages.length > 0) {
                    // Populate conversationHistory array
                    conversationHistory = messages.map(msg => ({
                        role: msg.role,
                        content: msg.content
                    }));

                    // Add "Load More" button at top if there are more messages
                    if (hasMoreMessages) {
                        addLoadMoreButton();
                    }

                    // SMART SYNC: Only re-render if data differs from cache
                    // Compare message counts and last message content
                    const cacheMatches = hasCachedMessages &&
                        cachedMessages.length === messages.length &&
                        cachedMessages[cachedMessages.length - 1]?.content === messages[messages.length - 1]?.content;

                    if (cacheMatches) {
                        // Cache is up to date - no need to re-render UI
                        console.log('[Cache] Cache matches Firestore - no UI update needed');
                    } else {
                        // Cache differs - update UI with Firestore data
                        console.log('[Cache] Cache differs from Firestore - updating UI');
                        chatMessages.innerHTML = '';

                        // Display all messages in UI with timestamps
                        messages.forEach(msg => {
                            addMessage(msg.role === 'assistant' ? 'ai' : msg.role, msg.content, msg.timestamp);
                        });
                        console.log('[Chat] Displayed', messages.length, 'messages in UI');
                    }

                    // Update cache with fresh Firestore messages for next PWA launch
                    cacheMessages(messages);
                } else if (!hasCachedMessages) {
                    // No history and no cache - show empty state
                    console.log('[Chat] No messages found, showing empty state');
                    showEmptyState();
                }
                // If we have cached messages but Firestore returned empty (network issue?),
                // keep showing cached messages
            } catch (error) {
                console.error('[Chat] Error loading conversation:', error);
                // Only show empty state if we don't have cached messages
                if (!hasCachedMessages) {
                    showEmptyState();
                }
            } finally {
                removeLoadingIndicator();
                console.log('[Chat] Finished loading conversation');
            }
        }

        // Add Message to Chat
        function addMessage(type, content, timestamp = null, replyTo = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            // Generate unique message ID
            const msgId = 'msg-' + Date.now() + '-' + (messageIdCounter++);
            messageDiv.setAttribute('data-msg-id', msgId);

            // Only add avatar for AI messages (WhatsApp style)
            if (type === 'ai') {
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.textContent = '';
                messageDiv.appendChild(avatar);
            }

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';

            // Add reply quote if this is a reply
            if (replyTo && replyTo.content) {
                const replyQuote = document.createElement('div');
                replyQuote.className = 'reply-quote';
                replyQuote.innerHTML = `
                    <div class="reply-quote-label">Replying to ${replyTo.role === 'ai' ? 'Mindclone' : 'yourself'}</div>
                    <div class="reply-quote-text">${replyTo.content.slice(0, 100)}${replyTo.content.length > 100 ? '...' : ''}</div>
                `;
                messageContent.appendChild(replyQuote);
            }

            // Use markdown for AI messages, plain text for user messages
            if (type === 'ai' && typeof marked !== 'undefined') {
                const actualContent = document.createElement('div');
                actualContent.innerHTML = marked.parse(content);
                messageContent.appendChild(actualContent);
            } else {
                const actualContent = document.createElement('div');

                // Check if message contains an image URL (from uploads)
                const imageUrlMatch = content.match(/Image URL:\s*(https:\/\/[^\s]+)/);
                if (imageUrlMatch) {
                    // Extract text before the [Image:...] part
                    const textBeforeImage = content.split(/\[Image:/)[0].trim();

                    // Add the text message if any
                    if (textBeforeImage) {
                        const textPart = document.createElement('div');
                        textPart.textContent = textBeforeImage;
                        textPart.style.marginBottom = '8px';
                        actualContent.appendChild(textPart);
                    }

                    // Create image element
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'chat-image-container';
                    imgContainer.style.cssText = 'max-width: 300px; border-radius: 12px; overflow: hidden; cursor: pointer;';

                    const img = document.createElement('img');
                    img.src = imageUrlMatch[1];
                    img.alt = 'Uploaded image';
                    img.style.cssText = 'width: 100%; height: auto; display: block;';
                    img.onclick = () => window.open(imageUrlMatch[1], '_blank');

                    imgContainer.appendChild(img);
                    actualContent.appendChild(imgContainer);
                } else {
                    actualContent.textContent = content;
                }

                messageContent.appendChild(actualContent);
            }

            // Add timestamp
            if (timestamp) {
                const timestampDiv = document.createElement('div');
                timestampDiv.className = 'message-timestamp';
                timestampDiv.textContent = formatTimestamp(timestamp);
                messageContent.appendChild(timestampDiv);
            }

            messageDiv.appendChild(messageContent);

            // Add WhatsApp-style dropdown menu for ALL messages
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'message-actions';

            const dropdownBtn = document.createElement('button');
            dropdownBtn.className = 'message-dropdown-btn';
            dropdownBtn.innerHTML = '&#x2304;'; // Elegant chevron 
            dropdownBtn.onclick = (e) => {
                e.stopPropagation();
                // Close all other dropdowns
                document.querySelectorAll('.message-dropdown.visible').forEach(d => d.classList.remove('visible'));
                dropdown.classList.toggle('visible');
            };

            const dropdown = document.createElement('div');
            dropdown.className = 'message-dropdown';

            // Reply option
            const replyItem = document.createElement('div');
            replyItem.className = 'message-dropdown-item';
            replyItem.innerHTML = '<span class="icon"></span> Reply';
            replyItem.onclick = (e) => {
                e.stopPropagation();
                dropdown.classList.remove('visible');
                setReplyTo(msgId, content, type === 'ai' ? 'ai' : 'user');
            };
            dropdown.appendChild(replyItem);

            // Copy option
            const copyItem = document.createElement('div');
            copyItem.className = 'message-dropdown-item';
            copyItem.innerHTML = '<span class="icon"></span> Copy';
            copyItem.onclick = (e) => {
                e.stopPropagation();
                dropdown.classList.remove('visible');
                navigator.clipboard.writeText(content).then(() => {
                    copyItem.innerHTML = '<span class="icon"></span> Copied!';
                    setTimeout(() => {
                        copyItem.innerHTML = '<span class="icon"></span> Copy';
                    }, 1500);
                });
            };
            dropdown.appendChild(copyItem);

            actionsDiv.appendChild(dropdownBtn);
            actionsDiv.appendChild(dropdown);
            messageContent.appendChild(actionsDiv);

            // Keep legacy copy button for AI messages (hidden by CSS but functional)
            if (type === 'ai') {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.textContent = 'Copy';
                copyBtn.onclick = () => copyMessage(content, copyBtn);
                messageDiv.appendChild(copyBtn);
            }

            chatMessages.appendChild(messageDiv);

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;

            return msgId;
        }

        // Format timestamp
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';

            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            // Less than 1 minute
            if (diff < 60000) return 'Just now';

            // Less than 1 hour
            if (diff < 3600000) {
                const mins = Math.floor(diff / 60000);
                return `${mins} ${mins === 1 ? 'minute' : 'minutes'} ago`;
            }

            // Less than 24 hours
            if (diff < 86400000) {
                const hours = Math.floor(diff / 3600000);
                return `${hours} ${hours === 1 ? 'hour' : 'hours'} ago`;
            }

            // Less than 7 days
            if (diff < 604800000) {
                const days = Math.floor(diff / 86400000);
                return `${days} ${days === 1 ? 'day' : 'days'} ago`;
            }

            // Show full date
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Copy message to clipboard
        async function copyMessage(content, button) {
            try {
                await navigator.clipboard.writeText(content);
                button.textContent = 'Copied!';
                button.classList.add('copied');
                setTimeout(() => {
                    button.textContent = 'Copy';
                    button.classList.remove('copied');
                }, 2000);
            } catch (error) {
                console.error('Failed to copy:', error);
            }
        }

        // Typing indicator state
        let currentAbortController = null;

        // Reply feature state
        let pendingReply = null; // { msgId, content, role }
        let messageIdCounter = 0; // For generating unique message IDs

        // Reply feature functions
        function setReplyTo(msgId, content, role) {
            pendingReply = { msgId, content, role };
            const replyPreview = document.getElementById('replyPreview');
            const replyPreviewText = document.getElementById('replyPreviewText');
            if (replyPreview && replyPreviewText) {
                replyPreviewText.textContent = content.slice(0, 100) + (content.length > 100 ? '...' : '');
                replyPreview.classList.add('visible');
            }
            chatInput.focus();
        }

        function cancelReply() {
            pendingReply = null;
            const replyPreview = document.getElementById('replyPreview');
            if (replyPreview) {
                replyPreview.classList.remove('visible');
            }
        }

        // Initialize reply cancel button
        document.addEventListener('DOMContentLoaded', () => {
            const replyCancelBtn = document.getElementById('replyCancelBtn');
            if (replyCancelBtn) {
                replyCancelBtn.addEventListener('click', cancelReply);
            }
        });

        // Show simple typing indicator (just bouncing dots)
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'message ai';
            typingDiv.innerHTML = `
                <div class="message-avatar"></div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Remove typing indicator
        function removeTypingIndicator() {
            const typingDiv = document.getElementById('typingIndicator');
            if (typingDiv) typingDiv.remove();
        }

        // Waiting indicator state (for when Mindclone "promises" to come back)
        let waitingTimerInterval = null;
        let waitingStartTime = null;

        // Show waiting indicator with timer (after pendingMessage is shown)
        function showWaitingIndicator() {
            waitingStartTime = Date.now();
            const waitingDiv = document.createElement('div');
            waitingDiv.id = 'waitingIndicator';
            waitingDiv.className = 'message ai';
            waitingDiv.innerHTML = `
                <div class="message-avatar"></div>
                <div class="message-content">
                    <div class="typing-wrapper">
                        <div class="recalling-spinner"></div>
                        <span class="typing-timer">0s</span>
                        <button class="typing-cancel-btn" onclick="cancelPendingRequest()">Cancel</button>
                    </div>
                </div>
            `;
            chatMessages.appendChild(waitingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Start the timer
            waitingTimerInterval = setInterval(() => {
                const timerEl = waitingDiv.querySelector('.typing-timer');
                const cancelBtn = waitingDiv.querySelector('.typing-cancel-btn');
                if (timerEl && waitingStartTime) {
                    const elapsed = Math.floor((Date.now() - waitingStartTime) / 1000);
                    timerEl.textContent = `${elapsed}s`;
                    // Show cancel button after 3 seconds
                    if (elapsed >= 3 && cancelBtn) {
                        cancelBtn.classList.add('visible');
                    }
                }
            }, 1000);
        }

        // Remove waiting indicator
        function removeWaitingIndicator() {
            if (waitingTimerInterval) {
                clearInterval(waitingTimerInterval);
                waitingTimerInterval = null;
            }
            waitingStartTime = null;
            const waitingDiv = document.getElementById('waitingIndicator');
            if (waitingDiv) waitingDiv.remove();
        }

        // Cancel pending request
        function cancelPendingRequest() {
            if (currentAbortController) {
                currentAbortController.abort();
                currentAbortController = null;
            }
            removeTypingIndicator();
            removeWaitingIndicator();
            // Re-enable the input
            messageInput.disabled = false;
            sendBtn.disabled = false;
            messageInput.focus();
        }

        // Show recalling indicator (for memory search)
        function showRecallingIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'recallingIndicator';
            indicator.className = 'message ai';
            indicator.innerHTML = `
                <div class="message-avatar"></div>
                <div class="message-content">
                    <div class="recalling-indicator">
                        <div class="recalling-spinner"></div>
                        <span>Recalling...</span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(indicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Remove recalling indicator
        function removeRecallingIndicator() {
            const indicator = document.getElementById('recallingIndicator');
            if (indicator) indicator.remove();
        }

        // Show empty state with suggested prompts
        function showEmptyState() {
            const emptyStateDiv = document.createElement('div');
            emptyStateDiv.id = 'emptyState';
            emptyStateDiv.className = 'empty-state';
            emptyStateDiv.innerHTML = `
                <img src="logo.png" alt="Mindclone" class="empty-state-logo">
                <h2>Start Your Journey</h2>
                <p>Begin your lifelong conversation with your Mindclone. I'm here to listen, learn, and grow with you.</p>
                <div class="suggested-prompts">
                    <div class="prompt-card" data-prompt="Hi! I'd like to tell you about myself.">
                        <div class="prompt-card-title">Introduce yourself</div>
                        <div class="prompt-card-text">Start by sharing who you are</div>
                    </div>
                    <div class="prompt-card" data-prompt="I've been thinking about something lately...">
                        <div class="prompt-card-title">Share your thoughts</div>
                        <div class="prompt-card-text">What's on your mind?</div>
                    </div>
                    <div class="prompt-card" data-prompt="Let me tell you about my day.">
                        <div class="prompt-card-title">Talk about your day</div>
                        <div class="prompt-card-text">Share what happened today</div>
                    </div>
                    <div class="prompt-card" data-prompt="I have a dream I want to share with you.">
                        <div class="prompt-card-title">Share a dream</div>
                        <div class="prompt-card-text">Tell me about your aspirations</div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(emptyStateDiv);

            // Add click handlers to prompt cards
            document.querySelectorAll('.prompt-card').forEach(card => {
                card.addEventListener('click', () => {
                    const prompt = card.getAttribute('data-prompt');
                    chatInput.value = prompt;
                    chatInput.focus();
                });
            });
        }

        // Remove empty state
        function removeEmptyState() {
            const emptyStateDiv = document.getElementById('emptyState');
            if (emptyStateDiv) emptyStateDiv.remove();
        }

        // ============================================
        // KNOWLEDGE BASE WORKFLOW FUNCTIONS
        // ============================================

        // Detect if message triggers workflow
        // Alpha: Link workflow disabled - will be enabled in Max plan
        function detectWorkflowTrigger(message) {
            return false; // Alpha: Link features hidden
            /* Original triggers preserved for Max plan:
            const lowerMsg = message.toLowerCase();
            const triggers = [
                'set up my link',
                'setup my link',
                'build my link',
                'create my link',
                'configure my link',
                'help with my link',
                'set up link',
                'setup link',
                'build link',
                'create link',
                'set up my public link',
                'setup my public link',
                'build my public link',
                'create my public link',
                'help me build my knowledge base',
                'setup my knowledge base',
                'setup knowledge base'
            ];
            return triggers.some(trigger => lowerMsg.includes(trigger));
            */
        }

        // Start knowledge base workflow
        async function startKnowledgeBaseWorkflow() {
            workflowState.active = true;
            saveWorkflowState(); // Persist state

            // Show workflow indicator
            showWorkflowIndicator(' Setting up your public link...');

            // Check if knowledge base already exists
            try {
                const currentUser = auth.currentUser;
                if (currentUser) {
                    const idToken = await currentUser.getIdToken();
                    const kbResponse = await fetch('/api/link-knowledge-base', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${idToken}`
                        }
                    });

                    const kbData = await kbResponse.json();

                    // If knowledge base exists and has content, skip to username claim
                    if (kbData.success && !kbData.isEmpty &&
                        (kbData.knowledgeBase && Object.keys(kbData.knowledgeBase).length > 0)) {
                        console.log('[Workflow] Knowledge base already exists, skipping to username claim');

                        await addWorkflowMessage('ai', `Great news! You already have a knowledge base set up for your public link.

I just need to claim your username to make your link active. Let me do that now...`);

                        // Wait a moment then trigger the save
                        setTimeout(async () => {
                            try {
                                // Load existing knowledge base into workflow state
                                workflowState.data.cof = kbData.cof || { purpose: '', targetAudiences: [], desiredActions: [] };
                                workflowState.data.sections = kbData.knowledgeBase || {};

                                // Show preview and trigger save
                                showKnowledgeBasePreview();

                                // Auto-click save button after preview loads
                                setTimeout(() => {
                                    const saveBtn = document.querySelector('.kb-btn-primary');
                                    if (saveBtn) {
                                        saveBtn.click();
                                    }
                                }, 500);
                            } catch (error) {
                                console.error('[Workflow] Error auto-completing:', error);
                                await addWorkflowMessage('ai', 'Something went wrong. Please go to Settings to claim your username manually.');
                            }
                        }, 1000);

                        return;
                    }
                }
            } catch (error) {
                console.error('[Workflow] Error checking existing knowledge base:', error);
                // Continue with normal workflow if check fails
            }

            // No existing knowledge base, start full workflow
            workflowState.step = 'intro';
            saveWorkflowState();

            const introMessage = `I'll help you set up your public link! This is your business card to the world - a way to share authentic information about yourself or your business with investors, customers, talent, and other stakeholders.

We'll start by defining your link's **Core Objective Function (CoF)** - the strategic "why" behind your link. Then we'll build a **Knowledge Base** with the specific information you want to share.

Let's begin! **What is the primary purpose of your public link?**

For example:
 "Help investors understand my startup and request intro calls"
 "Showcase my professional background to recruiters"
 "Share information about my business with potential customers"`;

            await addWorkflowMessage('ai', introMessage);
        }

        // Handle workflow responses
        async function handleWorkflowResponse(message) {
            const step = workflowState.step;
            const lowerMsg = message.toLowerCase();

            // Check if user is approving/editing a draft
            if (workflowState.waitingForApproval) {
                if (lowerMsg === 'approve' || lowerMsg === 'approved' || lowerMsg === 'yes' ||
                    lowerMsg === 'looks good' || lowerMsg === 'good' || lowerMsg === 'ok' ||
                    lowerMsg === 'okay' || lowerMsg === 'fine' || lowerMsg === 'perfect' ||
                    lowerMsg === 'great' || lowerMsg === 'sounds good' || lowerMsg === 'that works' ||
                    lowerMsg === 'works for me') {
                    // Reset approval state
                    workflowState.waitingForApproval = false;
                    workflowState.currentDraft = null;

                    // Handle CoF draft approvals
                    if (step === 'purpose_draft') {
                        workflowState.data.cof.purpose = workflowState.currentDraft;
                        workflowState.step = 'target_audiences';
                        const response = ` Purpose saved!

**Target Audiences**

Who are the primary people visiting your link? Tell me about them.`;
                        await addWorkflowMessage('ai', response);
                        return true;
                    } else if (step === 'audiences_draft') {
                        const audiences = workflowState.currentDraft
                            .split(/[,\n]/)
                            .map(a => a.trim())
                            .filter(a => a.length > 0);
                        workflowState.data.cof.targetAudiences = audiences;
                        workflowState.step = 'desired_actions';
                        const response = ` Target audiences saved!

**Desired Actions**

What do you want visitors to do after they learn about you? What actions should they take?`;
                        await addWorkflowMessage('ai', response);
                        return true;
                    } else if (step === 'actions_draft') {
                        const actions = workflowState.currentDraft
                            .split(/[,\n]/)
                            .map(a => a.trim())
                            .filter(a => a.length > 0);
                        workflowState.data.cof.desiredActions = actions;
                        workflowState.step = 'sections_intro';
                        const response = ` Desired actions saved!

**Core Objective Function Complete!**

Now let's build your **Knowledge Base** with specific information. I recommend 4 essential sections:

1. **About** - Who you are / what you do
2. **Product/Service** - What you offer
3. **Traction/Background** - Your achievements
4. **Contact** - How to reach you

Ready to start? Type "yes" to continue, or "skip" to save just the CoF for now.`;
                        await addWorkflowMessage('ai', response);
                        return true;
                    }

                    // Handle section draft approvals
                    const section = workflowState.currentSection;
                    if (section) {
                        workflowState.data.sections[section] = {
                            content: workflowState.currentDraft,
                            approved: true
                        };
                        workflowState.currentSection = null;
                    }

                    if (step === 'section_about') {
                        workflowState.step = 'section_product';
                        const response = ` Approved! Saved to knowledge base.

**Section 2: Product/Service**

Tell me about what you offer. What are your key products, services, or features?`;
                        await addWorkflowMessage('ai', response);
                        return true;
                    } else if (step === 'section_product') {
                        workflowState.step = 'section_traction';
                        const response = ` Approved! Saved to knowledge base.

**Section 3: Traction/Background**

Share your achievements, traction metrics, or professional background.`;
                        await addWorkflowMessage('ai', response);
                        return true;
                    } else if (step === 'section_traction') {
                        workflowState.step = 'section_contact';
                        const response = ` Approved! Saved to knowledge base.

**Section 4: Contact**

How should visitors reach you? Share your contact methods.`;
                        await addWorkflowMessage('ai', response);
                        return true;
                    } else if (step === 'section_contact') {
                        workflowState.step = 'complete';
                        const response = ` Approved! All sections completed.

Let me show you a preview of your complete knowledge base.`;
                        await addWorkflowMessage('ai', response);
                        setTimeout(() => showKnowledgeBasePreview(), 1000);
                        return true;
                    }
                } else {
                    // User provided feedback - regenerate based on current step
                    if (step === 'purpose_draft') {
                        await draftPurpose(workflowState.userInput, message);
                        return true;
                    } else if (step === 'audiences_draft') {
                        await draftAudiences(workflowState.userInput, message);
                        return true;
                    } else if (step === 'actions_draft') {
                        await draftActions(workflowState.userInput, message);
                        return true;
                    } else if (workflowState.currentSection) {
                        // User wants to edit section - use their feedback to regenerate
                        await generateSectionDraft(workflowState.currentSection, workflowState.userInput, message);
                        return true;
                    }
                }
            }

            // Normal workflow progression
            if (step === 'intro') {
                // User provided purpose - draft it professionally
                workflowState.userInput = message;
                workflowState.step = 'purpose_draft';
                await draftPurpose(message);
                return true;
            }

            if (step === 'purpose_draft') {
                // User approved purpose
                workflowState.data.cof.purpose = workflowState.currentDraft;
                workflowState.waitingForApproval = false;
                workflowState.step = 'target_audiences';

                const response = ` Purpose saved!

**Target Audiences**

Who are the primary people visiting your link? Tell me about them.`;
                await addWorkflowMessage('ai', response);
                return true;
            }

            if (step === 'target_audiences') {
                workflowState.userInput = message;
                workflowState.step = 'audiences_draft';
                await draftAudiences(message);
                return true;
            }

            if (step === 'audiences_draft') {
                // Parse and save audiences
                const audiences = workflowState.currentDraft
                    .split(/[,\n]/)
                    .map(a => a.trim())
                    .filter(a => a.length > 0);
                workflowState.data.cof.targetAudiences = audiences;
                workflowState.waitingForApproval = false;
                workflowState.step = 'desired_actions';

                const response = ` Target audiences saved!

**Desired Actions**

What do you want visitors to do after they learn about you? What actions should they take?`;
                await addWorkflowMessage('ai', response);
                return true;
            }

            if (step === 'desired_actions') {
                workflowState.userInput = message;
                workflowState.step = 'actions_draft';
                await draftActions(message);
                return true;
            }

            if (step === 'actions_draft') {
                // Parse and save actions
                const actions = workflowState.currentDraft
                    .split(/[,\n]/)
                    .map(a => a.trim())
                    .filter(a => a.length > 0);
                workflowState.data.cof.desiredActions = actions;
                workflowState.waitingForApproval = false;
                workflowState.step = 'sections_intro';

                const response = ` Desired actions saved!

**Core Objective Function Complete!**

Now let's build your **Knowledge Base** with specific information. I recommend 4 essential sections:

1. **About** - Who you are / what you do
2. **Product/Service** - What you offer
3. **Traction/Background** - Your achievements
4. **Contact** - How to reach you

Ready to start? Type "yes" to continue, or "skip" to save just the CoF for now.`;
                await addWorkflowMessage('ai', response);
                return true;
            }

            if (step === 'sections_intro') {
                if (lowerMsg.includes('skip') || lowerMsg.includes('later')) {
                    showKnowledgeBasePreview();
                    return true;
                }

                workflowState.step = 'section_about';
                const response = `Great! Let's start.

**Section 1: About**

Tell me about yourself or your business. What do you do? What problem do you solve?`;
                await addWorkflowMessage('ai', response);
                return true;
            }

            if (step === 'section_about') {
                workflowState.userInput = message;
                workflowState.currentSection = 'about';
                await generateSectionDraft('about', message);
                return true;
            }

            if (step === 'section_product') {
                workflowState.userInput = message;
                workflowState.currentSection = 'product';
                await generateSectionDraft('product', message);
                return true;
            }

            if (step === 'section_traction') {
                workflowState.userInput = message;
                workflowState.currentSection = 'traction';
                await generateSectionDraft('traction', message);
                return true;
            }

            if (step === 'section_contact') {
                workflowState.userInput = message;
                workflowState.currentSection = 'contact';
                await generateSectionDraft('contact', message);
                return true;
            }

            // If we got here, workflow is in an unexpected state
            console.error('Workflow in unexpected state:', {
                step: workflowState.step,
                waitingForApproval: workflowState.waitingForApproval,
                currentSection: workflowState.currentSection
            });

            await addWorkflowMessage('ai', `I got a bit confused. Let me ask again:\n\n` +
                (step === 'intro' ? 'What is the primary purpose of your public link?' :
                step === 'target_audiences' ? 'Who are the primary people visiting your link?' :
                step === 'desired_actions' ? 'What do you want visitors to do?' :
                step === 'section_about' ? 'Tell me about yourself or your business.' :
                step === 'section_product' ? 'Tell me about what you offer.' :
                step === 'section_traction' ? 'Share your achievements or traction metrics.' :
                step === 'section_contact' ? 'How should visitors reach you?' :
                'Please type "cancel" to restart the workflow.'));

            saveWorkflowState(); // Save state even after error
            return true; // Still block regular AI
        }

        // Helper functions to draft content using AI
        async function draftPurpose(userInput, feedback = null) {
            showTypingIndicator();
            try {
                console.log('[Workflow] Drafting purpose...', { userInput, feedback });

                let draftPrompt;
                if (feedback) {
                    draftPrompt = `The user is setting up their public link's Core Objective Function.

Original input: "${userInput}"
Previous draft: "${workflowState.currentDraft}"
User feedback: "${feedback}"

Revise the purpose statement based on their feedback. Keep it clear, concise (1-2 sentences), professional but authentic.

Return ONLY the revised purpose statement, nothing else.`;
                } else {
                    draftPrompt = `The user is setting up their public link's Core Objective Function. They told you about their purpose: "${userInput}"

Draft a clear, concise purpose statement (1-2 sentences) based on what they said. Make it professional but authentic.

Return ONLY the purpose statement, nothing else.`;
                }

                const draft = await callAIForDraft(draftPrompt);
                console.log('[Workflow] Purpose draft generated:', draft);

                removeTypingIndicator();

                workflowState.currentDraft = draft;
                workflowState.waitingForApproval = true;
                saveWorkflowState(); // Persist state
                saveWorkflowState(); // Persist state

                const response = feedback
                    ? `Here's the revised purpose:\n\n**"${draft}"**\n\nType **"approve"** to save, or tell me how to adjust further.`
                    : `Based on what you told me, here's the purpose I drafted:\n\n**"${draft}"**\n\nDoes this capture it well? Type **"approve"** to save it, or tell me how to adjust it.`;

                await addWorkflowMessage('ai', response);
            } catch (error) {
                console.error('[Workflow] Error drafting purpose:', error);
                removeTypingIndicator();

                // Reset workflow state to allow retry
                workflowState.step = 'intro';
                workflowState.waitingForApproval = false;
                workflowState.currentDraft = null;

                await addWorkflowMessage('ai', `Sorry, I had trouble drafting that (${error.message}). Let me try again. What is the primary purpose of your public link?`);
            }
        }

        async function draftAudiences(userInput, feedback = null) {
            showTypingIndicator();
            try {
                console.log('[Workflow] Drafting audiences...', { userInput, feedback });

                let draftPrompt;
                if (feedback) {
                    draftPrompt = `The user is defining who visits their public link.

Original input: "${userInput}"
Previous draft: "${workflowState.currentDraft}"
User feedback: "${feedback}"

Revise the target audiences list based on their feedback. Format as bullet points (). Be specific and concise.

Return ONLY the revised bulleted list, nothing else.`;
                } else {
                    draftPrompt = `The user is defining who visits their public link. They said: "${userInput}"

Based on that, list the target audiences as a clean list. Format as bullet points (). Be specific and concise.

Return ONLY the bulleted list, nothing else. Example format:
 Investors and VCs
 Potential customers
 Job candidates`;
                }

                const draft = await callAIForDraft(draftPrompt);
                console.log('[Workflow] Audiences draft generated:', draft);

                removeTypingIndicator();

                workflowState.currentDraft = draft;
                workflowState.waitingForApproval = true;
                saveWorkflowState(); // Persist state

                const response = feedback
                    ? `Here's the revised list:\n\n${draft}\n\nType **"approve"** to save, or tell me what else to change.`
                    : `Here are the target audiences I identified:\n\n${draft}\n\nType **"approve"** if this looks good, or tell me what to change.`;

                await addWorkflowMessage('ai', response);
            } catch (error) {
                console.error('[Workflow] Error drafting audiences:', error);
                removeTypingIndicator();

                // Reset workflow state to allow retry
                workflowState.step = 'target_audiences';
                workflowState.waitingForApproval = false;
                workflowState.currentDraft = null;

                await addWorkflowMessage('ai', `Sorry, I had trouble with that (${error.message}). Let me try again. Who are the primary people visiting your link?`);
            }
        }

        async function draftActions(userInput, feedback = null) {
            showTypingIndicator();
            try {
                console.log('[Workflow] Drafting actions...', { userInput, feedback });

                let draftPrompt;
                if (feedback) {
                    draftPrompt = `The user wants visitors to take certain actions after visiting their link.

Original input: "${userInput}"
Previous draft: "${workflowState.currentDraft}"
User feedback: "${feedback}"

Revise the desired actions list based on their feedback. Format as bullet points (). Be specific and action-oriented.

Return ONLY the revised bulleted list, nothing else.`;
                } else {
                    draftPrompt = `The user wants visitors to take certain actions after visiting their link. They said: "${userInput}"

Based on that, list the desired actions as a clean bullet list (). Be specific and action-oriented.

Return ONLY the bulleted list, nothing else. Example format:
 Request an intro call
 Sign up for product demo
 Apply for open positions`;
                }

                const draft = await callAIForDraft(draftPrompt);
                console.log('[Workflow] Actions draft generated:', draft);

                removeTypingIndicator();

                workflowState.currentDraft = draft;
                workflowState.waitingForApproval = true;
                saveWorkflowState(); // Persist state

                const response = feedback
                    ? `Here's the revised list:\n\n${draft}\n\nType **"approve"** to save, or tell me how to adjust further.`
                    : `Here are the desired actions I drafted:\n\n${draft}\n\nType **"approve"** to save, or tell me how to adjust.`;

                await addWorkflowMessage('ai', response);
            } catch (error) {
                console.error('[Workflow] Error drafting actions:', error);
                removeTypingIndicator();

                // Reset workflow state to allow retry
                workflowState.step = 'desired_actions';
                workflowState.waitingForApproval = false;
                workflowState.currentDraft = null;

                await addWorkflowMessage('ai', `Sorry, I had trouble with that (${error.message}). Let me try again. What do you want visitors to do after they learn about you?`);
            }
        }

        async function generateSectionDraft(sectionName, userInput, feedback = null) {
            showTypingIndicator();
            try {
                console.log('[Workflow] Drafting section:', sectionName, { userInput, feedback });

                let draftPrompt;
                if (feedback) {
                    draftPrompt = `The user is building their "${sectionName}" section for their public knowledge base.

Original user input: "${userInput}"
Previous draft: "${workflowState.currentDraft}"
User feedback: "${feedback}"

Revise the draft based on their feedback. Keep it professional, clear, and 2-3 sentences. Return ONLY the revised content.`;
                } else {
                    const sectionGuidance = {
                        'about': 'Explain who they are, what they do, and what problem they solve. 2-3 sentences.',
                        'product': 'Describe what they offer - products, services, or key features. 2-3 sentences.',
                        'traction': 'Share achievements, metrics, growth, or professional background. 2-3 sentences.',
                        'contact': 'List contact methods - email, website, social links. Clear and concise.'
                    };

                    draftPrompt = `The user is building their "${sectionName}" section for their public knowledge base.

They told you: "${userInput}"

${sectionGuidance[sectionName]}

Draft professional, authentic content based on what they said. Return ONLY the content for this section.`;
                }

                const draft = await callAIForDraft(draftPrompt);
                console.log('[Workflow] Section draft generated:', { sectionName, draft });

                removeTypingIndicator();

                workflowState.currentDraft = draft;
                workflowState.waitingForApproval = true;
                saveWorkflowState(); // Persist state

                const sectionTitle = sectionName.charAt(0).toUpperCase() + sectionName.slice(1);
                const response = `Here's what I drafted for your **${sectionTitle}** section:

---
${draft}
---

Type **"approve"** to save this, or tell me how to improve it.`;
                await addWorkflowMessage('ai', response);
            } catch (error) {
                console.error('[Workflow] Error drafting section:', sectionName, error);
                removeTypingIndicator();

                // Reset workflow state to allow retry
                workflowState.waitingForApproval = false;
                workflowState.currentDraft = null;
                // Keep workflowState.step and currentSection as is for retry

                await addWorkflowMessage('ai', `Sorry, I had trouble drafting that (${error.message}). Could you tell me about your ${sectionName} again?`);
            }
        }

        // Call AI to generate draft content with timeout protection
        async function callAIForDraft(prompt) {
            // Create timeout promise (30 seconds)
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error('Request timed out')), 30000);
            });

            // Create fetch promise
            const fetchPromise = fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    messages: [{ role: 'user', content: prompt }],
                    systemPrompt: 'You are a professional content writer helping someone build their public profile. Be concise, clear, and authentic. Follow instructions exactly.',
                    userId: auth.currentUser.uid
                })
            }).then(async (response) => {
                if (!response.ok) {
                    throw new Error(`API returned ${response.status}`);
                }
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'Failed to generate draft');
                }
                return data.content.trim();
            });

            // Race between fetch and timeout
            return Promise.race([fetchPromise, timeoutPromise]);
        }

        // Show knowledge base preview modal
        function showKnowledgeBasePreview() {
            const modal = document.createElement('div');
            modal.className = 'kb-preview-modal';
            modal.innerHTML = `
                <div class="kb-preview-overlay"></div>
                <div class="kb-preview-content">
                    <div class="kb-preview-header">
                        <h2> Your Knowledge Base Preview</h2>
                        <button class="kb-preview-close" onclick="closeKnowledgeBasePreview()"></button>
                    </div>
                    <div class="kb-preview-body">
                        ${generatePreviewHTML()}
                    </div>
                    <div class="kb-preview-footer">
                        <button class="kb-btn kb-btn-secondary" onclick="closeKnowledgeBasePreview()">Cancel</button>
                        <button class="kb-btn kb-btn-primary" onclick="saveKnowledgeBase()"> Approve & Save</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Fade in animation
            setTimeout(() => {
                modal.classList.add('active');
            }, 10);
        }

        // Generate preview HTML
        function generatePreviewHTML() {
            let html = '<div class="kb-preview-section">';
            html += '<h3>Core Objective Function</h3>';
            html += `<p><strong>Purpose:</strong> ${workflowState.data.cof.purpose || 'Not set'}</p>`;

            if (workflowState.data.cof.targetAudiences.length > 0) {
                html += `<p><strong>Target Audiences:</strong> ${workflowState.data.cof.targetAudiences.join(', ')}</p>`;
            }

            if (workflowState.data.cof.desiredActions.length > 0) {
                html += `<p><strong>Desired Actions:</strong> ${workflowState.data.cof.desiredActions.join(', ')}</p>`;
            }
            html += '</div>';

            // Add sections
            for (const [sectionId, sectionData] of Object.entries(workflowState.data.sections)) {
                const sectionTitle = sectionId.charAt(0).toUpperCase() + sectionId.slice(1);
                html += '<div class="kb-preview-section">';
                html += `<h3>${sectionTitle}</h3>`;
                html += `<p>${sectionData.content}</p>`;
                html += '</div>';
            }

            if (Object.keys(workflowState.data.sections).length === 0) {
                html += '<div class="kb-preview-section">';
                html += '<p class="kb-preview-empty">No knowledge base sections added yet. You can add them later.</p>';
                html += '</div>';
            }

            return html;
        }

        // Close preview modal
        window.closeKnowledgeBasePreview = function() {
            const modal = document.querySelector('.kb-preview-modal');
            if (modal) {
                modal.classList.remove('active');
                setTimeout(() => modal.remove(), 300);
            }
        };

        // Save knowledge base to Firestore
        window.saveKnowledgeBase = async function() {
            try {
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    throw new Error('Not authenticated');
                }

                // Show loading state
                const saveBtn = document.querySelector('.kb-btn-primary');
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.textContent = 'Saving...';
                }

                // Get ID token
                const idToken = await currentUser.getIdToken();

                // Step 1: Save knowledge base
                const kbResponse = await fetch('/api/link-knowledge-base', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({
                        cof: workflowState.data.cof,
                        sections: workflowState.data.sections
                    })
                });

                const kbData = await kbResponse.json();

                if (!kbData.success) {
                    throw new Error(kbData.error || 'Failed to save knowledge base');
                }

                // Step 2: Get current settings to check username
                const settingsResponse = await fetch('/api/link-settings', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${idToken}`
                    }
                });

                const settings = await settingsResponse.json();

                // Step 2.5: Check if username is set (users must claim their own username)
                let username = settings.username;
                if (!username) {
                    console.log('[Workflow] No username found - user needs to claim one in settings');
                    // Don't auto-claim - users should choose their own username
                    // They can set it up in the settings tab
                }

                // Step 3: Enable the public link
                const enableResponse = await fetch('/api/link-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({
                        linkEnabled: true
                    })
                });

                const enableData = await enableResponse.json();

                if (!enableData.success) {
                    throw new Error('Failed to enable public link');
                }

                // Close modal
                closeKnowledgeBasePreview();

                // Reset workflow state
                workflowState.active = false;
                workflowState.step = null;
                workflowState.data = {
                    cof: { purpose: '', targetAudiences: [], desiredActions: [] },
                    sections: {}
                };

                // Hide workflow indicator
                hideWorkflowIndicator();

            // Clear saved state
            clearWorkflowState();

                // Show success message with correct URL
                // Use the username variable from above (either from settings or newly claimed)
                const domain = window.location.hostname === 'localhost' ?
                    'http://localhost:3000' :
                    `https://${window.location.hostname}`;
                const publicLink = `${domain}/${username}`;

                const successMsg = ` **Your public link is now live!**

Knowledge base saved and link enabled successfully. Visitors will receive authentic, consistent information based on what you just set up.

**Your public link:** ${publicLink}

You can:
 Share this link with investors, customers, talent, media, etc.
 View or update your knowledge base in Settings
 I'll monitor visitor interactions and report back when important patterns emerge

${!settings.username ? '\n Note: You haven\'t set a username yet. Visit Settings to claim your custom username like "/yourname".\n' : ''}
Is there anything else you'd like to configure?`;

                await addWorkflowMessage('ai', successMsg);

            } catch (error) {
                console.error('Error saving knowledge base:', error);
                alert(`Failed to save: ${error.message}`);

                // Re-enable button
                const saveBtn = document.querySelector('.kb-btn-primary');
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = ' Approve & Save';
                }
            }
        };

        // Send Message
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message && !selectedFile) return;

            // Get current user
            const currentUser = auth.currentUser;
            if (!currentUser) {
                console.error('No user signed in');
                return;
            }

            // Remove empty state if present
            removeEmptyState();

            // Capture reply context before clearing
            const replyContext = pendingReply ? { ...pendingReply } : null;
            cancelReply(); // Clear the reply preview

            // Capture file info before clearing
            const fileToUpload = selectedFile;
            const fileDisplayName = selectedFile ? selectedFile.name : null;

            // Immediately clear input and file preview for better UX
            chatInput.value = '';
            if (selectedFile) {
                selectedFile = null;
                fileInput.value = '';
                filePreview.classList.remove('visible');
            }

            // Show user message immediately (with uploading indicator if file present)
            const userTimestamp = new Date();
            const uploadingIndicator = fileDisplayName ? `  ${fileDisplayName} ` : '';
            addMessage('user', message + uploadingIndicator, userTimestamp, replyContext);

            // Handle file upload if present
            let fileUrl = null;
            let fileMetadata = null;
            if (fileToUpload) {
                try {
                    fileUrl = await uploadFile(fileToUpload);
                    fileMetadata = {
                        name: fileToUpload.name,
                        type: fileToUpload.type,
                        size: fileToUpload.size,
                        url: fileUrl
                    };

                    // Update the user message to show upload complete
                    const lastUserMessage = chatMessages.querySelector('.message.user:last-of-type .message-content');
                    if (lastUserMessage) {
                        const isImage = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif'].includes(fileMetadata.type);

                        if (isImage) {
                            // For images, replace with actual image display
                            const messageText = message ? `<p style="margin: 0 0 8px 0;">${message}</p>` : '';
                            lastUserMessage.innerHTML = `${messageText}<img src="${fileUrl}" alt="${fileMetadata.name}" class="message-image">`;
                        } else {
                            // For other files, just replace the loading indicator
                            lastUserMessage.innerHTML = lastUserMessage.innerHTML.replace(' ', ' ');
                        }
                    }

                    console.log('File uploaded successfully:', fileUrl);
                } catch (error) {
                    console.error('File upload failed:', error);
                    // Update message to show error
                    const lastUserMessage = chatMessages.querySelector('.message.user:last-of-type .message-content');
                    if (lastUserMessage) {
                        lastUserMessage.innerHTML = lastUserMessage.innerHTML.replace(' ', '  (upload failed)');
                    }
                    addMessage('assistant', 'Sorry, the file upload failed. Please try again.', new Date());
                    return;
                }
            }

            // Prepare message with file attachment if present
            let finalMessage = message;
            let messageHTML = null;
            if (fileUrl) {
                const isImage = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif'].includes(fileMetadata.type);

                if (isImage) {
                    // For images, create HTML to display the image inline
                    messageHTML = `${message ? `<p>${message}</p>` : ''}<img src="${fileUrl}" alt="${fileMetadata.name}" class="message-image">`;
                    finalMessage = `${message}\n\n[Image: ${fileMetadata.name}]\nImage URL: ${fileUrl}`;
                } else {
                    finalMessage = `${message}\n\n[Attached file: ${fileMetadata.name}]\nFile URL: ${fileUrl}`;
                }
            }

            // Add reply context to message for AI understanding
            if (replyContext && replyContext.content) {
                const truncatedReply = replyContext.content.slice(0, 200) + (replyContext.content.length > 200 ? '...' : '');
                finalMessage = `[Replying to: "${truncatedReply}"]\n\n${finalMessage}`;
            }

            // === WORKFLOW HANDLING ===
            // Log workflow state for debugging
            console.log('[Workflow] Current state:', {
                active: workflowState.active,
                step: workflowState.step,
                waitingForApproval: workflowState.waitingForApproval,
                message: message
            });

            // Check if workflow is active - BLOCK ALL REGULAR AI
            if (workflowState.active) {
                console.log('[Workflow] Workflow is active, handling message in workflow');
                // Handle workflow response
                await handleWorkflowResponse(message);
                return; // ALWAYS block regular AI when workflow is active
            }

            // Check if message triggers workflow
            if (!workflowState.active && detectWorkflowTrigger(message)) {
                console.log('[Workflow] Message triggers workflow, starting...');
                await startKnowledgeBaseWorkflow();
                return; // Don't send to regular AI
            }
            // === END WORKFLOW HANDLING ===

            console.log('[Workflow] Not in workflow mode, sending to regular AI');

            // Add to conversation history
            conversationHistory.push({
                role: 'user',
                content: finalMessage
            });

            // Save user message to Firestore (non-blocking)
            saveMessageToFirestore(currentUser.uid, 'user', finalMessage);

            // Update local cache with user message
            appendMessageToCache('user', finalMessage);

            // Show typing indicator
            showTypingIndicator();

            // Disable input while processing
            chatInput.disabled = true;
            sendButton.disabled = true;

            try {
                // Create AbortController for cancellation
                currentAbortController = new AbortController();

                // Call API
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        messages: conversationHistory,
                        systemPrompt: systemPrompt,
                        userId: auth.currentUser.uid
                    }),
                    signal: currentAbortController.signal
                });

                const data = await response.json();

                // Remove typing indicator
                removeTypingIndicator();

                if (data.success && data.content) {
                    const aiTimestamp = new Date();

                    // If there's a pendingMessage (Mindclone said something before using a tool),
                    // show it first, then simulate "waiting" for the final response
                    if (data.pendingMessage) {
                        // Show the "promise" message (e.g., "Let me take a look...")
                        await addWorkflowMessage('ai', data.pendingMessage, aiTimestamp);

                        // Show waiting indicator with timer while "waiting" for result
                        showWaitingIndicator();

                        // Simulate the waiting time (the actual work already happened on backend,
                        // but we show this for UX to make it feel like Mindclone is working)
                        const minWaitTime = 1500; // At least 1.5 seconds
                        const maxWaitTime = 3000; // At most 3 seconds
                        const waitTime = Math.min(maxWaitTime, Math.max(minWaitTime, data.toolCallsUsed * 500));
                        await new Promise(r => setTimeout(r, waitTime));

                        removeWaitingIndicator();
                    } else if (data.usedMemorySearch) {
                        // Fallback: If no pending message but memory search was used, show recalling spinner
                        showRecallingIndicator();
                        await new Promise(r => setTimeout(r, 1200));
                        removeRecallingIndicator();
                    }

                    // Add AI response to UI
                    await addWorkflowMessage('ai', data.content, aiTimestamp);

                    // Add to conversation history
                    conversationHistory.push({
                        role: 'assistant',
                        content: data.content
                    });

                    // Save AI response to Firestore (non-blocking)
                    saveMessageToFirestore(currentUser.uid, 'assistant', data.content);

                    // Update local cache with AI response
                    appendMessageToCache('assistant', data.content);

                    // Speak the response if voice mode is enabled
                    speakResponse(data.content);
                } else {
                    // Check for subscription error
                    if (data.error === 'subscription_required') {
                        removeTypingIndicator();
                        showPaywall();
                        // Remove the user message we just added
                        conversationHistory.pop();
                        return;
                    }
                    throw new Error(data.error || 'Failed to get response');
                }
            } catch (error) {
                console.error('Error:', error);
                removeTypingIndicator();

                // Don't show error if user cancelled the request
                if (error.name === 'AbortError') {
                    console.log('Request was cancelled by user');
                    return;
                }

                // Show error message with retry button
                const errorDiv = document.createElement('div');
                errorDiv.className = 'message ai';
                errorDiv.innerHTML = `
                    <div class="message-avatar"></div>
                    <div class="message-content">
                        <div class="error-message">
                            <div class="error-message-text">
                                Sorry, I encountered an error connecting. This might be a temporary issue.
                            </div>
                            <button class="retry-btn" onclick="retryLastMessage()">Retry</button>
                        </div>
                    </div>
                `;
                chatMessages.appendChild(errorDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } finally {
                // Re-enable input
                chatInput.disabled = false;
                sendButton.disabled = false;
                chatInput.focus();
            }
        }

        // Retry last message
        window.retryLastMessage = async function() {
            // Remove error message
            const errorMessages = chatMessages.querySelectorAll('.error-message');
            errorMessages.forEach(msg => msg.closest('.message').remove());

            // Get last user message
            const lastUserMessage = conversationHistory.filter(msg => msg.role === 'user').pop();
            if (!lastUserMessage) return;

            // Remove last message from history and retry
            conversationHistory.pop(); // Remove the user message we're retrying
            chatInput.value = lastUserMessage.content;
            await sendMessage();
        };

        // Event Listeners
        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Fix for Safari iOS keyboard covering input
        chatInput.addEventListener('focus', () => {
            setTimeout(() => {
                chatInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        });

        // Auto-resize textarea as user types
        chatInput.addEventListener('input', () => {
            chatInput.style.height = 'auto';
            chatInput.style.height = Math.min(chatInput.scrollHeight, 200) + 'px';
        });

        // Scroll to bottom when keyboard appears (iOS Safari)
        // Note: Right panel toggle handler is defined earlier at toggleRightPanel()

        // File upload handlers
        attachButton.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                selectedFile = file;
                showFilePreview(file);
            }
        });

        removeFile.addEventListener('click', () => {
            selectedFile = null;
            fileInput.value = '';
            filePreview.classList.remove('visible');
        });

        // ==========================================
        // VOICE MODE - Speech-to-Text & Text-to-Speech
        // ==========================================

        // Voice state
        let isListening = false;
        let voiceModeEnabled = localStorage.getItem('voiceModeEnabled') === 'true';
        let currentAudio = null;
        let speechRecognition = null;

        // Check for Web Speech API support
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const speechSupported = !!SpeechRecognition;

        // Initialize speech recognition if supported
        if (speechSupported) {
            speechRecognition = new SpeechRecognition();
            speechRecognition.continuous = false;
            speechRecognition.interimResults = true;
            speechRecognition.lang = 'en-US';

            speechRecognition.onstart = () => {
                isListening = true;
                voiceButton.classList.add('listening');
                voiceButton.title = 'Listening... (click to stop)';
                chatInput.placeholder = 'Listening...';
            };

            speechRecognition.onend = () => {
                isListening = false;
                voiceButton.classList.remove('listening');
                voiceButton.title = 'Voice input (click to speak)';
                chatInput.placeholder = 'Type or speak your message...';
            };

            speechRecognition.onresult = (event) => {
                const transcript = Array.from(event.results)
                    .map(result => result[0].transcript)
                    .join('');

                chatInput.value = transcript;

                // Auto-send when speech is final
                if (event.results[event.results.length - 1].isFinal) {
                    setTimeout(() => {
                        if (chatInput.value.trim()) {
                            sendMessage();
                        }
                    }, 500);
                }
            };

            speechRecognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                isListening = false;
                voiceButton.classList.remove('listening');
                voiceButton.title = 'Voice input (click to speak)';
                chatInput.placeholder = 'Type or speak your message...';

                if (event.error === 'not-allowed') {
                    alert('Microphone access denied. Please allow microphone access in your browser settings.');
                }
            };
        } else {
            // Disable voice button if not supported
            voiceButton.classList.add('disabled');
            voiceButton.title = 'Voice input not supported in this browser (try Chrome or Edge)';
        }

        // Voice button click handler
        voiceButton.addEventListener('click', () => {
            if (!speechSupported) {
                alert('Voice input is not supported in this browser. Please use Chrome, Edge, or Safari.');
                return;
            }

            if (isListening) {
                speechRecognition.stop();
            } else {
                try {
                    speechRecognition.start();
                } catch (error) {
                    console.error('Speech recognition start error:', error);
                }
            }
        });

        // Text-to-Speech function using ElevenLabs
        async function speakResponse(text) {
            // Don't speak if voice mode is disabled
            if (!voiceModeEnabled) return;

            // Stop any currently playing audio
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }

            try {
                const response = await fetch('/api/tts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text })
                });

                if (!response.ok) {
                    const error = await response.json();
                    console.error('TTS error:', error);
                    return;
                }

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);

                currentAudio = new Audio(audioUrl);
                currentAudio.onended = () => {
                    URL.revokeObjectURL(audioUrl);
                    currentAudio = null;

                    // Auto-listen after AI finishes speaking (if voice mode enabled)
                    if (voiceModeEnabled && speechSupported && !isListening) {
                        setTimeout(() => {
                            try {
                                speechRecognition.start();
                            } catch (e) {
                                console.log('Could not auto-start listening:', e);
                            }
                        }, 500);
                    }
                };

                await currentAudio.play();
            } catch (error) {
                console.error('TTS playback error:', error);
            }
        }

        // Toggle voice mode
        function toggleVoiceMode() {
            voiceModeEnabled = !voiceModeEnabled;
            localStorage.setItem('voiceModeEnabled', voiceModeEnabled);
            updateVoiceModeUI();
        }

        function updateVoiceModeUI() {
            // Could add a visual indicator in the UI if needed
            if (voiceModeEnabled) {
                voiceButton.style.borderColor = 'var(--color-accent-primary)';
            } else {
                voiceButton.style.borderColor = '#333';
            }
        }

        // Initialize voice mode UI
        updateVoiceModeUI();

        // ==========================================
        // END VOICE MODE
        // ==========================================

        // ==========================================
        // OPENAI REALTIME VOICE MODE (WebRTC)
        // ==========================================

        const voiceModeOverlay = document.getElementById('voiceModeOverlay');
        const voiceModeClose = document.getElementById('voiceModeClose');
        const voiceOrb = document.getElementById('voiceOrb');
        const voiceRings = document.getElementById('voiceRings');
        const voiceModeStatus = document.getElementById('voiceModeStatus');
        const voiceTranscript = document.getElementById('voiceTranscript');
        const voiceModeMute = document.getElementById('voiceModeMute');
        const voiceModeEnd = document.getElementById('voiceModeEnd');

        let realtimePeerConnection = null;
        let realtimeDataChannel = null;
        let localMediaStream = null;
        let isRealtimeConnected = false;
        let isRealtimeMuted = false;
        let realtimeAudioElement = null;

        // Open voice mode overlay
        function openRealtimeVoiceMode() {
            voiceModeOverlay.classList.add('active');
            voiceModeStatus.textContent = 'Connecting...';
            voiceOrb.className = 'voice-orb connecting';
            voiceTranscript.textContent = 'Initializing voice connection...';
            startRealtimeSession();
        }

        // Close voice mode overlay
        function closeRealtimeVoiceMode() {
            voiceModeOverlay.classList.remove('active');
            stopRealtimeSession();
        }

        // Start realtime session with OpenAI
        async function startRealtimeSession() {
            try {
                // Get ephemeral token from our backend
                const tokenResponse = await fetch('/api/realtime-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ voice: 'alloy' })
                });

                if (!tokenResponse.ok) {
                    const error = await tokenResponse.json();
                    throw new Error(error.error || 'Failed to get session token');
                }

                const sessionData = await tokenResponse.json();
                const ephemeralKey = sessionData.client_secret?.value || sessionData.client_secret;

                if (!ephemeralKey) {
                    throw new Error('No ephemeral key received');
                }

                console.log('[Realtime] Session created:', sessionData.session_id);

                // Create peer connection
                realtimePeerConnection = new RTCPeerConnection();

                // Set up audio element for playback
                realtimeAudioElement = document.createElement('audio');
                realtimeAudioElement.autoplay = true;
                realtimePeerConnection.ontrack = (event) => {
                    console.log('[Realtime] Received audio track');
                    realtimeAudioElement.srcObject = event.streams[0];
                };

                // Get user microphone
                localMediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });

                // Add microphone track to connection
                localMediaStream.getTracks().forEach(track => {
                    realtimePeerConnection.addTrack(track, localMediaStream);
                });

                // Create data channel for events
                realtimeDataChannel = realtimePeerConnection.createDataChannel('oai-events');
                setupDataChannelHandlers();

                // Create offer
                const offer = await realtimePeerConnection.createOffer();
                await realtimePeerConnection.setLocalDescription(offer);

                // Send offer to OpenAI
                const sdpResponse = await fetch(
                    'https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview-2024-12-17',
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${ephemeralKey}`,
                            'Content-Type': 'application/sdp'
                        },
                        body: offer.sdp
                    }
                );

                if (!sdpResponse.ok) {
                    throw new Error('Failed to connect to OpenAI Realtime');
                }

                const answerSdp = await sdpResponse.text();
                await realtimePeerConnection.setRemoteDescription({
                    type: 'answer',
                    sdp: answerSdp
                });

                isRealtimeConnected = true;
                voiceModeStatus.textContent = 'Listening...';
                voiceOrb.className = 'voice-orb listening';
                voiceTranscript.textContent = 'Start speaking...';

                console.log('[Realtime] Connected successfully');

            } catch (error) {
                console.error('[Realtime] Connection error:', error);
                voiceModeStatus.textContent = 'Connection failed';
                voiceOrb.className = 'voice-orb';
                voiceTranscript.textContent = error.message;

                // Auto-close after showing error
                setTimeout(() => {
                    if (!isRealtimeConnected) {
                        closeRealtimeVoiceMode();
                    }
                }, 3000);
            }
        }

        // Set up data channel event handlers
        function setupDataChannelHandlers() {
            realtimeDataChannel.onopen = () => {
                console.log('[Realtime] Data channel open');
            };

            realtimeDataChannel.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    handleRealtimeEvent(message);
                } catch (e) {
                    console.error('[Realtime] Failed to parse message:', e);
                }
            };

            realtimeDataChannel.onerror = (error) => {
                console.error('[Realtime] Data channel error:', error);
            };

            realtimeDataChannel.onclose = () => {
                console.log('[Realtime] Data channel closed');
            };
        }

        // Handle events from OpenAI Realtime
        function handleRealtimeEvent(event) {
            console.log('[Realtime] Event:', event.type);

            switch (event.type) {
                case 'session.created':
                    console.log('[Realtime] Session ready');
                    break;

                case 'input_audio_buffer.speech_started':
                    voiceModeStatus.textContent = 'Listening...';
                    voiceOrb.className = 'voice-orb listening';
                    break;

                case 'input_audio_buffer.speech_stopped':
                    voiceModeStatus.textContent = 'Processing...';
                    break;

                case 'conversation.item.input_audio_transcription.completed':
                    if (event.transcript) {
                        voiceTranscript.textContent = `You: ${event.transcript}`;
                    }
                    break;

                case 'response.audio_transcript.delta':
                    voiceModeStatus.textContent = 'Speaking...';
                    voiceOrb.className = 'voice-orb speaking';
                    if (event.delta) {
                        const currentText = voiceTranscript.textContent;
                        if (currentText.startsWith('AI: ')) {
                            voiceTranscript.textContent = currentText + event.delta;
                        } else {
                            voiceTranscript.textContent = `AI: ${event.delta}`;
                        }
                    }
                    break;

                case 'response.audio_transcript.done':
                    if (event.transcript) {
                        voiceTranscript.textContent = `AI: ${event.transcript}`;
                    }
                    break;

                case 'response.done':
                    voiceModeStatus.textContent = 'Listening...';
                    voiceOrb.className = 'voice-orb listening';
                    break;

                case 'error':
                    console.error('[Realtime] Error:', event.error);
                    voiceTranscript.textContent = `Error: ${event.error?.message || 'Unknown error'}`;
                    break;
            }
        }

        // Stop realtime session
        function stopRealtimeSession() {
            isRealtimeConnected = false;

            if (realtimeDataChannel) {
                realtimeDataChannel.close();
                realtimeDataChannel = null;
            }

            if (realtimePeerConnection) {
                realtimePeerConnection.close();
                realtimePeerConnection = null;
            }

            if (localMediaStream) {
                localMediaStream.getTracks().forEach(track => track.stop());
                localMediaStream = null;
            }

            if (realtimeAudioElement) {
                realtimeAudioElement.srcObject = null;
                realtimeAudioElement = null;
            }

            voiceOrb.className = 'voice-orb';
            voiceModeStatus.textContent = 'Tap microphone to start';
            voiceTranscript.textContent = 'Your conversation will appear here...';
            isRealtimeMuted = false;
            voiceModeMute.textContent = 'Mute';
            voiceModeMute.classList.remove('muted');

            console.log('[Realtime] Session stopped');
        }

        // Toggle mute
        function toggleRealtimeMute() {
            if (!localMediaStream) return;

            isRealtimeMuted = !isRealtimeMuted;
            localMediaStream.getAudioTracks().forEach(track => {
                track.enabled = !isRealtimeMuted;
            });

            voiceModeMute.textContent = isRealtimeMuted ? 'Unmute' : 'Mute';
            voiceModeMute.classList.toggle('muted', isRealtimeMuted);
            voiceModeStatus.textContent = isRealtimeMuted ? 'Muted' : 'Listening...';
        }

        // Event listeners for voice mode overlay
        voiceModeClose?.addEventListener('click', closeRealtimeVoiceMode);
        voiceModeEnd?.addEventListener('click', closeRealtimeVoiceMode);
        voiceModeMute?.addEventListener('click', toggleRealtimeMute);

        // Long-press on voice button to open realtime mode
        let voiceButtonPressTimer = null;
        voiceButton?.addEventListener('mousedown', () => {
            voiceButtonPressTimer = setTimeout(() => {
                openRealtimeVoiceMode();
            }, 500); // 500ms long press
        });

        voiceButton?.addEventListener('mouseup', () => {
            if (voiceButtonPressTimer) {
                clearTimeout(voiceButtonPressTimer);
            }
        });

        voiceButton?.addEventListener('mouseleave', () => {
            if (voiceButtonPressTimer) {
                clearTimeout(voiceButtonPressTimer);
            }
        });

        // Touch support for mobile
        voiceButton?.addEventListener('touchstart', (e) => {
            voiceButtonPressTimer = setTimeout(() => {
                e.preventDefault();
                openRealtimeVoiceMode();
            }, 500);
        });

        voiceButton?.addEventListener('touchend', () => {
            if (voiceButtonPressTimer) {
                clearTimeout(voiceButtonPressTimer);
            }
        });

        // Also allow double-tap to open realtime mode
        let lastVoiceTap = 0;
        voiceButton?.addEventListener('click', (e) => {
            const now = Date.now();
            if (now - lastVoiceTap < 300) {
                e.preventDefault();
                e.stopPropagation();
                openRealtimeVoiceMode();
            }
            lastVoiceTap = now;
        });

        // ==========================================
        // END OPENAI REALTIME VOICE MODE
        // ==========================================

        function showFilePreview(file) {
            const fileSizeKB = (file.size / 1024).toFixed(2);
            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
            const sizeText = file.size < 1024 * 1024
                ? `${fileSizeKB} KB`
                : `${fileSizeMB} MB`;

            // Set icon based on file type
            const fileExt = file.name.split('.').pop().toLowerCase();
            let icon = '';
            if (['pdf'].includes(fileExt)) icon = '';
            else if (['png', 'jpg', 'jpeg', 'gif'].includes(fileExt)) icon = '';
            else if (['xlsx', 'xls', 'csv'].includes(fileExt)) icon = '';

            fileIcon.textContent = icon;
            fileName.textContent = file.name;
            fileSize.textContent = sizeText;
            filePreview.classList.add('visible');
        }

        async function uploadFile(file) {
            try {
                // Convert file to base64
                const reader = new FileReader();
                return new Promise((resolve, reject) => {
                    reader.onload = async () => {
                        try {
                            const base64File = reader.result.split(',')[1]; // Remove data:type;base64, prefix
                            const response = await fetch('/api/upload-document', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-User-ID': auth.currentUser.uid
                                },
                                body: JSON.stringify({
                                    file: base64File,
                                    filename: file.name,
                                    contentType: file.type,
                                    userId: auth.currentUser.uid
                                })
                            });

                            if (!response.ok) {
                                throw new Error('Upload failed');
                            }

                            const data = await response.json();
                            const fileUrl = data.url;

                            // Auto-process PDFs and Excel files
                            const fileExt = file.name.split('.').pop().toLowerCase();
                            if (['pdf', 'xlsx', 'xls', 'csv'].includes(fileExt)) {
                                console.log('[Upload] Processing document for Knowledge Base...');

                                // Show typing indicator while processing
                                if (typeof showTypingIndicator === 'function') {
                                    showTypingIndicator();
                                }

                                try {
                                    const processResponse = await fetch('/api/process-document', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            fileUrl: fileUrl,
                                            fileType: file.type,
                                            userId: auth.currentUser.uid,
                                            documentType: fileExt === 'pdf' ? 'pitch_deck' : 'financial_model'
                                        })
                                    });

                                    // Remove typing indicator
                                    if (typeof removeTypingIndicator === 'function') {
                                        removeTypingIndicator();
                                    }

                                    if (processResponse.ok) {
                                        const processData = await processResponse.json();
                                        console.log('[Upload] Document processed:', processData);

                                        // Show visible confirmation message
                                        const docType = processData.documentType === 'pitch_deck' ? 'Pitch Deck' : 'Financial Model';
                                        let summaryMsg = ` **${docType} processed successfully!**\n\n`;

                                        if (processData.summary) {
                                            if (processData.summary.pageCount) {
                                                summaryMsg += `- Pages: ${processData.summary.pageCount}\n`;
                                            }
                                            if (processData.summary.sectionsFound) {
                                                summaryMsg += `- Sections identified: ${processData.summary.sectionsFound}\n`;
                                            }
                                            if (processData.summary.sheetsFound) {
                                                summaryMsg += `- Sheets found: ${processData.summary.sheetsFound}\n`;
                                            }
                                            if (processData.summary.metricsExtracted) {
                                                summaryMsg += `- Financial metrics extracted: ${processData.summary.metricsExtracted}\n`;
                                            }
                                        }

                                        summaryMsg += `\nThis content is now available in your public MindClone link's knowledge base.`;

                                        // Add as system message to chat
                                        if (typeof addMessage === 'function') {
                                            addMessage('assistant', summaryMsg);
                                        }
                                    } else {
                                        const errorData = await processResponse.json().catch(() => ({}));
                                        console.warn('[Upload] Document processing failed:', errorData);
                                        if (typeof addMessage === 'function') {
                                            addMessage('assistant', ` File uploaded but processing failed: ${errorData.error || 'Unknown error'}. The file is stored but not yet in your knowledge base.`);
                                        }
                                    }
                                } catch (processError) {
                                    console.warn('[Upload] Document processing error:', processError);

                                    // Remove typing indicator on error too
                                    if (typeof removeTypingIndicator === 'function') {
                                        removeTypingIndicator();
                                    }

                                    if (typeof addMessage === 'function') {
                                        addMessage('assistant', ` File uploaded but processing encountered an error. The file is stored but may not be in your knowledge base.`);
                                    }
                                }
                            }

                            resolve(fileUrl);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            } catch (error) {
                console.error('File upload error:', error);
                throw error;
            }
        }

        // ============================================
        // NEW: Landing Page & Header Event Handlers
        // ============================================

        // Landing sign-in button
        const landingSignInBtn = document.getElementById('landingSignInBtn');
        console.log('[Auth] landingSignInBtn element:', landingSignInBtn);
        if (landingSignInBtn) {
            console.log('[Auth] Attaching click handler to landingSignInBtn');
            landingSignInBtn.addEventListener('click', async () => {
                console.log('[Auth] Landing sign-in button clicked');
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error('Sign-in error:', error);
                    alert('Sign-in failed: ' + error.message);
                }
            });
        } else {
            console.error('[Auth] landingSignInBtn not found in DOM!');
        }

        // Pricing sign-in button
        const pricingSignInBtn = document.getElementById('pricingSignInBtn');
        if (pricingSignInBtn) {
            pricingSignInBtn.addEventListener('click', async () => {
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error('Sign-in error:', error);
                }
            });
        }

        // Header avatar dropdown toggle
        const headerAvatar = document.getElementById('headerAvatar');
        const headerDropdown = document.getElementById('headerDropdown');
        if (headerAvatar && headerDropdown) {
            headerAvatar.addEventListener('click', (e) => {
                e.stopPropagation();
                headerDropdown.classList.toggle('hidden');
            });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const headerDropdown = document.getElementById('headerDropdown');
            const headerAvatar = document.getElementById('headerAvatar');
            if (headerDropdown && headerAvatar) {
                if (!headerDropdown.contains(e.target) && !headerAvatar.contains(e.target)) {
                    headerDropdown.classList.add('hidden');
                }
            }
        });

        // Activity button - open modal
        const activityBtn = document.getElementById('activityBtn');
        if (activityBtn) {
            activityBtn.addEventListener('click', () => {
                openActivityModal();
            });
        }

        // Activity modal close button
        const activityModalClose = document.getElementById('activityModalClose');
        if (activityModalClose) {
            activityModalClose.addEventListener('click', () => {
                closeActivityModal();
            });
        }

        // Activity modal overlay - close on click
        const activityModal = document.getElementById('activityModal');
        if (activityModal) {
            activityModal.addEventListener('click', (e) => {
                if (e.target.classList.contains('activity-modal-overlay') ||
                    e.target.id === 'activityModal') {
                    closeActivityModal();
                }
            });
        }

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const activityModal = document.getElementById('activityModal');
                if (activityModal && !activityModal.classList.contains('hidden')) {
                    closeActivityModal();
                }

                const headerDropdown = document.getElementById('headerDropdown');
                if (headerDropdown && !headerDropdown.classList.contains('hidden')) {
                    headerDropdown.classList.add('hidden');
                }
            }
        });

        // Header sign-out button
        const headerSignOutBtn = document.getElementById('headerSignOutBtn');
        if (headerSignOutBtn) {
            headerSignOutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    // Clear conversation history
                    conversationHistory = [];
                    chatMessages.innerHTML = '';
                    // Close dropdown
                    const headerDropdown = document.getElementById('headerDropdown');
                    if (headerDropdown) {
                        headerDropdown.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Sign-out error:', error);
                }
            });
        }

        // Account sidebar sign-out button
        const accountSignOutBtn = document.getElementById('accountSignOutBtn');
        if (accountSignOutBtn) {
            accountSignOutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    // Clear conversation history
                    conversationHistory = [];
                    chatMessages.innerHTML = '';
                    // Hide account sidebar
                    const accountSidebar = document.getElementById('accountSidebar');
                    if (accountSidebar) {
                        accountSidebar.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Sign-out error:', error);
                }
            });
        }

        // ============================================
        // Helper Functions for Activity Modal
        // ============================================

        // Open activity modal
        function openActivityModal() {
            const activityModal = document.getElementById('activityModal');
            if (activityModal) {
                activityModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
                populateActivityModal();
            }
        }

        // Close activity modal
        function closeActivityModal() {
            const activityModal = document.getElementById('activityModal');
            if (activityModal) {
                activityModal.classList.add('hidden');
                document.body.style.overflow = ''; // Restore scrolling
            }
        }

        // Populate activity modal with data
        function populateActivityModal() {
            const modalActivityList = document.getElementById('modalActivityList');
            const modalActivityEmpty = document.getElementById('modalActivityEmpty');
            const modalActivityCount = document.getElementById('modalActivityCount');
            const modalTotalCount = document.getElementById('modalTotalCount');

            if (!modalActivityList) return;

            // Clear existing content
            modalActivityList.innerHTML = '';

            // Calculate stats
            const now = Date.now();
            const oneDayAgo = now - (24 * 60 * 60 * 1000);
            const todayCount = activityData.filter(activity => {
                const timestamp = activity.timestamp?.toMillis ? activity.timestamp.toMillis() : activity.timestamp;
                return timestamp > oneDayAgo;
            }).length;

            // Update stats
            if (modalActivityCount) {
                modalActivityCount.textContent = todayCount;
            }
            if (modalTotalCount) {
                modalTotalCount.textContent = activityData.length;
            }

            // Show empty state or activity list
            if (activityData.length === 0) {
                if (modalActivityEmpty) {
                    modalActivityEmpty.classList.remove('hidden');
                }
                modalActivityList.classList.add('hidden');
            } else {
                if (modalActivityEmpty) {
                    modalActivityEmpty.classList.add('hidden');
                }
                modalActivityList.classList.remove('hidden');

                // Render activity items (most recent first)
                const sortedActivities = [...activityData].sort((a, b) => {
                    const aTime = a.timestamp?.toMillis ? a.timestamp.toMillis() : a.timestamp;
                    const bTime = b.timestamp?.toMillis ? b.timestamp.toMillis() : b.timestamp;
                    return bTime - aTime;
                });

                sortedActivities.forEach(activity => {
                    const item = document.createElement('div');
                    item.className = 'modal-activity-item';

                    const timestamp = activity.timestamp?.toMillis ? activity.timestamp.toMillis() : activity.timestamp;
                    const timeAgo = formatTimestamp({ toDate: () => new Date(timestamp) });

                    item.innerHTML = `
                        <div class="modal-activity-icon"></div>
                        <div class="modal-activity-details">
                            <div class="modal-activity-message">${activity.lastMessage || 'Started a conversation'}</div>
                            <div class="modal-activity-time">${timeAgo}</div>
                        </div>
                    `;

                    modalActivityList.appendChild(item);
                });
            }
        }

        // Update activity badge count
        function updateActivityBadge() {
            // Calculate today's activity count
            const now = Date.now();
            const oneDayAgo = now - (24 * 60 * 60 * 1000);
            const todayCount = activityData.filter(activity => {
                const timestamp = activity.timestamp?.toMillis ? activity.timestamp.toMillis() : activity.timestamp;
                return timestamp > oneDayAgo;
            }).length;

            // Update right panel count
            if (rightActivityCount) {
                rightActivityCount.textContent = `${todayCount} today`;
            }

            // Update old sidebar count (if it exists)
            const activityCount = document.getElementById('activityCount');
            if (activityCount) {
                activityCount.textContent = `${todayCount} today`;
            }

            // Update tab badge
            if (activityBadge) {
                activityBadge.textContent = todayCount > 0 ? todayCount : '';
            }
        }

        // Handle URL hash for deep linking on page load
        window.addEventListener('load', handlePanelDeepLink);

        // ==================== BILLING FUNCTIONS ====================

        // Global billing state
        let userBillingStatus = null;

        // Load billing status
        async function loadBillingStatus() {
            if (!auth.currentUser) return null;

            try {
                const idToken = await auth.currentUser.getIdToken();
                const response = await fetch('/api/billing/status', {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                if (!response.ok) throw new Error('Failed to load billing status');

                userBillingStatus = await response.json();
                updateBillingUI(userBillingStatus);
                return userBillingStatus;
            } catch (error) {
                console.error('[Billing] Error loading status:', error);
                return null;
            }
        }

        // Update UI based on billing status
        function updateBillingUI(status) {
            const banner = document.getElementById('subscriptionBanner');
            const bannerText = document.getElementById('bannerText');
            const currentPlanInfo = document.getElementById('currentPlanInfo');
            const upgradeBtn = document.getElementById('upgradeBtn');
            const manageBillingBtn = document.getElementById('manageBillingBtn');
            const grandfatheredBadge = document.getElementById('grandfatheredBadge');
            const trialCountdownBanner = document.getElementById('trialCountdownBanner');
            const trialDaysText = document.getElementById('trialDaysText');

            // Hide everything first
            banner?.classList.add('hidden');
            grandfatheredBadge?.classList.add('hidden');
            upgradeBtn?.classList.add('hidden');
            manageBillingBtn?.classList.add('hidden');
            trialCountdownBanner?.classList.add('hidden');
            document.body.classList.remove('has-banner');

            if (!status) return;

            if (status.isGrandfathered) {
                // Grandfathered user
                grandfatheredBadge?.classList.remove('hidden');
                if (currentPlanInfo) {
                    currentPlanInfo.innerHTML = `
                        <div class="plan-card grandfathered">
                            <span class="plan-name">Lifetime Free</span>
                            <span class="plan-status">Early Supporter</span>
                        </div>
                    `;
                }
            } else if (status.trialDaysRemaining > 0 || ['created', 'authenticated'].includes(status.status)) {
                // Trial user (Razorpay uses 'created' or 'authenticated' during trial)
                const daysLeft = status.trialDaysRemaining || 7;
                banner?.classList.remove('hidden');
                document.body.classList.add('has-banner');
                if (bannerText) bannerText.textContent = `Free trial: ${daysLeft} days remaining`;
                if (currentPlanInfo) {
                    currentPlanInfo.innerHTML = `
                        <div class="plan-card trial">
                            <span class="plan-name">Free Trial</span>
                            <span class="plan-status">${daysLeft} days left</span>
                        </div>
                    `;
                }
                if (upgradeBtn) {
                    upgradeBtn.textContent = 'Upgrade';
                    upgradeBtn.classList.remove('hidden');
                }
                // Show trial countdown banner in left panel
                if (trialCountdownBanner) {
                    trialCountdownBanner.classList.remove('hidden');
                    if (trialDaysText) {
                        // Calculate days and remaining hours for granular display
                        const totalHours = status.trialHoursRemaining || (daysLeft * 24);
                        const days = Math.floor(totalHours / 24);
                        const hours = totalHours % 24;
                        if (days > 0) {
                            trialDaysText.textContent = `${days}d ${hours}h left`;
                        } else {
                            trialDaysText.textContent = `${hours}h left`;
                        }
                    }
                    // Add urgent class if 2 days or less
                    if (daysLeft <= 2) {
                        trialCountdownBanner.classList.add('urgent');
                    } else {
                        trialCountdownBanner.classList.remove('urgent');
                    }
                }
            } else if (status.status === 'active') {
                // Active subscriber
                manageBillingBtn?.classList.remove('hidden');
                if (currentPlanInfo) {
                    const renewDate = status.currentPeriodEnd ? new Date(status.currentPeriodEnd).toLocaleDateString() : 'N/A';
                    currentPlanInfo.innerHTML = `
                        <div class="plan-card active">
                            <span class="plan-name">Pro</span>
                            <span class="plan-status">${status.cancelAtPeriodEnd ? 'Cancels' : 'Renews'} ${renewDate}</span>
                        </div>
                    `;
                }
            } else {
                // Expired/no subscription - show paywall
                if (status.accessLevel === 'read_only') {
                    showPaywall();
                }
                if (currentPlanInfo) {
                    currentPlanInfo.innerHTML = `
                        <div class="plan-card expired">
                            <span class="plan-name">No Plan</span>
                            <span class="plan-status">Read-only</span>
                        </div>
                    `;
                }
                if (upgradeBtn) {
                    upgradeBtn.textContent = 'Start Trial';
                    upgradeBtn.classList.remove('hidden');
                }
            }
        }

        // Create subscription and open Razorpay checkout
        async function startCheckout() {
            if (!auth.currentUser) return;

            try {
                const idToken = await auth.currentUser.getIdToken();
                const response = await fetch('/api/billing/create-checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    }
                });

                if (!response.ok) throw new Error('Failed to create subscription');

                const data = await response.json();

                // Option 1: Use Razorpay hosted checkout page
                if (data.shortUrl) {
                    window.location.href = data.shortUrl;
                    return;
                }

                // Option 2: Open embedded Razorpay checkout modal
                const options = {
                    key: data.keyId,
                    subscription_id: data.subscriptionId,
                    name: data.name || 'Mindclone Pro',
                    description: data.description || 'Monthly subscription with 7-day free trial',
                    prefill: data.prefill || {},
                    notes: data.notes || {},
                    theme: {
                        color: '#000000'
                    },
                    handler: function(response) {
                        // Payment successful
                        console.log('[Billing] Payment successful:', response);
                        alert('Subscription activated! Welcome to Mindclone Pro.');
                        loadBillingStatus();
                        hidePaywall();
                    },
                    modal: {
                        ondismiss: function() {
                            console.log('[Billing] Checkout dismissed');
                        }
                    }
                };

                const rzp = new Razorpay(options);
                rzp.on('payment.failed', function(response) {
                    console.error('[Billing] Payment failed:', response.error);
                    alert('Payment failed: ' + (response.error.description || 'Please try again.'));
                });
                rzp.open();

            } catch (error) {
                console.error('[Billing] Checkout error:', error);
                alert('Failed to start checkout. Please try again.');
            }
        }

        // Open billing management modal
        async function openBillingPortal() {
            if (!auth.currentUser) return;

            const action = await showBillingOptions();
            if (!action) return;

            try {
                const idToken = await auth.currentUser.getIdToken();
                const response = await fetch('/api/billing/create-portal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({ action })
                });

                if (!response.ok) throw new Error('Failed to process request');

                const result = await response.json();

                if (action === 'cancel') {
                    alert(result.message || 'Subscription will be cancelled at the end of the billing period.');
                } else if (action === 'pause') {
                    alert(result.message || 'Subscription paused.');
                } else if (action === 'resume') {
                    alert(result.message || 'Subscription resumed.');
                }

                await loadBillingStatus();
            } catch (error) {
                console.error('[Billing] Portal error:', error);
                alert('Failed to process request. Please try again.');
            }
        }

        // Show billing options dialog
        function showBillingOptions() {
            return new Promise((resolve) => {
                const options = [
                    { value: 'cancel', label: 'Cancel Subscription' },
                    { value: null, label: 'Close' }
                ];

                const choice = confirm('Would you like to cancel your subscription?\n\nYour access will continue until the end of the current billing period.');
                resolve(choice ? 'cancel' : null);
            });
        }

        // Show paywall modal
        function showPaywall() {
            const modal = document.getElementById('paywallModal');
            modal?.classList.remove('hidden');
        }

        // Hide paywall modal
        function hidePaywall() {
            const modal = document.getElementById('paywallModal');
            modal?.classList.add('hidden');
        }

        // Check access before sending message
        function checkAccessBeforeSend() {
            if (!userBillingStatus) return true; // Allow if status not loaded yet

            if (userBillingStatus.accessLevel === 'read_only') {
                showPaywall();
                return false;
            }
            return true;
        }

        // Initialize billing event listeners
        function initializeBilling() {
            document.getElementById('upgradeBtn')?.addEventListener('click', startCheckout);
            document.getElementById('upgradeBannerBtn')?.addEventListener('click', startCheckout);
            document.getElementById('paywallUpgradeBtn')?.addEventListener('click', startCheckout);
            document.getElementById('manageBillingBtn')?.addEventListener('click', openBillingPortal);
            document.getElementById('paywallCloseBtn')?.addEventListener('click', hidePaywall);
        }

        // Initialize billing on page load
        initializeBilling();

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('[PWA] Service Worker registered:', reg.scope))
                    .catch(err => console.warn('[PWA] Service Worker registration failed:', err));
            });
        }
    </script>
</body>
</html>
